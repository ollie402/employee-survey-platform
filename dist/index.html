<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realworld Employee Survey Platform</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        /* Adaptable Logo Styles - NEW ADDITION */
        .logo-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin-right: 0.5rem;
            transition: all 0.3s ease;
        }

        .logo-icon.has-default {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .logo-icon.has-custom {
            background: transparent !important;
            width: auto;
            max-width: 150px;
            height: 45px;
        }

        .login-header .logo-icon.has-custom {
            width: auto;
            max-width: 200px;
            height: 60px;
            margin-bottom: 1rem;
        }

        .sidebar .logo {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            font-weight: bold;
            font-size: 1.25rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar .logo-icon.has-custom {
            max-width: 120px;
            height: 40px;
        }

        /* Ensure images scale properly */
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        /* END Adaptable Logo Styles */

        .chat-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .chat-window {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 500px;
            height: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            background: var(--primary-color);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        
        .chat-header h2 {
            margin: 0;
            font-size: 1.25rem;
        }
        
        .chat-header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
            font-size: 0.875rem;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: #f8f9fa;
        }
        
        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid #e0e0e0;
            background: white;
        }
        
        .chat-input-group {
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 24px;
            outline: none;
            font-size: 0.875rem;
        }
        
        .chat-send-btn {
            padding: 0.75rem 1.5rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .chat-send-btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }
        
        .message {
            margin-bottom: 1rem;
            animation: slideIn 0.3s ease-out;
        }
        
        .message.user {
            text-align: right;
        }
        
        .message-bubble {
            display: inline-block;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .message.bot .message-bubble {
            background: white;
            color: #333;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .message.user .message-bubble {
            background: var(--primary-color);
            color: white;
        }
        
        .typing-indicator {
            display: none;
            padding: 0.75rem 1rem;
            background: white;
            border-radius: 12px;
            display: inline-block;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .typing-indicator.show {
            display: inline-block;
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* ENHANCED CHAT FEEDBACK STYLES */
        .feedback-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .view-toggle {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-secondary);
            padding: 0.25rem;
            border-radius: 6px;
        }
        
        .view-toggle button {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .view-toggle button.active {
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .sentiment-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .sentiment-positive {
            background: #dcfce7;
            color: #166534;
        }
        
        .sentiment-neutral {
            background: #fef3c7;
            color: #92400e;
        }
        
        .sentiment-negative {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .priority-indicator {
            width: 4px;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            border-radius: 4px 0 0 4px;
        }
        
        .priority-high {
            background: var(--danger-color);
        }
        
        .priority-medium {
            background: var(--warning-color);
        }
        
        .priority-low {
            background: var(--success-color);
        }
        
        .feedback-item {
            position: relative;
            padding: 1rem 1rem 1rem 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .feedback-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }
        
        .feedback-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .feedback-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .action-btn {
            padding: 0.25rem 0.5rem;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
        }
        
        .action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .response-box {
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            border-left: 3px solid var(--primary-color);
        }
        
        .keyword-tag {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--primary-color);
            color: white;
            border-radius: 4px;
            font-size: 0.625rem;
            margin-right: 0.25rem;
        }
        /* END ENHANCED STYLES */

        /* NEW CHAT TYPE SELECTION STYLES */
        .chat-type-option {
            position: relative;
            transition: all 0.3s ease;
        }

        .chat-type-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .chat-type-option input[type="radio"] {
            position: absolute;
            top: 1rem;
            right: 1rem;
            transform: scale(1.2);
        }

        .chat-type-option.selected {
            border-color: var(--primary-color) !important;
            background: #f0f9ff !important;
        }

        /* Participant Management Styles */
        .participants-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
        }

        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            transition: all 0.2s;
        }

        .participant-item:hover {
            background: #e0e7ff;
        }

        .participant-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--primary-color);
            color: white;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Response Tracking Styles */
        .response-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .response-indicator.responded {
            background: #dcfce7;
            color: #166534;
        }

        .response-indicator.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .response-indicator.expired {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Link Display Styles */
        .link-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .link-display input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.875rem;
            background: white;
        }

        .link-display button {
            padding: 0.5rem 1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .link-display button:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        /* Info Cards */
        .info-card {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .info-card.success {
            background: #dcfce7;
            border-left: 4px solid #10b981;
        }

        .info-card.warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }

        .info-card.info {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
        }

        /* Chat Session Cards */
        .chat-session-card {
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .chat-session-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .chat-session-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .chat-session-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chat-session-type {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .chat-session-type.continuous {
            background: #e0f2fe;
            color: #0369a1;
        }

        .chat-session-type.personal {
            background: #fce7f3;
            color: #a21caf;
        }

        .chat-session-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .chat-stat {
            text-align: center;
        }

        .chat-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .chat-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Progress Bars */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary-color);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Action Buttons Grid */
        .action-buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .action-btn-small {
            padding: 0.5rem;
            font-size: 0.875rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .action-btn-small:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        /* Modal Overlay Enhancement */
        .modal {
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Design for Chat Widgets */
        @media (max-width: 768px) {
            .chat-type-option {
                grid-column: span 2;
            }
            
            .action-buttons-grid {
                grid-template-columns: 1fr;
            }
            
            .chat-session-stats {
                grid-template-columns: 1fr 1fr;
            }
        }
        /* END NEW CHAT TYPE SELECTION STYLES */

        /* TEMPLATE BUILDER STYLES */
        .template-question-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .template-question-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .question-number {
            font-weight: 600;
            color: var(--primary-color);
        }

        .question-content {
            padding: 1rem;
        }

        .question-options {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
        }

        /* Template Card Styles */
        .template-card {
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
            background: white;
        }

        .template-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .template-category-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--primary-color);
            color: white;
            border-radius: 4px;
            font-size: 0.625rem;
            margin-left: 0.5rem;
        }

        /* Chat Preview Styles */
        .chat-preview-message {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
        }

        .chat-preview-message.bot {
            background: white;
            border: 1px solid #e5e7eb;
            margin-right: 2rem;
        }

        /* Enhanced Chat Management Styles */
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .stat-change {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #dc2626;
        }

        .chat-widget-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .chat-widget-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .chat-widget-card.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .dropdown-menu {
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            transform: translateY(-5px);
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-menu a:hover {
            background-color: #f3f4f6;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        .template-card {
            transition: all 0.2s ease;
        }

        .template-card:hover {
            transform: translateY(-1px);
            border-color: var(--primary-color);
        }

        /* Activity feed styles */
        .activity-item {
            transition: all 0.2s ease;
        }

        .activity-item:hover {
            background-color: rgba(59, 130, 246, 0.05);
        }

        .chat-preview-message.user {
            background: #f0f9ff;
            border: 1px solid #bfdbfe;
            margin-left: 2rem;
            text-align: right;
        }

        /* Question Type Indicator */
        .question-type-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #e0e7ff;
            color: #4338ca;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Template Selection Styles */
        .template-select-card {
            padding: 1rem;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
        }

        .template-select-card:hover {
            border-color: var(--primary-color);
            background: #f0f9ff;
        }

        .template-select-card.selected {
            border-color: var(--primary-color);
            background: #e0f2fe;
        }

        /* AI Personality Badges */
        .ai-personality-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .ai-personality-professional {
            background: #e5e7eb;
            color: #374151;
        }

        .ai-personality-friendly {
            background: #fef3c7;
            color: #92400e;
        }

        .ai-personality-casual {
            background: #dbeafe;
            color: #1e40af;
        }

        .ai-personality-formal {
            background: #f3e8ff;
            color: #6b21a8;
        }

        .ai-personality-empathetic {
            background: #fce7f3;
            color: #a21caf;
        }

        /* Template Stats Grid */
        .template-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .template-stat {
            text-align: center;
        }

        .template-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .template-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Template Quick Actions */
        .template-quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .template-quick-action {
            padding: 0.25rem 0.5rem;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .template-quick-action:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Question Builder Animations */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .template-question-item {
            animation: slideDown 0.3s ease-out;
        }

        /* Drag and Drop Styles (for future implementation) */
        .question-dragging {
            opacity: 0.5;
        }

        .question-drag-over {
            border-top: 3px solid var(--primary-color);
        }

        /* Template Info Box */
        .template-info-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .template-info-box h3 {
            margin: 0 0 0.5rem 0;
        }

        .template-info-box p {
            margin: 0;
            opacity: 0.95;
        }

        /* Question Type Icons */
        .question-type-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }

        /* Template Category Colors */
        .template-category-general {
            background: #6b7280;
        }

        .template-category-satisfaction {
            background: #10b981;
        }

        .template-category-employee {
            background: #3b82f6;
        }

        .template-category-product {
            background: #8b5cf6;
        }

        .template-category-service {
            background: #f59e0b;
        }

        .template-category-event {
            background: #ec4899;
        }

        .template-category-custom {
            background: #14b8a6;
        }

        /* Template List View */
        .template-list-view {
            display: grid;
            gap: 1rem;
        }

        .template-grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        /* Template Search Bar */
        .template-search {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .template-search input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        .template-search button {
            padding: 0.5rem 1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        /* Responsive Design for Templates */
        @media (max-width: 768px) {
            .template-stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .template-grid-view {
                grid-template-columns: 1fr;
            }
            
            .chat-preview-message.bot {
                margin-right: 0;
            }
            
            .chat-preview-message.user {
                margin-left: 0;
            }
        }
        /* END TEMPLATE BUILDER STYLES */
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-container" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="logo">
                    <div class="logo-icon has-default">R</div>
                    <span>Realworld</span>
                </div>
                <h2 data-translate="sign-in-title">Sign In to Your Account</h2>
                <p data-translate="sign-in-description">Enter your credentials to access the employee survey platform</p>
            </div>

            <form id="login-form" class="login-form">
                <div class="form-group">
                    <label class="form-label" for="email" data-translate="email-address">Email Address</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email"
                        class="form-input" 
                        required 
                        autocomplete="email"
                        placeholder="Enter your email address"
                        data-translate-placeholder="email-placeholder"
                        value=""
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="password" data-translate="password">Password</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password"
                        class="form-input" 
                        required 
                        autocomplete="current-password"
                        placeholder="Enter your password"
                        data-translate-placeholder="password-placeholder"
                        value=""
                    >
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="remember-me">
                        <span class="checkmark"></span>
                        <span data-translate="remember-me">Remember me</span>
                    </label>
                </div>

                <button type="submit" class="btn btn-primary btn-full-width" id="login-btn" data-translate="sign-in">
                    Sign In
                </button>

                <div class="login-divider">
                    <span data-translate="or-continue-with">or continue with</span>
                </div>

                <div class="social-login">
                    <button type="button" class="btn-social" onclick="handleSocialLogin('google')">
                        <span>üîç</span>
                        Google
                    </button>
                    <button type="button" class="btn-social" onclick="handleSocialLogin('microsoft')">
                        <span>ü™ü</span>
                        Microsoft
                    </button>
                </div>

                <div style="text-align: center; margin-top: 1rem;">
                    <a href="#" onclick="showForgotPassword()" style="color: var(--primary-color); text-decoration: none; font-size: 0.875rem;" data-translate="forgot-password">Forgot your password?</a>
                </div>
            </form>

            <!-- Quick Login Buttons for Testing -->
            <div class="quick-login">
                <h4 data-translate="quick-login-testing">Quick Login (Testing)</h4>
                <button type="button" class="btn btn-secondary btn-sm" onclick="quickLogin('master')" style="margin-right: 0.5rem; margin-bottom: 0.5rem;" data-translate="login-master-admin">
                    Login as Master Admin
                </button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="quickLogin('client1')" style="margin-right: 0.5rem; margin-bottom: 0.5rem;" data-translate="login-sarah-techcorp">
                    Login as Sarah (TechCorp)
                </button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="quickLogin('client2')" style="margin-bottom: 0.5rem;" data-translate="login-mike-startupx">
                    Login as Mike (StartupX)
                </button>
            </div>

            <div class="demo-credentials">
                <h4 data-translate="demo-credentials">Demo Credentials</h4>
                <div class="demo-account" onclick="fillCredentials('paul.everitt@rworld.co.uk', 'Doughball8987!')">
                    <strong data-translate="master-administrator">Master Administrator:</strong><br>
                    Email: paul.everitt@rworld.co.uk<br>
                    Password: Doughball8987!
                </div>
                <div class="demo-account" onclick="fillCredentials('sarah@techcorp.com', 'demo123')">
                    <strong data-translate="client-user-techcorp">Client User (TechCorp):</strong><br>
                    Email: sarah@techcorp.com<br>
                    Password: demo123
                </div>
                <div class="demo-account" onclick="fillCredentials('mike@startupx.com', 'demo123')">
                    <strong data-translate="client-user-startupx">Client User (StartupX):</strong><br>
                    Email: mike@startupx.com<br>
                    Password: demo123
                </div>
            </div>
        </div>
    </div>

    <div class="app-container hidden" id="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <div class="logo-icon has-default">R</div>
                Realworld
            </div>

            <nav>
                <div class="nav-section" id="master-admin-section">
                    <div class="nav-title" data-translate="master-admin">Master Admin</div>
                    <div class="nav-item active" onclick="showSection('dashboard')">
                        <div class="nav-icon">üìä</div>
                        <span data-translate="dashboard">Dashboard</span>
                    </div>
                    <div class="nav-item" onclick="showSection('organizations')">
                        <div class="nav-icon">üè¢</div>
                        <span data-translate="organizations">Organizations</span>
                    </div>
                    <div class="nav-item" onclick="showSection('users')">
                        <div class="nav-icon">üë•</div>
                        <span data-translate="users">User Management</span>
                    </div>
                    <div class="nav-item" onclick="showSection('branding')">
                        <div class="nav-icon">üé®</div>
                        <span data-translate="branding">Branding</span>
                    </div>
                </div>

                <div class="nav-section" id="start-listening-section">
                    <div class="nav-title" data-translate="start-listening">Start Listening</div>
                    <div class="nav-item" onclick="showSection('chat-feedback')">
                        <div class="nav-icon">üí¨</div>
                        <span data-translate="chat-feedback">Analytics</span>
                    </div>
                    <div class="nav-item" onclick="showSection('chat-management')">
                        <div class="nav-icon">üí¨</div>
                        <span data-translate="chat-management">Chat Management</span>
                    </div>
                    <div class="nav-item" onclick="showSection('chat-reports')">
                        <div class="nav-icon">üìã</div>
                        <span data-translate="ai-reports">AI Reports</span>
                    </div>
                </div>

                <div class="nav-section" id="keep-listening-section">
                    <div class="nav-title" data-translate="keep-listening">Keep Listening</div>
                    <div class="nav-item" onclick="showSection('survey-builder')">
                        <div class="nav-icon">üìù</div>
                        <span data-translate="survey-builder">Survey Builder</span>
                    </div>
                    <div class="nav-item" onclick="showSection('survey-analytics')">
                        <div class="nav-icon">üìä</div>
                        <span data-translate="survey-analytics">Survey Analytics</span>
                    </div>
                    <div class="nav-item" onclick="showSection('participants')">
                        <div class="nav-icon">üë§</div>
                        <span data-translate="participants">Participants</span>
                    </div>
                    <div class="nav-item" onclick="showSection('data-management')">
                        <div class="nav-icon">üìä</div>
                        <span data-translate="data-management">Data Management</span>
                    </div>
                    <div class="nav-item" onclick="showSection('ai-data-chat')">
                        <div class="nav-icon">ü§ñ</div>
                        <span data-translate="ai-data-chat">AI Data Chat</span>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()" aria-label="Toggle Navigation Menu">
                        ‚ò∞
                    </button>
                    
                    <!-- Language Selector -->
                    <div class="language-selector">
                        <button class="language-btn" onclick="toggleLanguageDropdown()" id="language-btn">
                            <span class="language-flag" id="current-flag">üá¨üáß</span>
                            <span id="current-language">English</span>
                            <span>‚ñº</span>
                        </button>
                        <div class="language-dropdown" id="language-dropdown">
                            <div class="language-option selected" onclick="changeLanguage('en')" data-lang="en">
                                <span class="language-flag">üá¨üáß</span>
                                <div class="language-info">
                                    <div class="language-name">English</div>
                                    <div class="language-native">English</div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('es')" data-lang="es">
                                <span class="language-flag">üá™üá∏</span>
                                <div class="language-info">
                                    <div class="language-name">Spanish</div>
                                    <div class="language-native">Espa√±ol</div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('fr')" data-lang="fr">
                                <span class="language-flag">üá´üá∑</span>
                                <div class="language-info">
                                    <div class="language-name">French</div>
                                    <div class="language-native">Fran√ßais</div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('de')" data-lang="de">
                                <span class="language-flag">üá©üá™</span>
                                <div class="language-info">
                                    <div class="language-name">German</div>
                                    <div class="language-native">Deutsch</div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('it')" data-lang="it">
                                <span class="language-flag">üáÆüáπ</span>
                                <div class="language-info">
                                    <div class="language-name">Italian</div>
                                    <div class="language-native">Italiano</div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('pt')" data-lang="pt">
                                <span class="language-flag">üáµüáπ</span>
                                <div class="language-info">
                                    <div class="language-name">Portuguese</div>
                                    <div class="language-native">Portugu√™s</div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('nl')" data-lang="nl">
                                <span class="language-flag">üá≥üá±</span>
                                <div class="language-info">
                                    <div class="language-name">Dutch</div>
                                    <div class="language-native">Nederlands</div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('zh')" data-lang="zh">
                                <span class="language-flag">üá®üá≥</span>
                                <div class="language-info">
                                    <div class="language-name">Chinese</div>
                                    <div class="language-native">‰∏≠Êñá</div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('ja')" data-lang="ja">
                                <span class="language-flag">üáØüáµ</span>
                                <div class="language-info">
                                    <div class="language-name">Japanese</div>
                                    <div class="language-native">Êó•Êú¨Ë™û</div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('ko')" data-lang="ko">
                                <span class="language-flag">üá∞üá∑</span>
                                <div class="language-info">
                                    <div class="language-name">Korean</div>
                                    <div class="language-native">ÌïúÍµ≠Ïñ¥</div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('ar')" data-lang="ar">
                                <span class="language-flag">üá∏üá¶</span>
                                <div class="language-info">
                                    <div class="language-name">Arabic</div>
                                    <div class="language-native">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('ru')" data-lang="ru">
                                <span class="language-flag">üá∑üá∫</span>
                                <div class="language-info">
                                    <div class="language-name">Russian</div>
                                    <div class="language-native">–†—É—Å—Å–∫–∏–π</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h1 class="breadcrumb" id="breadcrumb" data-translate="dashboard">Dashboard</h1>
                </div>
                <div class="header-right">
                    <div class="user-menu">
                        <div class="user-info" onclick="toggleUserMenu()" id="user-info">
                            <div class="user-avatar" id="user-avatar">PE</div>
                            <div>
                                <div style="font-weight: 500;" id="user-name">Paul Everitt</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);" id="user-role">
                                    Master Administrator
                                    <span class="user-role-badge master-admin" id="user-role-badge">MASTER</span>
                                </div>
                            </div>
                        </div>
                        <div class="user-dropdown" id="user-dropdown">
                            <div class="user-dropdown-item" onclick="showProfile()">
                                <span>üë§</span> <span data-translate="profile-settings">Profile Settings</span>
                            </div>
                            <div class="user-dropdown-item" onclick="showOrganizationSettings()">
                                <span>üè¢</span> <span data-translate="organization-settings">Organization Settings</span>
                            </div>
                            <div class="user-dropdown-item" onclick="showSecuritySettings()">
                                <span>üîí</span> <span data-translate="security">Security</span>
                            </div>
                            <div class="user-dropdown-item" onclick="showHelp()">
                                <span>‚ùì</span> <span data-translate="help-support">Help & Support</span>
                            </div>
                            <div class="user-dropdown-item" onclick="handleLogout()" style="color: var(--danger-color); border-top: 1px solid var(--border-color);">
                                <span>üö™</span> <span data-translate="sign-out">Sign Out</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="content-area" id="content-area">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="fade-in">
                    <div class="dashboard-grid">
                        <div class="stat-card" onclick="showStatDetails('organizations', '47')">
                            <div class="stat-value">47</div>
                            <div class="stat-label" data-translate="active-organizations">Active Organizations</div>
                        </div>
                        <div class="stat-card" onclick="showStatDetails('users', '1,247')">
                            <div class="stat-value">1,247</div>
                            <div class="stat-label" data-translate="total-users">Total Users</div>
                        </div>
                        <div class="stat-card" onclick="showStatDetails('surveys', '89')">
                            <div class="stat-value">89</div>
                            <div class="stat-label" data-translate="active-surveys">Active Surveys</div>
                        </div>
                        <div class="stat-card" onclick="showStatDetails('responses', '15,632')">
                            <div class="stat-value">15,632</div>
                            <div class="stat-label" data-translate="total-responses">Total Responses</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title" data-translate="recent-activity">Recent Activity</h2>
                            <button class="btn btn-secondary" onclick="handleViewAll()" data-translate="view-all">View All</button>
                        </div>
                        <table class="table" id="activity-table">
                            <thead>
                                <tr>
                                    <th onclick="sortTable(this, 0)" data-translate="organization">Organization</th>
                                    <th onclick="sortTable(this, 1)" data-translate="activity">Activity</th>
                                    <th onclick="sortTable(this, 2)" data-translate="user">User</th>
                                    <th onclick="sortTable(this, 3)" data-translate="time">Time</th>
                                </tr>
                            </thead>
                            <tbody id="activity-table-body">
                                <!-- Recent activity will be loaded from database -->
                                <tr style="text-align: center; color: var(--text-secondary);">
                                    <td colspan="4">No recent activity. Activity will appear here as users interact with your surveys.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Quick Actions Card -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Quick Actions</h2>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <button class="btn btn-primary" onclick="showCreateOrganizationModal()" style="padding: 1rem;">
                                <div>üè¢</div>
                                <div data-translate="add-organization">Add Organization</div>
                            </button>
                            <button class="btn btn-success" onclick="createNewChat()" style="padding: 1rem;">
                                <div>üí¨</div>
                                <div data-translate="create-new-chat">Create Chat</div>
                            </button>
                            <button class="btn btn-secondary" onclick="showSection('survey-builder')" style="padding: 1rem;">
                                <div>üìù</div>
                                <div>Build Survey</div>
                            </button>
                            <button class="btn btn-warning" onclick="generateNewReport()" style="padding: 1rem;">
                                <div>üìä</div>
                                <div>Generate Report</div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Organizations Section -->
                <div id="organizations-section" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title" data-translate="organizations">Organizations</h2>
                            <div>
                                <button class="btn btn-secondary" onclick="handleExportData('organizations')">Export</button>
                                <button class="btn btn-primary" onclick="showCreateOrganizationModal()" data-translate="add-organization">
                                    Add Organization
                                </button>
                            </div>
                        </div>

                        <div class="filters">
                            <div class="filter-group">
                                <label class="filter-label">Search</label>
                                <input type="text" class="form-input" placeholder="Search organizations..." 
                                       style="min-width: 200px;" oninput="filterOrganizations('search', this.value)">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label" data-translate="plan">Plan</label>
                                <select class="form-select" style="min-width: 150px;" onchange="filterOrganizations('plan', this.value)">
                                    <option value="">All Plans</option>
                                    <option value="start">Start Listening</option>
                                    <option value="keep">Keep Listening</option>
                                    <option value="both">Start + Keep</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label" data-translate="status">Status</label>
                                <select class="form-select" style="min-width: 120px;" onchange="filterOrganizations('status', this.value)">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="suspended">Suspended</option>
                                    <option value="trial">Trial</option>
                                </select>
                            </div>
                        </div>

                        <table class="table" id="organizations-table">
                            <thead>
                                <tr>
                                    <th onclick="sortTable(this, 0)" data-translate="organization-name">Organization Name</th>
                                    <th onclick="sortTable(this, 1)" data-translate="plan">Plan</th>
                                    <th onclick="sortTable(this, 2)" data-translate="users">Users</th>
                                    <th onclick="sortTable(this, 3)" data-translate="status">Status</th>
                                    <th onclick="sortTable(this, 4)">Last Activity</th>
                                    <th data-translate="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="organizations-table-body">
                                <!-- Organizations will be loaded from database -->
                                <tr style="text-align: center; color: var(--text-secondary);">
                                    <td colspan="6">No organizations found. Click 'Add Organization' to create your first organization.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="users-section" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title" data-translate="users">User Management</h2>
                            <div>
                                <button class="btn btn-secondary" onclick="handleBulkAction('users')">Bulk Actions</button>
                                <button class="btn btn-secondary" onclick="handleExportData('users')">Export</button>
                                <button class="btn btn-primary" onclick="showCreateUserModal()" data-translate="add-user">
                                    Add User
                                </button>
                            </div>
                        </div>

                        <div class="filters">
                            <div class="filter-group">
                                <label class="filter-label">Search</label>
                                <input type="text" class="form-input" placeholder="Search users..." 
                                       style="min-width: 200px;" oninput="filterUsers('search', this.value)">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label" data-translate="organization">Organization</label>
                                <select class="form-select" style="min-width: 150px;" onchange="filterUsers('organization', this.value)" id="organization-filter">
                                    <option value="">All Organizations</option>
                                    <!-- Organization options will be populated from database -->
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Role</label>
                                <select class="form-select" style="min-width: 120px;" onchange="filterUsers('role', this.value)">
                                    <option value="">All Roles</option>
                                    <option value="admin">Admin</option>
                                    <option value="user">User</option>
                                    <option value="viewer">Viewer</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label" data-translate="status">Status</label>
                                <select class="form-select" style="min-width: 120px;" onchange="filterUsers('status', this.value)">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="pending">Pending</option>
                                </select>
                            </div>
                        </div>

                        <table class="table" id="users-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" onclick="toggleSelectAll(this, 'users')"></th>
                                    <th onclick="sortTable(this, 1)" data-translate="name">Name</th>
                                    <th onclick="sortTable(this, 2)" data-translate="email">Email</th>
                                    <th onclick="sortTable(this, 3)" data-translate="organization">Organization</th>
                                    <th onclick="sortTable(this, 4)" data-translate="access">Access</th>
                                    <th onclick="sortTable(this, 5)" data-translate="status">Status</th>
                                    <th onclick="sortTable(this, 6)">Last Login</th>
                                    <th data-translate="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- Users will be loaded from database -->
                                <tr style="text-align: center; color: var(--text-secondary);">
                                    <td colspan="8">No users found. Click 'Add User' to invite your first user.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Branding Section -->
                <div id="branding-section" class="hidden">
                    <div class="card">
                        <div class="card-header">
                           <h2 class="card-title">Branding & Customization</h2>
                        <div>
                      <button class="btn btn-secondary" onclick="resetBranding()" style="margin-right: 0.5rem;">Reset to Defaults</button>
                          <button class="btn btn-primary" onclick="saveBranding()">Save Changes</button>
                               </div>
                            </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div>
                                <div class="form-group">
                                    <label class="form-label">Company Name</label>
                                    <input type="text" id="brand-company-name" class="form-input" value="Realworld" placeholder="Your Company Name">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Primary Color</label>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <input type="color" id="brand-primary-color" value="#2563eb" style="width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                                        <input type="text" class="form-input" value="#2563eb" style="flex: 1;">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Secondary Color</label>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <input type="color" id="brand-secondary-color" value="#64748b" style="width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                                        <input type="text" class="form-input" value="#64748b" style="flex: 1;">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Font Family</label>
                                    <select id="brand-font" class="form-select">
                                        <option value="system">System Default</option>
                                        <option value="inter">Inter</option>
                                        <option value="roboto">Roboto</option>
                                        <option value="open-sans">Open Sans</option>
                                        <option value="lato">Lato</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <div class="form-group">
                                    <label class="form-label">Logo Upload</label>
                                    <div class="file-upload-area" onclick="document.getElementById('logo-upload').click()">
                                        <input type="file" id="logo-upload" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                                        <div>
                                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìé</div>
                                            <div><strong>Click to upload logo</strong></div>
                                            <div style="color: var(--text-secondary); margin-top: 0.5rem;">PNG, JPG up to 2MB</div>
                                            <div style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.5rem;">
                                                üí° Tip: Use a transparent PNG for best results
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Welcome Message</label>
                            <textarea id="brand-welcome-message" class="form-input" rows="3" placeholder="Welcome! Your feedback helps us improve...">Welcome! Your feedback helps us improve and create a better workplace for everyone.</textarea>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h4>Preview</h4>
                            </div>
                            <div id="brand-preview" style="padding: 2rem; border: 2px dashed var(--border-color); border-radius: 8px; text-align: center; background: var(--bg-secondary);">
                                <div style="font-size: 2rem; font-weight: bold; color: var(--primary-color); margin-bottom: 1rem;">Realworld</div>
                                <div style="color: var(--text-secondary);">Welcome! Your feedback helps us improve and create a better workplace for everyone.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Section (formerly Chat Feedback) -->
                <div id="chat-feedback-section" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Analytics</h2>
                            <div>
                                <button class="btn btn-secondary" onclick="showFeedbackSettings()">‚öôÔ∏è Settings</button>
                                <button class="btn btn-primary" onclick="generateFeedbackReport()">üìä Generate Report</button>
                            </div>
                        </div>
                        
                        <!-- Enhanced Statistics Dashboard -->
                        <div class="dashboard-grid">
                            <div class="stat-card">
                                <div class="stat-value">1,847</div>
                                <div class="stat-label">Total Chat Sessions</div>
                                <div style="font-size: 0.75rem; color: var(--success-color); margin-top: 0.5rem;">‚Üë 12% from last week</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">4.8</div>
                                <div class="stat-label">Average Rating</div>
                                <div style="display: flex; gap: 0.25rem; margin-top: 0.5rem;">
                                    <span>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">92%</div>
                                <div class="stat-label">Response Rate</div>
                                <div style="font-size: 0.75rem; color: var(--warning-color); margin-top: 0.5rem;">‚Üì 3% from last week</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">156</div>
                                <div class="stat-label">This Week</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">23 pending review</div>
                            </div>
                        </div>

                        <!-- Performance Metrics from Analytics -->
                        <div class="dashboard-grid">
                            <div class="stat-card">
                                <div class="stat-value">89%</div>
                                <div class="stat-label">Completion Rate</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">2m 15s</div>
                                <div class="stat-label">Avg. Session Duration</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">4.6/5</div>
                                <div class="stat-label">Quality Score</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">+23%</div>
                                <div class="stat-label">Growth vs Last Month</div>
                            </div>
                        </div>

                        <!-- Sentiment Overview -->
                        <div class="card" style="margin-bottom: 1.5rem;">
                            <div class="card-header">
                                <h4>Sentiment Analysis Overview</h4>
                                <select class="form-select" style="width: 150px;" onchange="updateSentimentView(this.value)">
                                    <option value="today">Today</option>
                                    <option value="week" selected>This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                                </select>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                <div style="text-align: center; padding: 1rem; background: #dcfce7; border-radius: 8px;">
                                    <div style="font-size: 2rem;">üòä</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #166534;">68%</div>
                                    <div style="color: #166534;">Positive</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: #fef3c7; border-radius: 8px;">
                                    <div style="font-size: 2rem;">üòê</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #92400e;">24%</div>
                                    <div style="color: #92400e;">Neutral</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: #fee2e2; border-radius: 8px;">
                                    <div style="font-size: 2rem;">üòû</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #991b1b;">8%</div>
                                    <div style="color: #991b1b;">Negative</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: #f3f4f6; border-radius: 8px;">
                                    <div style="font-size: 2rem;">üéØ</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">89%</div>
                                    <div style="color: var(--text-secondary);">Resolution Rate</div>
                                </div>
                            </div>
                        </div>

                        <!-- Analytics Charts Section -->
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-bottom: 1.5rem;">
                            <div class="card">
                                <div class="card-header">
                                    <h4>Response Trends</h4>
                                    <select class="form-select" style="width: 150px;">
                                        <option>Last 30 days</option>
                                        <option>Last 7 days</option>
                                        <option>Last 90 days</option>
                                        <option>Custom range</option>
                                    </select>
                                </div>
                                <div class="chart-placeholder">
                                    üìà Interactive chart showing response trends over time
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h4>Sentiment Breakdown</h4>
                                </div>
                                <div style="display: grid; gap: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>üòä Positive</span>
                                        <div style="flex: 1; margin: 0 1rem; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                            <div style="width: 68%; height: 100%; background: #10b981;"></div>
                                        </div>
                                        <span><strong>68%</strong></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>üòê Neutral</span>
                                        <div style="flex: 1; margin: 0 1rem; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                            <div style="width: 24%; height: 100%; background: #f59e0b;"></div>
                                        </div>
                                        <span><strong>24%</strong></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>üòû Negative</span>
                                        <div style="flex: 1; margin: 0 1rem; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                            <div style="width: 8%; height: 100%; background: #ef4444;"></div>
                                        </div>
                                        <span><strong>8%</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Filters and Actions -->
                        <div class="card">
                            <div class="card-header">
                                <h4>Feedback Management</h4>
                                <div class="view-toggle">
                                    <button class="active" onclick="switchFeedbackView('table')">üìã Table</button>
                                    <button onclick="switchFeedbackView('cards')">üé¥ Cards</button>
                                    <button onclick="switchFeedbackView('timeline')">üìÖ Timeline</button>
                                </div>
                            </div>
                            
                            <!-- Advanced Filters -->
                            <div class="filters" style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                                <div class="filter-group">
                                    <label class="filter-label">Search</label>
                                    <input type="text" class="form-input" placeholder="Search feedback..." 
                                           style="min-width: 200px;" oninput="filterFeedback('search', this.value)">
                                </div>
                                <div class="filter-group">
                                    <label class="filter-label">Date Range</label>
                                    <select class="form-select" onchange="filterFeedback('date', this.value)">
                                        <option value="all">All Time</option>
                                        <option value="today">Today</option>
                                        <option value="week" selected>This Week</option>
                                        <option value="month">This Month</option>
                                        <option value="custom">Custom Range</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="filter-label">Sentiment</label>
                                    <select class="form-select" onchange="filterFeedback('sentiment', this.value)">
                                        <option value="">All Sentiments</option>
                                        <option value="positive">üòä Positive</option>
                                        <option value="neutral">üòê Neutral</option>
                                        <option value="negative">üòû Negative</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="filter-label">Priority</label>
                                    <select class="form-select" onchange="filterFeedback('priority', this.value)">
                                        <option value="">All Priorities</option>
                                        <option value="high">üî¥ High</option>
                                        <option value="medium">üü° Medium</option>
                                        <option value="low">üü¢ Low</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="filter-label">Status</label>
                                    <select class="form-select" onchange="filterFeedback('status', this.value)">
                                        <option value="">All Status</option>
                                        <option value="new">New</option>
                                        <option value="pending">Pending Review</option>
                                        <option value="reviewed">Reviewed</option>
                                        <option value="resolved">Resolved</option>
                                        <option value="archived">Archived</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="filter-label">Tags</label>
                                    <select class="form-select" onchange="filterFeedback('tags', this.value)">
                                        <option value="">All Tags</option>
                                        <option value="product">Product</option>
                                        <option value="service">Service</option>
                                        <option value="support">Support</option>
                                        <option value="pricing">Pricing</option>
                                        <option value="feature">Feature Request</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Bulk Actions Toolbar -->
                            <div class="feedback-toolbar">
                                <button class="btn btn-secondary btn-sm" onclick="selectAllFeedback()">
                                    <input type="checkbox" id="select-all-feedback" style="margin-right: 0.5rem;">
                                    Select All
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="markAsReviewed()">‚úì Mark Reviewed</button>
                                <button class="btn btn-success btn-sm" onclick="markAsResolved()">‚úì Mark Resolved</button>
                                <button class="btn btn-warning btn-sm" onclick="assignToTeam()">üë• Assign</button>
                                <button class="btn btn-secondary btn-sm" onclick="addTags()">üè∑Ô∏è Add Tags</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportSelectedFeedback()">üì• Export Selected</button>
                                <button class="btn btn-danger btn-sm" onclick="archiveSelected()">üìÅ Archive</button>
                            </div>

                            <!-- Enhanced Table View -->
                            <div id="feedback-table-view">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" onclick="toggleSelectAll(this, 'feedback')"></th>
                                            <th onclick="sortTable(this, 1)">Date/Time</th>
                                            <th onclick="sortTable(this, 2)">User</th>
                                            <th onclick="sortTable(this, 3)">Message</th>
                                            <th onclick="sortTable(this, 4)">Rating</th>
                                            <th onclick="sortTable(this, 5)">Sentiment</th>
                                            <th onclick="sortTable(this, 6)">Priority</th>
                                            <th onclick="sortTable(this, 7)">Category</th>
                                            <th onclick="sortTable(this, 8)">Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><input type="checkbox"></td>
                                            <td>Dec 15, 2024<br><small>14:32</small></td>
                                            <td>
                                                <strong>Anonymous User</strong><br>
                                                <small style="color: var(--text-secondary);">Widget: Footer</small>
                                            </td>
                                            <td style="max-width: 300px;">
                                                "The new feature is amazing! It saves me so much time in my daily workflow."
                                                <div style="margin-top: 0.5rem;">
                                                    <span class="keyword-tag">feature</span>
                                                    <span class="keyword-tag">workflow</span>
                                                </div>
                                            </td>
                                            <td>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</td>
                                            <td><span class="sentiment-badge sentiment-positive">üòä Positive</span></td>
                                            <td><span class="tag tag-active">Low</span></td>
                                            <td><span class="tag tag-active">Product</span></td>
                                            <td><span class="tag tag-active">Reviewed</span></td>
                                            <td>
                                                <div style="display: flex; gap: 0.25rem;">
                                                    <button class="action-btn" onclick="viewFeedbackDetails(1)" title="View Details">üëÅÔ∏è</button>
                                                    <button class="action-btn" onclick="replyToFeedback(1)" title="Reply">üí¨</button>
                                                    <button class="action-btn" onclick="assignFeedback(1)" title="Assign">üë§</button>
                                                    <button class="action-btn" onclick="archiveFeedback(1)" title="Archive">üìÅ</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="checkbox"></td>
                                            <td>Dec 15, 2024<br><small>13:15</small></td>
                                            <td>
                                                <strong>John D.</strong><br>
                                                <small style="color: var(--text-secondary);">john.d@email.com</small>
                                            </td>
                                            <td style="max-width: 300px;">
                                                "Support response time could be better. Waited 2 hours for a simple query."
                                                <div style="margin-top: 0.5rem;">
                                                    <span class="keyword-tag">support</span>
                                                    <span class="keyword-tag">response time</span>
                                                </div>
                                            </td>
                                            <td>‚≠ê‚≠ê‚≠ê‚≠ê</td>
                                            <td><span class="sentiment-badge sentiment-neutral">üòê Neutral</span></td>
                                            <td><span class="tag tag-warning">Medium</span></td>
                                            <td><span class="tag tag-processing">Support</span></td>
                                            <td><span class="tag tag-pending">Pending</span></td>
                                            <td>
                                                <div style="display: flex; gap: 0.25rem;">
                                                    <button class="action-btn" onclick="viewFeedbackDetails(2)" title="View Details">üëÅÔ∏è</button>
                                                    <button class="action-btn" onclick="replyToFeedback(2)" title="Reply">üí¨</button>
                                                    <button class="action-btn" onclick="assignFeedback(2)" title="Assign">üë§</button>
                                                    <button class="action-btn" onclick="archiveFeedback(2)" title="Archive">üìÅ</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="checkbox"></td>
                                            <td>Dec 15, 2024<br><small>11:45</small></td>
                                            <td>
                                                <strong>Emily R.</strong><br>
                                                <small style="color: var(--text-secondary);">Chat Widget</small>
                                            </td>
                                            <td style="max-width: 300px;">
                                                "Login issues persist. Cannot access my dashboard. This is urgent!"
                                                <div style="margin-top: 0.5rem;">
                                                    <span class="keyword-tag">bug</span>
                                                    <span class="keyword-tag">urgent</span>
                                                    <span class="keyword-tag">login</span>
                                                </div>
                                                <div class="response-box">
                                                    <small><strong>Team Response:</strong> We're investigating this issue. Ticket #2847 created.</small>
                                                </div>
                                            </td>
                                            <td>‚≠ê‚≠ê</td>
                                            <td><span class="sentiment-badge sentiment-negative">üòû Negative</span></td>
                                            <td><span class="tag tag-danger">High</span></td>
                                            <td><span class="tag tag-danger">Technical</span></td>
                                            <td><span class="tag tag-processing">In Progress</span></td>
                                            <td>
                                                <div style="display: flex; gap: 0.25rem;">
                                                    <button class="action-btn" onclick="viewFeedbackDetails(3)" title="View Details">üëÅÔ∏è</button>
                                                    <button class="action-btn" onclick="replyToFeedback(3)" title="Reply">üí¨</button>
                                                    <button class="action-btn" onclick="assignFeedback(3)" title="Assign">üë§</button>
                                                    <button class="action-btn" onclick="escalateFeedback(3)" title="Escalate">‚ö†Ô∏è</button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>

                                <!-- Pagination -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                                    <div style="color: var(--text-secondary);">
                                        Showing 1-10 of 1,847 feedback entries
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-secondary btn-sm">‚Üê Previous</button>
                                        <button class="btn btn-secondary btn-sm active">1</button>
                                        <button class="btn btn-secondary btn-sm">2</button>
                                        <button class="btn btn-secondary btn-sm">3</button>
                                        <button class="btn btn-secondary btn-sm">...</button>
                                        <button class="btn btn-secondary btn-sm">185</button>
                                        <button class="btn btn-secondary btn-sm">Next ‚Üí</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Card View (Hidden by default) -->
                            <div id="feedback-cards-view" style="display: none;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1rem;">
                                    <!-- Sample Feedback Cards -->
                                    <div class="feedback-item">
                                        <div class="priority-indicator priority-low"></div>
                                        <div class="feedback-header">
                                            <div>
                                                <strong>Anonymous User</strong><br>
                                                <small style="color: var(--text-secondary);">Dec 15, 2024 ‚Ä¢ 14:32</small>
                                            </div>
                                            <div>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                                        </div>
                                        <p style="margin: 1rem 0;">"The new feature is amazing! It saves me so much time in my daily workflow."</p>
                                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                            <span class="sentiment-badge sentiment-positive">üòä Positive</span>
                                            <span class="tag tag-active">Product</span>
                                            <span class="tag tag-active">Reviewed</span>
                                        </div>
                                        <div class="feedback-actions" style="margin-top: 1rem;">
                                            <button class="action-btn">View</button>
                                            <button class="action-btn">Reply</button>
                                            <button class="action-btn">Archive</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Top Keywords/Topics -->
                        <div class="card">
                            <div class="card-header">
                                <h4>Trending Topics This Week</h4>
                                <button class="btn btn-secondary btn-sm" onclick="viewAllTopics()">View All</button>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <span style="padding: 0.5rem 1rem; background: var(--primary-color); color: white; border-radius: 20px; font-size: 0.875rem;">
                                    feature request (47)
                                </span>
                                <span style="padding: 0.5rem 1rem; background: var(--primary-color); color: white; border-radius: 20px; font-size: 0.875rem; opacity: 0.9;">
                                    user interface (32)
                                </span>
                                <span style="padding: 0.5rem 1rem; background: var(--primary-color); color: white; border-radius: 20px; font-size: 0.875rem; opacity: 0.8;">
                                    performance (28)
                                </span>
                                <span style="padding: 0.5rem 1rem; background: var(--primary-color); color: white; border-radius: 20px; font-size: 0.875rem; opacity: 0.7;">
                                    support (24)
                                </span>
                                <span style="padding: 0.5rem 1rem; background: var(--primary-color); color: white; border-radius: 20px; font-size: 0.875rem; opacity: 0.6;">
                                    pricing (19)
                                </span>
                                <span style="padding: 0.5rem 1rem; background: var(--primary-color); color: white; border-radius: 20px; font-size: 0.875rem; opacity: 0.5;">
                                    documentation (15)
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Management Section -->
                <div id="chat-management-section" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Chat Management</h2>
                            <div>
                                <button class="btn btn-secondary" onclick="manageChatSettings()">Settings</button>
                                <button class="btn btn-primary" onclick="createNewChatWidget()">Create Chat Widget</button>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h4>Active Chats</h4>
                                <small style="color: var(--text-secondary);">Currently active chat sessions</small>
                            </div>
                            
                            <!-- Empty state for now -->
                            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                                <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;">üí¨</div>
                                <h3 style="margin-bottom: 0.5rem;">No Active Chats</h3>
                                <p style="margin-bottom: 2rem;">Active chat sessions will appear here when users start conversations.</p>
                                <button class="btn btn-primary" onclick="createNewChatWidget()">Create Your First Chat Widget</button>
                            </div>
                            
                            <!-- This is where active chats will be listed when they exist -->
                            <div id="active-chats-list" style="display: none;">
                                <!-- Chat items will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Reports Section -->
                <div id="chat-reports-section" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">AI Reports</h2>
                            <button class="btn btn-primary" onclick="generateAIReport()">Generate New Report</button>
                        </div>

                        <div class="dashboard-grid">
                            <div class="stat-card">
                                <div class="stat-value">15</div>
                                <div class="stat-label">Reports Generated</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">847</div>
                                <div class="stat-label">Data Points Analyzed</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">23</div>
                                <div class="stat-label">Insights Discovered</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">94%</div>
                                <div class="stat-label">Accuracy Score</div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h4>Recent AI Reports</h4>
                            </div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Report Name</th>
                                        <th>Generated</th>
                                        <th>Data Source</th>
                                        <th>Insights</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Monthly Sentiment Analysis</strong></td>
                                        <td>Dec 15, 2024</td>
                                        <td>Chat Feedback</td>
                                        <td><span class="tag tag-active">12 insights</span></td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm">View</button>
                                            <button class="btn btn-primary btn-sm">Download</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>User Experience Trends</strong></td>
                                        <td>Dec 12, 2024</td>
                                        <td>All Channels</td>
                                        <td><span class="tag tag-processing">8 insights</span></td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm">View</button>
                                            <button class="btn btn-primary btn-sm">Download</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Survey Builder Section -->
                <div id="survey-builder-section" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Survey Builder</h2>
                            <button class="btn btn-primary" onclick="createNewSurvey()">Create New Survey</button>
                        </div>

                        <div class="dashboard-grid">
                            <div class="stat-card">
                                <div class="stat-value">23</div>
                                <div class="stat-label">Active Surveys</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">156</div>
                                <div class="stat-label">Total Surveys</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">2,847</div>
                                <div class="stat-label">Total Responses</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">78%</div>
                                <div class="stat-label">Completion Rate</div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h4>My Surveys</h4>
                                <div>
                                    <select class="form-select" style="margin-right: 1rem;">
                                        <option>All Surveys</option>
                                        <option>Active</option>
                                        <option>Draft</option>
                                        <option>Completed</option>
                                    </select>
                                    <button class="btn btn-secondary">Templates</button>
                                </div>
                            </div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Survey Name</th>
                                        <th>Status</th>
                                        <th>Responses</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Q4 Employee Satisfaction</strong></td>
                                        <td><span class="tag tag-active">Active</span></td>
                                        <td>127/200</td>
                                        <td>Dec 1, 2024</td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm">Edit</button>
                                            <button class="btn btn-primary btn-sm">Results</button>
                                            <button class="btn btn-warning btn-sm">Share</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Product Feedback Survey</strong></td>
                                        <td><span class="tag tag-processing">Draft</span></td>
                                        <td>0/‚àû</td>
                                        <td>Dec 10, 2024</td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm">Edit</button>
                                            <button class="btn btn-success btn-sm">Publish</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Survey Analytics Section -->
                <div id="survey-analytics-section" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Survey Analytics</h2>
                            <div>
                                <select class="form-select" style="margin-right: 1rem;">
                                    <option>All Surveys</option>
                                    <option>Q4 Employee Satisfaction</option>
                                    <option>Product Feedback</option>
                                </select>
                                <button class="btn btn-secondary">Export Results</button>
                            </div>
                        </div>

                        <div class="dashboard-grid">
                            <div class="stat-card">
                                <div class="stat-value">85%</div>
                                <div class="stat-label">Response Rate</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">4.2/5</div>
                                <div class="stat-label">Average Score</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">3m 24s</div>
                                <div class="stat-label">Avg. Completion Time</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">847</div>
                                <div class="stat-label">Total Responses</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                            <div class="card">
                                <div class="card-header">
                                    <h4>Response Timeline</h4>
                                </div>
                                <div class="chart-placeholder">
                                    üìä Response volume over time chart
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h4>Question Performance</h4>
                                </div>
                                <div style="display: grid; gap: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>Overall Satisfaction</span>
                                        <span><strong>89%</strong></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>Work-Life Balance</span>
                                        <span><strong>76%</strong></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>Management</span>
                                        <span><strong>82%</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Participants Section -->
                <div id="participants-section" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Participants</h2>
                            <div>
                                <button class="btn btn-secondary" onclick="importParticipants()">Import</button>
                                <button class="btn btn-primary" onclick="addParticipant()">Add Participant</button>
                            </div>
                        </div>

                        <div class="dashboard-grid">
                            <div class="stat-card">
                                <div class="stat-value">1,247</div>
                                <div class="stat-label">Total Participants</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">892</div>
                                <div class="stat-label">Active This Month</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">156</div>
                                <div class="stat-label">New This Week</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">23</div>
                                <div class="stat-label">Pending Invites</div>
                            </div>
                        </div>

                        <div class="filters">
                            <div class="filter-group">
                                <label class="filter-label">Search</label>
                                <input type="text" class="form-input" placeholder="Search participants..." style="min-width: 200px;">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Department</label>
                                <select class="form-select">
                                    <option>All Departments</option>
                                    <option>Engineering</option>
                                    <option>Marketing</option>
                                    <option>Sales</option>
                                    <option>HR</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Status</label>
                                <select class="form-select">
                                    <option>All Status</option>
                                    <option>Active</option>
                                    <option>Inactive</option>
                                    <option>Pending</option>
                                </select>
                            </div>
                        </div>

                        <div class="card">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox"></th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Department</th>
                                        <th>Last Response</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><input type="checkbox"></td>
                                        <td>John Smith</td>
                                        <td>john.smith@techcorp.com</td>
                                        <td>Engineering</td>
                                        <td>2 days ago</td>
                                        <td><span class="tag tag-active">Active</span></td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm">Edit</button>
                                            <button class="btn btn-warning btn-sm">Suspend</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><input type="checkbox"></td>
                                        <td>Emma Davis</td>
                                        <td>emma.davis@techcorp.com</td>
                                        <td>Marketing</td>
                                        <td>1 week ago</td>
                                        <td><span class="tag tag-active">Active</span></td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm">Edit</button>
                                            <button class="btn btn-warning btn-sm">Suspend</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Data Management Section -->
                <div id="data-management-section" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Data Management</h2>
                            <div>
                                <button class="btn btn-secondary" onclick="backupData()">Backup Data</button>
                                <button class="btn btn-primary" onclick="exportAllData()">Export All</button>
                            </div>
                        </div>

                        <div class="dashboard-grid">
                            <div class="stat-card">
                                <div class="stat-value">15.4GB</div>
                                <div class="stat-label">Total Data Size</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">45,847</div>
                                <div class="stat-label">Total Records</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">Dec 15</div>
                                <div class="stat-label">Last Backup</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">99.9%</div>
                                <div class="stat-label">Data Integrity</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div class="card">
                                <div class="card-header">
                                    <h4>Export Data</h4>
                                </div>
                                <div style="display: grid; gap: 1rem;">
                                    <div>
                                        <label class="form-label">Data Type</label>
                                        <select class="form-select">
                                            <option>All Data</option>
                                            <option>Survey Responses</option>
                                            <option>Chat Feedback</option>
                                            <option>Participants</option>
                                            <option>Analytics Data</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="form-label">Format</label>
                                        <select class="form-select">
                                            <option>CSV</option>
                                            <option>Excel (XLSX)</option>
                                            <option>JSON</option>
                                            <option>PDF Report</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="form-label">Date Range</label>
                                        <select class="form-select">
                                            <option>All Time</option>
                                            <option>Last 30 days</option>
                                            <option>Last 90 days</option>
                                            <option>This Year</option>
                                            <option>Custom Range</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary">Generate Export</button>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h4>Data Sources</h4>
                                </div>
                                <div style="display: grid; gap: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px;">
                                        <div>
                                            <strong>Survey Responses</strong><br>
                                            <small style="color: var(--text-secondary);">8.2GB ‚Ä¢ 23,847 records</small>
                                        </div>
                                        <span class="tag tag-active">Active</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px;">
                                        <div>
                                            <strong>Chat Feedback</strong><br>
                                            <small style="color: var(--text-secondary);">4.7GB ‚Ä¢ 15,247 records</small>
                                        </div>
                                        <span class="tag tag-active">Active</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px;">
                                        <div>
                                            <strong>User Analytics</strong><br>
                                            <small style="color: var(--text-secondary);">2.5GB ‚Ä¢ 6,753 records</small>
                                        </div>
                                        <span class="tag tag-active">Active</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Data Chat Section -->
                <div id="ai-data-chat-section" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">AI Data Chat</h2>
                            <div>
                                <select class="form-select" style="margin-right: 1rem;">
                                    <option>All Data Sources</option>
                                    <option>Survey Data Only</option>
                                    <option>Chat Feedback Only</option>
                                    <option>Combined Analytics</option>
                                </select>
                                <button class="btn btn-primary" onclick="clearAIChat()">Clear Chat</button>
                            </div>
                        </div>

                        <div class="dashboard-grid">
                            <div class="stat-card">
                                <div class="stat-value">847</div>
                                <div class="stat-label">AI Queries Processed</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">156</div>
                                <div class="stat-label">Insights Generated</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">98.7%</div>
                                <div class="stat-label">Accuracy Rate</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">2.3s</div>
                                <div class="stat-label">Avg. Response Time</div>
                            </div>
                        </div>

                        <div class="card" style="height: 500px; display: flex; flex-direction: column;">
                            <div class="card-header">
                                <h4>Chat with Your Data</h4>
                            </div>
                            <div id="ai-chat-messages" style="flex: 1; overflow-y: auto; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary);">
                                <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px; border-left: 4px solid var(--primary-color);">
                                    <strong>AI Assistant:</strong> Hello! I can help you analyze your survey and feedback data. Try asking me questions like "What's the average satisfaction score?" or "Show me trends in customer feedback over the last month."
                                </div>
                            </div>
                            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                                <input type="text" id="ai-chat-input" class="form-input" placeholder="Ask me anything about your data..." style="flex: 1;" onkeypress="if(event.key==='Enter') sendAIMessage()">
                                <button class="btn btn-primary" onclick="sendAIMessage()">Send</button>
                            </div>
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
                                <button class="btn btn-secondary btn-sm" onclick="sendSuggestion('What is the average satisfaction score?')">Average satisfaction</button>
                                <button class="btn btn-secondary btn-sm" onclick="sendSuggestion('Show me feedback trends this month')">Monthly trends</button>
                                <button class="btn btn-secondary btn-sm" onclick="sendSuggestion('Which departments need improvement?')">Department insights</button>
                                <button class="btn btn-secondary btn-sm" onclick="sendSuggestion('Generate a summary report')">Summary report</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-translate="reset-password">Reset Password</h3>
                <button class="close-btn" onclick="closeModal('forgot-password-modal')">&times;</button>
            </div>
            <form onsubmit="handleForgotPassword(event)">
                <div class="form-group">
                    <label class="form-label" data-translate="email-address">Email Address</label>
                    <input type="email" class="form-input" required placeholder="Enter your email address">
                    <small class="form-help" data-translate="reset-password-help">We'll send you a link to reset your password</small>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('forgot-password-modal')" data-translate="cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-translate="send-reset-link">Send Reset Link</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profile-settings-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 data-translate="profile-settings">Profile Settings</h3>
                <button class="close-btn" onclick="closeModal('profile-settings-modal')">&times;</button>
            </div>
            <form id="profile-form" onsubmit="handleProfileUpdate(event)">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" id="profile-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="profile-email" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Job Title</label>
                    <input type="text" id="profile-job-title" class="form-input" placeholder="e.g., Survey Administrator">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" id="profile-phone" class="form-input" placeholder="+44 1234 567890">
                </div>
                <div class="form-group">
                    <label class="form-label">Time Zone</label>
                    <select id="profile-timezone" class="form-select">
                        <option value="UTC">UTC (Coordinated Universal Time)</option>
                        <option value="Europe/London">Europe/London (GMT/BST)</option>
                        <option value="America/New_York">America/New_York (EST/EDT)</option>
                        <option value="America/Los_Angeles">America/Los_Angeles (PST/PDT)</option>
                        <option value="Europe/Berlin">Europe/Berlin (CET/CEST)</option>
                        <option value="Asia/Tokyo">Asia/Tokyo (JST)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Language Preference</label>
                    <select id="profile-language" class="form-select">
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Bio / Description</label>
                    <textarea id="profile-bio" class="form-input" rows="3" placeholder="Tell us about yourself..."></textarea>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('profile-settings-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Organization Settings Modal -->
    <div id="organization-settings-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 data-translate="organization-settings">Organization Settings</h3>
                <button class="close-btn" onclick="closeModal('organization-settings-modal')">&times;</button>
            </div>
            <form id="organization-form" onsubmit="handleOrganizationUpdate(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Organization Name</label>
                        <input type="text" id="org-name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Industry</label>
                        <select id="org-industry" class="form-select">
                            <option value="">Select Industry</option>
                            <option value="technology">Technology</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="finance">Finance</option>
                            <option value="education">Education</option>
                            <option value="retail">Retail</option>
                            <option value="manufacturing">Manufacturing</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Company Size</label>
                        <select id="org-size" class="form-select">
                            <option value="">Select Size</option>
                            <option value="1-10">1-10 employees</option>
                            <option value="11-50">11-50 employees</option>
                            <option value="51-200">51-200 employees</option>
                            <option value="201-1000">201-1000 employees</option>
                            <option value="1000+">1000+ employees</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Country</label>
                        <select id="org-country" class="form-select">
                            <option value="">Select Country</option>
                            <option value="GB">United Kingdom</option>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="ES">Spain</option>
                            <option value="AU">Australia</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Website</label>
                    <input type="url" id="org-website" class="form-input" placeholder="https://www.example.com">
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="org-description" class="form-input" rows="3" placeholder="Describe your organization..."></textarea>
                </div>

                <div class="card" style="margin: 2rem 0;">
                    <div class="card-header">
                        <h4>Notification Settings</h4>
                    </div>
                    <div style="display: grid; gap: 1rem;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="notify-new-responses">
                            Email notifications for new survey responses
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="notify-weekly-reports">
                            Weekly summary reports
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="notify-system-updates">
                            System updates and maintenance notifications
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="notify-feature-updates">
                            New feature announcements
                        </label>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('organization-settings-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Settings</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Security Settings Modal -->
    <div id="security-settings-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 data-translate="security">Security Settings</h3>
                <button class="close-btn" onclick="closeModal('security-settings-modal')">&times;</button>
            </div>
            
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h4>Change Password</h4>
                </div>
                <form id="password-form" onsubmit="handlePasswordChange(event)">
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <input type="password" id="current-password" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" id="new-password" class="form-input" required minlength="8">
                        <small class="form-help">Must be at least 8 characters long</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" id="confirm-password" class="form-input" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Update Password</button>
                </form>
            </div>

            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h4>Two-Factor Authentication</h4>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <p><strong>Status:</strong> <span id="2fa-status" class="tag tag-inactive">Disabled</span></p>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">Add an extra layer of security to your account</p>
                    </div>
                    <button class="btn btn-primary" id="toggle-2fa" onclick="toggle2FA()">Enable 2FA</button>
                </div>
            </div>

            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h4>Login Sessions</h4>
                </div>
                <div id="login-sessions">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 0.5rem;">
                        <div>
                            <strong>Current Session</strong><br>
                            <small style="color: var(--text-secondary);">Chrome on Windows ‚Ä¢ London, UK ‚Ä¢ Active now</small>
                        </div>
                        <span class="tag tag-active">Current</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 0.5rem;">
                        <div>
                            <strong>Mobile Session</strong><br>
                            <small style="color: var(--text-secondary);">Safari on iPhone ‚Ä¢ London, UK ‚Ä¢ 2 hours ago</small>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="terminateSession('mobile')">Terminate</button>
                    </div>
                </div>
                <button class="btn btn-warning" onclick="terminateAllSessions()">Terminate All Other Sessions</button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h4>Privacy Settings</h4>
                </div>
                <div style="display: grid; gap: 1rem;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="privacy-analytics" checked>
                        Allow usage analytics to improve the platform
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="privacy-marketing">
                        Receive marketing communications
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="privacy-profile" checked>
                        Make my profile visible to organization members
                    </label>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('security-settings-modal')">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveSecuritySettings()">Save Security Settings</button>
            </div>
        </div>
    </div>

    <!-- Help & Support Modal -->
    <div id="help-support-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 data-translate="help-support">Help & Support</h3>
                <button class="close-btn" onclick="closeModal('help-support-modal')">&times;</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <div class="card">
                    <div class="card-header">
                        <h4>üìö Documentation</h4>
                    </div>
                    <div style="display: grid; gap: 0.5rem;">
                        <a href="#" onclick="openHelpArticle('getting-started')" style="color: var(--primary-color); text-decoration: none;">Getting Started Guide</a>
                        <a href="#" onclick="openHelpArticle('survey-builder')" style="color: var(--primary-color); text-decoration: none;">Survey Builder Tutorial</a>
                        <a href="#" onclick="openHelpArticle('analytics')" style="color: var(--primary-color); text-decoration: none;">Analytics & Reporting</a>
                        <a href="#" onclick="openHelpArticle('user-management')" style="color: var(--primary-color); text-decoration: none;">User Management</a>
                        <a href="#" onclick="openHelpArticle('api')" style="color: var(--primary-color); text-decoration: none;">API Documentation</a>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h4>üé• Video Tutorials</h4>
                    </div>
                    <div style="display: grid; gap: 0.5rem;">
                        <a href="#" onclick="playVideo('platform-overview')" style="color: var(--primary-color); text-decoration: none;">Platform Overview (5 min)</a>
                        <a href="#" onclick="playVideo('creating-surveys')" style="color: var(--primary-color); text-decoration: none;">Creating Your First Survey (8 min)</a>
                        <a href="#" onclick="playVideo('analyzing-results')" style="color: var(--primary-color); text-decoration: none;">Analyzing Survey Results (6 min)</a>
                        <a href="#" onclick="playVideo('advanced-features')" style="color: var(--primary-color); text-decoration: none;">Advanced Features (12 min)</a>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h4>üí¨ Contact Support</h4>
                </div>
                <form id="support-form" onsubmit="handleSupportRequest(event)">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Subject</label>
                            <select class="form-select" required>
                                <option value="">Select a topic</option>
                                <option value="technical">Technical Issue</option>
                                <option value="billing">Billing Question</option>
                                <option value="feature">Feature Request</option>
                                <option value="account">Account Management</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Priority</label>
                            <select class="form-select" required>
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Message</label>
                        <textarea class="form-input" rows="5" placeholder="Describe your issue or question in detail..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox">
                            Include system information in my request
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary">Send Support Request</button>
                </form>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="stat-card" onclick="openLiveChat()">
                    <div class="stat-value">üí¨</div>
                    <div class="stat-label">Live Chat</div>
                    <small style="color: var(--success-color);">‚óè Available now</small>
                </div>
                <div class="stat-card" onclick="callSupport()">
                    <div class="stat-value">üìû</div>
                    <div class="stat-label">Phone Support</div>
                    <small style="color: var(--text-secondary);">+44 20 1234 5678</small>
                </div>
                <div class="stat-card" onclick="emailSupport()">
                    <div class="stat-value">üìß</div>
                    <div class="stat-label">Email Support</div>
                    <small style="color: var(--text-secondary);">support@realworld.co.uk</small>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h4>‚ÑπÔ∏è System Information</h4>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
                    <div><strong>Version:</strong> 2.4.1</div>
                    <div><strong>Browser:</strong> <span id="browser-info">Chrome 91.0</span></div>
                    <div><strong>Plan:</strong> <span id="user-plan">Professional</span></div>
                    <div><strong>Organization:</strong> <span id="user-org">TechCorp Ltd</span></div>
                    <div><strong>Last Updated:</strong> Dec 15, 2024</div>
                    <div><strong>Server Status:</strong> <span style="color: var(--success-color);">‚óè All systems operational</span></div>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('help-support-modal')">Close</button>
            </div>
        </div>
    </div>

<!-- Supabase JavaScript library -->
<script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
<!-- Supabase client configuration -->
<script src="lib/supabase.js"></script>
<script src="assets/js/config.js"></script>
<script src="assets/js/database.js"></script>
<script src="assets/js/app.js"></script>
<script>
// NEW CHAT WIDGET FUNCTIONS

// Global storage for templates
if (!window.chatTemplates) {
    window.chatTemplates = [];
}

// UPDATE createNewChatWidget() function to include template selection
function createNewChatWidget() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Create Chat Widget</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            
            <div style="padding: 1.5rem;">
                <h4 style="margin-bottom: 1.5rem; text-align: center; color: var(--text-primary);">Choose Chat Type</h4>
                
                <div class="chat-type-options" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                    <div class="chat-type-option" onclick="selectChatType(this, 'listening')" style="padding: 1.5rem; border: 2px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center;">
                        <input type="radio" name="chatType" value="listening" style="display: none;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üëÇ</div>
                        <h5 style="margin: 0;">Listening</h5>
                    </div>
                    
                    <div class="chat-type-option" onclick="selectChatType(this, 'chat')" style="padding: 1.5rem; border: 2px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center;">
                        <input type="radio" name="chatType" value="chat" style="display: none;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üí¨</div>
                        <h5 style="margin: 0;">Chat</h5>
                    </div>
                    
                    <div class="chat-type-option" onclick="selectChatType(this, 'pulse')" style="padding: 1.5rem; border: 2px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center;">
                        <input type="radio" name="chatType" value="pulse" style="display: none;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìä</div>
                        <h5 style="margin: 0;">Pulse</h5>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                    <button type="button" class="btn btn-primary" id="next-btn" onclick="proceedToChatSetup()" disabled>Next</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Select chat type function
function selectChatType(element, type) {
    // Remove selection from all options
    document.querySelectorAll('.chat-type-option').forEach(option => {
        option.style.borderColor = 'var(--border-color)';
        option.style.backgroundColor = 'transparent';
    });
    
    // Select the clicked option
    element.style.borderColor = 'var(--primary-color)';
    element.style.backgroundColor = '#f0f9ff';
    
    // Check the radio button
    const radio = element.querySelector('input[type="radio"]');
    radio.checked = true;
    
    // Enable the Next button
    document.getElementById('next-btn').disabled = false;
}

// Proceed to chat setup based on selected type
function proceedToChatSetup() {
    const selectedType = document.querySelector('input[name="chatType"]:checked');
    
    if (!selectedType) {
        showToast('Please select a chat type', 'warning');
        return;
    }
    
    const chatType = selectedType.value;
    
    // Close current modal
    document.querySelector('.modal').remove();
    
    // Show the appropriate setup page based on chat type
    switch(chatType) {
        case 'listening':
            showListeningSetup();
            break;
        case 'chat':
            showChatSetup();
            break;
        case 'pulse':
            showPulseSetup();
            break;
        default:
            showToast('Invalid chat type selected', 'error');
    }
}

// Setup functions for each chat type
function showListeningSetup() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>üëÇ Listening Chat Setup</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            
            <form onsubmit="generateListeningChatLink(event)">
                <div style="padding: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Chat Name</label>
                        <input type="text" id="listening-chat-name" class="form-input" required 
                               placeholder="e.g., General Feedback, Customer Insights">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Welcome Messages</label>
                        <textarea id="listening-welcome-msg" class="form-input" rows="4" 
                                  placeholder="Enter welcome messages that users will see when they start the chat...">Hi! Thanks for taking the time to share your feedback with us. Please feel free to tell us about your experience or any suggestions you might have.</textarea>
                        <small class="form-help">This message will appear when users first open the chat</small>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Generate Link</button>
                    </div>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Focus on the chat name input
    setTimeout(() => {
        document.getElementById('listening-chat-name').focus();
    }, 100);
}

// Generate listening chat link
function generateListeningChatLink(event) {
    event.preventDefault();
    
    const chatName = document.getElementById('listening-chat-name').value;
    const welcomeMsg = document.getElementById('listening-welcome-msg').value;
    
    // Generate unique session ID for listening chat
    const sessionId = 'listening_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // Create URL parameters
    const params = new URLSearchParams({
        session: sessionId,
        type: 'listening',
        name: chatName,
        welcome: welcomeMsg
    });
    
    // Generate the original link
    const originalLink = window.location.origin + '/chat.html?' + params.toString();
    
    // Prepare chat data
    const chatData = {
        id: sessionId,
        name: chatName,
        type: 'listening',
        welcome: welcomeMsg,
        link: originalLink,
        created: new Date().toISOString()
    };
    
    // Generate short URL
    const shortUrl = generateShortUrl(chatName, originalLink, chatData);
    chatData.shortUrl = shortUrl;
    
    // Save to database
    saveChatSession(chatData).then(() => {
        console.log('Listening chat saved to database');
        // Refresh the active chats display
        loadActiveChatsList();
    }).catch(error => {
        console.error('Error saving listening chat:', error);
    });
    
    // Close current modal
    document.querySelector('.modal').remove();
    
    // Show success modal with link
    showListeningLinkModal(chatData);
}

// Show modal with generated listening chat link
function showListeningLinkModal(chatData) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>üéâ Listening Chat Created!</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            
            <div style="padding: 1.5rem;">
                <div style="background: #dcfce7; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #10b981;">
                    <h4 style="margin-bottom: 0.5rem; color: #166534;">‚úÖ "${chatData.name}" is ready!</h4>
                    <p style="color: #166534; margin: 0; font-size: 0.9rem;">Your listening chat has been created and is ready to collect feedback.</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Your Chat Link</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" class="form-input" value="${chatData.shortUrl || chatData.link}" readonly id="generated-link" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="copyToClipboard('generated-link')" style="white-space: nowrap;">Copy Link</button>
                    </div>
                    <small class="form-help">Share this link with your audience to start collecting feedback</small>
                </div>
                
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <h5 style="margin-bottom: 0.75rem;">üí° Next Steps:</h5>
                    <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem;">
                        <li>Copy and share the link with your audience</li>
                        <li>Monitor responses in the Active Chats section</li>
                        <li>View analytics and insights as feedback comes in</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                    <button class="btn btn-primary" onclick="testChatLink('${chatData.link}')">Test Chat</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Auto-select the link text for easy copying
    setTimeout(() => {
        document.getElementById('generated-link').select();
    }, 100);
}

// Copy to clipboard function
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    element.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(element.value).then(() => {
        showToast('Link copied to clipboard!', 'success');
    });
}

// Test chat link function
function testChatLink(link) {
    window.open(link, '_blank');
}

function showChatSetup() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>üí¨ Chat Setup</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            
            <form onsubmit="generateGuidedChatLink(event)">
                <div style="padding: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Chat Name</label>
                        <input type="text" id="chat-name" class="form-input" required 
                               placeholder="e.g., Employee Wellbeing Check, Team Feedback">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Welcome Messages</label>
                        <textarea id="chat-welcome-msg" class="form-input" rows="4" 
                                  placeholder="Enter welcome messages that users will see when they start the chat...">Hi! I'm here to have a conversation with you about your work experience. Please feel free to share your thoughts and experiences with me.</textarea>
                        <small class="form-help">This message will appear when users first open the chat</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Work-Life Topics</label>
                        <textarea id="chat-topics" class="form-input" rows="3" 
                                  placeholder="Enter topics the AI should naturally work into conversations (e.g., finance, mental health, work-life balance, career development...)">finance, mental health, work-life balance</textarea>
                        <small class="form-help">The AI will naturally weave these topics into conversations, not as direct questions but as discussion areas</small>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Generate Link</button>
                    </div>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Focus on the chat name input
    setTimeout(() => {
        document.getElementById('chat-name').focus();
    }, 100);
}

// Generate guided chat link with topics
function generateGuidedChatLink(event) {
    event.preventDefault();
    
    const chatName = document.getElementById('chat-name').value;
    const welcomeMsg = document.getElementById('chat-welcome-msg').value;
    const topics = document.getElementById('chat-topics').value;
    
    // Generate unique session ID for chat
    const sessionId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // Create URL parameters
    const params = new URLSearchParams({
        session: sessionId,
        type: 'chat',
        name: chatName,
        welcome: welcomeMsg,
        topics: topics
    });
    
    // Generate the original link
    const originalLink = window.location.origin + '/chat.html?' + params.toString();
    
    // Prepare chat data
    const chatData = {
        id: sessionId,
        name: chatName,
        type: 'chat',
        welcome: welcomeMsg,
        topics: topics,
        link: originalLink,
        created: new Date().toISOString()
    };
    
    // Generate short URL
    const shortUrl = generateShortUrl(chatName, originalLink, chatData);
    chatData.shortUrl = shortUrl;
    
    // Save to database
    saveChatSession(chatData).then(() => {
        console.log('Guided chat saved to database');
        // Refresh the active chats display
        loadActiveChatsList();
    }).catch(error => {
        console.error('Error saving guided chat:', error);
    });
    
    // Close current modal
    document.querySelector('.modal').remove();
    
    // Show success modal with link
    showChatLinkModal(chatData);
}

// Show modal with generated chat link
function showChatLinkModal(chatData) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>üéâ Chat Created!</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            
            <div style="padding: 1.5rem;">
                <div style="background: #dcfce7; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #10b981;">
                    <h4 style="margin-bottom: 0.5rem; color: #166534;">‚úÖ "${chatData.name}" is ready!</h4>
                    <p style="color: #166534; margin: 0; font-size: 0.9rem;">Your chat is ready with AI guidance on: <strong>${chatData.topics}</strong></p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Your Chat Link</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" class="form-input" value="${chatData.shortUrl || chatData.link}" readonly id="generated-chat-link" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="copyToClipboard('generated-chat-link')" style="white-space: nowrap;">Copy Link</button>
                    </div>
                    <small class="form-help">Share this link with your audience to start guided conversations</small>
                </div>
                
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <h5 style="margin-bottom: 0.75rem;">ü§ñ AI Conversation Topics:</h5>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                        ${chatData.topics.split(',').map(topic => `
                            <span style="padding: 0.25rem 0.75rem; background: #e0f2fe; color: #0369a1; border-radius: 12px; font-size: 0.85rem;">${topic.trim()}</span>
                        `).join('')}
                    </div>
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 0;">The AI will naturally guide conversations to explore these areas of work-life experience.</p>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                    <button class="btn btn-primary" onclick="testChatLink('${chatData.link}')">Test Chat</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Auto-select the link text for easy copying
    setTimeout(() => {
        document.getElementById('generated-chat-link').select();
    }, 100);
}

function showPulseSetup() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>üìä Pulse Survey Setup</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            
            <form onsubmit="generatePulseLink(event)">
                <div style="padding: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Survey Name</label>
                        <input type="text" id="pulse-name" class="form-input" required 
                               placeholder="e.g., Weekly Team Pulse, Employee Satisfaction Check">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Welcome Messages</label>
                        <textarea id="pulse-welcome-msg" class="form-input" rows="4" 
                                  placeholder="Enter welcome messages that users will see when they start the survey...">Hi! I'd like to ask you a few quick questions to get a pulse on how things are going. This should only take a few minutes.</textarea>
                        <small class="form-help">This message will appear when users first open the chat</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Survey Questions</label>
                        <div id="pulse-questions-container">
                            <div class="question-item" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                    <input type="text" class="form-input question-text" placeholder="Enter your question..." style="flex: 2;" value="How satisfied are you with your current workload?">
                                    <select class="form-select question-type" style="flex: 1;">
                                        <option value="rating">Rating Scale (1-5)</option>
                                        <option value="yes-no">Yes/No</option>
                                        <option value="multiple-choice">Multiple Choice</option>
                                        <option value="text">Open Text</option>
                                    </select>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeQuestion(this)">√ó</button>
                                </div>
                                <div class="question-options" style="display: none;">
                                    <label class="form-label" style="font-size: 0.85rem;">Options (one per line):</label>
                                    <textarea class="form-input options-text" rows="3" placeholder="Option 1&#10;Option 2&#10;Option 3"></textarea>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addPulseQuestion()">+ Add Question</button>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Generate Survey Link</button>
                    </div>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Add event listeners for question type changes
    setupQuestionTypeListeners();
    
    // Focus on the survey name input
    setTimeout(() => {
        document.getElementById('pulse-name').focus();
    }, 100);
}

// Setup event listeners for question type changes
function setupQuestionTypeListeners() {
    document.querySelectorAll('.question-type').forEach(select => {
        select.addEventListener('change', function() {
            const optionsDiv = this.closest('.question-item').querySelector('.question-options');
            if (this.value === 'multiple-choice') {
                optionsDiv.style.display = 'block';
            } else {
                optionsDiv.style.display = 'none';
            }
        });
    });
}

// Add new question to pulse survey
function addPulseQuestion() {
    const container = document.getElementById('pulse-questions-container');
    const questionItem = document.createElement('div');
    questionItem.className = 'question-item';
    questionItem.style.cssText = 'border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;';
    
    questionItem.innerHTML = `
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <input type="text" class="form-input question-text" placeholder="Enter your question..." style="flex: 2;">
            <select class="form-select question-type" style="flex: 1;">
                <option value="rating">Rating Scale (1-5)</option>
                <option value="yes-no">Yes/No</option>
                <option value="multiple-choice">Multiple Choice</option>
                <option value="text">Open Text</option>
            </select>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeQuestion(this)">√ó</button>
        </div>
        <div class="question-options" style="display: none;">
            <label class="form-label" style="font-size: 0.85rem;">Options (one per line):</label>
            <textarea class="form-input options-text" rows="3" placeholder="Option 1&#10;Option 2&#10;Option 3"></textarea>
        </div>
    `;
    
    container.appendChild(questionItem);
    setupQuestionTypeListeners();
}

// Remove question from pulse survey
function removeQuestion(button) {
    button.closest('.question-item').remove();
}

// Generate pulse survey link
function generatePulseLink(event) {
    event.preventDefault();
    
    const surveyName = document.getElementById('pulse-name').value;
    const welcomeMsg = document.getElementById('pulse-welcome-msg').value;
    
    // Collect all questions
    const questions = [];
    document.querySelectorAll('.question-item').forEach(item => {
        const questionText = item.querySelector('.question-text').value;
        const questionType = item.querySelector('.question-type').value;
        const options = item.querySelector('.options-text').value;
        
        if (questionText.trim()) {
            const question = {
                text: questionText,
                type: questionType
            };
            
            if (questionType === 'multiple-choice' && options.trim()) {
                question.options = options.split('\n').map(opt => opt.trim()).filter(opt => opt);
            }
            
            questions.push(question);
        }
    });
    
    if (questions.length === 0) {
        showToast('Please add at least one question', 'warning');
        return;
    }
    
    // Generate unique session ID for pulse survey
    const sessionId = 'pulse_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // Create URL parameters
    const params = new URLSearchParams({
        session: sessionId,
        type: 'pulse',
        name: surveyName,
        welcome: welcomeMsg,
        questions: JSON.stringify(questions)
    });
    
    // Generate the original link
    const originalLink = window.location.origin + '/chat.html?' + params.toString();
    
    // Prepare chat data
    const chatData = {
        id: sessionId,
        name: surveyName,
        type: 'pulse',
        welcome: welcomeMsg,
        questions: questions,
        link: originalLink,
        created: new Date().toISOString()
    };
    
    // Generate short URL
    const shortUrl = generateShortUrl(surveyName, originalLink, chatData);
    chatData.shortUrl = shortUrl;
    
    // Save to database
    saveChatSession(chatData).then(() => {
        console.log('Pulse survey saved to database');
        // Refresh the active chats display
        loadActiveChatsList();
    }).catch(error => {
        console.error('Error saving pulse survey:', error);
    });
    
    // Close current modal
    document.querySelector('.modal').remove();
    
    // Show success modal with link
    showPulseLinkModal(chatData);
}

// Show modal with generated pulse survey link
function showPulseLinkModal(pulseData) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>üéâ Pulse Survey Created!</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            
            <div style="padding: 1.5rem;">
                <div style="background: #dcfce7; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #10b981;">
                    <h4 style="margin-bottom: 0.5rem; color: #166534;">‚úÖ "${pulseData.name}" is ready!</h4>
                    <p style="color: #166534; margin: 0; font-size: 0.9rem;">Your pulse survey with ${pulseData.questions.length} questions is ready to collect responses.</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Your Survey Link</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" class="form-input" value="${pulseData.shortUrl || pulseData.link}" readonly id="generated-pulse-link" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="copyToClipboard('generated-pulse-link')" style="white-space: nowrap;">Copy Link</button>
                    </div>
                    <small class="form-help">Share this link to collect structured feedback through chat</small>
                </div>
                
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <h5 style="margin-bottom: 0.75rem;">üìä Survey Questions Preview:</h5>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${pulseData.questions.map((q, index) => `
                            <div style="margin-bottom: 1rem; padding: 0.75rem; background: white; border-radius: 6px; border-left: 3px solid var(--primary-color);">
                                <div style="font-weight: 500; margin-bottom: 0.25rem;">${index + 1}. ${q.text}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    Type: ${q.type === 'rating' ? 'Rating Scale (1-5)' : q.type === 'yes-no' ? 'Yes/No' : q.type === 'multiple-choice' ? 'Multiple Choice' : 'Open Text'}
                                    ${q.options ? `<br>Options: ${q.options.join(', ')}` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                    <button class="btn btn-primary" onclick="testChatLink('${pulseData.link}')">Test Survey</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Auto-select the link text for easy copying
    setTimeout(() => {
        document.getElementById('generated-pulse-link').select();
    }, 100);
}

function toggleChatTypeFields() {
    // Placeholder for any future functionality
}

// UPDATE generateChatLink to include template data
async function generateChatLink(event) {
    event.preventDefault();
    
    // Get chat type
    const chatType = document.querySelector('input[name="chatType"]:checked').value;
    
    // Get common form values
    const sessionName = document.getElementById('chat-session-name').value;
    const welcomeMsg = document.getElementById('chat-welcome-msg').value;
    
    // Get selected template data
    const templateData = document.getElementById('selected-template-data').value;
    const template = templateData ? JSON.parse(templateData) : null;
    
    if (chatType === 'continuous') {
        // Handle continuous chat with template
        generateContinuousChatLink(sessionName, welcomeMsg, template);
    } else {
        // Handle personal chat with template
        generatePersonalChatLinks(sessionName, welcomeMsg, template);
    }
}

// UPDATE generateContinuousChatLink to include template
function generateContinuousChatLink(sessionName, welcomeMsg, template = null) {
    const expiry = document.getElementById('chat-expiry').value;
    const allowAnonymous = document.getElementById('chat-anonymous').checked;
    const optionalEmail = document.getElementById('chat-optional-email').checked;
    
    // Generate unique session ID for continuous chat
    const sessionId = 'continuous_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // Create URL parameters
    const params = new URLSearchParams({
        id: sessionId,
        type: 'continuous',
        name: sessionName,
        welcome: welcomeMsg,
        expiry: expiry,
        anonymous: allowAnonymous,
        optionalEmail: optionalEmail
    });
    
    // Add template ID if selected
    if (template) {
        params.append('templateId', template.id);
    }
    
    // Generate the link
    const chatLink = window.location.origin + '/chat.html?' + params.toString();
    
    // Store session data with template
    const chatSessionData = {
        id: sessionId,
        type: 'continuous',
        name: sessionName,
        welcomeMsg: welcomeMsg,
        expiry: expiry,
        allowAnonymous: allowAnonymous,
        optionalEmail: optionalEmail,
        link: chatLink,
        template: template,  // Include template data
        created: new Date().toISOString()
    };
    
    // Store the session (in real app, this would go to database)
    if (!window.chatSessions) {
        window.chatSessions = [];
    }
    window.chatSessions.push(chatSessionData);
    
    // Close current modal
    document.querySelector('.modal').remove();
    
    // Show success modal with link
    showContinuousChatLinkModal(chatSessionData);
}

// Function to generate personal chat links
async function generatePersonalChatLinks(sessionName, welcomeMsg, template = null) {
    const participants = window.tempParticipants || [];
    
    if (participants.length === 0) {
        showToast('Please add participants first', 'warning');
        return;
    }
    
    const expiry = document.getElementById('personal-chat-expiry').value;
    const sendInvites = document.getElementById('send-email-invites').checked;
    const trackResponses = document.getElementById('track-responses').checked;
    const allowMultiple = document.getElementById('allow-multiple-responses').checked;
    
    // Generate unique links for each participant
    const personalLinks = [];
    const baseSessionId = 'personal_' + Date.now();
    
    participants.forEach((participant, index) => {
        const personalId = baseSessionId + '_' + index + '_' + Math.random().toString(36).substr(2, 9);
        
        const params = new URLSearchParams({
            id: personalId,
            type: 'personal',
            name: sessionName,
            welcome: welcomeMsg,
            expiry: expiry,
            participantName: participant.name,
            participantEmail: participant.email,
            trackResponses: trackResponses,
            allowMultiple: allowMultiple
        });
        
        // Add template ID if selected
        if (template) {
            params.append('templateId', template.id);
        }
        
        const link = window.location.origin + '/chat.html?' + params.toString();
        
        personalLinks.push({
            participant: participant,
            link: link,
            id: personalId,
            responded: false,
            responseCount: 0
        });
    });
    
    // Store session data
    const chatSessionData = {
        id: baseSessionId,
        type: 'personal',
        name: sessionName,
        welcomeMsg: welcomeMsg,
        expiry: expiry,
        trackResponses: trackResponses,
        allowMultiple: allowMultiple,
        personalLinks: personalLinks,
        template: template,  // Include template data
        created: new Date().toISOString()
    };
    
    // Store the session
    if (!window.chatSessions) {
        window.chatSessions = [];
    }
    window.chatSessions.push(chatSessionData);
    
    // Send email invites if selected
    if (sendInvites) {
        await sendPersonalInvites(personalLinks, sessionName);
    }
    
    // Close current modal
    document.querySelector('.modal').remove();
    
    // Show success modal with links
    showPersonalChatLinksModal(chatSessionData);
}

// Show success modal for continuous chat
function showContinuousChatLinkModal(sessionData) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>‚úÖ Continuous Chat Link Generated!</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div>
                <div class="alert alert-success" style="margin-bottom: 1.5rem;">
                    <strong>Success!</strong> Your continuous chat link for "${sessionData.name}" is ready.
                </div>
                
                <div class="form-group">
                    <label class="form-label">Share this link with all participants:</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="generated-link" class="form-input" value="${sessionData.link}" 
                               readonly style="font-family: monospace; font-size: 0.875rem;">
                        <button class="btn btn-primary" onclick="copyLinkToClipboard()">Copy</button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem;">
                    <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                        <strong>üìä Link Settings:</strong>
                        <ul style="margin: 0.5rem 0 0 1rem; font-size: 0.875rem;">
                            <li>Type: Continuous (Shared)</li>
                            <li>Expiry: ${sessionData.expiry === 'never' ? 'Never' : sessionData.expiry}</li>
                            <li>Anonymous: ${sessionData.allowAnonymous ? 'Yes' : 'No'}</li>
                        </ul>
                    </div>
                    <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                        <strong>üìà Usage:</strong>
                        <ul style="margin: 0.5rem 0 0 1rem; font-size: 0.875rem;">
                            <li>Share via email, social media, or website</li>
                            <li>Unlimited participants</li>
                            <li>Real-time response tracking</li>
                        </ul>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem;">
                    <label class="form-label">QR Code (for easy mobile access):</label>
                    <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color); text-align: center;">
                        <div style="width: 200px; height: 200px; margin: 0 auto; background: var(--bg-secondary); 
                                    display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                            <span style="color: var(--text-secondary);">QR Code Here</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="testChatLink('${sessionData.link}')">
                        üß™ Test Link
                    </button>
                    <button class="btn btn-success" onclick="emailChatLink(${JSON.stringify(sessionData).replace(/"/g, '&quot;')})">
                        üìß Email to Me
                    </button>
                    <button class="btn btn-primary" onclick="downloadQRCode()">
                        üì• Download QR
                    </button>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="generateAnotherLink()">Create Another</button>
                    <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Done</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    showToast('Continuous chat link generated successfully!', 'success');
}

// Show success modal for personal chat links
function showPersonalChatLinksModal(sessionData) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>‚úÖ Personal Chat Links Generated!</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div>
                <div class="alert alert-success" style="margin-bottom: 1.5rem;">
                    <strong>Success!</strong> Generated ${sessionData.personalLinks.length} unique personal links for "${sessionData.name}"
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                        <strong>üìä Session Settings:</strong>
                        <ul style="margin: 0.5rem 0 0 1rem; font-size: 0.875rem;">
                            <li>Type: Personal (Individual Links)</li>
                            <li>Participants: ${sessionData.personalLinks.length}</li>
                            <li>Expiry: ${sessionData.expiry}</li>
                            <li>Response Tracking: ${sessionData.trackResponses ? 'Enabled' : 'Disabled'}</li>
                        </ul>
                    </div>
                    <div style="padding: 1rem; background: #dcfce7; border-radius: 8px;">
                        <strong>‚úâÔ∏è Email Status:</strong>
                        <div style="margin-top: 0.5rem; font-size: 0.875rem;">
                            <div id="email-status">Preparing to send invitations...</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Participant Links:</label>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Personal Link</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sessionData.personalLinks.map(item => `
                                    <tr>
                                        <td>${item.participant.name}</td>
                                        <td>${item.participant.email}</td>
                                        <td>
                                            <input type="text" value="${item.link}" readonly 
                                                   style="width: 100%; font-size: 0.75rem; font-family: monospace;">
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary" 
                                                    onclick="copyPersonalLink('${item.link}')">Copy</button>
                                            <button class="btn btn-sm btn-primary" 
                                                    onclick="testChatLink('${item.link}')">Test</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="exportPersonalLinks(${JSON.stringify(sessionData).replace(/"/g, '&quot;')})">
                        üì• Export to CSV
                    </button>
                    <button class="btn btn-success" onclick="resendAllInvites(${JSON.stringify(sessionData).replace(/"/g, '&quot;')})">
                        üìß Resend All Invites
                    </button>
                    <button class="btn btn-primary" onclick="viewResponseTracking('${sessionData.id}')">
                        üìä Track Responses
                    </button>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="generateAnotherLink()">Create Another</button>
                    <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Done</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    showToast(`Generated ${sessionData.personalLinks.length} personal chat links!`, 'success');
}

// Send personal invites via email
async function sendPersonalInvites(personalLinks, sessionName) {
    const emailStatus = document.getElementById('email-status');
    let successCount = 0;
    let failCount = 0;
    
    for (const linkData of personalLinks) {
        try {
            // Simulated API call - replace with actual endpoint
            const response = await fetch('/api/send-chat-invite', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: linkData.participant.email,
                    name: linkData.participant.name,
                    sessionName: sessionName,
                    personalLink: linkData.link
                }),
            });
            
            if (response.ok) {
                successCount++;
            } else {
                failCount++;
            }
        } catch (error) {
            failCount++;
            console.error('Failed to send invite to', linkData.participant.email, error);
        }
        
        // Update status
        if (emailStatus) {
            emailStatus.textContent = `Sent ${successCount} of ${personalLinks.length} invitations...`;
        }
    }
    
    // Final status
    if (emailStatus) {
        if (failCount === 0) {
            emailStatus.innerHTML = `<span style="color: var(--success-color);">‚úÖ All ${successCount} invitations sent successfully!</span>`;
        } else {
            emailStatus.innerHTML = `<span style="color: var(--warning-color);">‚ö†Ô∏è Sent ${successCount} invitations, ${failCount} failed.</span>`;
        }
    }
}

// Helper functions
function copyPersonalLink(link) {
    const tempInput = document.createElement('input');
    tempInput.value = link;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand('copy');
    document.body.removeChild(tempInput);
    showToast('Link copied to clipboard!', 'success');
}

function exportPersonalLinks(sessionData) {
    let csvContent = 'Name,Email,Personal Link\n';
    sessionData.personalLinks.forEach(item => {
        csvContent += `"${item.participant.name}","${item.participant.email}","${item.link}"\n`;
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `personal_links_${sessionData.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
    
    showToast('Personal links exported to CSV', 'success');
}

function resendAllInvites(sessionData) {
    if (confirm(`Resend invitations to all ${sessionData.personalLinks.length} participants?`)) {
        sendPersonalInvites(sessionData.personalLinks, sessionData.name);
        showToast('Resending all invitations...', 'info');
    }
}

function viewResponseTracking(sessionId) {
    showToast('Opening response tracking dashboard...', 'info');
    // This would open a dashboard showing who has responded
}

function downloadQRCode() {
    showToast('Downloading QR code...', 'info');
    // This would generate and download the QR code
}

function copyLinkToClipboard() {
    const linkInput = document.getElementById('generated-link');
    linkInput.select();
    document.execCommand('copy');
    showToast('Link copied to clipboard!', 'success');
}

function testChatLink(link) {
    window.open(link, '_blank');
}

function emailChatLink(sessionData) {
    showToast('Opening email client...', 'info');
    // This would open email client with pre-filled content
}

function generateAnotherLink() {
    document.querySelector('.modal').remove();
    createNewChatWidget();
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// TEMPLATE MANAGEMENT FUNCTIONS

// Function to create a new chat template
function createChatTemplate() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>üéØ Create Chat Template</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <form onsubmit="saveChatTemplate(event)">
                <!-- Template Basic Info -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; color: var(--primary-color);">üìã Template Information</h4>
                    
                    <div class="form-group">
                        <label class="form-label">Template Name <span style="color: red;">*</span></label>
                        <input type="text" id="template-name" class="form-input" required 
                               placeholder="e.g., Customer Satisfaction Survey">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="template-description" class="form-input" rows="2" 
                                  placeholder="Brief description of what this template is for..."></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select id="template-category" class="form-select">
                                <option value="general">General Feedback</option>
                                <option value="satisfaction">Customer Satisfaction</option>
                                <option value="employee">Employee Feedback</option>
                                <option value="product">Product Feedback</option>
                                <option value="service">Service Evaluation</option>
                                <option value="event">Event Feedback</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Estimated Time</label>
                            <select id="template-time" class="form-select">
                                <option value="2">2 minutes</option>
                                <option value="5" selected>5 minutes</option>
                                <option value="10">10 minutes</option>
                                <option value="15">15 minutes</option>
                                <option value="20">20+ minutes</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Chat Flow Settings -->
                <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; color: var(--primary-color);">üí¨ Chat Flow Settings</h4>
                    
                    <div class="form-group">
                        <label class="form-label">Introduction Message</label>
                        <textarea id="template-intro" class="form-input" rows="2" 
                                  placeholder="Hi! Thanks for taking the time to provide feedback. I'll ask you a few quick questions...">Hi! Thanks for taking the time to provide feedback. I'll ask you a few quick questions to understand your experience better.</textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="template-allow-skip" checked>
                                Allow users to skip questions
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="template-show-progress" checked>
                                Show progress indicator
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Closing Message</label>
                        <textarea id="template-closing" class="form-input" rows="2" 
                                  placeholder="Thank you for your valuable feedback! We appreciate your time.">Thank you for your valuable feedback! Your responses will help us improve our services.</textarea>
                    </div>
                </div>

                <!-- Questions Builder -->
                <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; color: var(--primary-color);">üìù Questions</h4>
                        <button type="button" class="btn btn-primary btn-sm" onclick="addTemplateQuestion()" 
                                style="margin-left: auto;">
                            + Add Question
                        </button>
                    </div>
                    
                    <div id="template-questions-container">
                        <!-- Questions will be added here dynamically -->
                        <div class="template-question-item" data-question-id="1">
                            <div class="question-header">
                                <span class="question-number">Question 1</span>
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeTemplateQuestion(this)">Remove</button>
                            </div>
                            <div class="question-content">
                                <div class="form-group">
                                    <label class="form-label">Question Text <span style="color: red;">*</span></label>
                                    <input type="text" class="form-input question-text" required 
                                           placeholder="Enter your question here...">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label class="form-label">Question Type</label>
                                        <select class="form-select question-type" onchange="updateQuestionOptions(this)">
                                            <option value="text">Text Response</option>
                                            <option value="rating">Rating (1-5)</option>
                                            <option value="yes-no">Yes/No</option>
                                            <option value="multiple-choice">Multiple Choice</option>
                                            <option value="scale">Scale (1-10)</option>
                                            <option value="emoji">Emoji Rating</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Required?</label>
                                        <select class="form-select question-required">
                                            <option value="yes">Yes</option>
                                            <option value="no">No</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="question-options" style="display: none;">
                                    <!-- Options for multiple choice questions will appear here -->
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Follow-up Prompt (Optional)</label>
                                    <input type="text" class="form-input question-followup" 
                                           placeholder="e.g., 'Can you tell me more about that?'">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                        <small style="color: var(--text-secondary);">
                            üí° <strong>Tips:</strong> Keep questions clear and concise. Start with easy questions to build rapport. 
                            Use a mix of question types for better engagement.
                        </small>
                    </div>
                </div>

                <!-- AI Behavior Settings -->
                <div style="background: #fef3c7; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; color: #92400e;">ü§ñ AI Behavior Settings</h4>
                    
                    <div class="form-group">
                        <label class="form-label">AI Personality</label>
                        <select id="template-ai-personality" class="form-select">
                            <option value="professional">Professional</option>
                            <option value="friendly" selected>Friendly</option>
                            <option value="casual">Casual</option>
                            <option value="formal">Formal</option>
                            <option value="empathetic">Empathetic</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Response Style</label>
                        <div style="display: grid; gap: 0.5rem;">
                            <label class="checkbox-label">
                                <input type="checkbox" id="ai-acknowledge" checked>
                                Acknowledge user responses before moving to next question
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="ai-clarify" checked>
                                Ask for clarification if response is unclear
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="ai-empathy">
                                Show empathy for negative feedback
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="ai-dynamic">
                                Dynamically adjust questions based on responses
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Template Preview -->
                <div style="margin-bottom: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="previewTemplate()" style="width: 100%;">
                        üëÅÔ∏è Preview Template Chat Flow
                    </button>
                </div>

                <!-- Form Actions -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                    <button type="button" class="btn btn-secondary" onclick="saveTemplateAsDraft()">Save as Draft</button>
                    <button type="submit" class="btn btn-primary">Save Template</button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Initialize question numbers
    updateQuestionNumbers();
}

// Add a new question to the template
function addTemplateQuestion() {
    const container = document.getElementById('template-questions-container');
    const questionCount = container.querySelectorAll('.template-question-item').length + 1;
    
    const questionHTML = `
        <div class="template-question-item" data-question-id="${questionCount}">
            <div class="question-header">
                <span class="question-number">Question ${questionCount}</span>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeTemplateQuestion(this)">Remove</button>
            </div>
            <div class="question-content">
                <div class="form-group">
                    <label class="form-label">Question Text <span style="color: red;">*</span></label>
                    <input type="text" class="form-input question-text" required 
                           placeholder="Enter your question here...">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Question Type</label>
                        <select class="form-select question-type" onchange="updateQuestionOptions(this)">
                            <option value="text">Text Response</option>
                            <option value="rating">Rating (1-5)</option>
                            <option value="yes-no">Yes/No</option>
                            <option value="multiple-choice">Multiple Choice</option>
                            <option value="scale">Scale (1-10)</option>
                            <option value="emoji">Emoji Rating</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Required?</label>
                        <select class="form-select question-required">
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                </div>
                <div class="question-options" style="display: none;">
                    <!-- Options for multiple choice questions will appear here -->
                </div>
                <div class="form-group">
                    <label class="form-label">Follow-up Prompt (Optional)</label>
                    <input type="text" class="form-input question-followup" 
                           placeholder="e.g., 'Can you tell me more about that?'">
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', questionHTML);
    updateQuestionNumbers();
    showToast('Question added!', 'success');
}

// Remove a question from the template
function removeTemplateQuestion(button) {
    const questionItem = button.closest('.template-question-item');
    questionItem.remove();
    updateQuestionNumbers();
    showToast('Question removed', 'info');
}

// Update question numbers after add/remove
function updateQuestionNumbers() {
    const questions = document.querySelectorAll('.template-question-item');
    questions.forEach((question, index) => {
        question.querySelector('.question-number').textContent = `Question ${index + 1}`;
        question.setAttribute('data-question-id', index + 1);
    });
}

// Update question options based on type
function updateQuestionOptions(select) {
    const questionItem = select.closest('.template-question-item');
    const optionsDiv = questionItem.querySelector('.question-options');
    const questionType = select.value;
    
    if (questionType === 'multiple-choice') {
        optionsDiv.style.display = 'block';
        optionsDiv.innerHTML = `
            <div class="form-group">
                <label class="form-label">Options (one per line)</label>
                <textarea class="form-input question-mc-options" rows="4" 
                          placeholder="Option 1&#10;Option 2&#10;Option 3&#10;Option 4"></textarea>
            </div>
        `;
    } else {
        optionsDiv.style.display = 'none';
        optionsDiv.innerHTML = '';
    }
}

// Save the template
function saveChatTemplate(event) {
    event.preventDefault();
    
    // Gather all the template data
    const templateData = {
        id: 'template_' + Date.now(),
        name: document.getElementById('template-name').value,
        description: document.getElementById('template-description').value,
        category: document.getElementById('template-category').value,
        estimatedTime: document.getElementById('template-time').value,
        intro: document.getElementById('template-intro').value,
        closing: document.getElementById('template-closing').value,
        allowSkip: document.getElementById('template-allow-skip').checked,
        showProgress: document.getElementById('template-show-progress').checked,
        aiPersonality: document.getElementById('template-ai-personality').value,
        aiSettings: {
            acknowledge: document.getElementById('ai-acknowledge').checked,
            clarify: document.getElementById('ai-clarify').checked,
            empathy: document.getElementById('ai-empathy').checked,
            dynamic: document.getElementById('ai-dynamic').checked
        },
        questions: [],
        createdAt: new Date().toISOString(),
        status: 'active'
    };
    
    // Gather all questions
    const questionItems = document.querySelectorAll('.template-question-item');
    questionItems.forEach((item, index) => {
        const question = {
            id: index + 1,
            text: item.querySelector('.question-text').value,
            type: item.querySelector('.question-type').value,
            required: item.querySelector('.question-required').value === 'yes',
            followup: item.querySelector('.question-followup').value
        };
        
        // Add options for multiple choice
        if (question.type === 'multiple-choice') {
            const optionsText = item.querySelector('.question-mc-options')?.value || '';
            question.options = optionsText.split('\n').filter(opt => opt.trim());
        }
        
        templateData.questions.push(question);
    });
    
    // Validate at least one question
    if (templateData.questions.length === 0) {
        showToast('Please add at least one question to the template', 'warning');
        return;
    }
    
    // Save to storage
    window.chatTemplates.push(templateData);
    localStorage.setItem('chatTemplates', JSON.stringify(window.chatTemplates));
    
    // Close modal
    event.target.closest('.modal').remove();
    
    // Show success message
    showToast(`Template "${templateData.name}" saved successfully!`, 'success');
    
    // Refresh template list if on chat management page
    if (document.getElementById('chat-management-section') && !document.getElementById('chat-management-section').classList.contains('hidden')) {
        refreshTemplatesList();
    }
}

// Save template as draft
function saveTemplateAsDraft() {
    const templateName = document.getElementById('template-name').value || 'Untitled Template';
    
    // Similar to saveChatTemplate but with draft status
    const templateData = {
        id: 'template_draft_' + Date.now(),
        name: templateName + ' (Draft)',
        status: 'draft',
        // ... gather other data same as saveChatTemplate
    };
    
    window.chatTemplates.push(templateData);
    localStorage.setItem('chatTemplates', JSON.stringify(window.chatTemplates));
    
    document.querySelector('.modal').remove();
    showToast(`Draft template saved!`, 'info');
}

// Preview template
function previewTemplate() {
    const questions = [];
    document.querySelectorAll('.template-question-item').forEach(item => {
        questions.push({
            text: item.querySelector('.question-text').value || 'Question text',
            type: item.querySelector('.question-type').value
        });
    });
    
    if (questions.length === 0) {
        showToast('Add questions to preview the template', 'warning');
        return;
    }
    
    // Create preview modal
    const previewModal = document.createElement('div');
    previewModal.className = 'modal';
    previewModal.style.zIndex = '10001';
    previewModal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Template Preview</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                <div class="chat-preview-message bot">
                    <strong>AI:</strong> ${document.getElementById('template-intro').value || 'Welcome!'}
                </div>
                ${questions.map((q, i) => `
                    <div class="chat-preview-message bot">
                        <strong>AI:</strong> ${q.text}
                        ${getQuestionTypePreview(q.type)}
                    </div>
                    <div class="chat-preview-message user">
                        <strong>User:</strong> <em>[User response]</em>
                    </div>
                `).join('')}
                <div class="chat-preview-message bot">
                    <strong>AI:</strong> ${document.getElementById('template-closing').value || 'Thank you!'}
                </div>
            </div>
            <div style="margin-top: 1rem; text-align: right;">
                <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Close Preview</button>
            </div>
        </div>
    `;
    document.body.appendChild(previewModal);
}

// Get question type preview HTML
function getQuestionTypePreview(type) {
    const previews = {
        'text': '<div style="margin-top: 0.5rem;"><input type="text" class="form-input" placeholder="Type your answer..." disabled></div>',
        'rating': '<div style="margin-top: 0.5rem;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>',
        'yes-no': '<div style="margin-top: 0.5rem;"><button class="btn btn-sm">Yes</button> <button class="btn btn-sm">No</button></div>',
        'multiple-choice': '<div style="margin-top: 0.5rem;">‚óã Option A<br>‚óã Option B<br>‚óã Option C</div>',
        'scale': '<div style="margin-top: 0.5rem;">1 ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî 10</div>',
        'emoji': '<div style="margin-top: 0.5rem;">üòû üòê üòä üòÉ üòç</div>'
    };
    return previews[type] || '';
}

// Load templates from storage on page load
function loadTemplates() {
    const saved = localStorage.getItem('chatTemplates');
    if (saved) {
        window.chatTemplates = JSON.parse(saved);
    }
}

// Refresh templates list in the UI
function refreshTemplatesList() {
    const container = document.querySelector('#chat-management-section .card:nth-child(2) div');
    if (!container) return;
    
    const templates = window.chatTemplates.filter(t => t.status === 'active');
    
    if (templates.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                No templates created yet. Click "Create Template" to get started.
            </div>
        `;
        return;
    }
    
    container.innerHTML = templates.map(template => `
        <div style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 0.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <strong>${template.name}</strong><br>
                    <small style="color: var(--text-secondary);">
                        ${template.questions.length} questions ‚Ä¢ ${template.estimatedTime} min ‚Ä¢ ${template.category}
                    </small>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary btn-sm" onclick="editTemplate('${template.id}')">Edit</button>
                    <button class="btn btn-primary btn-sm" onclick="duplicateTemplate('${template.id}')">Duplicate</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTemplate('${template.id}')">Delete</button>
                </div>
            </div>
        </div>
    `).join('');
}

// Edit existing template
function editTemplate(templateId) {
    const template = window.chatTemplates.find(t => t.id === templateId);
    if (!template) {
        showToast('Template not found', 'error');
        return;
    }
    
    // Create edit modal (similar to create but pre-filled)
    createChatTemplate();
    
    // Pre-fill the form after a short delay to ensure modal is rendered
    setTimeout(() => {
        document.getElementById('template-name').value = template.name;
        document.getElementById('template-description').value = template.description || '';
        document.getElementById('template-category').value = template.category;
        document.getElementById('template-time').value = template.estimatedTime;
        document.getElementById('template-intro').value = template.intro;
        document.getElementById('template-closing').value = template.closing;
        // ... fill other fields
        
        showToast('Editing template: ' + template.name, 'info');
    }, 100);
}

// Duplicate template
function duplicateTemplate(templateId) {
    const template = window.chatTemplates.find(t => t.id === templateId);
    if (!template) return;
    
    const duplicate = {
        ...template,
        id: 'template_' + Date.now(),
        name: template.name + ' (Copy)',
        createdAt: new Date().toISOString()
    };
    
    window.chatTemplates.push(duplicate);
    localStorage.setItem('chatTemplates', JSON.stringify(window.chatTemplates));
    
    refreshTemplatesList();
    showToast(`Template duplicated: ${duplicate.name}`, 'success');
}

// Delete template
function deleteTemplate(templateId) {
    if (!confirm('Are you sure you want to delete this template?')) return;
    
    const index = window.chatTemplates.findIndex(t => t.id === templateId);
    if (index > -1) {
        const name = window.chatTemplates[index].name;
        window.chatTemplates.splice(index, 1);
        localStorage.setItem('chatTemplates', JSON.stringify(window.chatTemplates));
        
        refreshTemplatesList();
        showToast(`Template deleted: ${name}`, 'success');
    }
}

// Function to load selected template details
function loadSelectedTemplate(templateId) {
    const infoDiv = document.getElementById('template-info');
    const hiddenField = document.getElementById('selected-template-data');
    
    if (!templateId) {
        infoDiv.style.display = 'none';
        hiddenField.value = '';
        document.getElementById('chat-welcome-msg').value = 'Welcome to our feedback chat! Your insights help us improve.';
        return;
    }
    
    const template = window.chatTemplates.find(t => t.id === templateId);
    if (!template) return;
    
    // Store template data
    hiddenField.value = JSON.stringify(template);
    
    // Update welcome message with template intro
    document.getElementById('chat-welcome-msg').value = template.intro;
    
    // Show template info
    infoDiv.style.display = 'block';
    infoDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <strong style="color: #0f766e;">${template.name}</strong>
                <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                    ${template.description || 'No description provided'}
                </div>
            </div>
            <button type="button" class="btn btn-sm" onclick="previewSelectedTemplate('${templateId}')">
                üëÅÔ∏è Preview
            </button>
        </div>
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e6fffa;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                <div>
                    <strong style="font-size: 0.75rem; color: #0f766e;">Questions:</strong>
                    <div style="font-size: 1.25rem; font-weight: bold;">${template.questions.length}</div>
                </div>
                <div>
                    <strong style="font-size: 0.75rem; color: #0f766e;">Est. Time:</strong>
                    <div style="font-size: 1.25rem; font-weight: bold;">${template.estimatedTime} min</div>
                </div>
                <div>
                    <strong style="font-size: 0.75rem; color: #0f766e;">Category:</strong>
                    <div style="font-size: 1.25rem; font-weight: bold;">${template.category}</div>
                </div>
                <div>
                    <strong style="font-size: 0.75rem; color: #0f766e;">AI Style:</strong>
                    <div style="font-size: 1.25rem; font-weight: bold;">${template.aiPersonality}</div>
                </div>
            </div>
        </div>
        <div style="margin-top: 1rem;">
            <strong style="font-size: 0.75rem; color: #0f766e;">Questions Preview:</strong>
            <ol style="margin: 0.5rem 0 0 1.5rem; font-size: 0.875rem;">
                ${template.questions.slice(0, 3).map(q => `
                    <li>${q.text} <span style="color: var(--text-secondary);">(${q.type})</span></li>
                `).join('')}
                ${template.questions.length > 3 ? `<li style="color: var(--text-secondary);">... and ${template.questions.length - 3} more</li>` : ''}
            </ol>
        </div>
    `;
    
    showToast(`Template loaded: ${template.name}`, 'success');
}

// Preview selected template
function previewSelectedTemplate(templateId) {
    const template = window.chatTemplates.find(t => t.id === templateId);
    if (!template) return;
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.zIndex = '10001';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Template Preview: ${template.name}</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div style="max-height: 500px; overflow-y: auto;">
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                    <div class="chat-preview-message bot">
                        <strong>ü§ñ AI:</strong> ${template.intro}
                    </div>
                    ${template.questions.map((q, i) => `
                        <div class="chat-preview-message bot" style="margin-top: 1rem;">
                            <strong>ü§ñ AI (Question ${i + 1}/${template.questions.length}):</strong> ${q.text}
                            ${getQuestionTypePreview(q.type)}
                        </div>
                        <div class="chat-preview-message user" style="margin-top: 0.5rem;">
                            <strong>üë§ User:</strong> <em style="color: var(--text-secondary);">[User would respond here]</em>
                        </div>
                        ${q.followup ? `
                            <div class="chat-preview-message bot" style="margin-top: 0.5rem;">
                                <strong>ü§ñ AI (Follow-up):</strong> ${q.followup}
                            </div>
                        ` : ''}
                    `).join('')}
                    <div class="chat-preview-message bot" style="margin-top: 1rem;">
                        <strong>ü§ñ AI:</strong> ${template.closing}
                    </div>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: #e6fffa; border-radius: 8px;">
                    <strong>Template Settings:</strong>
                    <ul style="margin: 0.5rem 0 0 1rem; font-size: 0.875rem;">
                        <li>AI Personality: ${template.aiPersonality}</li>
                        <li>Allow Skip: ${template.allowSkip ? 'Yes' : 'No'}</li>
                        <li>Show Progress: ${template.showProgress ? 'Yes' : 'No'}</li>
                        <li>Total Questions: ${template.questions.length}</li>
                    </ul>
                </div>
            </div>
            <div style="margin-top: 1rem; text-align: right;">
                <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Close Preview</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Function to manage templates
function manageTemplates() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.zIndex = '10001';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Manage Templates</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div>
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-primary" onclick="createChatTemplate(); this.closest('.modal').remove();">
                        + Create New Template
                    </button>
                </div>
                <div id="templates-list">
                    ${window.chatTemplates && window.chatTemplates.length > 0 ? 
                        window.chatTemplates.map(t => `
                            <div class="template-card">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <strong>${t.name}</strong>
                                        ${t.status === 'draft' ? '<span class="tag tag-pending">Draft</span>' : ''}
                                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                            ${t.questions.length} questions ‚Ä¢ ${t.estimatedTime} min ‚Ä¢ ${t.category}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-secondary btn-sm" onclick="editTemplate('${t.id}')">Edit</button>
                                        <button class="btn btn-primary btn-sm" onclick="duplicateTemplate('${t.id}')">Duplicate</button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteTemplate('${t.id}'); refreshManageTemplates();">Delete</button>
                                    </div>
                                </div>
                            </div>
                        `).join('') : 
                        '<div style="text-align: center; padding: 3rem; color: var(--text-secondary);">No templates created yet</div>'
                    }
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Refresh the manage templates modal
function refreshManageTemplates() {
    const templatesList = document.getElementById('templates-list');
    if (!templatesList) return;
    
    templatesList.innerHTML = window.chatTemplates && window.chatTemplates.length > 0 ? 
        window.chatTemplates.map(t => `
            <div class="template-card">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <strong>${t.name}</strong>
                        ${t.status === 'draft' ? '<span class="tag tag-pending">Draft</span>' : ''}
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                            ${t.questions.length} questions ‚Ä¢ ${t.estimatedTime} min ‚Ä¢ ${t.category}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary btn-sm" onclick="editTemplate('${t.id}')">Edit</button>
                        <button class="btn btn-primary btn-sm" onclick="duplicateTemplate('${t.id}')">Duplicate</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTemplate('${t.id}'); refreshManageTemplates();">Delete</button>
                    </div>
                </div>
            </div>
        `).join('') : 
        '<div style="text-align: center; padding: 3rem; color: var(--text-secondary);">No templates created yet</div>';
}

// DATABASE FORM HANDLERS

// Handle organization form submission
async function handleOrganizationUpdate(event) {
    event.preventDefault();
    
    const formData = {
        name: document.getElementById('org-name').value,
        industry: document.getElementById('org-industry').value,
        size: document.getElementById('org-size').value,
        country: document.getElementById('org-country').value,
        website: document.getElementById('org-website').value,
        description: document.getElementById('org-description').value,
        plan: document.getElementById('org-plan').value
    };
    
    try {
        const result = await saveOrganization(formData);
        showToast('Organization saved successfully!', 'success');
        closeModal('organization-settings-modal');
        loadOrganizationsData(); // Refresh the organizations table
    } catch (error) {
        console.error('Error saving organization:', error);
        showToast('Failed to save organization', 'error');
    }
}

// Handle user form submission (for adding users)
async function handleUserSubmit(event) {
    event.preventDefault();
    
    const formData = {
        name: document.getElementById('user-name').value,
        email: document.getElementById('user-email').value,
        organization: document.getElementById('user-org').value,
        role: document.getElementById('user-role').value || 'user'
    };
    
    try {
        const result = await saveUser(formData);
        showToast('User saved successfully!', 'success');
        closeModal('add-user-modal');
        loadUsersData(); // Refresh the users table
    } catch (error) {
        console.error('Error saving user:', error);
        showToast('Failed to save user', 'error');
    }
}

// Load organizations data from database
async function loadOrganizationsData() {
    try {
        const organizations = await loadOrganizations();
        const tbody = document.getElementById('organizations-table-body');
        
        if (organizations.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        No organizations found. Add your first organization to get started.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = organizations.map(org => `
            <tr onclick="showOrganizationDetails('${org.id}')">
                <td>${org.name}</td>
                <td><span class="tag tag-active">${org.plan || 'Basic'}</span></td>
                <td>0</td>
                <td><span class="tag tag-active">Active</span></td>
                <td>${new Date(org.created_at).toLocaleDateString()}</td>
                <td onclick="event.stopPropagation()">
                    <button class="btn btn-secondary btn-sm" onclick="handleEditOrganization('${org.id}')" data-translate="edit">Edit</button>
                    <button class="btn btn-warning btn-sm" onclick="handleSuspendOrganization('${org.id}')" data-translate="suspend">Suspend</button>
                    <button class="btn btn-danger btn-sm" onclick="handleDeleteOrganization('${org.id}')">Delete</button>
                </td>
            </tr>
        `).join('');
        
        // Update organization filter
        const filter = document.getElementById('organization-filter');
        if (filter) {
            filter.innerHTML = '<option value="">All Organizations</option>' + 
                organizations.map(org => `<option value="${org.id}">${org.name}</option>`).join('');
        }
        
    } catch (error) {
        console.error('Error loading organizations:', error);
        showToast('Failed to load organizations', 'error');
    }
}

// Load users data from database
async function loadUsersData() {
    try {
        const users = await loadUsers();
        const tbody = document.getElementById('users-table-body');
        
        if (users.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        No users found. Add your first user to get started.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = users.map(user => `
            <tr onclick="showUserDetails('${user.id}')">
                <td onclick="event.stopPropagation()"><input type="checkbox"></td>
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td>${user.organization || 'N/A'}</td>
                <td><span class="tag tag-active">${user.role || 'User'}</span></td>
                <td><span class="tag tag-${user.status === 'active' ? 'active' : 'pending'}">${user.status || 'Active'}</span></td>
                <td>${user.last_login || 'Never'}</td>
                <td onclick="event.stopPropagation()">
                    <button class="btn btn-secondary btn-sm" onclick="handleEditUser('${user.id}')" data-translate="edit">Edit</button>
                    <button class="btn btn-warning btn-sm" onclick="handleSuspendUser('${user.id}')" data-translate="suspend">Suspend</button>
                    <button class="btn btn-danger btn-sm" onclick="handleRemoveUser('${user.id}')">Remove</button>
                </td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading users:', error);
        showToast('Failed to load users', 'error');
    }
}

// Enhanced Chat Management Functions

function toggleDropdown(button) {
    const dropdown = button.nextElementSibling;
    const isVisible = dropdown.classList.contains('show');
    
    // Close all other dropdowns
    document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
        menu.classList.remove('show');
    });
    
    // Toggle current dropdown
    if (!isVisible) {
        dropdown.classList.add('show');
    }
    
    // Close dropdown when clicking outside
    if (!isVisible) {
        setTimeout(() => {
            document.addEventListener('click', function closeOnOutside(e) {
                if (!button.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                    document.removeEventListener('click', closeOnOutside);
                }
            });
        }, 0);
    }
}

function viewChannelAnalytics(channelId) {
    showToast(`Opening analytics for ${channelId} channel...`, 'info');
    // Implementation would load analytics dashboard
}

function pauseWidget(widgetId) {
    showToast(`Pausing ${widgetId} widget...`, 'info');
    // Implementation would pause the widget
    
    // Update UI to show paused state
    const widget = document.querySelector(`[onclick*="${widgetId}"]`)?.closest('.chat-widget-card');
    if (widget) {
        const statusTag = widget.querySelector('.tag');
        if (statusTag) {
            statusTag.textContent = 'PAUSED';
            statusTag.style.background = '#fef3c7';
            statusTag.style.color = '#92400e';
        }
        
        const activeCount = widget.querySelector('[data-active]');
        if (activeCount) {
            activeCount.textContent = 'üë• 0 active';
        }
    }
}

function resumeWidget(widgetId) {
    showToast(`Resuming ${widgetId} widget...`, 'info');
    // Implementation would resume the widget
    
    // Update UI to show live state
    const widget = document.querySelector(`[onclick*="${widgetId}"]`)?.closest('.chat-widget-card');
    if (widget) {
        const statusTag = widget.querySelector('.tag');
        if (statusTag) {
            statusTag.textContent = 'LIVE';
            statusTag.className = 'tag tag-success';
        }
    }
}

function duplicateWidget(widgetId) {
    showToast(`Duplicating ${widgetId} widget...`, 'info');
    // Implementation would create a copy of the widget
}

function exportWidget(widgetId) {
    showToast(`Exporting data from ${widgetId} widget...`, 'info');
    // Implementation would export widget data
}

function deleteWidget(widgetId) {
    if (confirm(`Are you sure you want to delete the ${widgetId} widget? This action cannot be undone.`)) {
        showToast(`Deleting ${widgetId} widget...`, 'warning');
        // Implementation would delete the widget
    }
}

function refreshChannels() {
    showToast('Refreshing channels...', 'info');
    // Implementation would refresh the channels list
    
    // Simulate refresh with loading animation
    const refreshBtn = document.querySelector('[onclick="refreshChannels()"]');
    const originalText = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<span style="margin-right: 0.25rem;">üîÑ</span>Refreshing...';
    refreshBtn.disabled = true;
    
    setTimeout(() => {
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
        showToast('Channels refreshed successfully', 'success');
    }, 1500);
}

function useTemplate(templateId) {
    showToast(`Using ${templateId} template...`, 'info');
    // Implementation would create a new widget based on the template
}

function previewTemplate(templateId) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Template Preview: ${templateId.charAt(0).toUpperCase() + templateId.slice(1)}</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                <div class="chat-preview-message bot">
                    <strong>AI:</strong> Welcome! I'd like to get your feedback on our ${templateId} experience.
                </div>
                <div class="chat-preview-message bot">
                    <strong>AI:</strong> How would you rate your overall experience? (Scale: 1-5)
                </div>
                <div class="chat-preview-message user">
                    <strong>You:</strong> 4
                </div>
                <div class="chat-preview-message bot">
                    <strong>AI:</strong> Thank you! What did you like most about your experience?
                </div>
                <div class="chat-preview-message user">
                    <strong>You:</strong> The service was quick and helpful.
                </div>
                <div class="chat-preview-message bot">
                    <strong>AI:</strong> Great! Is there anything we could improve?
                </div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                <button class="btn btn-primary" onclick="useTemplate('${templateId}'); this.closest('.modal').remove();">Use Template</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function exportAllData() {
    showToast('Preparing data export...', 'info');
    // Implementation would export all chat data
    
    setTimeout(() => {
        showToast('Export ready! Check your downloads folder.', 'success');
    }, 2000);
}

function viewActiveConversations() {
    showToast('Opening active conversations dashboard...', 'info');
    // Implementation would show active conversations
}

function generateWeeklyReport() {
    showToast('Generating weekly report...', 'info');
    // Implementation would generate and download weekly report
    
    setTimeout(() => {
        showToast('Weekly report generated successfully!', 'success');
    }, 3000);
}

// Initialize templates on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check for short URL redirect first
    handleShortUrlRedirect();
    
    loadTemplates();
    loadOrganizationsData();
    loadUsersData();
    
    // Load active chats
    loadActiveChatsList();
    
    // Initialize enhanced chat management features
    if (window.location.hash === '#chat-management') {
        showSection('chat-management');
    }
});

// Handle short URL redirects
async function handleShortUrlRedirect() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Check for ?chat=slug parameter
    const chatSlug = urlParams.get('chat');
    
    if (chatSlug) {
        try {
            const mapping = await loadUrlMapping(chatSlug);
            
            if (mapping && mapping.original_url) {
                // Redirect to the original chat URL
                window.location.href = mapping.original_url;
                return;
            }
        } catch (error) {
            console.error('Error handling chat slug redirect:', error);
        }
    }
    
    // Also check other URL parameters for slug-based routing
    const slugParam = urlParams.get('s') || urlParams.get('slug');
    
    if (slugParam) {
        try {
            const mapping = await loadUrlMapping(slugParam);
            
            if (mapping && mapping.original_url) {
                // Redirect to the original chat URL
                window.location.href = mapping.original_url;
                return;
            }
        } catch (error) {
            console.error('Error handling slug parameter redirect:', error);
        }
    }
}

// Load and display active chats
async function loadActiveChatsList() {
    try {
        // Try to load from database first
        let chatSessions = await loadChatSessions();
        
        // If database is empty, try localStorage as fallback
        if (chatSessions.length === 0) {
            chatSessions = loadChatSessionsFromLocalStorage();
        }
        
        // Filter out deleted chats
        chatSessions = chatSessions.filter(chat => chat.status !== 'deleted');
        
        const activeChatsContainer = document.getElementById('active-chats-list');
        const emptyState = activeChatsContainer.previousElementSibling;
        
        if (chatSessions.length === 0) {
            // Show empty state
            activeChatsContainer.style.display = 'none';
            emptyState.style.display = 'block';
        } else {
            // Show chat list
            emptyState.style.display = 'none';
            activeChatsContainer.style.display = 'block';
            
            // Generate chat items HTML
            activeChatsContainer.innerHTML = chatSessions.map(chat => `
                <div class="chat-item" style="
                    padding: 1rem; 
                    border: 1px solid var(--border-color); 
                    border-radius: 8px; 
                    margin-bottom: 1rem;
                    background: white;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.25rem;">
                                ${chat.type === 'listening' ? 'üëÇ' : chat.type === 'chat' ? 'üí¨' : 'üìä'}
                            </span>
                            <strong>${chat.name}</strong>
                            <span class="tag ${chat.status === 'active' ? 'tag-success' : 'tag-secondary'}" style="font-size: 0.75rem;">
                                ${chat.status?.toUpperCase() || 'ACTIVE'}
                            </span>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                            Type: ${chat.type === 'listening' ? 'Listening Chat' : chat.type === 'chat' ? 'Guided Chat' : 'Pulse Survey'}
                        </div>
                        ${chat.topics ? `
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                Topics: ${Array.isArray(chat.topics) ? chat.topics.join(', ') : chat.topics}
                            </div>
                        ` : ''}
                        ${chat.questions ? `
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                Questions: ${Array.isArray(chat.questions) ? chat.questions.length : 'N/A'} questions
                            </div>
                        ` : ''}
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">
                            Created: ${new Date(chat.created || chat.created_at).toLocaleDateString()}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button class="btn btn-secondary btn-sm" onclick="copyToClipboard('chat-link-${chat.id}', '${chat.link}')" title="Copy Link">üìã</button>
                        <button class="btn btn-secondary btn-sm" onclick="editChatSession('${chat.session_id || chat.id}')" title="Edit">‚úèÔ∏è</button>
                        <button class="btn btn-secondary btn-sm" onclick="testChatLink('${chat.link}')" title="Test">üîó</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteChatSession('${chat.session_id || chat.id}')" title="Delete">üóëÔ∏è</button>
                    </div>
                    <input type="hidden" id="chat-link-${chat.id}" value="${chat.link}">
                </div>
            `).join('');
        }
        
        console.log(`Loaded ${chatSessions.length} active chats`);
    } catch (error) {
        console.error('Error loading active chats:', error);
        showToast('Error loading active chats', 'error');
    }
}

// Copy link function for active chats
function copyToClipboard(elementId, link) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(link).then(() => {
            showToast('Link copied to clipboard!', 'success');
        }).catch(err => {
            console.error('Failed to copy link:', err);
            fallbackCopyTextToClipboard(link);
        });
    } else {
        fallbackCopyTextToClipboard(link);
    }
}

function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.top = '0';
    textArea.style.left = '0';
    textArea.style.position = 'fixed';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
        document.execCommand('copy');
        showToast('Link copied to clipboard!', 'success');
    } catch (err) {
        showToast('Failed to copy link', 'error');
    }
    document.body.removeChild(textArea);
}

// Edit chat session (placeholder)
function editChatSession(sessionId) {
    showToast('Edit functionality coming soon!', 'info');
    // TODO: Implement edit functionality
}

// Delete chat session
async function deleteChatSession(sessionId) {
    if (confirm('Are you sure you want to delete this chat session? This action cannot be undone.')) {
        try {
            await updateChatSessionStatus(sessionId, 'deleted');
            showToast('Chat session deleted successfully', 'success');
            loadActiveChatsList(); // Refresh the list
        } catch (error) {
            console.error('Error deleting chat session:', error);
            showToast('Error deleting chat session', 'error');
        }
    }
}
</script>
</body>
</html>