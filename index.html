<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realworld Employee Survey Platform</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        /* Fix dropdown visibility issues */
        .dropdown-menu {
            position: absolute !important;
            z-index: 9999 !important;
            background: white !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            min-width: 200px !important;
            padding: 8px 0 !important;
            top: 100% !important;
            right: 0 !important;
        }
        
        .dropdown-menu[style*="display: block"] {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .dropdown-item {
            width: 100% !important;
            text-align: left !important;
            padding: 0.75rem 1rem !important;
            border: none !important;
            background: none !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            gap: 0.5rem !important;
            font-size: 0.875rem !important;
            color: #1e293b !important;
        }
        
        .dropdown-item:hover {
            background-color: #f8f9fa !important;
        }

        /* Adaptable Logo Styles - NEW ADDITION */
        .logo-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin-right: 0.5rem;
            transition: all 0.3s ease;
        }

        .logo-icon.has-default {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .logo-icon.has-custom {
            background: transparent !important;
            width: auto;
            max-width: 150px;
            height: 45px;
        }

        .login-header .logo-icon.has-custom {
            width: auto;
            max-width: 200px;
            height: 60px;
            margin-bottom: 1rem;
        }

        .sidebar .logo {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            font-weight: bold;
            font-size: 1.25rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar .logo-icon.has-custom {
            max-width: 120px;
            height: 40px;
        }

        /* Ensure images scale properly */
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        /* END Adaptable Logo Styles */

        .chat-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .chat-window {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 500px;
            height: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            background: var(--primary-color);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        
        .chat-header h2 {
            margin: 0;
            font-size: 1.25rem;
        }
        
        .chat-header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
            font-size: 0.875rem;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: #f8f9fa;
        }
        
        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid #e0e0e0;
            background: white;
        }
        
        .chat-input-group {
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 24px;
            outline: none;
            font-size: 0.875rem;
        }
        
        .chat-send-btn {
            padding: 0.75rem 1.5rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .chat-send-btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }
        
        .message {
            margin-bottom: 1rem;
            animation: slideIn 0.3s ease-out;
        }
        
        .message.user {
            text-align: right;
        }
        
        .message-bubble {
            display: inline-block;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .message.bot .message-bubble {
            background: white;
            color: #333;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .message.user .message-bubble {
            background: var(--primary-color);
            color: white;
        }
        
        .typing-indicator {
            display: none;
            padding: 0.75rem 1rem;
            background: white;
            border-radius: 12px;
            display: inline-block;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .typing-indicator.show {
            display: inline-block;
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* ENHANCED CHAT FEEDBACK STYLES */
        .feedback-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .view-toggle {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-secondary);
            padding: 0.25rem;
            border-radius: 6px;
        }
        
        .view-toggle button {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .view-toggle button.active {
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .sentiment-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .sentiment-positive {
            background: var(--bg-secondary);
            color: var(--success-color);
            border-left: 3px solid var(--success-color);
        }

        .sentiment-neutral {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-left: 3px solid var(--text-secondary);
        }

        .sentiment-negative {
            background: var(--bg-secondary);
            color: var(--danger-color);
            border-left: 3px solid var(--danger-color);
        }
        
        .priority-indicator {
            width: 4px;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            border-radius: 4px 0 0 4px;
        }
        
        .priority-high {
            background: var(--danger-color);
        }
        
        .priority-medium {
            background: var(--warning-color);
        }
        
        .priority-low {
            background: var(--success-color);
        }
        
        .feedback-item {
            position: relative;
            padding: 1rem 1rem 1rem 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .feedback-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }
        
        .feedback-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .feedback-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .action-btn {
            padding: 0.25rem 0.5rem;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
        }
        
        .action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .response-box {
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            border-left: 3px solid var(--primary-color);
        }
        
        .keyword-tag {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--primary-color);
            color: white;
            border-radius: 4px;
            font-size: 0.625rem;
            margin-right: 0.25rem;
        }
        /* END ENHANCED STYLES */

        /* NEW CHAT TYPE SELECTION STYLES */
        .chat-type-option {
            position: relative;
            transition: all 0.3s ease;
        }

        .chat-type-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .chat-type-option input[type="radio"] {
            position: absolute;
            top: 1rem;
            right: 1rem;
            transform: scale(1.2);
        }

        .chat-type-option.selected {
            border-color: var(--primary-color) !important;
            background: #f0f9ff !important;
        }

        /* Participant Management Styles */
        .participants-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
        }

        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            transition: all 0.2s;
        }

        .participant-item:hover {
            background: #e0e7ff;
        }

        .participant-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--primary-color);
            color: white;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Response Tracking Styles */
        .response-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .response-indicator.responded {
            background: var(--bg-secondary);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .response-indicator.pending {
            background: var(--bg-secondary);
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
        }

        .response-indicator.expired {
            background: var(--bg-secondary);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        /* Link Display Styles */
        .link-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .link-display input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.875rem;
            background: white;
        }

        .link-display button {
            padding: 0.5rem 1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .link-display button:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        /* Info Cards */
        .info-card {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .info-card.success {
            background: var(--bg-secondary);
            border-left: 4px solid var(--success-color);
            border: 1px solid var(--border-color);
        }

        .info-card.warning {
            background: var(--bg-secondary);
            border-left: 4px solid var(--warning-color);
            border: 1px solid var(--border-color);
        }

        .info-card.info {
            background: var(--bg-secondary);
            border-left: 4px solid var(--primary-color);
            border: 1px solid var(--border-color);
        }

        /* Chat Session Cards */
        .chat-session-card {
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .chat-session-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .chat-session-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .chat-session-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chat-session-type {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .chat-session-type.continuous {
            background: #e0f2fe;
            color: #0369a1;
        }

        .chat-session-type.personal {
            background: #fce7f3;
            color: #a21caf;
        }

        .chat-session-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .chat-stat {
            text-align: center;
        }

        .chat-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .chat-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Progress Bars */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary-color);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Action Buttons Grid */
        .action-buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .action-btn-small {
            padding: 0.5rem;
            font-size: 0.875rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .action-btn-small:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        /* Modal Overlay Enhancement */
        .modal {
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Design for Chat Widgets */
        @media (max-width: 768px) {
            .chat-type-option {
                grid-column: span 2;
            }
            
            .action-buttons-grid {
                grid-template-columns: 1fr;
            }
            
            .chat-session-stats {
                grid-template-columns: 1fr 1fr;
            }
        }
        /* END NEW CHAT TYPE SELECTION STYLES */

        /* TEMPLATE BUILDER STYLES */
        .template-question-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .template-question-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .question-number {
            font-weight: 600;
            color: var(--primary-color);
        }

        .question-content {
            padding: 1rem;
        }

        .question-options {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
        }

        /* Template Card Styles */
        .template-card {
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
            background: white;
        }

        .template-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .template-category-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--primary-color);
            color: white;
            border-radius: 4px;
            font-size: 0.625rem;
            margin-left: 0.5rem;
        }

        /* Chat Preview Styles */
        .chat-preview-message {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
        }

        .chat-preview-message.bot {
            background: white;
            border: 1px solid #e5e7eb;
            margin-right: 2rem;
        }

        /* Enhanced Chat Management Styles */
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .stat-change {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #dc2626;
        }

        .chat-widget-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .chat-widget-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .chat-widget-card.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .dropdown-menu {
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            transform: translateY(-5px);
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-menu a:hover {
            background-color: #f3f4f6;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        .template-card {
            transition: all 0.2s ease;
        }

        .template-card:hover {
            transform: translateY(-1px);
            border-color: var(--primary-color);
        }

        /* Activity feed styles */
        .activity-item {
            transition: all 0.2s ease;
        }

        .activity-item:hover {
            background-color: rgba(59, 130, 246, 0.05);
        }

        .chat-preview-message.user {
            background: #f0f9ff;
            border: 1px solid #bfdbfe;
            margin-left: 2rem;
            text-align: right;
        }

        /* Question Type Indicator */
        .question-type-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #e0e7ff;
            color: #4338ca;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Template Selection Styles */
        .template-select-card {
            padding: 1rem;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
        }

        .template-select-card:hover {
            border-color: var(--primary-color);
            background: #f0f9ff;
        }

        .template-select-card.selected {
            border-color: var(--primary-color);
            background: #e0f2fe;
        }

        /* AI Personality Badges */
        .ai-personality-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .ai-personality-professional {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .ai-personality-friendly {
            background: var(--bg-secondary);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .ai-personality-casual {
            background: var(--bg-secondary);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .ai-personality-formal {
            background: var(--bg-secondary);
            color: var(--secondary-color);
            border: 1px solid var(--secondary-color);
        }

        .ai-personality-empathetic {
            background: var(--bg-secondary);
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
        }

        /* Template Stats Grid */
        .template-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .template-stat {
            text-align: center;
        }

        .template-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .template-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Template Quick Actions */
        .template-quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .template-quick-action {
            padding: 0.25rem 0.5rem;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .template-quick-action:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Question Builder Animations */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .template-question-item {
            animation: slideDown 0.3s ease-out;
        }

        /* Drag and Drop Styles (for future implementation) */
        .question-dragging {
            opacity: 0.5;
        }

        .question-drag-over {
            border-top: 3px solid var(--primary-color);
        }

        /* Template Info Box */
        .template-info-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .template-info-box h3 {
            margin: 0 0 0.5rem 0;
        }

        .template-info-box p {
            margin: 0;
            opacity: 0.95;
        }

        /* Question Type Icons */
        .question-type-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }

        /* Template Category Colors */
        .template-category-general {
            background: var(--secondary-color);
            color: white;
        }

        .template-category-satisfaction {
            background: var(--success-color);
            color: white;
        }

        .template-category-employee {
            background: var(--primary-color);
            color: white;
        }

        .template-category-product {
            background: var(--warning-color);
            color: white;
        }

        .template-category-service {
            background: var(--danger-color);
            color: white;
        }

        .template-category-event {
            background: var(--text-primary);
            color: white;
        }

        .template-category-custom {
            background: var(--success-color);
            color: white;
        }

        /* Template List View */
        .template-list-view {
            display: grid;
            gap: 1rem;
        }

        .template-grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        /* Template Search Bar */
        .template-search {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .template-search input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        .template-search button {
            padding: 0.5rem 1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        /* Responsive Design for Templates */
        @media (max-width: 768px) {
            .template-stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .template-grid-view {
                grid-template-columns: 1fr;
            }
            
            .chat-preview-message.bot {
                margin-right: 0;
            }
            
            .chat-preview-message.user {
                margin-left: 0;
            }
        }
        /* END TEMPLATE BUILDER STYLES */
        
        /* Enhanced Navigation Layout - Better spacing after Keep Listening removal */
        .nav-section {
            margin-bottom: 3rem !important;
            padding: 1.5rem 0;
            border-bottom: 1px solid rgba(226, 232, 240, 0.3);
        }
        
        .nav-section:last-child {
            border-bottom: none;
        }
        
        .nav-title {
            font-size: 1rem !important;
            font-weight: 700 !important;
            margin-bottom: 1.5rem !important;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            color: var(--text-primary) !important;
            text-transform: none !important;
        }
        
        .nav-item {
            padding: 1rem 1.25rem !important;
            margin-bottom: 0.75rem !important;
            font-weight: 500;
            font-size: 0.95rem;
            border-radius: 10px !important;
            transition: all 0.3s ease !important;
        }
        
        .nav-item:hover {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%) !important;
            transform: translateX(4px) !important;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15) !important;
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1d4ed8 100%) !important;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3) !important;
            transform: translateX(2px) !important;
        }
        
        .nav-icon {
            width: 24px !important;
            height: 24px !important;
            margin-right: 16px !important;
            font-size: 1.1rem;
        }
        
        /* Better sidebar spacing */
        .sidebar {
            padding: 2rem !important;
        }
        
        .sidebar nav {
            margin-top: 2rem;
        }
        
        /* CSS GRID ORGANIZATIONS TABLE */
        .organizations-grid-container {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1.5fr 2fr; /* Organization, Users, Status, Date, Actions */
            grid-auto-flow: row;
            gap: 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        
        .org-grid-header {
            background: var(--bg-secondary);
            padding: 1rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            min-height: 60px;
        }
        
        .org-grid-header:last-child {
            border-right: none;
        }
        
        .org-grid-cell {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            min-height: 60px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .org-grid-cell:last-child {
            border-right: none;
            cursor: default;
        }
        
        .org-grid-cell:nth-child(5n+1):hover,
        .org-grid-cell:nth-child(5n+1):hover + .org-grid-cell,
        .org-grid-cell:nth-child(5n+1):hover + .org-grid-cell + .org-grid-cell,
        .org-grid-cell:nth-child(5n+1):hover + .org-grid-cell + .org-grid-cell + .org-grid-cell,
        .org-grid-cell:nth-child(5n+1):hover + .org-grid-cell + .org-grid-cell + .org-grid-cell + .org-grid-cell {
            background: var(--bg-secondary);
        }
        
        
        .org-grid-empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
        }
        
        /* Individual column classes */
        .org-grid-cell-1 { grid-column: 1; } /* Organization Name */
        .org-grid-cell-2 { grid-column: 2; } /* Users */
        .org-grid-cell-3 { grid-column: 3; } /* Status */
        .org-grid-cell-4 { grid-column: 4; } /* Last Activity */
        .org-grid-cell-5 { grid-column: 5; } /* Actions */

        /* Recipients Management Navigation Styles */
        .recipients-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
        }

        .breadcrumb-link {
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
        }

        .breadcrumb-link:hover {
            color: var(--primary-hover);
            text-decoration: underline;
        }

        .breadcrumb-item.current {
            color: var(--text-primary);
            font-weight: 500;
        }

        .breadcrumb-separator {
            margin: 0 0.25rem;
            color: var(--text-secondary);
        }

        .back-arrow {
            display: flex;
            align-items: center;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .back-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .back-icon {
            font-size: 1rem;
            font-weight: bold;
        }

        .manage-recipients-container {
            padding: 0 1rem;
        }

        .recipients-header {
            margin-bottom: 2rem;
        }

        /* ============================================== */
        /* SURVEY BUILDER STYLES - START                  */
        /* ============================================== */

        /* Survey Builder Root Variables */
        .survey-builder-container {
            --sb-primary: #673ab7;
            --sb-primary-light: #ede7f6;
            --sb-background: #f0ebf8;
            --sb-surface: #ffffff;
            --sb-text: #202124;
            --sb-text-secondary: #5f6368;
            --sb-border: #dadce0;
            --sb-error: #d93025;
            --sb-success: #1e8e3e;
            font-family: 'Google Sans', 'Segoe UI', Roboto, sans-serif;
        }

        .survey-builder-container .sb-hidden { display: none !important; }
        .survey-builder-container .sb-flex { display: flex; }
        .survey-builder-container .sb-flex-col { flex-direction: column; }
        .survey-builder-container .sb-items-center { align-items: center; }
        .survey-builder-container .sb-justify-between { justify-content: space-between; }
        .survey-builder-container .sb-justify-center { justify-content: center; }
        .survey-builder-container .sb-gap-8 { gap: 8px; }
        .survey-builder-container .sb-gap-12 { gap: 12px; }
        .survey-builder-container .sb-gap-16 { gap: 16px; }
        .survey-builder-container .sb-gap-24 { gap: 24px; }

        /* Survey Builder Card Styles */
        .survey-builder-container .sb-card {
            background: var(--sb-surface);
            border-radius: 8px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            overflow: hidden;
        }

        /* Survey Builder Button Styles */
        .survey-builder-container .sb-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s;
        }

        .survey-builder-container .sb-btn-primary {
            background: var(--sb-primary);
            color: white;
        }

        .survey-builder-container .sb-btn-primary:hover {
            opacity: 0.9;
        }

        .survey-builder-container .sb-btn-secondary {
            background: transparent;
            color: var(--sb-text-secondary);
            border: 1px solid var(--sb-border);
        }

        .survey-builder-container .sb-btn-secondary:hover {
            background: var(--sb-primary-light);
        }

        .survey-builder-container .sb-btn-text {
            background: transparent;
            color: var(--sb-primary);
            padding: 8px 16px;
        }

        .survey-builder-container .sb-btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--sb-text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .survey-builder-container .sb-btn-icon:hover {
            background: rgba(0,0,0,0.05);
        }

        .survey-builder-container .sb-btn-icon.active {
            background: var(--sb-primary-light);
            color: var(--sb-primary);
        }

        .survey-builder-container .sb-btn-icon.danger:hover {
            color: var(--sb-error);
        }

        /* Survey Builder Input Styles */
        .survey-builder-container .sb-input {
            width: 100%;
            padding: 12px 0;
            border: none;
            border-bottom: 1px solid var(--sb-border);
            font-size: 14px;
            font-family: inherit;
            color: var(--sb-text);
            background: transparent;
            outline: none;
            transition: border-color 0.2s;
        }

        .survey-builder-container .sb-input:focus {
            border-bottom-color: var(--sb-primary);
        }

        .survey-builder-container .sb-input-title {
            font-size: 32px;
            font-weight: 400;
        }

        .survey-builder-container .sb-input-lg {
            font-size: 16px;
        }

        .survey-builder-container .sb-select {
            padding: 12px;
            border: 1px solid var(--sb-border);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            cursor: pointer;
            outline: none;
        }

        .survey-builder-container .sb-select:focus {
            border-color: var(--sb-primary);
        }

        .survey-builder-container textarea.sb-input {
            resize: vertical;
            min-height: 60px;
        }

        /* Survey Builder Toggle Switch */
        .survey-builder-container .sb-toggle {
            position: relative;
            width: 48px;
            height: 24px;
            cursor: pointer;
        }

        .survey-builder-container .sb-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .survey-builder-container .sb-toggle-slider {
            position: absolute;
            inset: 0;
            background: var(--sb-border);
            border-radius: 12px;
            transition: background 0.2s;
        }

        .survey-builder-container .sb-toggle-slider::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: left 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .survey-builder-container .sb-toggle input:checked + .sb-toggle-slider {
            background: var(--sb-primary);
        }

        .survey-builder-container .sb-toggle input:checked + .sb-toggle-slider::before {
            left: 26px;
        }

        /* Survey Builder Dashboard */
        .survey-builder-container #sb-dashboard-view {
            min-height: calc(100vh - 200px);
            background: #f1f3f4;
        }

        .survey-builder-container .sb-dashboard-header {
            background: var(--sb-surface);
            border-bottom: 1px solid var(--sb-border);
            padding: 12px 24px;
        }

        .survey-builder-container .sb-dashboard-header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .survey-builder-container .sb-logo {
            width: 40px;
            height: 40px;
            background: #673ab7;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }

        .survey-builder-container .sb-dashboard-title {
            font-size: 22px;
            color: var(--sb-text-secondary);
            font-weight: 400;
        }

        .survey-builder-container .sb-dashboard-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        .survey-builder-container .sb-dashboard-section-title {
            font-size: 24px;
            font-weight: 400;
            margin-bottom: 32px;
        }

        .survey-builder-container .sb-surveys-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 24px;
        }

        /* Survey Card */
        .survey-builder-container .sb-survey-card {
            cursor: pointer;
            transition: box-shadow 0.2s;
        }

        .survey-builder-container .sb-survey-card:hover {
            box-shadow: 0 2px 4px 0 rgba(60,64,67,0.3), 0 3px 6px 2px rgba(60,64,67,0.15);
        }

        .survey-builder-container .sb-survey-card-header {
            height: 8px;
            background: var(--sb-primary);
        }

        .survey-builder-container .sb-survey-card-body {
            padding: 20px;
        }

        .survey-builder-container .sb-survey-card-title {
            font-size: 16px;
            font-weight: 400;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .survey-builder-container .sb-survey-card-meta {
            font-size: 12px;
            color: var(--sb-text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .survey-builder-container .sb-survey-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .survey-builder-container .sb-survey-card-action {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border: 1px solid var(--sb-border);
            border-radius: 16px;
            background: transparent;
            cursor: pointer;
            font-size: 12px;
            color: var(--sb-text-secondary);
            font-family: inherit;
            transition: all 0.2s;
        }

        .survey-builder-container .sb-survey-card-action:hover {
            background: var(--sb-primary-light);
        }

        .survey-builder-container .sb-survey-card-action.copied {
            background: var(--sb-primary-light);
            color: var(--sb-primary);
        }

        /* New Survey Card */
        .survey-builder-container .sb-new-survey-card {
            border: 2px dashed var(--sb-border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
            cursor: pointer;
            transition: border-color 0.2s;
            background: white;
            border-radius: 8px;
        }

        .survey-builder-container .sb-new-survey-card:hover {
            border-color: var(--sb-primary);
        }

        .survey-builder-container .sb-new-survey-card svg {
            color: #673ab7;
            margin-bottom: 8px;
        }

        /* Survey Builder View */
        .survey-builder-container #sb-builder-view {
            min-height: calc(100vh - 200px);
            background: var(--sb-background);
        }

        .survey-builder-container .sb-builder-header {
            background: var(--sb-surface);
            border-bottom: 1px solid var(--sb-border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .survey-builder-container .sb-builder-header-top {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .survey-builder-container .sb-builder-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .survey-builder-container .sb-builder-back {
            display: flex;
            align-items: center;
            gap: 8px;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--sb-text-secondary);
            font-size: 14px;
            font-family: inherit;
        }

        .survey-builder-container .sb-builder-survey-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .survey-builder-container .sb-builder-survey-icon {
            width: 32px;
            height: 32px;
            background: var(--sb-primary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .survey-builder-container .sb-builder-survey-name {
            font-size: 16px;
            color: var(--sb-text);
        }

        .survey-builder-container .sb-builder-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .survey-builder-container .sb-builder-tabs {
            display: flex;
            justify-content: center;
            border-top: 1px solid var(--sb-border);
        }

        .survey-builder-container .sb-builder-tab {
            padding: 16px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--sb-text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s;
        }

        .survey-builder-container .sb-builder-tab.active {
            color: var(--sb-primary);
            border-bottom-color: var(--sb-primary);
        }

        .survey-builder-container .sb-builder-content {
            display: flex;
        }

        /* Page Sidebar */
        .survey-builder-container .sb-page-sidebar {
            width: 160px;
            background: var(--sb-surface);
            border-right: 1px solid var(--sb-border);
            height: calc(100vh - 200px);
            position: sticky;
            top: 120px;
            overflow-y: auto;
            padding: 16px 8px;
            flex-shrink: 0;
        }

        .survey-builder-container .sb-page-sidebar-title {
            font-size: 12px;
            font-weight: 500;
            color: var(--sb-text-secondary);
            margin-bottom: 12px;
            padding: 0 8px;
        }

        .survey-builder-container .sb-page-thumbnail {
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: grab;
            border: 2px solid transparent;
            transition: all 0.15s;
        }

        .survey-builder-container .sb-page-thumbnail:hover {
            background: rgba(0,0,0,0.02);
        }

        .survey-builder-container .sb-page-thumbnail.active {
            background: var(--sb-primary-light);
            border-color: var(--sb-primary);
        }

        .survey-builder-container .sb-page-thumbnail.drag-over {
            border: 2px dashed var(--sb-primary);
        }

        .survey-builder-container .sb-page-thumbnail-preview {
            background: var(--sb-surface);
            border: 1px solid var(--sb-border);
            border-radius: 4px;
            padding: 8px;
            min-height: 60px;
            position: relative;
        }

        .survey-builder-container .sb-page-thumbnail-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--sb-primary);
            border-radius: 4px 4px 0 0;
        }

        .survey-builder-container .sb-page-thumbnail-content {
            padding-top: 8px;
        }

        .survey-builder-container .sb-page-thumbnail-line {
            height: 3px;
            background: var(--sb-border);
            border-radius: 2px;
            margin-bottom: 4px;
        }

        .survey-builder-container .sb-page-thumbnail-line.w-80 { width: 80%; }
        .survey-builder-container .sb-page-thumbnail-line.w-60 { width: 60%; }

        .survey-builder-container .sb-page-thumbnail-question {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 3px;
        }

        .survey-builder-container .sb-page-thumbnail-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            border: 1px solid var(--sb-text-secondary);
        }

        .survey-builder-container .sb-page-thumbnail-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 6px;
        }

        .survey-builder-container .sb-page-thumbnail-label {
            font-size: 11px;
            color: var(--sb-text);
        }

        .survey-builder-container .sb-page-thumbnail.active .sb-page-thumbnail-label {
            color: var(--sb-primary);
        }

        .survey-builder-container .sb-page-thumbnail-delete {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 2px;
            color: var(--sb-text-secondary);
            opacity: 0.6;
        }

        .survey-builder-container .sb-page-thumbnail-count {
            font-size: 9px;
            color: var(--sb-text-secondary);
        }

        .survey-builder-container .sb-add-page-btn {
            width: 100%;
            padding: 12px 8px;
            border: 1px dashed var(--sb-border);
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: var(--sb-text-secondary);
            font-size: 12px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .survey-builder-container .sb-add-page-btn:hover {
            border-color: var(--sb-primary);
            color: var(--sb-primary);
        }

        /* Builder Main */
        .survey-builder-container .sb-builder-main {
            flex: 1;
            max-width: 768px;
            margin: 0 auto;
            padding: 24px 16px 100px;
        }

        /* Header Card */
        .survey-builder-container .sb-header-card {
            margin-bottom: 16px;
            border-left: 6px solid transparent;
            transition: border-color 0.2s;
        }

        .survey-builder-container .sb-header-card:focus-within {
            border-left-color: var(--sb-primary);
        }

        .survey-builder-container .sb-header-card-top {
            height: 10px;
            background: var(--sb-primary);
        }

        .survey-builder-container .sb-header-card-body {
            padding: 24px;
        }

        /* Page Instructions Card */
        .survey-builder-container .sb-page-card {
            margin-bottom: 16px;
            border-left: 6px solid transparent;
        }

        .survey-builder-container .sb-page-card:focus-within {
            border-left-color: var(--sb-primary);
        }

        .survey-builder-container .sb-page-card-header {
            padding: 20px 24px;
            background: var(--sb-primary-light);
        }

        .survey-builder-container .sb-page-card-header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .survey-builder-container .sb-page-card-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--sb-primary);
        }

        .survey-builder-container .sb-page-logic-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border: 1px solid var(--sb-border);
            border-radius: 16px;
            background: transparent;
            cursor: pointer;
            font-size: 12px;
            color: var(--sb-text-secondary);
            font-family: inherit;
            transition: all 0.2s;
        }

        .survey-builder-container .sb-page-logic-btn.active {
            border-color: var(--sb-primary);
            background: var(--sb-primary-light);
            color: var(--sb-primary);
        }

        .survey-builder-container .sb-page-logic-panel {
            padding: 16px 24px;
            background: var(--sb-surface);
            border-top: 1px solid var(--sb-border);
        }

        .survey-builder-container .sb-page-logic-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .survey-builder-container .sb-page-logic-title span {
            font-weight: 500;
            font-size: 14px;
        }

        .survey-builder-container .sb-page-logic-title small {
            font-size: 12px;
            color: var(--sb-text-secondary);
        }

        .survey-builder-container .sb-logic-rule {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding: 12px;
            background: var(--sb-primary-light);
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .survey-builder-container .sb-logic-rule-label {
            font-size: 13px;
            color: var(--sb-text-secondary);
        }

        .survey-builder-container .sb-logic-rule select {
            padding: 8px 12px;
            border: 1px solid var(--sb-border);
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
            min-width: 150px;
        }

        .survey-builder-container .sb-add-logic-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: 1px dashed var(--sb-border);
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
            font-size: 13px;
            color: var(--sb-primary);
            font-family: inherit;
        }

        .survey-builder-container .sb-add-logic-btn:hover {
            border-color: var(--sb-primary);
        }

        .survey-builder-container .sb-logic-help {
            font-size: 12px;
            color: var(--sb-text-secondary);
            margin-top: 8px;
        }

        /* Question Card */
        .survey-builder-container .sb-question-card {
            margin-bottom: 16px;
            border-left: 6px solid transparent;
            transition: all 0.2s;
        }

        .survey-builder-container .sb-question-card:focus-within {
            border-left-color: var(--sb-primary);
        }

        .survey-builder-container .sb-question-card.dragging {
            opacity: 0.5;
        }

        .survey-builder-container .sb-question-card.drag-over {
            border: 2px dashed var(--sb-primary);
            transform: scale(1.01);
        }

        .survey-builder-container .sb-question-drag-handle {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
            background: var(--sb-primary-light);
            cursor: grab;
            border-bottom: 1px solid var(--sb-border);
            gap: 4px;
        }

        .survey-builder-container .sb-question-drag-handle span {
            font-size: 11px;
            color: var(--sb-text-secondary);
        }

        .survey-builder-container .sb-question-body {
            padding: 24px 24px 16px;
        }

        .survey-builder-container .sb-question-header {
            display: flex;
            gap: 24px;
            margin-bottom: 16px;
        }

        .survey-builder-container .sb-question-text-input {
            flex: 1;
        }

        /* Question Type Selector */
        .survey-builder-container .sb-question-type-selector {
            position: relative;
        }

        .survey-builder-container .sb-question-type-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border: 1px solid var(--sb-border);
            border-radius: 4px;
            background: var(--sb-surface);
            cursor: pointer;
            min-width: 200px;
            font-size: 14px;
            color: var(--sb-text);
            font-family: inherit;
        }

        .survey-builder-container .sb-question-type-btn svg:last-child {
            margin-left: auto;
            transition: transform 0.2s;
        }

        .survey-builder-container .sb-question-type-btn.open svg:last-child {
            transform: rotate(90deg);
        }

        .survey-builder-container .sb-question-type-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: var(--sb-surface);
            border-radius: 8px;
            box-shadow: 0 2px 6px 2px rgba(60,64,67,0.15), 0 1px 2px 0 rgba(60,64,67,0.3);
            min-width: 200px;
            z-index: 100;
            overflow: hidden;
        }

        .survey-builder-container .sb-question-type-option {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            color: var(--sb-text);
            font-family: inherit;
            text-align: left;
        }

        .survey-builder-container .sb-question-type-option:hover,
        .survey-builder-container .sb-question-type-option.selected {
            background: var(--sb-primary-light);
        }

        /* Options Editor */
        .survey-builder-container .sb-options-editor {
            margin-top: 16px;
        }

        .survey-builder-container .sb-option-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .survey-builder-container .sb-option-icon {
            width: 20px;
            height: 20px;
            border: 2px solid var(--sb-text-secondary);
            border-radius: 50%;
            flex-shrink: 0;
        }

        .survey-builder-container .sb-option-icon.checkbox {
            border-radius: 2px;
        }

        .survey-builder-container .sb-option-input {
            flex: 1;
            padding: 8px 0;
            border: none;
            border-bottom: 1px solid transparent;
            font-size: 14px;
            font-family: inherit;
            color: var(--sb-text);
            background: transparent;
            outline: none;
        }

        .survey-builder-container .sb-option-input:focus {
            border-bottom-color: var(--sb-border);
        }

        .survey-builder-container .sb-add-option-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            color: var(--sb-text-secondary);
            font-family: inherit;
        }

        .survey-builder-container .sb-add-option-btn:hover {
            color: var(--sb-primary);
        }

        .survey-builder-container .sb-add-option-label {
            border-bottom: 1px solid var(--sb-border);
            padding-bottom: 4px;
        }

        /* Rating Scale Preview */
        .survey-builder-container .sb-rating-preview {
            margin-top: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .survey-builder-container .sb-rating-label {
            font-size: 14px;
            color: var(--sb-text-secondary);
        }

        .survey-builder-container .sb-rating-points {
            display: flex;
            gap: 24px;
        }

        .survey-builder-container .sb-rating-point {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .survey-builder-container .sb-rating-point-value {
            font-size: 12px;
            color: var(--sb-text-secondary);
        }

        .survey-builder-container .sb-rating-point-circle {
            width: 20px;
            height: 20px;
            border: 2px solid var(--sb-text-secondary);
            border-radius: 50%;
        }

        /* Question Footer */
        .survey-builder-container .sb-question-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 12px 16px;
            border-top: 1px solid var(--sb-border);
            gap: 4px;
        }

        .survey-builder-container .sb-question-footer-divider {
            width: 1px;
            height: 32px;
            background: var(--sb-border);
            margin: 0 8px;
        }

        .survey-builder-container .sb-required-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .survey-builder-container .sb-required-label {
            font-size: 14px;
            color: var(--sb-text);
        }

        /* Question Logic Panel */
        .survey-builder-container .sb-question-logic-panel {
            padding: 16px 24px;
            background: var(--sb-primary-light);
            border-top: 1px solid var(--sb-border);
        }

        /* Empty State */
        .survey-builder-container .sb-empty-state {
            padding: 48px;
            text-align: center;
        }

        .survey-builder-container .sb-empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .survey-builder-container .sb-empty-state-text {
            color: var(--sb-text-secondary);
            margin-bottom: 16px;
        }

        /* Page Navigation */
        .survey-builder-container .sb-page-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            margin-top: 24px;
        }

        .survey-builder-container .sb-page-nav-btn {
            padding: 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            color: var(--sb-text-secondary);
            border-radius: 50%;
        }

        .survey-builder-container .sb-page-nav-btn:disabled {
            color: var(--sb-border);
            cursor: not-allowed;
        }

        .survey-builder-container .sb-page-nav-dot {
            min-width: 36px;
            height: 36px;
            padding: 0 12px;
            border: none;
            background: transparent;
            color: var(--sb-text);
            border-radius: 18px;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
        }

        .survey-builder-container .sb-page-nav-dot.active {
            background: var(--sb-primary);
            color: white;
            font-weight: 500;
        }

        /* Floating Action Bar */
        .survey-builder-container .sb-floating-actions {
            position: fixed;
            right: 32px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--sb-surface);
            border-radius: 8px;
            box-shadow: 0 2px 6px 2px rgba(60,64,67,0.15), 0 1px 2px 0 rgba(60,64,67,0.3);
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 50;
        }

        .survey-builder-container .sb-floating-action {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            border-radius: 50%;
            cursor: pointer;
            color: var(--sb-text-secondary);
            transition: all 0.2s;
        }

        .survey-builder-container .sb-floating-action:hover {
            background: var(--sb-primary-light);
            color: var(--sb-primary);
        }

        /* Save Bar */
        .survey-builder-container .sb-save-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--sb-surface);
            border-top: 1px solid var(--sb-border);
            padding: 12px 24px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            z-index: 100;
        }

        /* Settings Panel */
        .survey-builder-container .sb-settings-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            z-index: 200;
        }

        .survey-builder-container .sb-settings-panel {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 400px;
            background: var(--sb-surface);
            box-shadow: -2px 0 8px rgba(0,0,0,0.15);
            overflow-y: auto;
            z-index: 201;
        }

        .survey-builder-container .sb-settings-header {
            padding: 24px;
            border-bottom: 1px solid var(--sb-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .survey-builder-container .sb-settings-title {
            font-size: 18px;
            font-weight: 500;
        }

        .survey-builder-container .sb-settings-body {
            padding: 24px;
        }

        .survey-builder-container .sb-settings-section {
            margin-bottom: 32px;
        }

        .survey-builder-container .sb-settings-section-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .survey-builder-container .sb-theme-colors {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .survey-builder-container .sb-theme-color-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .survey-builder-container .sb-theme-color-btn.selected {
            border-color: #202124;
            outline: 2px solid currentColor;
            outline-offset: 2px;
        }

        .survey-builder-container .sb-date-inputs {
            display: grid;
            gap: 16px;
        }

        .survey-builder-container .sb-date-input-group label {
            display: block;
            font-size: 12px;
            color: var(--sb-text-secondary);
            margin-bottom: 8px;
        }

        .survey-builder-container .sb-date-input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--sb-border);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .survey-builder-container .sb-scale-points-select {
            width: 100%;
            margin-bottom: 16px;
        }

        .survey-builder-container .sb-scale-labels {
            display: grid;
            gap: 12px;
        }

        .survey-builder-container .sb-scale-label-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .survey-builder-container .sb-scale-label-number {
            width: 24px;
            font-size: 14px;
            color: var(--sb-text-secondary);
            text-align: center;
        }

        .survey-builder-container .sb-scale-label-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--sb-border);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .survey-builder-container .sb-landing-textarea,
        .survey-builder-container .sb-thankyou-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--sb-border);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

        /* Link Modal */
        .survey-builder-container .sb-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .survey-builder-container .sb-modal {
            background: var(--sb-surface);
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .survey-builder-container .sb-modal-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .survey-builder-container .sb-modal-text {
            color: var(--sb-text-secondary);
            margin-bottom: 16px;
            font-size: 14px;
        }

        .survey-builder-container .sb-modal-link-row {
            display: flex;
            gap: 8px;
        }

        .survey-builder-container .sb-modal-link-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--sb-border);
            border-radius: 4px;
            font-size: 14px;
            background: var(--sb-primary-light);
        }

        /* Preview View */
        .survey-builder-container #sb-preview-view {
            min-height: calc(100vh - 200px);
        }

        .survey-builder-container .sb-preview-banner {
            background: #202124;
            color: white;
            padding: 12px 24px;
            text-align: center;
            font-size: 14px;
        }

        .survey-builder-container .sb-preview-banner button {
            margin-left: 16px;
            padding: 6px 16px;
            background: white;
            color: #202124;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
        }

        .survey-builder-container .sb-preview-progress {
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 12px 24px;
        }

        .survey-builder-container .sb-preview-progress-bar {
            max-width: 640px;
            margin: 0 auto;
            height: 8px;
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .survey-builder-container .sb-preview-progress-fill {
            height: 100%;
            background: var(--sb-primary);
            transition: width 0.3s;
        }

        .survey-builder-container .sb-preview-main {
            max-width: 640px;
            margin: 0 auto;
            padding: 24px 16px;
        }

        /* Landing Page */
        .survey-builder-container .sb-landing-card {
            overflow: hidden;
        }

        .survey-builder-container .sb-landing-card-top {
            height: 10px;
            background: var(--sb-primary);
        }

        .survey-builder-container .sb-landing-card-body {
            padding: 24px;
        }

        .survey-builder-container .sb-landing-title {
            font-size: 32px;
            font-weight: 400;
            margin-bottom: 16px;
        }

        .survey-builder-container .sb-landing-description {
            color: var(--sb-text-secondary);
            margin-bottom: 16px;
        }

        .survey-builder-container .sb-landing-content {
            color: var(--sb-text-secondary);
            border-top: 1px solid var(--sb-border);
            padding-top: 16px;
        }

        .survey-builder-container .sb-landing-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--sb-border);
        }

        /* Page Instructions (Preview) */
        .survey-builder-container .sb-preview-page-instructions {
            border-radius: 8px;
            padding: 20px 24px;
            margin-bottom: 16px;
            border-left: 4px solid var(--sb-primary);
        }

        .survey-builder-container .sb-preview-page-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .survey-builder-container .sb-preview-page-text {
            font-size: 14px;
            color: var(--sb-text-secondary);
            line-height: 1.6;
        }

        /* Page Indicator */
        .survey-builder-container .sb-page-indicator {
            font-size: 12px;
            color: var(--sb-text-secondary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .survey-builder-container .sb-page-indicator-dots {
            display: flex;
            gap: 4px;
        }

        .survey-builder-container .sb-page-indicator-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--sb-border);
        }

        .survey-builder-container .sb-page-indicator-dot.active {
            background: var(--sb-primary);
        }

        /* Question (Preview) */
        .survey-builder-container .sb-preview-question {
            margin-bottom: 16px;
            padding: 24px;
            border-left: 4px solid transparent;
        }

        .survey-builder-container .sb-preview-question.error {
            border-left-color: var(--sb-error);
        }

        .survey-builder-container .sb-preview-question-text {
            font-size: 16px;
            margin-bottom: 16px;
        }

        .survey-builder-container .sb-preview-question-text .required {
            color: var(--sb-primary);
            margin-left: 4px;
        }

        .survey-builder-container .sb-preview-rating {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .survey-builder-container .sb-preview-rating-label {
            font-size: 14px;
            color: var(--sb-text-secondary);
        }

        .survey-builder-container .sb-preview-rating-points {
            display: flex;
            gap: 24px;
        }

        .survey-builder-container .sb-preview-rating-point {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .survey-builder-container .sb-preview-rating-point-value {
            font-size: 12px;
            color: var(--sb-text-secondary);
        }

        .survey-builder-container .sb-preview-rating-point input {
            width: 20px;
            height: 20px;
            accent-color: var(--sb-primary);
        }

        .survey-builder-container .sb-preview-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .survey-builder-container .sb-preview-option {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .survey-builder-container .sb-preview-option input {
            width: 20px;
            height: 20px;
            accent-color: var(--sb-primary);
        }

        .survey-builder-container .sb-preview-option span {
            font-size: 14px;
        }

        .survey-builder-container .sb-preview-textarea {
            width: 100%;
            padding: 12px 0;
            border: none;
            border-bottom: 1px solid var(--sb-border);
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            outline: none;
            background: transparent;
        }

        .survey-builder-container .sb-preview-textarea:focus {
            border-bottom-color: var(--sb-primary);
        }

        .survey-builder-container .sb-preview-error {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
            color: var(--sb-error);
            font-size: 12px;
        }

        /* Navigation (Preview) */
        .survey-builder-container .sb-preview-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 24px;
        }

        .survey-builder-container .sb-preview-nav-left {
            display: flex;
            gap: 12px;
        }

        /* Thank You Page */
        .survey-builder-container .sb-thankyou-card {
            max-width: 640px;
            margin: 0 auto;
            overflow: hidden;
        }

        .survey-builder-container .sb-thankyou-card-top {
            height: 10px;
            background: var(--sb-primary);
        }

        .survey-builder-container .sb-thankyou-card-body {
            padding: 48px 24px;
            text-align: center;
        }

        .survey-builder-container .sb-thankyou-icon {
            color: var(--sb-success);
            margin-bottom: 24px;
        }

        .survey-builder-container .sb-thankyou-title {
            font-size: 24px;
            font-weight: 400;
            margin-bottom: 16px;
        }

        .survey-builder-container .sb-thankyou-message {
            color: var(--sb-text-secondary);
            margin-bottom: 24px;
        }

        /* SVG Icons */
        .survey-builder-container .sb-icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        .survey-builder-container .sb-icon-sm { width: 16px; height: 16px; }
        .survey-builder-container .sb-icon-lg { width: 24px; height: 24px; }
        .survey-builder-container .sb-icon-xl { width: 48px; height: 48px; }

        /* ============================================== */
        /* SURVEY BUILDER STYLES - END                    */
        /* ============================================== */

        /* ============================================== */
        /* CHATS SECTION STYLES                           */
        /* ============================================== */
        .chats-container {
            --chat-primary: #3b82f6;
            --chat-primary-light: #eff6ff;
            --chat-surface: #ffffff;
            --chat-text: #202124;
            --chat-text-secondary: #5f6368;
            --chat-border: #dadce0;
            font-family: 'Google Sans', 'Segoe UI', Roboto, sans-serif;
            min-height: calc(100vh - 200px);
            background: #f1f3f4;
        }

        .chats-container .chat-dashboard-header {
            background: var(--chat-surface);
            border-bottom: 1px solid var(--chat-border);
            padding: 12px 24px;
        }

        .chats-container .chat-dashboard-header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chats-container .chat-logo {
            width: 40px;
            height: 40px;
            background: #1e2a3b;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .chats-container .chat-dashboard-title {
            font-size: 22px;
            color: var(--chat-text-secondary);
            font-weight: 400;
        }

        .chats-container .chat-dashboard-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        .chats-container .chat-dashboard-section-title {
            font-size: 24px;
            font-weight: 400;
            margin-bottom: 32px;
        }

        .chats-container .chats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 24px;
        }

        .chats-container .chat-card {
            background: var(--chat-surface);
            border-radius: 8px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            cursor: pointer;
            transition: box-shadow 0.2s;
        }

        .chats-container .chat-card:hover {
            box-shadow: 0 2px 4px 0 rgba(60,64,67,0.3), 0 3px 6px 2px rgba(60,64,67,0.15);
        }

        .chats-container .chat-card-header {
            height: 8px;
            background: var(--chat-primary);
            border-radius: 8px 8px 0 0;
        }

        .chats-container .chat-card-body {
            padding: 20px;
        }

        .chats-container .chat-card-title {
            font-size: 16px;
            font-weight: 400;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chats-container .chat-card-meta {
            font-size: 12px;
            color: var(--chat-text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chats-container .chat-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .chats-container .chat-card-action {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border: 1px solid var(--chat-border);
            border-radius: 16px;
            background: transparent;
            cursor: pointer;
            font-size: 12px;
            color: var(--chat-text-secondary);
            font-family: inherit;
            transition: all 0.2s;
        }

        .chats-container .chat-card-action:hover {
            background: var(--chat-primary-light);
        }

        .chats-container .new-chat-card {
            border: 2px dashed var(--chat-border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
            cursor: pointer;
            transition: border-color 0.2s;
            background: white;
            border-radius: 8px;
        }

        .chats-container .new-chat-card:hover {
            border-color: var(--chat-primary);
        }

        .chats-container .new-chat-card svg {
            color: #3b82f6;
            margin-bottom: 8px;
            width: 48px;
            height: 48px;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        /* ============================================== */
        /* CHATS SECTION STYLES - END                     */
        /* ============================================== */
    </style>
</head>
<body>
    <!-- ==================== NEW AUTH WIZARD - ADD BEFORE EXISTING LOGIN ==================== -->

    <!-- Auth Header with Logo (shared across auth pages) -->
    <header id="auth-header" class="auth-header">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 862 144" class="auth-logo">
            <g>
                <path d="M64.807,0l0,56.669l-15.313,15.081l15.313,15.313l0,56.437l-1.661,-0.233c-0.155,0 -1.915,-0.244 -5.281,-0.731c-3.344,-0.465 -7.563,-1.738 -12.656,-3.82l-0.963,-0.465l-0,-42.585l-13.619,-13.619l-9.102,0c0.31,1.75 1.063,4.418 2.259,8.006c1.196,3.587 3.233,7.451 6.112,11.592l0.731,0.964l-14.616,14.582l-0.93,-1.196c-10.054,-12.755 -15.081,-27.504 -15.081,-44.245c0,-2.237 0.199,-5.271 0.598,-9.102c0.399,-3.809 1.318,-8.027 2.757,-12.656c1.439,-4.628 3.554,-9.456 6.345,-14.483c2.79,-5.026 6.577,-9.932 11.36,-14.715c4.606,-4.606 9.345,-8.271 14.217,-10.995c4.872,-2.702 9.334,-4.772 13.387,-6.212c4.074,-1.439 7.462,-2.358 10.164,-2.757c2.724,-0.398 4.163,-0.597 4.318,-0.597l1.661,-0.233Zm-2.856,55.473l-0,-52.351c-8.46,1.108 -16.277,3.732 -23.452,7.873c-7.175,4.141 -13.387,9.323 -18.635,15.546c-5.27,6.223 -9.423,13.198 -12.457,20.927c-3.033,7.728 -4.55,15.822 -4.55,24.282c-0,15.634 4.473,29.342 13.42,41.123l10.762,-10.497c-3.676,-5.58 -6.034,-10.53 -7.075,-14.848c-1.041,-4.296 -1.562,-6.522 -1.562,-6.677l-0.232,-1.694l13.652,0l15.28,15.314l0,41.854c3.366,1.284 6.356,2.236 8.969,2.856c2.635,0.642 4.595,1.041 5.88,1.196l-0,-52.118l-16.277,-16.509l16.277,-16.277Zm-16.975,-30.826l2.126,-1.195l0,25.577l-15.28,15.313l-13.652,0l0.232,-1.694c0,-0.155 0.167,-1.151 0.499,-2.989c0.31,-1.816 1.029,-4.119 2.159,-6.91c1.107,-2.79 2.657,-5.901 4.65,-9.334c1.993,-3.432 4.662,-6.82 8.006,-10.164c2.391,-2.392 4.827,-4.385 7.308,-5.979c2.458,-1.595 3.775,-2.47 3.952,-2.625Zm-0.73,23.186l-0,-19.366c-5.736,3.831 -10.641,8.537 -14.716,14.118c-4.052,5.58 -6.721,11.87 -8.005,18.867l9.102,0l13.619,-13.619Zm70.321,-27.969l0.963,0.93c0.31,0.177 1.584,1.462 3.82,3.853c2.237,2.392 4.629,5.736 7.175,10.032c2.547,4.296 4.894,9.556 7.042,15.778c2.149,6.223 3.223,13.321 3.223,21.293c-0,6.533 -0.753,12.467 -2.259,17.804c-1.506,5.359 -3.222,9.943 -5.149,13.752c-1.904,3.831 -3.654,6.865 -5.248,9.102c-1.595,2.237 -2.469,3.432 -2.624,3.587l-0.964,1.196l-12.689,-12.689l-15.778,33.982l-0.465,0.232c-2.879,1.107 -5.592,2.026 -8.138,2.757c-2.547,0.709 -5.814,1.307 -9.8,1.794l-1.694,0.233l0,-143.5l1.694,0.233c3.809,0.487 6.954,1.085 9.434,1.793c2.48,0.731 5.315,1.728 8.504,2.99l0.93,0.232l-0,84.207l9.101,-20.097l13.387,13.387c0.332,-1.263 0.609,-2.857 0.831,-4.784c0.243,-1.904 0.365,-3.975 0.365,-6.211c-0,-5.736 -0.753,-10.873 -2.259,-15.413c-1.528,-4.562 -3.244,-8.393 -5.149,-11.493c-1.904,-3.101 -3.653,-5.448 -5.248,-7.043c-1.594,-1.594 -3.587,-3.587 -3.587,-3.587l14.582,-14.35Zm-7.407,79.855l13.154,13.154c0.797,-1.107 1.948,-2.857 3.454,-5.248c1.506,-2.392 3.023,-5.382 4.551,-8.969c1.506,-3.588 2.824,-7.651 3.953,-12.191c1.107,-4.54 1.661,-9.445 1.661,-14.715c-0,-6.688 -0.842,-12.745 -2.525,-18.17c-1.661,-5.426 -3.565,-10.176 -5.713,-14.251c-2.17,-4.052 -4.329,-7.44 -6.477,-10.164c-2.149,-2.702 -3.699,-4.529 -4.651,-5.481l-10.53,10.53c0.952,0.952 2.27,2.458 3.953,4.518c1.661,2.081 3.333,4.672 5.016,7.772c1.683,3.123 3.122,6.799 4.318,11.029c1.196,4.207 1.794,8.946 1.794,14.217c-0,3.831 -0.321,7.097 -0.963,9.799c-0.643,2.724 -0.964,4.163 -0.964,4.318l-0.731,2.392l-13.851,-14.118l-12.922,28.235l0,-95.201c-2.546,-0.952 -4.894,-1.749 -7.042,-2.392c-2.17,-0.642 -4.761,-1.196 -7.773,-1.661l0,137.255c3.189,-0.62 5.891,-1.251 8.105,-1.893c2.237,-0.643 4.551,-1.362 6.943,-2.159l17.24,-36.606Z" style="fill:#fff;fill-rule:nonzero;"/>
            </g>
            <g>
                <path d="M179.021,40.437l24.716,-0l-0,6.218l-24.716,0c-0.805,0 -1.5,0.286 -2.084,0.859c-0.584,0.583 -0.876,1.278 -0.876,2.084l0,34.805l-6.218,-0l-0,-34.805c-0,-2.522 0.899,-4.683 2.697,-6.481c1.787,-1.787 3.947,-2.68 6.481,-2.68Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M252.079,40.437l26.397,-0c2.569,-0 4.753,0.893 6.551,2.68c1.799,1.798 2.698,3.959 2.698,6.481l-0,15.922l-38.588,0l-0,9.704c-0,0.818 0.286,1.512 0.858,2.085c0.584,0.583 1.279,0.875 2.084,0.875l35.646,0l-0,6.219l-35.646,-0c-2.522,-0 -4.682,-0.899 -6.481,-2.698c-1.786,-1.786 -2.68,-3.947 -2.68,-6.481l0,-25.626c0,-2.522 0.894,-4.683 2.68,-6.481c1.799,-1.787 3.959,-2.68 6.481,-2.68Zm-2.942,9.161l-0,9.704l32.282,-0l0,-9.704c0,-0.806 -0.286,-1.501 -0.858,-2.084c-0.584,-0.573 -1.279,-0.859 -2.085,-0.859l-26.397,0c-0.805,0 -1.5,0.286 -2.084,0.859c-0.572,0.583 -0.858,1.278 -0.858,2.084Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M326.9,40.437l35.558,-0c2.58,-0 4.764,0.893 6.551,2.68c1.798,1.798 2.697,3.959 2.697,6.481l0,34.805l-35.628,-0c-2.534,-0 -4.694,-0.899 -6.481,-2.698c-1.798,-1.786 -2.697,-3.947 -2.697,-6.481l-0,-15.922l38.518,-0l-0,-9.704c-0,-0.806 -0.292,-1.501 -0.876,-2.084c-0.584,-0.573 -1.279,-0.859 -2.084,-0.859l-35.558,0l-0,-6.218Zm9.178,37.747l29.34,0l-0,-12.664l-32.3,0l0,9.704c0,0.818 0.292,1.512 0.876,2.085c0.584,0.583 1.279,0.875 2.084,0.875Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M443.028,79.253l0,5.15l-17.586,-0c-5.512,-0 -9.301,-1.367 -11.368,-4.099c-2.079,-2.721 -3.141,-6.032 -3.188,-9.932l-0,-41.461l5.833,0l-0,41.233c-0,3.796 0.899,6.26 2.697,7.392c1.799,1.145 3.831,1.717 6.096,1.717l17.516,-0Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M510.393,40.437l-25.009,43.966l-6.278,-0l28.133,-49.489l6.278,-0l28.133,49.489l-6.278,-0l-24.979,-43.966Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M605.994,40.437l-0,43.966l-6.218,-0l-0,-43.966l6.218,-0Zm-3.109,-11.526c1.148,-0 2.127,0.405 2.936,1.214c0.818,0.818 1.227,1.804 1.227,2.959c-0,1.143 -0.409,2.121 -1.227,2.93c-0.809,0.818 -1.788,1.227 -2.936,1.227c-1.155,-0 -2.134,-0.409 -2.942,-1.227c-0.818,-0.809 -1.227,-1.787 -1.227,-2.93c-0,-1.155 0.409,-2.141 1.227,-2.959c0.808,-0.809 1.787,-1.214 2.942,-1.214Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M681.806,40.437l24.716,-0l-0,6.218l-24.716,0c-0.805,0 -1.5,0.286 -2.084,0.859c-0.584,0.583 -0.876,1.278 -0.876,2.084l0,34.805l-6.218,-0l0,-34.805c0,-2.522 0.899,-4.683 2.698,-6.481c1.786,-1.787 3.946,-2.68 6.48,-2.68Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M777.839,79.253l0,5.15l-17.586,-0c-5.512,-0 -9.301,-1.367 -11.368,-4.099c-2.079,-2.721 -3.141,-6.032 -3.188,-9.932l-0,-41.461l5.833,0l-0,41.233c-0,3.796 0.899,6.26 2.697,7.392c1.799,1.145 3.831,1.717 6.096,1.717l17.516,-0Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M855.621,40.437l0,-14.416l6.219,0l-0,58.382l-35.558,-0c-2.581,-0 -4.771,-0.899 -6.569,-2.698c-1.787,-1.786 -2.68,-3.947 -2.68,-6.481l0,-25.626c0,-2.522 0.893,-4.683 2.68,-6.481c1.798,-1.787 3.988,-2.68 6.569,-2.68l29.339,-0Zm-29.339,37.747l26.379,0c0.806,0 1.501,-0.292 2.084,-0.875c0.584,-0.573 0.876,-1.267 0.876,-2.085l0,-25.626c0,-0.806 -0.292,-1.501 -0.876,-2.084c-0.583,-0.573 -1.278,-0.859 -2.084,-0.859l-26.379,0c-0.818,0 -1.513,0.286 -2.085,0.859c-0.584,0.583 -0.876,1.278 -0.876,2.084l0,25.626c0,0.818 0.292,1.512 0.876,2.085c0.572,0.583 1.267,0.875 2.085,0.875Z" style="fill:#fff;fill-rule:nonzero;"/>
            </g>
            <g>
                <path d="M323.946,100.769l8.671,-0c0.843,-0 1.562,0.297 2.157,0.892c0.581,0.581 0.871,1.286 0.871,2.116l-0,5.227l-12.653,-0l-0,3.194c-0,0.263 0.09,0.491 0.269,0.685c0.194,0.193 0.422,0.29 0.685,0.29l11.699,0l-0,2.033l-11.699,0c-0.83,0 -1.535,-0.297 -2.116,-0.892c-0.594,-0.581 -0.892,-1.286 -0.892,-2.116l0,-8.421c0,-0.83 0.298,-1.535 0.892,-2.116c0.581,-0.595 1.286,-0.892 2.116,-0.892Zm-0.954,3.008l-0,3.194l10.599,0l0,-3.194c0,-0.263 -0.096,-0.491 -0.29,-0.685c-0.194,-0.193 -0.422,-0.29 -0.684,-0.29l-8.671,-0c-0.263,-0 -0.491,0.097 -0.685,0.29c-0.179,0.194 -0.269,0.422 -0.269,0.685Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M346.535,100.769l19.063,-0c0.857,-0 1.576,0.297 2.157,0.892c0.581,0.581 0.871,1.286 0.871,2.116l0,11.429l-2.033,0l0,-11.429c0,-0.263 -0.096,-0.491 -0.29,-0.685c-0.194,-0.193 -0.429,-0.29 -0.705,-0.29l-5.995,-0c-0.263,-0 -0.491,0.097 -0.684,0.29c-0.194,0.194 -0.291,0.422 -0.291,0.685l0,11.429l-2.053,0l-0,-11.429c-0,-0.263 -0.097,-0.491 -0.291,-0.685c-0.193,-0.193 -0.422,-0.29 -0.684,-0.29l-6.016,-0c-0.276,-0 -0.505,0.097 -0.684,0.29c-0.194,0.194 -0.291,0.422 -0.291,0.685l0,11.429l-2.074,0l0,-14.437Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M379.184,100.769l11.699,-0c0.83,-0 1.535,0.297 2.116,0.892c0.595,0.581 0.892,1.286 0.892,2.116l-0,8.421c-0,0.83 -0.297,1.535 -0.892,2.116c-0.581,0.595 -1.286,0.892 -2.116,0.892l-9.666,0l0,5.725l-2.033,0l0,-20.162Zm12.674,11.429l0,-8.421c0,-0.263 -0.097,-0.491 -0.29,-0.685c-0.194,-0.193 -0.422,-0.29 -0.685,-0.29l-8.67,-0c-0.263,-0 -0.491,0.097 -0.685,0.29c-0.207,0.194 -0.311,0.422 -0.311,0.685l0,8.421c0,0.263 0.104,0.491 0.311,0.685c0.194,0.193 0.422,0.29 0.685,0.29l8.67,0c0.263,0 0.491,-0.097 0.685,-0.29c0.193,-0.194 0.29,-0.422 0.29,-0.685Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M403.951,112.198l0,-16.158l2.054,-0l-0,16.158c-0,0.263 0.09,0.491 0.269,0.685c0.194,0.193 0.422,0.29 0.685,0.29l2.448,0l-0,2.033l-2.448,0c-0.83,0 -1.535,-0.297 -2.116,-0.892c-0.594,-0.581 -0.892,-1.286 -0.892,-2.116Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M422.516,100.769l8.65,-0c0.843,-0 1.563,0.297 2.157,0.892c0.595,0.581 0.892,1.286 0.892,2.116l0,8.421c0,0.83 -0.297,1.535 -0.892,2.116c-0.594,0.595 -1.314,0.892 -2.157,0.892l-8.65,0c-0.83,0 -1.542,-0.297 -2.136,-0.892c-0.595,-0.581 -0.892,-1.286 -0.892,-2.116l-0,-8.421c-0,-0.83 0.297,-1.535 0.892,-2.116c0.594,-0.595 1.306,-0.892 2.136,-0.892Zm8.65,2.033l-8.65,-0c-0.276,-0 -0.505,0.097 -0.684,0.29c-0.194,0.194 -0.291,0.422 -0.291,0.685l0,8.421c0,0.263 0.097,0.491 0.291,0.685c0.179,0.193 0.408,0.29 0.684,0.29l8.65,0c0.263,0 0.491,-0.097 0.684,-0.29c0.194,-0.194 0.291,-0.422 0.291,-0.685l-0,-8.421c-0,-0.263 -0.097,-0.491 -0.291,-0.685c-0.193,-0.193 -0.421,-0.29 -0.684,-0.29Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M450.83,100.769l-0,17.093c-0,0.843 -0.29,1.555 -0.871,2.136c-0.581,0.595 -1.293,0.892 -2.137,0.892l-9.023,0l0,-2.074l9.023,-0c0.263,-0 0.491,-0.09 0.685,-0.27c0.193,-0.193 0.29,-0.422 0.29,-0.684l0,-2.697l-9.645,0c-0.83,0 -1.535,-0.297 -2.116,-0.892c-0.595,-0.581 -0.892,-1.286 -0.892,-2.116l0,-11.388l2.033,0l-0,11.388c-0,0.263 0.097,0.491 0.29,0.685c0.194,0.193 0.422,0.29 0.685,0.29l8.67,0c0.263,0 0.491,-0.097 0.685,-0.29c0.193,-0.194 0.29,-0.422 0.29,-0.685l0,-11.388l2.033,0Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M464.23,100.728l8.67,-0c0.844,-0 1.556,0.297 2.137,0.892c0.595,0.581 0.892,1.286 0.892,2.116l-0,5.227l-12.674,-0l-0,3.194c-0,0.263 0.097,0.491 0.29,0.685c0.194,0.193 0.422,0.29 0.685,0.29l11.699,0l-0,2.033l-11.699,0c-0.83,0 -1.542,-0.297 -2.137,-0.892c-0.58,-0.581 -0.871,-1.286 -0.871,-2.116l0,-8.421c0,-0.83 0.291,-1.535 0.871,-2.116c0.595,-0.595 1.307,-0.892 2.137,-0.892Zm-0.975,3.008l-0,3.194l10.6,0l-0,-3.194c-0,-0.263 -0.09,-0.491 -0.27,-0.685c-0.194,-0.193 -0.422,-0.29 -0.685,-0.29l-8.67,-0c-0.263,-0 -0.491,0.097 -0.685,0.29c-0.193,0.194 -0.29,0.422 -0.29,0.685Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M490.345,100.769l8.671,-0c0.843,-0 1.562,0.297 2.157,0.892c0.581,0.581 0.871,1.286 0.871,2.116l0,5.227l-12.653,-0l0,3.194c0,0.263 0.09,0.491 0.27,0.685c0.193,0.193 0.422,0.29 0.684,0.29l11.699,0l0,2.033l-11.699,0c-0.829,0 -1.535,-0.297 -2.116,-0.892c-0.594,-0.581 -0.891,-1.286 -0.891,-2.116l-0,-8.421c-0,-0.83 0.297,-1.535 0.891,-2.116c0.581,-0.595 1.287,-0.892 2.116,-0.892Zm-0.954,3.008l0,3.194l10.6,0l-0,-3.194c-0,-0.263 -0.097,-0.491 -0.291,-0.685c-0.193,-0.193 -0.421,-0.29 -0.684,-0.29l-8.671,-0c-0.262,-0 -0.491,0.097 -0.684,0.29c-0.18,0.194 -0.27,0.422 -0.27,0.685Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M543.53,103.777l-0,0.207l-2.074,0l-0,-0.207c-0,-0.263 -0.097,-0.491 -0.291,-0.685c-0.193,-0.193 -0.422,-0.29 -0.684,-0.29l-8.65,-0c-0.277,-0 -0.505,0.097 -0.685,0.29c-0.193,0.194 -0.29,0.422 -0.29,0.685l-0,2.219c-0,0.263 0.097,0.491 0.29,0.685c0.18,0.193 0.408,0.29 0.685,0.29l8.65,0c0.843,0 1.562,0.29 2.157,0.871c0.595,0.595 0.892,1.307 0.892,2.137l-0,2.219c-0,0.83 -0.297,1.535 -0.892,2.116c-0.595,0.595 -1.314,0.892 -2.157,0.892l-8.65,0c-0.83,0 -1.542,-0.297 -2.137,-0.892c-0.594,-0.581 -0.892,-1.286 -0.892,-2.116l0,-0.207l2.054,-0l-0,0.207c-0,0.263 0.097,0.491 0.29,0.685c0.18,0.193 0.408,0.29 0.685,0.29l8.65,0c0.262,0 0.491,-0.097 0.684,-0.29c0.194,-0.194 0.291,-0.422 0.291,-0.685l-0,-2.219c-0,-0.263 -0.097,-0.491 -0.291,-0.685c-0.193,-0.193 -0.422,-0.29 -0.684,-0.29l-8.65,-0c-0.83,-0 -1.542,-0.29 -2.137,-0.871c-0.594,-0.595 -0.892,-1.307 -0.892,-2.137l0,-2.219c0,-0.83 0.298,-1.535 0.892,-2.116c0.595,-0.595 1.307,-0.892 2.137,-0.892l8.65,-0c0.843,-0 1.562,0.297 2.157,0.892c0.595,0.581 0.892,1.286 0.892,2.116Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M566.471,112.198l0,-11.429l2.054,-0l0,11.429c0,0.83 -0.297,1.535 -0.892,2.116c-0.581,0.595 -1.3,0.892 -2.157,0.892l-8.65,0c-0.83,0 -1.542,-0.297 -2.136,-0.892c-0.581,-0.581 -0.872,-1.286 -0.872,-2.116l0,-11.429l2.033,-0l0,11.429c0,0.263 0.097,0.491 0.291,0.685c0.193,0.193 0.421,0.29 0.684,0.29l8.65,0c0.276,0 0.511,-0.097 0.705,-0.29c0.194,-0.194 0.29,-0.422 0.29,-0.685Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M582.402,100.769l8.11,-0l0,2.033l-8.11,-0c-0.277,-0 -0.505,0.097 -0.685,0.29c-0.193,0.194 -0.29,0.422 -0.29,0.685l0,11.429l-2.053,0l-0,-11.429c-0,-0.83 0.297,-1.535 0.891,-2.116c0.595,-0.595 1.307,-0.892 2.137,-0.892Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M608.808,113.215l6.783,-12.446l2.385,-0l-7.986,14.437l-2.365,0l-7.965,-14.437l2.386,-0l6.762,12.446Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M630.629,100.769l8.65,-0c0.857,-0 1.576,0.297 2.157,0.892c0.595,0.581 0.892,1.286 0.892,2.116l0,5.227l-12.674,-0l0,3.194c0,0.263 0.097,0.491 0.291,0.685c0.193,0.193 0.421,0.29 0.684,0.29l11.699,0l0,2.033l-11.699,0c-0.83,0 -1.542,-0.297 -2.136,-0.892c-0.581,-0.581 -0.872,-1.286 -0.872,-2.116l0,-8.421c0,-0.83 0.291,-1.535 0.872,-2.116c0.594,-0.595 1.306,-0.892 2.136,-0.892Zm-0.975,3.008l0,3.194l10.6,0l-0,-3.194c-0,-0.263 -0.097,-0.491 -0.291,-0.685c-0.179,-0.193 -0.407,-0.29 -0.684,-0.29l-8.65,-0c-0.263,-0 -0.491,0.097 -0.684,0.29c-0.194,0.194 -0.291,0.422 -0.291,0.685Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M668.568,100.802l0,17.093c0,0.843 -0.29,1.555 -0.871,2.136c-0.581,0.595 -1.293,0.892 -2.137,0.892l-9.002,0l-0,-2.074l9.002,-0c0.263,-0 0.491,-0.09 0.685,-0.27c0.193,-0.193 0.29,-0.422 0.29,-0.684l0,-2.697l-9.645,0c-0.83,0 -1.535,-0.297 -2.116,-0.892c-0.595,-0.581 -0.892,-1.286 -0.892,-2.116l0,-11.388l2.054,0l-0,11.388c-0,0.263 0.089,0.491 0.269,0.685c0.194,0.193 0.422,0.29 0.685,0.29l8.67,0c0.263,0 0.491,-0.097 0.685,-0.29c0.193,-0.194 0.29,-0.422 0.29,-0.685l0,-11.388l2.033,0Z" style="fill:#fff;fill-rule:nonzero;"/>
                <path d="M694.102,103.769l0,0.207l-2.074,0l0,-0.207c0,-0.263 -0.097,-0.491 -0.29,-0.685c-0.194,-0.193 -0.422,-0.29 -0.685,-0.29l-8.649,-0c-0.277,-0 -0.505,0.097 -0.685,0.29c-0.194,0.194 -0.29,0.422 -0.29,0.685l-0,2.219c-0,0.263 0.096,0.491 0.29,0.685c0.18,0.193 0.408,0.29 0.685,0.29l8.649,0c0.844,0 1.563,0.29 2.158,0.871c0.594,0.595 0.891,1.307 0.891,2.137l0,2.219c0,0.83 -0.297,1.535 -0.891,2.116c-0.595,0.595 -1.314,0.892 -2.158,0.892l-8.649,0c-0.83,0 -1.542,-0.297 -2.137,-0.892c-0.595,-0.581 -0.892,-1.286 -0.892,-2.116l0,-0.207l2.054,-0l-0,0.207c-0,0.263 0.096,0.491 0.29,0.685c0.18,0.193 0.408,0.29 0.685,0.29l8.649,0c0.263,0 0.491,-0.097 0.685,-0.29c0.193,-0.194 0.29,-0.422 0.29,-0.685l0,-2.219c0,-0.263 -0.097,-0.491 -0.29,-0.685c-0.194,-0.193 -0.422,-0.29 -0.685,-0.29l-8.649,-0c-0.83,-0 -1.542,-0.29 -2.137,-0.871c-0.595,-0.595 -0.892,-1.307 -0.892,-2.137l0,-2.219c0,-0.83 0.297,-1.535 0.892,-2.116c0.595,-0.595 1.307,-0.892 2.137,-0.892l8.649,-0c0.844,-0 1.563,0.297 2.158,0.892c0.594,0.581 0.891,1.286 0.891,2.116Z" style="fill:#fff;fill-rule:nonzero;"/>
            </g>
        </svg>
    </header>

    <!-- STEP 1: Create Account -->
    <div id="auth-signup-step1" class="auth-page">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-top-nav">
                    Already have an account? <a href="#" onclick="showBlueLoginPage(); return false;">Log in</a>
                </div>

                <h1 class="auth-heading">Create an account</h1>

                <form id="auth-signup-form-step1" onsubmit="authGoToStep2(event)">
                    <div class="auth-form-group">
                        <label for="auth-signup-email" class="auth-form-label">Email address</label>
                        <input
                            type="email"
                            id="auth-signup-email"
                            class="auth-form-input"
                            placeholder="Enter your email address"
                            required
                            autocomplete="email"
                        >
                        <div id="auth-email-error" class="auth-form-error"></div>
                    </div>

                    <div class="auth-checkbox-group">
                        <label class="auth-checkbox-label">
                            <input type="checkbox" id="auth-signup-terms" class="auth-checkbox-input" required>
                            <span class="auth-checkbox-text">
                                You agree to the <a href="/terms" target="_blank">Terms of Use</a> and <a href="/privacy" target="_blank">Privacy Notice</a>.
                            </span>
                        </label>
                    </div>

                    <div class="auth-checkbox-group">
                        <label class="auth-checkbox-label">
                            <input type="checkbox" id="auth-signup-marketing" class="auth-checkbox-input">
                            <span class="auth-checkbox-text">
                                You agree to receive product news and special promotions via email. You can opt-out of these emails in your My Account page anytime.
                            </span>
                        </label>
                    </div>

                    <button type="submit" class="auth-btn-primary">Next</button>
                </form>

                <div class="auth-divider">
                    <span class="auth-divider-text">Or sign up with</span>
                </div>

                <div class="auth-social-buttons">
                    <button type="button" class="auth-social-btn" onclick="authSocialSignup('microsoft')">
                        <svg viewBox="0 0 21 21">
                            <rect x="1" y="1" width="9" height="9" fill="#f25022"/>
                            <rect x="11" y="1" width="9" height="9" fill="#7fba00"/>
                            <rect x="1" y="11" width="9" height="9" fill="#00a4ef"/>
                            <rect x="11" y="11" width="9" height="9" fill="#ffb900"/>
                        </svg>
                        <span>Microsoft</span>
                    </button>

                    <button type="button" class="auth-social-btn" onclick="authSocialSignup('google')">
                        <svg viewBox="0 0 24 24">
                            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                        </svg>
                        <span>Google</span>
                    </button>

                    <button type="button" class="auth-social-btn" onclick="authSocialSignup('apple')">
                        <svg viewBox="0 0 24 24">
                            <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z" fill="#000"/>
                        </svg>
                        <span>Apple</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- STEP 2: Create Password -->
    <div id="auth-signup-step2" class="auth-page hidden">
        <div class="auth-container">
            <div class="auth-card">
                <a href="#" class="auth-back-link" onclick="authGoBackToStep1(); return false;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back
                </a>

                <h1 class="auth-heading">Create password</h1>
                <div id="auth-display-email" class="auth-email-display"></div>

                <form id="auth-signup-form-step2" onsubmit="authCreateAccount(event)">
                    <div class="auth-form-group">
                        <label for="auth-signup-password" class="auth-form-label">Enter a password</label>
                        <input
                            type="password"
                            id="auth-signup-password"
                            class="auth-form-input"
                            required
                            minlength="8"
                            autocomplete="new-password"
                        >
                        <div class="auth-form-hint">Enter at least 8 characters. Don't use common words, names, or sequential or repeated characters.</div>
                        <div id="auth-password-error" class="auth-form-error"></div>
                    </div>

                    <div class="auth-form-group">
                        <label for="auth-signup-confirm-password" class="auth-form-label">Confirm password</label>
                        <input
                            type="password"
                            id="auth-signup-confirm-password"
                            class="auth-form-input"
                            required
                            autocomplete="new-password"
                        >
                        <div id="auth-confirm-password-error" class="auth-form-error"></div>
                    </div>

                    <button type="submit" class="auth-btn-primary">Create account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- ==================== EXISTING CODE BELOW - DO NOT MODIFY ==================== -->

    <!-- Login Screen -->
    <div id="login-container" class="login-container hidden">
        <div class="login-card">
            <div class="login-top-nav">
                Don't have an account? <a href="#" onclick="showAuthPage('auth-signup-step1'); return false;">Sign up</a>
            </div>
            <div class="login-header">
                <div class="logo">
                    <div class="logo-icon has-default">R</div>
                    <span>Realworld</span>
                </div>
                <h2 data-translate="sign-in-title">Sign In to Your Account</h2>
                <p data-translate="sign-in-description">Enter your credentials to access the employee survey platform</p>
            </div>

            <form id="login-form" class="login-form">
                <div class="form-group">
                    <label class="form-label" for="email" data-translate="email-address">Email Address</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email"
                        class="form-input" 
                        required 
                        autocomplete="email"
                        placeholder="Enter your email address"
                        data-translate-placeholder="email-placeholder"
                        value=""
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="password" data-translate="password">Password</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password"
                        class="form-input" 
                        required 
                        autocomplete="current-password"
                        placeholder="Enter your password"
                        data-translate-placeholder="password-placeholder"
                        value=""
                    >
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="remember-me">
                        <span class="checkmark"></span>
                        <span data-translate="remember-me">Remember me</span>
                    </label>
                </div>

                <button type="submit" class="btn btn-primary btn-full-width" id="login-btn" data-translate="sign-in">
                    Sign In
                </button>

                <div class="login-divider">
                    <span data-translate="or-continue-with">or continue with</span>
                </div>

                <div class="social-login">
                    <button type="button" class="btn-social" onclick="handleSocialLogin('google')">
                        <span></span>
                        Google
                    </button>
                    <button type="button" class="btn-social" onclick="handleSocialLogin('microsoft')">
                        <span></span>
                        Microsoft
                    </button>
                </div>

                <div style="text-align: center; margin-top: 1rem;">
                    <a href="#" onclick="showForgotPassword()" style="color: var(--primary-color); text-decoration: none; font-size: 0.875rem;" data-translate="forgot-password">Forgot your password?</a>
                </div>
            </form>

            <!-- Quick Login Buttons for Testing -->
            <div class="quick-login">
                <h4 data-translate="quick-login-testing">Quick Login (Testing)</h4>
                <button type="button" class="btn btn-secondary btn-sm" onclick="quickLogin('master')" style="margin-right: 0.5rem; margin-bottom: 0.5rem;" data-translate="login-master-admin">
                    Login as Master Admin
                </button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="quickLogin('client1')" style="margin-right: 0.5rem; margin-bottom: 0.5rem;" data-translate="login-sarah-techcorp">
                    Login as Sarah (TechCorp)
                </button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="quickLogin('client2')" style="margin-bottom: 0.5rem;" data-translate="login-mike-startupx">
                    Login as Mike (StartupX)
                </button>
            </div>

            <div class="demo-credentials">
                <h4 data-translate="demo-credentials">Demo Credentials</h4>
                <div class="demo-account" onclick="fillCredentials('paul.everitt@rworld.co.uk', 'Doughball8987!')">
                    <strong data-translate="master-administrator">Master Administrator:</strong><br>
                    Email: paul.everitt@rworld.co.uk<br>
                    Password: Doughball8987!
                </div>
                <div class="demo-account" onclick="fillCredentials('sarah@techcorp.com', 'demo123')">
                    <strong data-translate="client-user-techcorp">Client User (TechCorp):</strong><br>
                    Email: sarah@techcorp.com<br>
                    Password: demo123
                </div>
                <div class="demo-account" onclick="fillCredentials('mike@startupx.com', 'demo123')">
                    <strong data-translate="client-user-startupx">Client User (StartupX):</strong><br>
                    Email: mike@startupx.com<br>
                    Password: demo123
                </div>
            </div>
        </div>
    </div>

    <div class="app-container hidden" id="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <img src="assets/images/rworld-in-line-logo-white.svg" alt="Realworld" style="height: 40px; width: auto;">
            </div>

            <nav>
                <div class="nav-section" id="master-admin-section">
                    <div class="nav-title" data-translate="master-admin">Master Admin</div>
                    <div class="nav-item" onclick="showSection('organizations')">
                        <span data-translate="organizations">Organizations</span>
                    </div>
                    <div class="nav-item" onclick="showSection('users')">
                        <span data-translate="users">User Management</span>
                    </div>
                    <div class="nav-item" onclick="showSection('branding')">
                        <span data-translate="branding">Branding</span>
                    </div>
                </div>

                <div class="nav-section" id="start-listening-section">
                    <div class="nav-item" onclick="showSection('home')">
                        <span>Home</span>
                    </div>
                    <div class="nav-item" onclick="showSection('listen')">
                        <span>Listen</span>
                    </div>
                    <div class="nav-item" onclick="showSection('engage')">
                        <span>Engage</span>
                    </div>
                    <div class="nav-item" onclick="showSection('explore')">
                        <span>Explore</span>
                    </div>
                    <div class="nav-item" onclick="showSection('chat-feedback')">
                        <span data-translate="chat-feedback">Analytics</span>
                    </div>
                    <div class="nav-item" onclick="showSection('chat-management')">
                        <span data-translate="chat-management">Chat Management</span>
                    </div>
                    <div class="nav-item" onclick="showSection('survey-builder')">
                        <span>Survey Builder</span>
                    </div>
                </div>

            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()" aria-label="Toggle Navigation Menu">
                        
                    </button>
                    
                    <!-- Language Selector -->
                    <div class="language-selector">
                        <button class="language-btn" onclick="toggleLanguageDropdown()" id="language-btn">
                            <span class="language-flag" id="current-flag"></span>
                            <span id="current-language">English</span>
                            <span></span>
                        </button>
                        <div class="language-dropdown" id="language-dropdown">
                            <div class="language-option selected" onclick="changeLanguage('en')" data-lang="en">
                                <span class="language-flag"></span>
                                <div class="language-info">
                                    <div class="language-name">English</div>
                                    <div class="language-native">English</div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('es')" data-lang="es">
                                <span class="language-flag"></span>
                                <div class="language-info">
                                    <div class="language-name">Spanish</div>
                                    <div class="language-native">Espaol</div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('fr')" data-lang="fr">
                                <span class="language-flag"></span>
                                <div class="language-info">
                                    <div class="language-name">French</div>
                                    <div class="language-native">Franais</div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('de')" data-lang="de">
                                <span class="language-flag"></span>
                                <div class="language-info">
                                    <div class="language-name">German</div>
                                    <div class="language-native">Deutsch</div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('it')" data-lang="it">
                                <span class="language-flag"></span>
                                <div class="language-info">
                                    <div class="language-name">Italian</div>
                                    <div class="language-native">Italiano</div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('pt')" data-lang="pt">
                                <span class="language-flag"></span>
                                <div class="language-info">
                                    <div class="language-name">Portuguese</div>
                                    <div class="language-native">Portugus</div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('nl')" data-lang="nl">
                                <span class="language-flag"></span>
                                <div class="language-info">
                                    <div class="language-name">Dutch</div>
                                    <div class="language-native">Nederlands</div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('zh')" data-lang="zh">
                                <span class="language-flag"></span>
                                <div class="language-info">
                                    <div class="language-name">Chinese</div>
                                    <div class="language-native"></div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('ja')" data-lang="ja">
                                <span class="language-flag"></span>
                                <div class="language-info">
                                    <div class="language-name">Japanese</div>
                                    <div class="language-native"></div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('ko')" data-lang="ko">
                                <span class="language-flag"></span>
                                <div class="language-info">
                                    <div class="language-name">Korean</div>
                                    <div class="language-native"></div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('ar')" data-lang="ar">
                                <span class="language-flag"></span>
                                <div class="language-info">
                                    <div class="language-name">Arabic</div>
                                    <div class="language-native"></div>
                                </div>
                            </div>
                            <div class="language-option" onclick="changeLanguage('ru')" data-lang="ru">
                                <span class="language-flag"></span>
                                <div class="language-info">
                                    <div class="language-name">Russian</div>
                                    <div class="language-native"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h1 class="breadcrumb" id="breadcrumb" data-translate="dashboard">Dashboard</h1>
                </div>
                <div class="header-right">
                    <div class="user-menu">
                        <div class="user-info" onclick="toggleUserMenu()" id="user-info">
                            <div class="user-avatar" id="user-avatar">PE</div>
                            <div>
                                <div style="font-weight: 500;" id="user-name">Paul Everitt</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);" id="user-role">
                                    Master Administrator
                                    <span class="user-role-badge master-admin" id="user-role-badge">MASTER</span>
                                </div>
                            </div>
                        </div>
                        <div class="user-dropdown" id="user-dropdown">
                            <div class="user-dropdown-item" onclick="showProfile()">
                                <span></span> <span data-translate="profile-settings">Profile Settings</span>
                            </div>
                            <div class="user-dropdown-item" onclick="showOrganizationSettings()">
                                <span></span> <span data-translate="organization-settings">Organization Settings</span>
                            </div>
                            <div class="user-dropdown-item" onclick="showSecuritySettings()">
                                <span></span> <span data-translate="security">Security</span>
                            </div>
                            <div class="user-dropdown-item" onclick="showHelp()">
                                <span></span> <span data-translate="help-support">Help & Support</span>
                            </div>
                            <div class="user-dropdown-item" onclick="handleLogout()" style="color: var(--danger-color); border-top: 1px solid var(--border-color);">
                                <span></span> <span data-translate="sign-out">Sign Out</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="content-area" id="content-area">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="fade-in">
                    <div class="dashboard-grid">
                        <div class="stat-card" onclick="showStatDetails('organizations', '47')">
                            <div class="stat-value">47</div>
                            <div class="stat-label" data-translate="active-organizations">Active Organizations</div>
                        </div>
                        <div class="stat-card" onclick="showStatDetails('users', '1,247')">
                            <div class="stat-value">1,247</div>
                            <div class="stat-label" data-translate="total-users">Total Users</div>
                        </div>
                        <div class="stat-card" onclick="showStatDetails('surveys', '89')">
                            <div class="stat-value">89</div>
                            <div class="stat-label" data-translate="active-surveys">Active Surveys</div>
                        </div>
                        <div class="stat-card" onclick="showStatDetails('responses', '15,632')">
                            <div class="stat-value">15,632</div>
                            <div class="stat-label" data-translate="total-responses">Total Responses</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title" data-translate="recent-activity">Recent Activity</h2>
                            <button class="btn btn-secondary" onclick="handleViewAll()" data-translate="view-all">View All</button>
                        </div>
                        <table class="table" id="activity-table">
                            <thead>
                                <tr>
                                    <th onclick="sortTable(this, 0)" data-translate="organization">Organization</th>
                                    <th onclick="sortTable(this, 1)" data-translate="activity">Activity</th>
                                    <th onclick="sortTable(this, 2)" data-translate="user">User</th>
                                    <th onclick="sortTable(this, 3)" data-translate="time">Time</th>
                                </tr>
                            </thead>
                            <tbody id="activity-table-body">
                                <!-- Recent activity will be loaded from database -->
                                <tr style="text-align: center; color: var(--text-secondary);">
                                    <td colspan="4">No recent activity. Activity will appear here as users interact with your surveys.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Quick Actions Card -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Quick Actions</h2>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <button class="btn btn-primary" onclick="showCreateOrganizationModal()" style="padding: 1rem;">
                                <div></div>
                                <div data-translate="add-organization">Add Organization</div>
                            </button>
                            <button class="btn btn-success" onclick="createNewChat()" style="padding: 1rem;">
                                <div></div>
                                <div data-translate="create-new-chat">Create Chat</div>
                            </button>
                                <div></div>
                                <div>Build Survey</div>
                            </button>
                            <button class="btn btn-warning" onclick="generateAIReport()" style="padding: 1rem;">
                                <div></div>
                                <div>Generate Report</div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Home Section -->
                <div id="home-section" class="hidden">
                    <div style="padding: 40px;">
                        <div style="display: flex; gap: 24px; justify-content: center; align-items: stretch;">

                            <!-- Listen Card -->
                            <div style="flex: 1; max-width: 350px; background: #ffffff; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; flex-direction: column;">
                                <h2 style="font-size: 24px; font-weight: 700; color: #1e293b; margin: 0 0 12px 0;">Listen</h2>
                                <div style="width: 50px; height: 3px; background: #1e2a3b; margin-bottom: 20px;"></div>
                                <p style="color: #64748b; font-size: 15px; line-height: 1.6; flex-grow: 1;">Collect real-time feedback from your employees through anonymous chat surveys. Understand what matters most to your people.</p>
                                <button onclick="showSection('listen')" style="background: #d6366c; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 15px; font-weight: 500; cursor: pointer; margin-top: 20px;">Start Listening</button>
                            </div>

                            <!-- Engage Card -->
                            <div style="flex: 1; max-width: 350px; background: #ffffff; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; flex-direction: column;">
                                <h2 style="font-size: 24px; font-weight: 700; color: #1e293b; margin: 0 0 12px 0;">Engage</h2>
                                <div style="width: 50px; height: 3px; background: #1e2a3b; margin-bottom: 20px;"></div>
                                <p style="color: #64748b; font-size: 15px; line-height: 1.6; flex-grow: 1;">Build meaningful connections with your workforce. Create pulse surveys and gather insights that drive engagement.</p>
                                <button onclick="showSection('engage')" style="background: #d6366c; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 15px; font-weight: 500; cursor: pointer; margin-top: 20px;">Engage Now</button>
                            </div>

                            <!-- Explore Card -->
                            <div style="flex: 1; max-width: 350px; background: #ffffff; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; flex-direction: column;">
                                <h2 style="font-size: 24px; font-weight: 700; color: #1e293b; margin: 0 0 12px 0;">Explore</h2>
                                <div style="width: 50px; height: 3px; background: #1e2a3b; margin-bottom: 20px;"></div>
                                <p style="color: #64748b; font-size: 15px; line-height: 1.6; flex-grow: 1;">Dive deep into your data with powerful analytics. Discover trends, patterns and actionable insights.</p>
                                <button onclick="showSection('explore')" style="background: #d6366c; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 15px; font-weight: 500; cursor: pointer; margin-top: 20px;">Explore Data</button>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Listen Section (Chats) -->
                <div id="listen-section" class="hidden">
                    <div class="chats-container">
                        <main class="chat-dashboard-main">
                            <h1 class="chat-dashboard-section-title">Recent chats</h1>
                            <div class="chats-grid-container">
                                <div class="chats-grid" id="chats-grid">
                                    <!-- New Chat Card -->
                                    <div class="new-chat-card" onclick="openChatEditor()">
                                        <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                        <span>Blank</span>
                                    </div>
                                    <!-- Chat cards will be loaded dynamically from database -->

                                    <!-- Stacked overflow (only shown when needed) -->
                                    <div class="chat-stack" id="chatStack" style="display: none;">
                                        <div class="stack-card stack-3"></div>
                                        <div class="stack-card stack-2"></div>
                                        <div class="stack-card stack-1"></div>
                                        <div class="stack-top">
                                            <span class="stack-count">+5 more</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Expanded overflow section (hidden by default) -->
                                <div class="chats-overflow-expanded" id="chatsOverflowExpanded" style="display: none;">
                                    <div class="overflow-header">
                                        <span>All chats</span>
                                        <button class="btn-show-less" id="showLessBtn">Show less</button>
                                    </div>
                                    <div class="overflow-grid" id="overflowGrid">
                                        <!-- Hidden tiles appear here when expanded -->
                                    </div>
                                </div>
                            </div>
                        </main>
                    </div>
                </div>

                <!-- Chat Editor Section -->
                <div id="chat-editor-section" class="hidden">
                    <!-- Top Header Bar -->
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; border-bottom: 1px solid #e2e8f0; background: white;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <button onclick="showSection('listen')" style="background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 4px; color: #64748b; font-size: 14px;">
                                 Back
                            </button>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 36px; height: 36px; background: #3b82f6; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    <span style="color: white;"></span>
                                </div>
                                <input type="text" id="chat-editor-name" placeholder="Untitled Chat" style="border: none; font-size: 18px; font-weight: 600; outline: none; width: 250px;">
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button style="background: none; border: none; cursor: pointer; font-size: 20px;" title="Settings"></button>
                            <button style="background: none; border: none; cursor: pointer; font-size: 20px;" title="Preview"></button>
                        </div>
                    </div>

                    <!-- Tab Navigation -->
                    <div style="display: flex; gap: 0; border-bottom: 1px solid #e2e8f0; background: white;">
                        <button class="chat-editor-tab active" onclick="showChatEditorTab('setup')" data-tab="setup" style="padding: 16px 24px; border: none; background: none; cursor: pointer; font-size: 14px; color: #3b82f6; border-bottom: 2px solid #3b82f6; font-weight: 500;">Setup</button>
                        <button class="chat-editor-tab" onclick="showChatEditorTab('responses')" data-tab="responses" style="padding: 16px 24px; border: none; background: none; cursor: pointer; font-size: 14px; color: #64748b; border-bottom: 2px solid transparent;">Responses</button>
                        <button class="chat-editor-tab" onclick="showChatEditorTab('settings')" data-tab="settings" style="padding: 16px 24px; border: none; background: none; cursor: pointer; font-size: 14px; color: #64748b; border-bottom: 2px solid transparent;">Settings</button>
                    </div>

                    <!-- Tab Content Area -->
                    <div style="padding: 32px; background: #f8fafc; min-height: calc(100vh - 140px);">

                        <!-- Setup Tab -->
                        <div id="chat-editor-tab-setup" class="chat-editor-tab-content">
                            <div class="chat-editor-setup-content">
                                <!-- Left side: Form -->
                                <div class="chat-editor-form" style="max-width: 500px; background: white; border-radius: 12px; padding: 32px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">

                                    <div style="margin-bottom: 24px;">
                                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1e293b;">Chat Name</label>
                                        <input type="text" id="chat-setup-name" placeholder="e.g., General Feedback, Customer Insights" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                                    </div>

                                    <div style="margin-bottom: 24px;">
                                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1e293b;">Welcome Message</label>
                                        <textarea id="chat-setup-welcome" rows="4" placeholder="Hi! Thanks for taking the time to share your feedback with us." style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; resize: vertical; box-sizing: border-box;">Hi! Thanks for taking the time to share your feedback with us. Please feel free to tell us about your experience or any suggestions you might have.</textarea>
                                        <p style="color: #94a3b8; font-size: 12px; margin-top: 4px;">This message will appear when users first open the chat</p>
                                    </div>

                                    <div style="margin-bottom: 24px;">
                                        <label style="display: block; font-weight: 600; margin-bottom: 12px; color: #1e293b;">Access Type</label>
                                        <div style="display: flex; gap: 16px;">
                                            <div onclick="selectAccessType('open')" id="access-type-open" style="flex: 1; padding: 20px; border: 2px solid #3b82f6; border-radius: 12px; cursor: pointer; text-align: center; background: #eff6ff;">
                                                <div style="font-size: 32px; margin-bottom: 8px;"></div>
                                                <div style="font-weight: 600; color: #1e293b;">Open Access</div>
                                                <div style="font-size: 12px; color: #64748b;">Anyone with the link can access</div>
                                            </div>
                                            <div onclick="selectAccessType('invite')" id="access-type-invite" style="flex: 1; padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; text-align: center;">
                                                <div style="font-size: 32px; margin-bottom: 8px;"></div>
                                                <div style="font-weight: 600; color: #1e293b;">Invite Only</div>
                                                <div style="font-size: 12px; color: #64748b;">Only invited emails can access</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="chat-editor-buttons">
                                        <button onclick="generateChatLink()" class="btn-generate-link">Generate Link</button>
                                        <button type="button" id="saveChatBtn" class="btn-save-chat">Save</button>
                                    </div>

                                </div>

                                <!-- Right side: Success Panel -->
                                <div id="chat-success-panel" class="chat-success-panel" style="display: none;">
                                    <div class="chat-success-card">
                                        <div class="chat-success-header">
                                            <span class="party-emoji"></span>
                                            <h2>Listening Chat Created!</h2>
                                            <button class="chat-success-close-x" id="closeSuccessPanelX">&times;</button>
                                        </div>

                                        <div class="chat-success-ready">
                                            <span class="green-check"></span>
                                            <span>"<span id="successChatName">Untitled Chat</span>" is ready!</span>
                                        </div>
                                        <p class="chat-success-subtitle">Your listening chat has been created and is ready to collect feedback.</p>

                                        <div class="chat-link-section">
                                            <label class="chat-link-label">Your Chat Link</label>
                                            <div class="chat-link-input-group">
                                                <input type="text" id="generatedChatLink" class="chat-link-input" readonly>
                                                <button id="copyLinkBtn" class="copy-link-btn">Copy Link</button>
                                            </div>
                                            <p class="chat-link-helper">Share this link with your audience to start collecting feedback.</p>
                                        </div>

                                        <div class="next-steps-box">
                                            <div class="next-steps-header">
                                                <span></span>
                                                <strong>Next Steps:</strong>
                                            </div>
                                            <ul class="next-steps-list">
                                                <li>Copy and share the link with your audience</li>
                                                <li>Monitor responses in the Active Chats section</li>
                                                <li>View analytics and insights as feedback comes in</li>
                                            </ul>
                                        </div>

                                        <div class="chat-success-buttons">
                                            <button id="closeSuccessPanel" class="btn-close-panel">Close</button>
                                            <button id="testChatBtn" class="btn-test-chat">Test Chat</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Responses Tab -->
                        <div id="chat-editor-tab-responses" class="chat-editor-tab-content" style="display: none;">
                            <div class="responses-tab-content">
                                <!-- Empty state - show when no responses -->
                                <div class="responses-empty-state" id="responsesEmptyState">
                                    <div class="empty-state-icon"></div>
                                    <h3>No responses yet</h3>
                                    <p>Responses will appear here once people start using your chat.</p>
                                </div>

                                <!-- Responses table - always visible -->
                                <div class="responses-table-container" id="responsesTableContainer">
                                    <div class="responses-table-header">
                                        <h3>Responses (<span id="responseCount">0</span>)</h3>
                                        <button class="btn-export-responses" id="exportResponsesBtn">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                <polyline points="7 10 12 15 17 10"></polyline>
                                                <line x1="12" y1="15" x2="12" y2="3"></line>
                                            </svg>
                                            Export CSV
                                        </button>
                                    </div>
                                    <table class="responses-table">
                                        <thead>
                                            <tr>
                                                <th class="col-response">Response</th>
                                                <th class="col-participant" id="participantColumn">Participant</th>
                                                <th class="col-date">Date Submitted</th>
                                                <th class="col-status">Status</th>
                                                <th class="col-actions">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="responsesTableBody">
                                            <!-- Rows will be inserted here by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Settings Tab -->
                        <div id="chat-editor-tab-settings" class="chat-editor-tab-content" style="display: none;">
                            <div style="max-width: 600px; background: white; border-radius: 12px; padding: 32px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
                                <h3 style="margin-bottom: 24px; color: #1e293b;">Chat Settings</h3>
                                <p style="color: #64748b;">Additional settings will be available here.</p>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Organizations Section -->
                <div id="organizations-section" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title" data-translate="organizations">Organizations</h2>
                            <div>
                                <button class="btn btn-secondary" onclick="handleExportData('organizations')">Export</button>
                                <button class="btn btn-primary" onclick="showCreateOrganizationModal()" data-translate="add-organization">
                                    Add Organization
                                </button>
                            </div>
                        </div>

                        <div class="filters">
                            <div class="filter-group">
                                <label class="filter-label">Search</label>
                                <input type="text" class="form-input" placeholder="Search organizations..." 
                                       style="min-width: 200px;" oninput="filterOrganizations('search', this.value)">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label" data-translate="status">Status</label>
                                <select class="form-select" style="min-width: 120px;" onchange="filterOrganizations('status', this.value)">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="suspended">Suspended</option>
                                    <option value="trial">Trial</option>
                                </select>
                            </div>
                        </div>

                        <!-- CSS GRID ORGANIZATIONS TABLE -->
                        <div class="organizations-grid-container">
                            <!-- Header -->
                            <div class="org-grid-header org-grid-cell-1">Organization Name</div>
                            <div class="org-grid-header org-grid-cell-2">Users</div>
                            <div class="org-grid-header org-grid-cell-3">Status</div>
                            <div class="org-grid-header org-grid-cell-4">Last Activity</div>
                            <div class="org-grid-header org-grid-cell-5">Actions</div>
                            
                            <!-- Data rows will be populated here via JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="users-section" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title" data-translate="users">User Management</h2>
                            <div>
                                <button class="btn btn-secondary" onclick="handleBulkAction('users')">Bulk Actions</button>
                                <button class="btn btn-secondary" onclick="handleExportData('users')">Export</button>
                                <button class="btn btn-primary" onclick="showCreateUserModal()" data-translate="add-user">
                                    Add User
                                </button>
                            </div>
                        </div>

                        <div class="filters">
                            <div class="filter-group">
                                <label class="filter-label">Search</label>
                                <input type="text" class="form-input" placeholder="Search users..." 
                                       style="min-width: 200px;" oninput="filterUsers('search', this.value)">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label" data-translate="organization">Organization</label>
                                <select class="form-select" style="min-width: 150px;" onchange="filterUsers('organization', this.value)" id="organization-filter">
                                    <option value="">All Organizations</option>
                                    <!-- Organization options will be populated from database -->
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Role</label>
                                <select class="form-select" style="min-width: 120px;" onchange="filterUsers('role', this.value)">
                                    <option value="">All Roles</option>
                                    <option value="admin">Admin</option>
                                    <option value="user">User</option>
                                    <option value="viewer">Viewer</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label" data-translate="status">Status</label>
                                <select class="form-select" style="min-width: 120px;" onchange="filterUsers('status', this.value)">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="pending">Pending</option>
                                </select>
                            </div>
                        </div>

                        <table class="table" id="users-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" onclick="toggleSelectAll(this, 'users')"></th>
                                    <th onclick="sortTable(this, 1)" data-translate="name">Name</th>
                                    <th onclick="sortTable(this, 2)" data-translate="email">Email</th>
                                    <th onclick="sortTable(this, 3)" data-translate="organization">Organization</th>
                                    <th onclick="sortTable(this, 4)" data-translate="access">Access</th>
                                    <th onclick="sortTable(this, 5)" data-translate="status">Status</th>
                                    <th onclick="sortTable(this, 6)">Last Login</th>
                                    <th data-translate="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- Users will be loaded from database -->
                                <tr style="text-align: center; color: var(--text-secondary);">
                                    <td colspan="8">No users found. Click 'Add User' to invite your first user.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Branding Section -->
                <div id="branding-section" class="hidden">
                    <div class="card">
                        <div class="card-header">
                           <h2 class="card-title">Branding & Customization</h2>
                        <div>
                      <button class="btn btn-secondary" onclick="resetBranding()" style="margin-right: 0.5rem;">Reset to Defaults</button>
                          <button class="btn btn-primary" onclick="saveBranding()">Save Changes</button>
                               </div>
                            </div>
                        
                        <!-- Color Customization Tabs -->
                        <div style="border-bottom: 2px solid var(--border-color); margin-bottom: 2rem;">
                            <div style="display: flex; gap: 1rem;">
                                <button class="color-tab-btn active" onclick="switchColorTab('basic')" data-tab="basic" style="padding: 12px 24px; border: none; background: none; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: all 0.3s;">
                                     Basic Settings
                                </button>
                                <button class="color-tab-btn" onclick="switchColorTab('advanced')" data-tab="advanced" style="padding: 12px 24px; border: none; background: none; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: all 0.3s;">
                                     Advanced Colors
                                </button>
                                <button class="color-tab-btn" onclick="switchColorTab('paint')" data-tab="paint" style="padding: 12px 24px; border: none; background: none; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: all 0.3s;">
                                     Paint Mode
                                </button>
                            </div>
                        </div>

                        <!-- Basic Settings Tab -->
                        <div id="basic-color-tab" class="color-tab-content">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                <div>
                                    <div class="form-group">
                                        <label class="form-label">Company Name</label>
                                        <input type="text" id="brand-company-name" class="form-input" value="Realworld" placeholder="Your Company Name">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label"> Primary Color (Buttons, Links)</label>
                                        <div style="display: flex; gap: 1rem; align-items: center;">
                                            <input type="color" id="brand-primary-color" value="#2563eb" onchange="updateColorPreview('primary', this.value)" style="width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                                            <input type="text" id="brand-primary-color-text" class="form-input" value="#2563eb" onchange="updateColorFromText('primary', this.value)" style="flex: 1;">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label"> Secondary Color (Accents)</label>
                                        <div style="display: flex; gap: 1rem; align-items: center;">
                                            <input type="color" id="brand-secondary-color" value="#64748b" onchange="updateColorPreview('secondary', this.value)" style="width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                                            <input type="text" id="brand-secondary-color-text" class="form-input" value="#64748b" onchange="updateColorFromText('secondary', this.value)" style="flex: 1;">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Font Family</label>
                                        <select id="brand-font" class="form-select">
                                            <option value="system">System Default</option>
                                            <option value="inter">Inter</option>
                                            <option value="roboto">Roboto</option>
                                            <option value="open-sans">Open Sans</option>
                                            <option value="lato">Lato</option>
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <div class="form-group">
                                        <label class="form-label">Logo Upload</label>
                                        <div class="file-upload-area" onclick="document.getElementById('logo-upload').click()">
                                            <input type="file" id="logo-upload" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                                            <div>
                                                <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                                                <div><strong>Click to upload logo</strong></div>
                                                <div style="color: var(--text-secondary); margin-top: 0.5rem;">PNG, JPG up to 2MB</div>
                                                <div style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.5rem;">
                                                     Tip: Use a transparent PNG for best results
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Colors Tab -->
                        <div id="advanced-color-tab" class="color-tab-content" style="display: none;">
                            <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 2rem; border-left: 4px solid #ff9800;">
                                <strong style="display: block; margin-bottom: 5px;"> Full UI Customization</strong>
                                <p style="margin: 0; font-size: 14px; color: #2c3e50;">
                                    Customize every surface of your application. Changes apply instantly to the preview.
                                </p>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                                <!-- Background Colors -->
                                <div class="form-group">
                                    <label class="form-label"> Main Background</label>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <input type="color" id="brand-bg-main" value="#f8fafc" onchange="updateColorPreview('bg-main', this.value)" style="width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                                        <input type="text" id="brand-bg-main-text" class="form-input" value="#f8fafc" onchange="updateColorFromText('bg-main', this.value)" style="flex: 1;">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label"> Secondary Background</label>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <input type="color" id="brand-bg-secondary" value="#ffffff" onchange="updateColorPreview('bg-secondary', this.value)" style="width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                                        <input type="text" id="brand-bg-secondary-text" class="form-input" value="#ffffff" onchange="updateColorFromText('bg-secondary', this.value)" style="flex: 1;">
                                    </div>
                                </div>

                                <!-- Sidebar Colors -->
                                <div class="form-group">
                                    <label class="form-label"> Sidebar Background</label>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <input type="color" id="brand-sidebar-bg" value="#1e293b" onchange="updateColorPreview('sidebar-bg', this.value)" style="width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                                        <input type="text" id="brand-sidebar-bg-text" class="form-input" value="#1e293b" onchange="updateColorFromText('sidebar-bg', this.value)" style="flex: 1;">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label"> Sidebar Text</label>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <input type="color" id="brand-sidebar-text" value="#e2e8f0" onchange="updateColorPreview('sidebar-text', this.value)" style="width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                                        <input type="text" id="brand-sidebar-text-text" class="form-input" value="#e2e8f0" onchange="updateColorFromText('sidebar-text', this.value)" style="flex: 1;">
                                    </div>
                                </div>

                                <!-- Text Colors -->
                                <div class="form-group">
                                    <label class="form-label"> Primary Text</label>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <input type="color" id="brand-text-primary" value="#1e293b" onchange="updateColorPreview('text-primary', this.value)" style="width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                                        <input type="text" id="brand-text-primary-text" class="form-input" value="#1e293b" onchange="updateColorFromText('text-primary', this.value)" style="flex: 1;">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label"> Secondary Text</label>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <input type="color" id="brand-text-secondary" value="#64748b" onchange="updateColorPreview('text-secondary', this.value)" style="width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                                        <input type="text" id="brand-text-secondary-text" class="form-input" value="#64748b" onchange="updateColorFromText('text-secondary', this.value)" style="flex: 1;">
                                    </div>
                                </div>

                                <!-- Card & Border Colors -->
                                <div class="form-group">
                                    <label class="form-label"> Card Background</label>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <input type="color" id="brand-card-bg" value="#ffffff" onchange="updateColorPreview('card-bg', this.value)" style="width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                                        <input type="text" id="brand-card-bg-text" class="form-input" value="#ffffff" onchange="updateColorFromText('card-bg', this.value)" style="flex: 1;">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label"> Border Color</label>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <input type="color" id="brand-border" value="#e2e8f0" onchange="updateColorPreview('border', this.value)" style="width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                                        <input type="text" id="brand-border-text" class="form-input" value="#e2e8f0" onchange="updateColorFromText('border', this.value)" style="flex: 1;">
                                    </div>
                                </div>

                                <!-- Button Colors -->
                                <div class="form-group">
                                    <label class="form-label"> Button Hover</label>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <input type="color" id="brand-button-hover" value="#1d4ed8" onchange="updateColorPreview('button-hover', this.value)" style="width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                                        <input type="text" id="brand-button-hover-text" class="form-input" value="#1d4ed8" onchange="updateColorFromText('button-hover', this.value)" style="flex: 1;">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label"> Success Color</label>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <input type="color" id="brand-success" value="#22c55e" onchange="updateColorPreview('success', this.value)" style="width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                                        <input type="text" id="brand-success-text" class="form-input" value="#22c55e" onchange="updateColorFromText('success', this.value)" style="flex: 1;">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label"> Warning Color</label>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <input type="color" id="brand-warning" value="#f59e0b" onchange="updateColorPreview('warning', this.value)" style="width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                                        <input type="text" id="brand-warning-text" class="form-input" value="#f59e0b" onchange="updateColorFromText('warning', this.value)" style="flex: 1;">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label"> Error Color</label>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <input type="color" id="brand-error" value="#ef4444" onchange="updateColorPreview('error', this.value)" style="width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                                        <input type="text" id="brand-error-text" class="form-input" value="#ef4444" onchange="updateColorFromText('error', this.value)" style="flex: 1;">
                                    </div>
                                </div>
                            </div>

                            <div style="margin-top: 2rem; text-align: center;">
                                <button class="btn btn-secondary" onclick="resetAllColors()" style="margin-right: 1rem;">
                                     Reset All Colors
                                </button>
                                <button class="btn btn-primary" onclick="applyColorsLive()">
                                     Apply Live Preview
                                </button>
                            </div>
                        </div>

                        <!-- Paint Mode Tab -->
                        <div id="paint-color-tab" class="color-tab-content" style="display: none;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; margin-bottom: 2rem; color: white;">
                                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                    <span style="font-size: 48px;"></span>
                                    <div>
                                        <h2 style="margin: 0 0 5px 0; font-size: 24px;">Interactive Paint Mode</h2>
                                        <p style="margin: 0; opacity: 0.9; font-size: 14px;">Click on any element in your application to customize its color</p>
                                    </div>
                                </div>

                                <div id="paint-mode-controls" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                    <button id="toggle-paint-mode" onclick="togglePaintMode()" style="background: white; color: #667eea; border: none; padding: 12px 28px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: all 0.3s;">
                                         Enable Paint Mode
                                    </button>

                                    <div style="display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.2); padding: 10px 15px; border-radius: 8px;">
                                        <label style="font-weight: 600; font-size: 14px;">Brush Color:</label>
                                        <input type="color" id="paint-brush-color" value="#667eea" style="width: 50px; height: 50px; border: 3px solid white; border-radius: 8px; cursor: pointer;">
                                    </div>

                                    <button onclick="clearPaintMode()" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s;">
                                         Clear All
                                    </button>

                                    <button onclick="undoLastPaint()" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s;">
                                         Undo
                                    </button>
                                </div>
                            </div>

                            <!-- Instructions -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 2rem;">
                                <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; border-left: 4px solid #2196f3;">
                                    <h4 style="margin: 0 0 10px 0; color: #1976d2; font-size: 16px;"> Step 1: Enable</h4>
                                    <p style="margin: 0; font-size: 14px; color: #424242; line-height: 1.6;">Click "Enable Paint Mode" to activate the color picker tool</p>
                                </div>

                                <div style="background: #f3e5f5; padding: 20px; border-radius: 10px; border-left: 4px solid #9c27b0;">
                                    <h4 style="margin: 0 0 10px 0; color: #7b1fa2; font-size: 16px;"> Step 2: Pick Color</h4>
                                    <p style="margin: 0; font-size: 14px; color: #424242; line-height: 1.6;">Choose your desired color from the brush color picker</p>
                                </div>

                                <div style="background: #fff3e0; padding: 20px; border-radius: 10px; border-left: 4px solid #ff9800;">
                                    <h4 style="margin: 0 0 10px 0; color: #f57c00; font-size: 16px;"> Step 3: Click & Paint</h4>
                                    <p style="margin: 0; font-size: 14px; color: #424242; line-height: 1.6;">Click on any element (buttons, cards, text, backgrounds) to apply the color</p>
                                </div>
                            </div>

                            <!-- Element Selection Guide -->
                            <div style="background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 25px; margin-bottom: 2rem;">
                                <h3 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 18px; display: flex; align-items: center; gap: 10px;">
                                    <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 8px 12px; border-radius: 8px; color: white;"></span>
                                    What Can You Customize?
                                </h3>

                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                                        <strong style="display: block; color: #495057; margin-bottom: 5px;"> Buttons</strong>
                                        <small style="color: #6c757d;">All button backgrounds and states</small>
                                    </div>

                                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                                        <strong style="display: block; color: #495057; margin-bottom: 5px;"> Cards</strong>
                                        <small style="color: #6c757d;">Card backgrounds and borders</small>
                                    </div>

                                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                                        <strong style="display: block; color: #495057; margin-bottom: 5px;"> Sidebar</strong>
                                        <small style="color: #6c757d;">Navigation and menu items</small>
                                    </div>

                                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                                        <strong style="display: block; color: #495057; margin-bottom: 5px;"> Text</strong>
                                        <small style="color: #6c757d;">Headings and text colors</small>
                                    </div>

                                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                                        <strong style="display: block; color: #495057; margin-bottom: 5px;"> Backgrounds</strong>
                                        <small style="color: #6c757d;">Page and section backgrounds</small>
                                    </div>

                                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                                        <strong style="display: block; color: #495057; margin-bottom: 5px;"> Icons</strong>
                                        <small style="color: #6c757d;">Icon colors and fills</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Paint History -->
                            <div style="background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 25px;">
                                <h3 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 18px;"> Paint History</h3>
                                <div id="paint-history" style="max-height: 300px; overflow-y: auto;">
                                    <div style="text-align: center; padding: 40px; color: #9e9e9e;">
                                        <div style="font-size: 48px; margin-bottom: 10px;"></div>
                                        <p style="margin: 0;">No elements painted yet. Enable paint mode and click on elements to start customizing!</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Welcome Message</label>
                            <textarea id="brand-welcome-message" class="form-input" rows="3" placeholder="Welcome! Your feedback helps us improve...">Welcome! Your feedback helps us improve and create a better workplace for everyone.</textarea>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h4>Preview</h4>
                            </div>
                            <div id="brand-preview" style="padding: 2rem; border: 2px dashed var(--border-color); border-radius: 8px; text-align: center; background: var(--bg-secondary);">
                                <div style="font-size: 2rem; font-weight: bold; color: var(--primary-color); margin-bottom: 1rem;">Realworld</div>
                                <div style="color: var(--text-secondary);">Welcome! Your feedback helps us improve and create a better workplace for everyone.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Section (formerly Chat Feedback) -->
                <div id="chat-feedback-section" class="hidden">
                    <div class="card">
                        <!-- AI-Driven Analytics Dashboard -->
                        <div id="analytics-dashboard-container"></div>
                    </div>
                </div>

                <!-- Chat Management Section -->
                <div id="chat-management-section" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Chat Management</h2>
                            <div>
                                <button class="btn btn-secondary" onclick="manageChatSettings()">Settings</button>
                                <button class="btn btn-primary" onclick="createNewChatWidget()">Create Chat Widget</button>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4>Active Chats</h4>
                                        <small style="color: var(--text-secondary);">Currently active chat sessions</small>
                                    </div>
                                    <button class="btn btn-secondary btn-sm" onclick="loadActiveChatsList()" style="font-size: 0.75rem;"> Refresh</button>
                                </div>
                            </div>
                            
                            <!-- Empty state for now -->
                            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                                <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></div>
                                <h3 style="margin-bottom: 0.5rem;">No Active Chats</h3>
                                <p style="margin-bottom: 2rem;">Active chat sessions will appear here when users start conversations.</p>
                                <button class="btn btn-primary" onclick="createNewChatWidget()">Create Your First Chat Widget</button>
                            </div>
                            
                            <!-- This is where active chats will be listed when they exist -->
                            <div id="active-chats-list" style="display: none;">
                                <!-- Chat items will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Reports Section -->
                <div id="chat-reports-section" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">AI Reports</h2>
                            <div class="button-group">
                                <button class="btn btn-secondary" onclick="showImportDataModal()"> Import Data</button>
                                <button class="btn btn-primary" onclick="generateAIReport()">Generate New Report</button>
                            </div>
                        </div>

                        <div class="dashboard-grid">
                            <div class="stat-card">
                                <div class="stat-value">15</div>
                                <div class="stat-label">Reports Generated</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">847</div>
                                <div class="stat-label">Data Points Analyzed</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">23</div>
                                <div class="stat-label">Insights Discovered</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">94%</div>
                                <div class="stat-label">Accuracy Score</div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h4>Recent AI Reports</h4>
                            </div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Report Name</th>
                                        <th>Generated</th>
                                        <th>Data Source</th>
                                        <th>Insights</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Monthly Sentiment Analysis</strong></td>
                                        <td>Dec 15, 2024</td>
                                        <td>Chat Feedback</td>
                                        <td><span class="tag tag-active">12 insights</span></td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm">View</button>
                                            <button class="btn btn-primary btn-sm">Download</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>User Experience Trends</strong></td>
                                        <td>Dec 12, 2024</td>
                                        <td>All Channels</td>
                                        <td><span class="tag tag-processing">8 insights</span></td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm">View</button>
                                            <button class="btn btn-primary btn-sm">Download</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Survey Builder Section -->
                <div id="survey-builder-section" class="hidden">
                    <div class="survey-builder-container">
                        <!-- Dashboard View -->
                        <div id="sb-dashboard-view">
                            <header class="sb-dashboard-header">
                                <div class="sb-dashboard-header-content">
                                    <div class="sb-logo">S</div>
                                    <span class="sb-dashboard-title">Surveys</span>
                                </div>
                            </header>
                            <main class="sb-dashboard-main">
                                <h1 class="sb-dashboard-section-title">Recent surveys</h1>
                                <div class="sb-surveys-grid" id="sb-surveys-grid">
                                    <!-- New Survey Card -->
                                    <div class="sb-new-survey-card" onclick="sbCreateNewSurvey()">
                                        <svg class="sb-icon-xl" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                        <span>Blank</span>
                                    </div>
                                    <!-- Survey cards will be inserted here -->
                                </div>
                            </main>
                        </div>

                        <!-- Builder View -->
                        <div id="sb-builder-view" class="sb-hidden">
                            <header class="sb-builder-header">
                                <div class="sb-builder-header-top">
                                    <div class="sb-builder-header-left">
                                        <button class="sb-builder-back" onclick="sbGoToDashboard()">
                                            <svg class="sb-icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
                                            Back
                                        </button>
                                        <div class="sb-builder-survey-info">
                                            <div class="sb-builder-survey-icon">
                                                <svg class="sb-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                            </div>
                                            <span class="sb-builder-survey-name" id="sb-builder-survey-name">Untitled Survey</span>
                                        </div>
                                    </div>
                                    <div class="sb-builder-header-right">
                                        <button class="sb-btn-icon" onclick="sbOpenSettings()" title="Settings">
                                            <svg class="sb-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                                        </button>
                                        <button class="sb-btn-icon" onclick="sbPreviewSurvey()" title="Preview">
                                            <svg class="sb-icon" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                        </button>
                                        <button class="sb-btn sb-btn-primary" onclick="sbOpenLinkModal()">Send</button>
                                    </div>
                                </div>
                                <div class="sb-builder-tabs">
                                    <button class="sb-builder-tab active" data-tab="questions">Questions</button>
                                    <button class="sb-builder-tab" data-tab="responses">Responses</button>
                                    <button class="sb-builder-tab" onclick="sbOpenSettings()">Settings</button>
                                </div>
                            </header>

                            <div class="sb-builder-content">
                                <!-- Page Sidebar -->
                                <div class="sb-page-sidebar" id="sb-page-sidebar">
                                    <div class="sb-page-sidebar-title">PAGES</div>
                                    <div id="sb-page-thumbnails"></div>
                                    <button class="sb-add-page-btn" onclick="sbAddPage()">
                                        <svg class="sb-icon-sm" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                        Add page
                                    </button>
                                </div>

                                <!-- Main Builder Area -->
                                <div class="sb-builder-main" id="sb-builder-main">
                                    <!-- Content will be dynamically generated -->
                                </div>
                            </div>

                            <!-- Floating Actions -->
                            <div class="sb-floating-actions" id="sb-floating-actions">
                                <button class="sb-floating-action" onclick="sbAddQuestion('single')" title="Add question">
                                    <svg class="sb-icon-lg" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                </button>
                                <button class="sb-floating-action" onclick="sbAddQuestion('rating')" title="Linear Scale">
                                    <svg class="sb-icon" viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                                </button>
                                <button class="sb-floating-action" onclick="sbAddQuestion('single')" title="Multiple Choice">
                                    <svg class="sb-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle></svg>
                                </button>
                                <button class="sb-floating-action" onclick="sbAddQuestion('multi')" title="Checkboxes">
                                    <svg class="sb-icon" viewBox="0 0 24 24"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
                                </button>
                                <button class="sb-floating-action" onclick="sbAddQuestion('text')" title="Paragraph">
                                    <svg class="sb-icon" viewBox="0 0 24 24"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>
                                </button>
                            </div>

                            <!-- Save Bar -->
                            <div class="sb-save-bar">
                                <button class="sb-btn sb-btn-secondary" onclick="sbGoToDashboard()">Cancel</button>
                                <button class="sb-btn sb-btn-primary" onclick="sbSaveSurvey()">Save</button>
                            </div>
                        </div>

                        <!-- Preview View -->
                        <div id="sb-preview-view" class="sb-hidden"></div>

                        <!-- Settings Panel -->
                        <div id="sb-settings-panel" class="sb-hidden">
                            <div class="sb-settings-overlay" onclick="sbCloseSettings()"></div>
                            <div class="sb-settings-panel">
                                <div class="sb-settings-header">
                                    <h2 class="sb-settings-title">Settings</h2>
                                    <button class="sb-btn-icon" onclick="sbCloseSettings()">
                                        <svg class="sb-icon-lg" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                    </button>
                                </div>
                                <div class="sb-settings-body">
                                    <!-- Theme Colors -->
                                    <div class="sb-settings-section">
                                        <h3 class="sb-settings-section-title">Theme Color</h3>
                                        <div class="sb-theme-colors" id="sb-theme-colors"></div>
                                    </div>

                                    <!-- Dates -->
                                    <div class="sb-settings-section">
                                        <h3 class="sb-settings-section-title">Survey Availability</h3>
                                        <div class="sb-date-inputs">
                                            <div class="sb-date-input-group">
                                                <label>Start Date</label>
                                                <input type="date" id="sb-start-date">
                                            </div>
                                            <div class="sb-date-input-group">
                                                <label>End Date</label>
                                                <input type="date" id="sb-end-date">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Rating Scale -->
                                    <div class="sb-settings-section">
                                        <h3 class="sb-settings-section-title">Rating Scale</h3>
                                        <select id="sb-scale-points" class="sb-select sb-scale-points-select"></select>
                                        <div class="sb-scale-labels" id="sb-scale-labels"></div>
                                    </div>

                                    <!-- Landing Page -->
                                    <div class="sb-settings-section">
                                        <h3 class="sb-settings-section-title">Landing Page Message</h3>
                                        <textarea id="sb-landing-content" class="sb-landing-textarea"></textarea>
                                    </div>

                                    <!-- Thank You -->
                                    <div class="sb-settings-section">
                                        <h3 class="sb-settings-section-title">Confirmation Message</h3>
                                        <textarea id="sb-thankyou-content" class="sb-thankyou-textarea"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Link Modal -->
                        <div id="sb-link-modal" class="sb-hidden">
                            <div class="sb-modal-overlay" onclick="sbCloseLinkModal()">
                                <div class="sb-modal" onclick="event.stopPropagation()">
                                    <h2 class="sb-modal-title">Share Survey</h2>
                                    <p class="sb-modal-text">Anyone with this link can respond to your survey.</p>
                                    <div class="sb-modal-link-row">
                                        <input type="text" id="sb-survey-link" class="sb-modal-link-input" readonly>
                                        <button class="sb-btn sb-btn-primary" onclick="sbCopyLink()">
                                            <svg class="sb-icon" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                                            <span id="sb-copy-btn-text">Copy</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-translate="reset-password">Reset Password</h3>
                <button class="close-btn" onclick="closeModal('forgot-password-modal')">&times;</button>
            </div>
            <form onsubmit="handleForgotPassword(event)">
                <div class="form-group">
                    <label class="form-label" data-translate="email-address">Email Address</label>
                    <input type="email" class="form-input" required placeholder="Enter your email address">
                    <small class="form-help" data-translate="reset-password-help">We'll send you a link to reset your password</small>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('forgot-password-modal')" data-translate="cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-translate="send-reset-link">Send Reset Link</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profile-settings-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 data-translate="profile-settings">Profile Settings</h3>
                <button class="close-btn" onclick="closeModal('profile-settings-modal')">&times;</button>
            </div>
            <form id="profile-form" onsubmit="handleProfileUpdate(event)">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" id="profile-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="profile-email" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Job Title</label>
                    <input type="text" id="profile-job-title" class="form-input" placeholder="e.g., Survey Administrator">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" id="profile-phone" class="form-input" placeholder="+44 1234 567890">
                </div>
                <div class="form-group">
                    <label class="form-label">Time Zone</label>
                    <select id="profile-timezone" class="form-select">
                        <option value="UTC">UTC (Coordinated Universal Time)</option>
                        <option value="Europe/London">Europe/London (GMT/BST)</option>
                        <option value="America/New_York">America/New_York (EST/EDT)</option>
                        <option value="America/Los_Angeles">America/Los_Angeles (PST/PDT)</option>
                        <option value="Europe/Berlin">Europe/Berlin (CET/CEST)</option>
                        <option value="Asia/Tokyo">Asia/Tokyo (JST)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Language Preference</label>
                    <select id="profile-language" class="form-select">
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Bio / Description</label>
                    <textarea id="profile-bio" class="form-input" rows="3" placeholder="Tell us about yourself..."></textarea>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('profile-settings-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Organization Settings Modal -->
    <div id="organization-settings-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 data-translate="organization-settings">Organization Settings</h3>
                <button class="close-btn" onclick="closeModal('organization-settings-modal')">&times;</button>
            </div>
            <form id="organization-form" onsubmit="handleOrganizationUpdate(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Organization Name</label>
                        <input type="text" id="org-name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Industry</label>
                        <select id="org-industry" class="form-select">
                            <option value="">Select Industry</option>
                            <option value="technology">Technology</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="finance">Finance</option>
                            <option value="education">Education</option>
                            <option value="retail">Retail</option>
                            <option value="manufacturing">Manufacturing</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Company Size</label>
                        <select id="org-size" class="form-select">
                            <option value="">Select Size</option>
                            <option value="1-10">1-10 employees</option>
                            <option value="11-50">11-50 employees</option>
                            <option value="51-200">51-200 employees</option>
                            <option value="201-1000">201-1000 employees</option>
                            <option value="1000+">1000+ employees</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Country</label>
                        <select id="org-country" class="form-select">
                            <option value="">Select Country</option>
                            <option value="GB">United Kingdom</option>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="ES">Spain</option>
                            <option value="AU">Australia</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Website</label>
                    <input type="url" id="org-website" class="form-input" placeholder="https://www.example.com">
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="org-description" class="form-input" rows="3" placeholder="Describe your organization..."></textarea>
                </div>

                <div class="card" style="margin: 2rem 0;">
                    <div class="card-header">
                        <h4>Notification Settings</h4>
                    </div>
                    <div style="display: grid; gap: 1rem;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="notify-new-responses">
                            Email notifications for new survey responses
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="notify-weekly-reports">
                            Weekly summary reports
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="notify-system-updates">
                            System updates and maintenance notifications
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="notify-feature-updates">
                            New feature announcements
                        </label>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('organization-settings-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Settings</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Security Settings Modal -->
    <div id="security-settings-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 data-translate="security">Security Settings</h3>
                <button class="close-btn" onclick="closeModal('security-settings-modal')">&times;</button>
            </div>
            
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h4>Change Password</h4>
                </div>
                <form id="password-form" onsubmit="handlePasswordChange(event)">
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <input type="password" id="current-password" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" id="new-password" class="form-input" required minlength="8">
                        <small class="form-help">Must be at least 8 characters long</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" id="confirm-password" class="form-input" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Update Password</button>
                </form>
            </div>

            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h4>Two-Factor Authentication</h4>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <p><strong>Status:</strong> <span id="2fa-status" class="tag tag-inactive">Disabled</span></p>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">Add an extra layer of security to your account</p>
                    </div>
                    <button class="btn btn-primary" id="toggle-2fa" onclick="toggle2FA()">Enable 2FA</button>
                </div>
            </div>

            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h4>Login Sessions</h4>
                </div>
                <div id="login-sessions">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 0.5rem;">
                        <div>
                            <strong>Current Session</strong><br>
                            <small style="color: var(--text-secondary);">Chrome on Windows  London, UK  Active now</small>
                        </div>
                        <span class="tag tag-active">Current</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 0.5rem;">
                        <div>
                            <strong>Mobile Session</strong><br>
                            <small style="color: var(--text-secondary);">Safari on iPhone  London, UK  2 hours ago</small>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="terminateSession('mobile')">Terminate</button>
                    </div>
                </div>
                <button class="btn btn-warning" onclick="terminateAllSessions()">Terminate All Other Sessions</button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h4>Privacy Settings</h4>
                </div>
                <div style="display: grid; gap: 1rem;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="privacy-analytics" checked>
                        Allow usage analytics to improve the platform
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="privacy-marketing">
                        Receive marketing communications
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="privacy-profile" checked>
                        Make my profile visible to organization members
                    </label>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('security-settings-modal')">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveSecuritySettings()">Save Security Settings</button>
            </div>
        </div>
    </div>

    <!-- Help & Support Modal -->
    <div id="help-support-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 data-translate="help-support">Help & Support</h3>
                <button class="close-btn" onclick="closeModal('help-support-modal')">&times;</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <div class="card">
                    <div class="card-header">
                        <h4> Documentation</h4>
                    </div>
                    <div style="display: grid; gap: 0.5rem;">
                        <a href="#" onclick="openHelpArticle('getting-started')" style="color: var(--primary-color); text-decoration: none;">Getting Started Guide</a>
                        <a href="#" onclick="openHelpArticle('analytics')" style="color: var(--primary-color); text-decoration: none;">Analytics & Reporting</a>
                        <a href="#" onclick="openHelpArticle('user-management')" style="color: var(--primary-color); text-decoration: none;">User Management</a>
                        <a href="#" onclick="openHelpArticle('api')" style="color: var(--primary-color); text-decoration: none;">API Documentation</a>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h4> Video Tutorials</h4>
                    </div>
                    <div style="display: grid; gap: 0.5rem;">
                        <a href="#" onclick="playVideo('platform-overview')" style="color: var(--primary-color); text-decoration: none;">Platform Overview (5 min)</a>
                        <a href="#" onclick="playVideo('creating-surveys')" style="color: var(--primary-color); text-decoration: none;">Creating Your First Survey (8 min)</a>
                        <a href="#" onclick="playVideo('analyzing-results')" style="color: var(--primary-color); text-decoration: none;">Analyzing Survey Results (6 min)</a>
                        <a href="#" onclick="playVideo('advanced-features')" style="color: var(--primary-color); text-decoration: none;">Advanced Features (12 min)</a>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h4> Contact Support</h4>
                </div>
                <form id="support-form" onsubmit="handleSupportRequest(event)">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Subject</label>
                            <select class="form-select" required>
                                <option value="">Select a topic</option>
                                <option value="technical">Technical Issue</option>
                                <option value="billing">Billing Question</option>
                                <option value="feature">Feature Request</option>
                                <option value="account">Account Management</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Priority</label>
                            <select class="form-select" required>
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Message</label>
                        <textarea class="form-input" rows="5" placeholder="Describe your issue or question in detail..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox">
                            Include system information in my request
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary">Send Support Request</button>
                </form>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="stat-card" onclick="openLiveChat()">
                    <div class="stat-value"></div>
                    <div class="stat-label">Live Chat</div>
                    <small style="color: var(--success-color);"> Available now</small>
                </div>
                <div class="stat-card" onclick="callSupport()">
                    <div class="stat-value"></div>
                    <div class="stat-label">Phone Support</div>
                    <small style="color: var(--text-secondary);">+44 20 1234 5678</small>
                </div>
                <div class="stat-card" onclick="emailSupport()">
                    <div class="stat-value"></div>
                    <div class="stat-label">Email Support</div>
                    <small style="color: var(--text-secondary);">support@realworld.co.uk</small>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h4> System Information</h4>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
                    <div><strong>Version:</strong> 2.4.1</div>
                    <div><strong>Browser:</strong> <span id="browser-info">Chrome 91.0</span></div>
                    <div><strong>Plan:</strong> <span id="user-plan">Start Listening</span></div>
                    <div><strong>Organization:</strong> <span id="user-org">TechCorp Ltd</span></div>
                    <div><strong>Last Updated:</strong> Dec 15, 2024</div>
                    <div><strong>Server Status:</strong> <span style="color: var(--success-color);"> All systems operational</span></div>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('help-support-modal')">Close</button>
            </div>
        </div>
    </div>

<!-- Supabase JavaScript library -->
<script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
<!-- Supabase client configuration -->
<script src="lib/supabase.js"></script>
<script src="assets/js/config.js"></script>
<script src="assets/js/database.js"></script>
<!-- Chart.js for interactive charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/js/analytics-dashboard.js"></script>
<script src="assets/js/auth-wizard.js"></script>
<script src="assets/js/app.js?v=20250908-2125"></script>
<script>
// NEW CHAT WIDGET FUNCTIONS

// Global storage for templates
if (!window.chatTemplates) {
    window.chatTemplates = [];
}

// UPDATE createNewChatWidget() function to include template selection
function createNewChatWidget() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Create Chat Widget</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            
            <div style="padding: 1.5rem;">
                <h4 style="margin-bottom: 1.5rem; text-align: center; color: var(--text-primary);">Choose Chat Type</h4>
                
                <div class="chat-type-options" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                    <div class="chat-type-option" onclick="selectChatType(this, 'listening')" style="padding: 1.5rem; border: 2px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center;">
                        <input type="radio" name="chatType" value="listening" style="display: none;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                        <h5 style="margin: 0;">Listening</h5>
                    </div>
                    
                    <div class="chat-type-option" onclick="selectChatType(this, 'chat')" style="padding: 1.5rem; border: 2px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center;">
                        <input type="radio" name="chatType" value="chat" style="display: none;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                        <h5 style="margin: 0;">Chat</h5>
                    </div>
                    
                    <div class="chat-type-option" onclick="selectChatType(this, 'pulse')" style="padding: 1.5rem; border: 2px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center;">
                        <input type="radio" name="chatType" value="pulse" style="display: none;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                        <h5 style="margin: 0;">Pulse</h5>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                    <button type="button" class="btn btn-primary" id="next-btn" onclick="proceedToChatSetup()" disabled>Next</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Select chat type function
function selectChatType(element, type) {
    // Remove selection from all options
    document.querySelectorAll('.chat-type-option').forEach(option => {
        option.style.borderColor = 'var(--border-color)';
        option.style.backgroundColor = 'transparent';
    });
    
    // Select the clicked option
    element.style.borderColor = 'var(--primary-color)';
    element.style.backgroundColor = 'var(--bg-secondary)';
    element.style.border = '2px solid var(--primary-color)';
    
    // Check the radio button
    const radio = element.querySelector('input[type="radio"]');
    radio.checked = true;
    
    // Enable the Next button
    document.getElementById('next-btn').disabled = false;
}

// Select access type function
function selectAccessType(element, type) {
    // Remove selection from all access type options
    document.querySelectorAll('.access-type-option').forEach(option => {
        option.style.borderColor = 'var(--border-color)';
        option.style.backgroundColor = 'transparent';
    });
    
    // Select current option
    element.style.borderColor = 'var(--primary-color)';
    element.style.backgroundColor = 'var(--bg-secondary)';
    element.style.border = '2px solid var(--primary-color)';
    
    // Update radio button
    const radio = element.querySelector('input[type="radio"]');
    radio.checked = true;
    
    // Show/hide email invites field based on access type
    const emailInvitesGroup = document.getElementById('email-invites-group') || document.getElementById('listening-email-invites-group');
    if (type === 'closed') {
        if (emailInvitesGroup) emailInvitesGroup.style.display = 'block';
        // Make email field required for closed access
        const emailField = document.getElementById('listening-email-invites') || document.getElementById('chat-email-invites') || document.getElementById('pulse-email-invites');
        if (emailField) {
            emailField.required = true;
        }
    } else {
        if (emailInvitesGroup) emailInvitesGroup.style.display = 'none';
        // Remove required for open access
        const emailField = document.getElementById('listening-email-invites') || document.getElementById('chat-email-invites') || document.getElementById('pulse-email-invites');
        if (emailField) {
            emailField.required = false;
        }
    }
}

// Proceed to chat setup based on selected type
function proceedToChatSetup() {
    const selectedType = document.querySelector('input[name="chatType"]:checked');
    
    if (!selectedType) {
        showToast('Please select a chat type', 'warning');
        return;
    }
    
    const chatType = selectedType.value;
    
    // Close current modal
    document.querySelector('.modal').remove();
    
    // Show the appropriate setup page based on chat type
    switch(chatType) {
        case 'listening':
            showListeningSetup();
            break;
        case 'chat':
            showChatSetup();
            break;
        case 'pulse':
            showPulseSetup();
            break;
        default:
            showToast('Invalid chat type selected', 'error');
    }
}

// Setup functions for each chat type
function showListeningSetup() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3> Listening Chat Setup</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            
            <form onsubmit="generateListeningChatLink(event)">
                <div style="padding: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Chat Name</label>
                        <input type="text" id="listening-chat-name" class="form-input" required 
                               placeholder="e.g., General Feedback, Customer Insights">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Welcome Messages</label>
                        <textarea id="listening-welcome-msg" class="form-input" rows="4"
                                  placeholder="Enter welcome messages that users will see when they start the chat...">Hi! Thanks for taking the time to share your feedback with us. Please feel free to tell us about your experience or any suggestions you might have.</textarea>
                        <small class="form-help">This message will appear when users first open the chat</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Access Type</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div class="access-type-option" onclick="selectAccessType(this, 'open')" style="padding: 1rem; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center;">
                                <input type="radio" name="listeningAccessType" value="open" style="display: none;" checked>
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;"></div>
                                <h6 style="margin: 0;">Open Access</h6>
                                <small style="color: var(--text-secondary);">Anyone with the link can access</small>
                            </div>

                            <div class="access-type-option" onclick="selectAccessType(this, 'closed')" style="padding: 1rem; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center;">
                                <input type="radio" name="listeningAccessType" value="closed" style="display: none;">
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;"></div>
                                <h6 style="margin: 0;">Invite Only</h6>
                                <small style="color: var(--text-secondary);">Only invited emails can access</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="listening-email-invites-group" style="display: none;">
                        <label class="form-label">Email Invitations</label>
                        <textarea id="listening-email-invites" class="form-input" rows="3"
                                  placeholder="Enter email addresses separated by commas or new lines&#10;e.g., john@company.com, sarah@company.com"></textarea>
                        <small class="form-help">Only these email addresses will be able to access the chat</small>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Generate Link</button>
                    </div>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Focus on the chat name input
    setTimeout(() => {
        document.getElementById('listening-chat-name').focus();
    }, 100);
}

// Generate listening chat link
function generateListeningChatLink(event) {
    event.preventDefault();
    
    const chatName = document.getElementById('listening-chat-name').value;
    const welcomeMsg = document.getElementById('listening-welcome-msg').value;
    const accessType = document.querySelector('input[name="listeningAccessType"]:checked').value;
    const emailInvites = document.getElementById('listening-email-invites').value;

    // Generate unique session ID for listening chat
    const sessionId = 'listening_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

    // Create URL parameters
    const params = new URLSearchParams({
        session: sessionId,
        type: 'listening',
        name: chatName,
        welcome: welcomeMsg,
        access: accessType
    });

    // Add email invites if access type is closed
    if (accessType === 'closed' && emailInvites.trim()) {
        params.set('emails', emailInvites);
    }
    
    // Generate the original link
    const originalLink = 'https://employee-survey-platform.surge.sh/chat.html?' + params.toString();
    
    // Prepare chat data
    const chatData = {
        id: sessionId,
        name: chatName,
        type: 'listening',
        welcome: welcomeMsg,
        access: accessType,
        emails: accessType === 'closed' ? emailInvites : '',
        link: originalLink,
        created: new Date().toISOString()
    };
    
    // Generate short URL
    const shortUrl = generateShortUrl(chatName, originalLink, chatData);
    chatData.shortUrl = shortUrl;
    
    // Save to database
    saveChatSession(chatData).then(() => {
        console.log('Listening chat saved to database');
        // Refresh the active chats display
        loadActiveChatsList();
    }).catch(error => {
        console.error('Error saving listening chat:', error);
    });
    
    // Close current modal (remove all modals to be safe)
    document.querySelectorAll('.modal').forEach(modal => modal.remove());
    
    // Show success toast
    showToast(`Listening chat "${chatName}" created successfully!`, 'success');

    // Add to chat management interface
    addChatToManagement(chatData);

    // Check access type and handle accordingly
    if (accessType === 'open') {
        // For open access, show popup with link
        showListeningLinkModal(chatData);
    } else {
        // For invite only, navigate to chat management section (existing behavior)
        setTimeout(() => {
            // Hide all sections first
            document.querySelectorAll('[id$="-section"]').forEach(section => {
                section.classList.add('hidden');
            });

            // Show chat management section
            const chatMgmtSection = document.getElementById('chat-management-section');
            if (chatMgmtSection) {
                chatMgmtSection.classList.remove('hidden');
            }

            // Update navigation highlight
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const chatMgmtNavItem = document.querySelector('[onclick="showSection(\'chat-management\')"]');
            if (chatMgmtNavItem) {
                chatMgmtNavItem.classList.add('active');
            }
        }, 100);
    }
}

// Show modal with generated listening chat link
function showListeningLinkModal(chatData) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3> Listening Chat Created!</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            
            <div style="padding: 1.5rem;">
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--success-color); border: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 0.5rem; color: var(--success-color);"> "${chatData.name}" is ready!</h4>
                    <p style="color: var(--text-primary); margin: 0; font-size: 0.9rem;">Your listening chat has been created and is ready to collect feedback.</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Your Chat Link</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" class="form-input" value="${chatData.shortUrl || chatData.link}" readonly id="generated-link" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="copyToClipboard('generated-link')" style="white-space: nowrap;">Copy Link</button>
                    </div>
                    <small class="form-help">Share this link with your audience to start collecting feedback</small>
                </div>
                
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid var(--border-color);">
                    <h5 style="margin-bottom: 0.75rem;"> Next Steps:</h5>
                    <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem;">
                        <li>Copy and share the link with your audience</li>
                        <li>Monitor responses in the Active Chats section</li>
                        <li>View analytics and insights as feedback comes in</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                    <button class="btn btn-primary" onclick="testChatLink('${chatData.link}')">Test Chat</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Auto-select the link text for easy copying
    setTimeout(() => {
        document.getElementById('generated-link').select();
    }, 100);
}

// Copy to clipboard function
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    element.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(element.value).then(() => {
        showToast('Link copied to clipboard!', 'success');
    });
}

// Test chat link function
function testChatLink(link) {
    window.open(link, '_blank');
}

function showChatSetup() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3> Chat Setup</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            
            <form onsubmit="generateGuidedChatLink(event)">
                <div style="padding: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Chat Name</label>
                        <input type="text" id="chat-name" class="form-input" required 
                               placeholder="e.g., Employee Wellbeing Check, Team Feedback">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Welcome Messages</label>
                        <textarea id="chat-welcome-msg" class="form-input" rows="4" 
                                  placeholder="Enter welcome messages that users will see when they start the chat...">Hi! I'm here to have a conversation with you about your work experience. Please feel free to share your thoughts and experiences with me.</textarea>
                        <small class="form-help">This message will appear when users first open the chat</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Work-Life Topics</label>
                        <textarea id="chat-topics" class="form-input" rows="3" 
                                  placeholder="Enter topics the AI should naturally work into conversations (e.g., finance, mental health, work-life balance, career development...)">finance, mental health, work-life balance</textarea>
                        <small class="form-help">The AI will naturally weave these topics into conversations, not as direct questions but as discussion areas</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Access Type</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div class="access-type-option" onclick="selectAccessType(this, 'open')" style="padding: 1rem; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center;">
                                <input type="radio" name="accessType" value="open" style="display: none;" checked>
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;"></div>
                                <h6 style="margin: 0;">Open Access</h6>
                                <small style="color: var(--text-secondary);">Anyone with the link can access</small>
                            </div>
                            
                            <div class="access-type-option" onclick="selectAccessType(this, 'closed')" style="padding: 1rem; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center;">
                                <input type="radio" name="accessType" value="closed" style="display: none;">
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;"></div>
                                <h6 style="margin: 0;">Invite Only</h6>
                                <small style="color: var(--text-secondary);">Only invited emails can access</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" id="email-invites-group" style="display: none;">
                        <label class="form-label">Email Invitations</label>
                        <textarea id="chat-email-invites" class="form-input" rows="3" 
                                  placeholder="Enter email addresses separated by commas or new lines&#10;e.g., john@company.com, sarah@company.com"></textarea>
                        <small class="form-help">Only these email addresses will be able to access the chat</small>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Generate Link</button>
                    </div>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Focus on the chat name input
    setTimeout(() => {
        document.getElementById('chat-name').focus();
    }, 100);
}

// Generate guided chat link with topics
function generateGuidedChatLink(event) {
    event.preventDefault();
    
    const chatName = document.getElementById('chat-name').value;
    const welcomeMsg = document.getElementById('chat-welcome-msg').value;
    const topics = document.getElementById('chat-topics').value;
    const accessType = document.querySelector('input[name="accessType"]:checked').value;
    const emailInvites = document.getElementById('chat-email-invites').value;
    
    // Validate email invites for closed access
    if (accessType === 'closed' && (!emailInvites || emailInvites.trim() === '')) {
        showToast('Please enter email addresses for invite-only access', 'error');
        return;
    }
    
    // Parse and validate email addresses for closed access
    let invitedEmails = [];
    if (accessType === 'closed') {
        const rawEmails = emailInvites.split(/[,\n]/).map(email => email.trim()).filter(email => email);
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        for (let email of rawEmails) {
            if (!emailRegex.test(email)) {
                showToast(`Invalid email address: ${email}`, 'error');
                return;
            }
        }
        invitedEmails = rawEmails;
    }
    
    // Generate unique session ID for chat
    const sessionId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // Create URL parameters
    const params = new URLSearchParams({
        session: sessionId,
        type: 'chat',
        name: chatName,
        welcome: welcomeMsg,
        topics: topics
    });
    
    // Generate the original link
    const originalLink = 'https://employee-survey-platform.surge.sh/chat.html?' + params.toString();
    
    // Prepare chat data
    const chatData = {
        id: sessionId,
        name: chatName,
        type: 'chat',
        welcome: welcomeMsg,
        topics: topics,
        link: originalLink,
        accessType: accessType,
        invitedEmails: invitedEmails,
        created: new Date().toISOString()
    };
    
    // Generate short URL
    const shortUrl = generateShortUrl(chatName, originalLink, chatData);
    chatData.shortUrl = shortUrl;
    
    // Save to database
    saveChatSession(chatData).then(() => {
        console.log('Guided chat saved to database');
        // Refresh the active chats display
        loadActiveChatsList();
    }).catch(error => {
        console.error('Error saving guided chat:', error);
    });
    
    // Close current modal
    document.querySelector('.modal').remove();
    
    // Show success modal with link
    showChatLinkModal(chatData);
}

// Show modal with generated chat link
function showChatLinkModal(chatData) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3> Chat Created!</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            
            <div style="padding: 1.5rem;">
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--success-color); border: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 0.5rem; color: var(--success-color);"> "${chatData.name}" is ready!</h4>
                    <p style="color: var(--text-primary); margin: 0; font-size: 0.9rem;">Your chat is ready with AI guidance on: <strong>${chatData.topics}</strong></p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Your Chat Link</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" class="form-input" value="${chatData.shortUrl || chatData.link}" readonly id="generated-chat-link" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="copyToClipboard('generated-chat-link')" style="white-space: nowrap;">Copy Link</button>
                    </div>
                    <small class="form-help">Share this link with your audience to start guided conversations</small>
                </div>
                
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid var(--border-color);">
                    <h5 style="margin-bottom: 0.75rem;"> AI Conversation Topics:</h5>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                        ${chatData.topics.split(',').map(topic => `
                            <span style="padding: 0.25rem 0.75rem; background: #e0f2fe; color: #0369a1; border-radius: 12px; font-size: 0.85rem;">${topic.trim()}</span>
                        `).join('')}
                    </div>
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 0;">The AI will naturally guide conversations to explore these areas of work-life experience.</p>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                    <button class="btn btn-primary" onclick="testChatLink('${chatData.link}')">Test Chat</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Auto-select the link text for easy copying
    setTimeout(() => {
        document.getElementById('generated-chat-link').select();
    }, 100);
}

function showPulseSetup() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3> Pulse Survey Setup</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            
            <form onsubmit="generatePulseLink(event)">
                <div style="padding: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Survey Name</label>
                        <input type="text" id="pulse-name" class="form-input" required 
                               placeholder="e.g., Weekly Team Pulse, Employee Satisfaction Check">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Welcome Messages</label>
                        <textarea id="pulse-welcome-msg" class="form-input" rows="4" 
                                  placeholder="Enter welcome messages that users will see when they start the survey...">Hi! I'd like to ask you a few quick questions to get a pulse on how things are going. This should only take a few minutes.</textarea>
                        <small class="form-help">This message will appear when users first open the chat</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Survey Questions</label>
                        <div id="pulse-questions-container">
                            <div class="question-item" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                    <input type="text" class="form-input question-text" placeholder="Enter your question..." style="flex: 2;" value="How satisfied are you with your current workload?">
                                    <select class="form-select question-type" style="flex: 1;">
                                        <option value="rating">Rating Scale (1-5)</option>
                                        <option value="yes-no">Yes/No</option>
                                        <option value="multiple-choice">Multiple Choice</option>
                                        <option value="text">Open Text</option>
                                    </select>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeQuestion(this)"></button>
                                </div>
                                <div class="question-options" style="display: none;">
                                    <label class="form-label" style="font-size: 0.85rem;">Options (one per line):</label>
                                    <textarea class="form-input options-text" rows="3" placeholder="Option 1&#10;Option 2&#10;Option 3"></textarea>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addPulseQuestion()">+ Add Question</button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Access Type</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div class="access-type-option" onclick="selectAccessType(this, 'open')" style="padding: 1rem; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center;">
                                <input type="radio" name="accessType" value="open" style="display: none;" checked>
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;"></div>
                                <h6 style="margin: 0;">Open Access</h6>
                                <small style="color: var(--text-secondary);">Anyone with the link can access</small>
                            </div>
                            
                            <div class="access-type-option" onclick="selectAccessType(this, 'closed')" style="padding: 1rem; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center;">
                                <input type="radio" name="accessType" value="closed" style="display: none;">
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;"></div>
                                <h6 style="margin: 0;">Invite Only</h6>
                                <small style="color: var(--text-secondary);">Only invited emails can access</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" id="email-invites-group" style="display: none;">
                        <label class="form-label">Email Invitations</label>
                        <textarea id="pulse-email-invites" class="form-input" rows="3" 
                                  placeholder="Enter email addresses separated by commas or new lines&#10;e.g., john@company.com, sarah@company.com"></textarea>
                        <small class="form-help">Only these email addresses will be able to access the survey</small>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Generate Survey Link</button>
                    </div>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Add event listeners for question type changes
    setupQuestionTypeListeners();
    
    // Focus on the survey name input
    setTimeout(() => {
        document.getElementById('pulse-name').focus();
    }, 100);
}

// Setup event listeners for question type changes
function setupQuestionTypeListeners() {
    document.querySelectorAll('.question-type').forEach(select => {
        select.addEventListener('change', function() {
            const optionsDiv = this.closest('.question-item').querySelector('.question-options');
            if (this.value === 'multiple-choice') {
                optionsDiv.style.display = 'block';
            } else {
                optionsDiv.style.display = 'none';
            }
        });
    });
}

// Add new question to pulse survey
function addPulseQuestion() {
    const container = document.getElementById('pulse-questions-container');
    const questionItem = document.createElement('div');
    questionItem.className = 'question-item';
    questionItem.style.cssText = 'border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;';
    
    questionItem.innerHTML = `
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <input type="text" class="form-input question-text" placeholder="Enter your question..." style="flex: 2;">
            <select class="form-select question-type" style="flex: 1;">
                <option value="rating">Rating Scale (1-5)</option>
                <option value="yes-no">Yes/No</option>
                <option value="multiple-choice">Multiple Choice</option>
                <option value="text">Open Text</option>
            </select>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeQuestion(this)"></button>
        </div>
        <div class="question-options" style="display: none;">
            <label class="form-label" style="font-size: 0.85rem;">Options (one per line):</label>
            <textarea class="form-input options-text" rows="3" placeholder="Option 1&#10;Option 2&#10;Option 3"></textarea>
        </div>
    `;
    
    container.appendChild(questionItem);
    setupQuestionTypeListeners();
}

// Remove question from pulse survey
function removeQuestion(button) {
    button.closest('.question-item').remove();
}

// Generate pulse survey link
function generatePulseLink(event) {
    event.preventDefault();
    
    const surveyName = document.getElementById('pulse-name').value;
    const welcomeMsg = document.getElementById('pulse-welcome-msg').value;
    const accessType = document.querySelector('input[name="accessType"]:checked').value;
    const emailInvites = document.getElementById('pulse-email-invites').value;
    
    // Collect all questions
    const questions = [];
    document.querySelectorAll('.question-item').forEach(item => {
        const questionText = item.querySelector('.question-text').value;
        const questionType = item.querySelector('.question-type').value;
        const options = item.querySelector('.options-text').value;
        
        if (questionText.trim()) {
            const question = {
                text: questionText,
                type: questionType
            };
            
            if (questionType === 'multiple-choice' && options.trim()) {
                question.options = options.split('\n').map(opt => opt.trim()).filter(opt => opt);
            }
            
            questions.push(question);
        }
    });
    
    if (questions.length === 0) {
        showToast('Please add at least one question', 'warning');
        return;
    }
    
    // Validate email invites for closed access
    if (accessType === 'closed' && (!emailInvites || emailInvites.trim() === '')) {
        showToast('Please enter email addresses for invite-only access', 'error');
        return;
    }
    
    // Parse and validate email addresses for closed access
    let invitedEmails = [];
    if (accessType === 'closed') {
        const rawEmails = emailInvites.split(/[,\n]/).map(email => email.trim()).filter(email => email);
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        for (let email of rawEmails) {
            if (!emailRegex.test(email)) {
                showToast(`Invalid email address: ${email}`, 'error');
                return;
            }
        }
        invitedEmails = rawEmails;
    }
    
    // Generate unique session ID for pulse survey
    const sessionId = 'pulse_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // Create URL parameters
    const params = new URLSearchParams({
        session: sessionId,
        type: 'pulse',
        name: surveyName,
        welcome: welcomeMsg,
        questions: JSON.stringify(questions)
    });
    
    // Generate the original link
    const originalLink = 'https://employee-survey-platform.surge.sh/chat.html?' + params.toString();
    
    // Prepare chat data
    const chatData = {
        id: sessionId,
        name: surveyName,
        type: 'pulse',
        welcome: welcomeMsg,
        questions: questions,
        link: originalLink,
        accessType: accessType,
        invitedEmails: invitedEmails,
        created: new Date().toISOString()
    };
    
    // Generate short URL
    const shortUrl = generateShortUrl(surveyName, originalLink, chatData);
    chatData.shortUrl = shortUrl;
    
    // Save to database
    saveChatSession(chatData).then(() => {
        console.log('Pulse survey saved to database');
        // Refresh the active chats display
        loadActiveChatsList();
    }).catch(error => {
        console.error('Error saving pulse survey:', error);
    });
    
    // Close current modal (remove all modals to be safe)
    document.querySelectorAll('.modal').forEach(modal => modal.remove());
    
    // Show success toast
    showToast(`Pulse survey "${surveyName}" created successfully!`, 'success');
    
    // Add to chat management interface
    addChatToManagement(chatData);
    
    // Navigate to chat management section
    setTimeout(() => {
        // Hide all sections first
        document.querySelectorAll('[id$="-section"]').forEach(section => {
            section.classList.add('hidden');
        });
        
        // Show chat management section
        const chatMgmtSection = document.getElementById('chat-management-section');
        if (chatMgmtSection) {
            chatMgmtSection.classList.remove('hidden');
        }
        
        // Update navigation highlight
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        const chatMgmtNavItem = document.querySelector('[onclick="showSection(\'chat-management\')"]');
        if (chatMgmtNavItem) {
            chatMgmtNavItem.classList.add('active');
        }
    }, 100);
}

// Show modal with generated pulse survey link
function showPulseLinkModal(pulseData) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3> Pulse Survey Created!</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            
            <div style="padding: 1.5rem;">
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--success-color); border: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 0.5rem; color: var(--success-color);"> "${pulseData.name}" is ready!</h4>
                    <p style="color: var(--text-primary); margin: 0; font-size: 0.9rem;">Your pulse survey with ${pulseData.questions.length} questions is ready to collect responses.</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Your Survey Link</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" class="form-input" value="${pulseData.shortUrl || pulseData.link}" readonly id="generated-pulse-link" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="copyToClipboard('generated-pulse-link')" style="white-space: nowrap;">Copy Link</button>
                    </div>
                    <small class="form-help">Share this link to collect structured feedback through chat</small>
                </div>
                
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid var(--border-color);">
                    <h5 style="margin-bottom: 0.75rem;"> Survey Questions Preview:</h5>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${pulseData.questions.map((q, index) => `
                            <div style="margin-bottom: 1rem; padding: 0.75rem; background: white; border-radius: 6px; border-left: 3px solid var(--primary-color);">
                                <div style="font-weight: 500; margin-bottom: 0.25rem;">${index + 1}. ${q.text}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    Type: ${q.type === 'rating' ? 'Rating Scale (1-5)' : q.type === 'yes-no' ? 'Yes/No' : q.type === 'multiple-choice' ? 'Multiple Choice' : 'Open Text'}
                                    ${q.options ? `<br>Options: ${q.options.join(', ')}` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                    <button class="btn btn-primary" onclick="testChatLink('${pulseData.link}')">Test Survey</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Auto-select the link text for easy copying
    setTimeout(() => {
        document.getElementById('generated-pulse-link').select();
    }, 100);
}

function toggleChatTypeFields() {
    // Placeholder for any future functionality
}

// UPDATE generateChatLink to include template data
async function generateChatLink(event) {
    event.preventDefault();
    
    // Get chat type
    const chatType = document.querySelector('input[name="chatType"]:checked').value;
    
    // Get common form values
    const sessionName = document.getElementById('chat-session-name').value;
    const welcomeMsg = document.getElementById('chat-welcome-msg').value;
    
    // Get selected template data
    const templateData = document.getElementById('selected-template-data').value;
    const template = templateData ? JSON.parse(templateData) : null;
    
    if (chatType === 'continuous') {
        // Handle continuous chat with template
        generateContinuousChatLink(sessionName, welcomeMsg, template);
    } else {
        // Handle personal chat with template
        generatePersonalChatLinks(sessionName, welcomeMsg, template);
    }
}

// UPDATE generateContinuousChatLink to include template
function generateContinuousChatLink(sessionName, welcomeMsg, template = null) {
    const expiry = document.getElementById('chat-expiry').value;
    const allowAnonymous = document.getElementById('chat-anonymous').checked;
    const optionalEmail = document.getElementById('chat-optional-email').checked;
    
    // Generate unique session ID for continuous chat
    const sessionId = 'continuous_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // Create URL parameters
    const params = new URLSearchParams({
        id: sessionId,
        type: 'continuous',
        name: sessionName,
        welcome: welcomeMsg,
        expiry: expiry,
        anonymous: allowAnonymous,
        optionalEmail: optionalEmail
    });
    
    // Add template ID if selected
    if (template) {
        params.append('templateId', template.id);
    }
    
    // Generate the link
    const chatLink = 'https://employee-survey-platform.surge.sh/chat.html?' + params.toString();
    
    // Store session data with template
    const chatSessionData = {
        id: sessionId,
        type: 'continuous',
        name: sessionName,
        welcomeMsg: welcomeMsg,
        expiry: expiry,
        allowAnonymous: allowAnonymous,
        optionalEmail: optionalEmail,
        link: chatLink,
        template: template,  // Include template data
        created: new Date().toISOString()
    };
    
    // Store the session (in real app, this would go to database)
    if (!window.chatSessions) {
        window.chatSessions = [];
    }
    window.chatSessions.push(chatSessionData);
    
    // Close current modal
    document.querySelector('.modal').remove();
    
    // Show success modal with link
    showContinuousChatLinkModal(chatSessionData);
}

// Function to generate personal chat links
async function generatePersonalChatLinks(sessionName, welcomeMsg, template = null) {
    const participants = window.tempParticipants || [];
    
    if (participants.length === 0) {
        showToast('Please add participants first', 'warning');
        return;
    }
    
    const expiry = document.getElementById('personal-chat-expiry').value;
    const sendInvites = document.getElementById('send-email-invites').checked;
    const trackResponses = document.getElementById('track-responses').checked;
    const allowMultiple = document.getElementById('allow-multiple-responses').checked;
    
    // Generate unique links for each participant
    const personalLinks = [];
    const baseSessionId = 'personal_' + Date.now();
    
    participants.forEach((participant, index) => {
        const personalId = baseSessionId + '_' + index + '_' + Math.random().toString(36).substr(2, 9);
        
        const params = new URLSearchParams({
            id: personalId,
            type: 'personal',
            name: sessionName,
            welcome: welcomeMsg,
            expiry: expiry,
            participantName: participant.name,
            participantEmail: participant.email,
            trackResponses: trackResponses,
            allowMultiple: allowMultiple
        });
        
        // Add template ID if selected
        if (template) {
            params.append('templateId', template.id);
        }
        
        const link = 'https://employee-survey-platform.surge.sh/chat.html?' + params.toString();
        
        personalLinks.push({
            participant: participant,
            link: link,
            id: personalId,
            responded: false,
            responseCount: 0
        });
    });
    
    // Store session data
    const chatSessionData = {
        id: baseSessionId,
        type: 'personal',
        name: sessionName,
        welcomeMsg: welcomeMsg,
        expiry: expiry,
        trackResponses: trackResponses,
        allowMultiple: allowMultiple,
        personalLinks: personalLinks,
        template: template,  // Include template data
        created: new Date().toISOString()
    };
    
    // Store the session
    if (!window.chatSessions) {
        window.chatSessions = [];
    }
    window.chatSessions.push(chatSessionData);
    
    // Send email invites if selected
    if (sendInvites) {
        await sendPersonalInvites(personalLinks, sessionName);
    }
    
    // Close current modal
    document.querySelector('.modal').remove();
    
    // Show success modal with links
    showPersonalChatLinksModal(chatSessionData);
}

// Show success modal for continuous chat
function showContinuousChatLinkModal(sessionData) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3> Continuous Chat Link Generated!</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div>
                <div class="alert alert-success" style="margin-bottom: 1.5rem;">
                    <strong>Success!</strong> Your continuous chat link for "${sessionData.name}" is ready.
                </div>
                
                <div class="form-group">
                    <label class="form-label">Share this link with all participants:</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="generated-link" class="form-input" value="${sessionData.link}" 
                               readonly style="font-family: monospace; font-size: 0.875rem;">
                        <button class="btn btn-primary" onclick="copyLinkToClipboard()">Copy</button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem;">
                    <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                        <strong> Link Settings:</strong>
                        <ul style="margin: 0.5rem 0 0 1rem; font-size: 0.875rem;">
                            <li>Type: Continuous (Shared)</li>
                            <li>Expiry: ${sessionData.expiry === 'never' ? 'Never' : sessionData.expiry}</li>
                            <li>Anonymous: ${sessionData.allowAnonymous ? 'Yes' : 'No'}</li>
                        </ul>
                    </div>
                    <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                        <strong> Usage:</strong>
                        <ul style="margin: 0.5rem 0 0 1rem; font-size: 0.875rem;">
                            <li>Share via email, social media, or website</li>
                            <li>Unlimited participants</li>
                            <li>Real-time response tracking</li>
                        </ul>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem;">
                    <label class="form-label">QR Code (for easy mobile access):</label>
                    <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color); text-align: center;">
                        <div style="width: 200px; height: 200px; margin: 0 auto; background: var(--bg-secondary); 
                                    display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                            <span style="color: var(--text-secondary);">QR Code Here</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="testChatLink('${sessionData.link}')">
                         Test Link
                    </button>
                    <button class="btn btn-success" onclick="emailChatLink(${JSON.stringify(sessionData).replace(/"/g, '&quot;')})">
                         Email to Me
                    </button>
                    <button class="btn btn-primary" onclick="downloadQRCode()">
                         Download QR
                    </button>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="generateAnotherLink()">Create Another</button>
                    <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Done</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    showToast('Continuous chat link generated successfully!', 'success');
}

// Show success modal for personal chat links
function showPersonalChatLinksModal(sessionData) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3> Personal Chat Links Generated!</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div>
                <div class="alert alert-success" style="margin-bottom: 1.5rem;">
                    <strong>Success!</strong> Generated ${sessionData.personalLinks.length} unique personal links for "${sessionData.name}"
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                        <strong> Session Settings:</strong>
                        <ul style="margin: 0.5rem 0 0 1rem; font-size: 0.875rem;">
                            <li>Type: Personal (Individual Links)</li>
                            <li>Participants: ${sessionData.personalLinks.length}</li>
                            <li>Expiry: ${sessionData.expiry}</li>
                            <li>Response Tracking: ${sessionData.trackResponses ? 'Enabled' : 'Disabled'}</li>
                        </ul>
                    </div>
                    <div style="padding: 1rem; background: #dcfce7; border-radius: 8px;">
                        <strong> Email Status:</strong>
                        <div style="margin-top: 0.5rem; font-size: 0.875rem;">
                            <div id="email-status">Preparing to send invitations...</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Participant Links:</label>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Personal Link</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sessionData.personalLinks.map(item => `
                                    <tr>
                                        <td>${item.participant.name}</td>
                                        <td>${item.participant.email}</td>
                                        <td>
                                            <input type="text" value="${item.link}" readonly 
                                                   style="width: 100%; font-size: 0.75rem; font-family: monospace;">
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary" 
                                                    onclick="copyPersonalLink('${item.link}')">Copy</button>
                                            <button class="btn btn-sm btn-primary" 
                                                    onclick="testChatLink('${item.link}')">Test</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="exportPersonalLinks(${JSON.stringify(sessionData).replace(/"/g, '&quot;')})">
                         Export to CSV
                    </button>
                    <button class="btn btn-success" onclick="resendAllInvites(${JSON.stringify(sessionData).replace(/"/g, '&quot;')})">
                         Resend All Invites
                    </button>
                    <button class="btn btn-primary" onclick="viewResponseTracking('${sessionData.id}')">
                         Track Responses
                    </button>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="generateAnotherLink()">Create Another</button>
                    <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Done</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    showToast(`Generated ${sessionData.personalLinks.length} personal chat links!`, 'success');
}

// Send personal invites via email
async function sendPersonalInvites(personalLinks, sessionName) {
    const emailStatus = document.getElementById('email-status');
    let successCount = 0;
    let failCount = 0;
    
    for (const linkData of personalLinks) {
        try {
            // Simulated API call - replace with actual endpoint
            const response = await fetch('/api/send-chat-invite', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: linkData.participant.email,
                    name: linkData.participant.name,
                    sessionName: sessionName,
                    personalLink: linkData.link
                }),
            });
            
            if (response.ok) {
                successCount++;
            } else {
                failCount++;
            }
        } catch (error) {
            failCount++;
            console.error('Failed to send invite to', linkData.participant.email, error);
        }
        
        // Update status
        if (emailStatus) {
            emailStatus.textContent = `Sent ${successCount} of ${personalLinks.length} invitations...`;
        }
    }
    
    // Final status
    if (emailStatus) {
        if (failCount === 0) {
            emailStatus.innerHTML = `<span style="color: var(--success-color);"> All ${successCount} invitations sent successfully!</span>`;
        } else {
            emailStatus.innerHTML = `<span style="color: var(--warning-color);"> Sent ${successCount} invitations, ${failCount} failed.</span>`;
        }
    }
}

// Helper functions
function copyPersonalLink(link) {
    const tempInput = document.createElement('input');
    tempInput.value = link;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand('copy');
    document.body.removeChild(tempInput);
    showToast('Link copied to clipboard!', 'success');
}

function exportPersonalLinks(sessionData) {
    let csvContent = 'Name,Email,Personal Link\n';
    sessionData.personalLinks.forEach(item => {
        csvContent += `"${item.participant.name}","${item.participant.email}","${item.link}"\n`;
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `personal_links_${sessionData.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
    
    showToast('Personal links exported to CSV', 'success');
}

function resendAllInvites(sessionData) {
    if (confirm(`Resend invitations to all ${sessionData.personalLinks.length} participants?`)) {
        sendPersonalInvites(sessionData.personalLinks, sessionData.name);
        showToast('Resending all invitations...', 'info');
    }
}

function viewResponseTracking(sessionId) {
    showToast('Opening response tracking dashboard...', 'info');
    // This would open a dashboard showing who has responded
}

function downloadQRCode() {
    showToast('Downloading QR code...', 'info');
    // This would generate and download the QR code
}

function copyLinkToClipboard() {
    const linkInput = document.getElementById('generated-link');
    linkInput.select();
    document.execCommand('copy');
    showToast('Link copied to clipboard!', 'success');
}

function testChatLink(link) {
    window.open(link, '_blank');
}

function emailChatLink(sessionData) {
    showToast('Opening email client...', 'info');
    // This would open email client with pre-filled content
}

function generateAnotherLink() {
    document.querySelector('.modal').remove();
    createNewChatWidget();
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'success' ? 'var(--success-color)' : type === 'warning' ? 'var(--warning-color)' : 'var(--primary-color)'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// TEMPLATE MANAGEMENT FUNCTIONS

// Function to create a new chat template
function createChatTemplate() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3> Create Chat Template</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <form onsubmit="saveChatTemplate(event)">
                <!-- Template Basic Info -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; color: var(--primary-color);"> Template Information</h4>
                    
                    <div class="form-group">
                        <label class="form-label">Template Name <span style="color: red;">*</span></label>
                        <input type="text" id="template-name" class="form-input" required 
                               placeholder="e.g., Customer Satisfaction Survey">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="template-description" class="form-input" rows="2" 
                                  placeholder="Brief description of what this template is for..."></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select id="template-category" class="form-select">
                                <option value="general">General Feedback</option>
                                <option value="satisfaction">Customer Satisfaction</option>
                                <option value="employee">Employee Feedback</option>
                                <option value="product">Product Feedback</option>
                                <option value="service">Service Evaluation</option>
                                <option value="event">Event Feedback</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Estimated Time</label>
                            <select id="template-time" class="form-select">
                                <option value="2">2 minutes</option>
                                <option value="5" selected>5 minutes</option>
                                <option value="10">10 minutes</option>
                                <option value="15">15 minutes</option>
                                <option value="20">20+ minutes</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Chat Flow Settings -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 1rem; color: var(--primary-color);"> Chat Flow Settings</h4>
                    
                    <div class="form-group">
                        <label class="form-label">Introduction Message</label>
                        <textarea id="template-intro" class="form-input" rows="2" 
                                  placeholder="Hi! Thanks for taking the time to provide feedback. I'll ask you a few quick questions...">Hi! Thanks for taking the time to provide feedback. I'll ask you a few quick questions to understand your experience better.</textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="template-allow-skip" checked>
                                Allow users to skip questions
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="template-show-progress" checked>
                                Show progress indicator
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Closing Message</label>
                        <textarea id="template-closing" class="form-input" rows="2" 
                                  placeholder="Thank you for your valuable feedback! We appreciate your time.">Thank you for your valuable feedback! Your responses will help us improve our services.</textarea>
                    </div>
                </div>

                <!-- Questions Builder -->
                <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; color: var(--primary-color);"> Questions</h4>
                        <button type="button" class="btn btn-primary btn-sm" onclick="addTemplateQuestion()" 
                                style="margin-left: auto;">
                            + Add Question
                        </button>
                    </div>
                    
                    <div id="template-questions-container">
                        <!-- Questions will be added here dynamically -->
                        <div class="template-question-item" data-question-id="1">
                            <div class="question-header">
                                <span class="question-number">Question 1</span>
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeTemplateQuestion(this)">Remove</button>
                            </div>
                            <div class="question-content">
                                <div class="form-group">
                                    <label class="form-label">Question Text <span style="color: red;">*</span></label>
                                    <input type="text" class="form-input question-text" required 
                                           placeholder="Enter your question here...">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label class="form-label">Question Type</label>
                                        <select class="form-select question-type" onchange="updateQuestionOptions(this)">
                                            <option value="text">Text Response</option>
                                            <option value="rating">Rating (1-5)</option>
                                            <option value="yes-no">Yes/No</option>
                                            <option value="multiple-choice">Multiple Choice</option>
                                            <option value="scale">Scale (1-10)</option>
                                            <option value="emoji">Emoji Rating</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Required?</label>
                                        <select class="form-select question-required">
                                            <option value="yes">Yes</option>
                                            <option value="no">No</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="question-options" style="display: none;">
                                    <!-- Options for multiple choice questions will appear here -->
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Follow-up Prompt (Optional)</label>
                                    <input type="text" class="form-input question-followup" 
                                           placeholder="e.g., 'Can you tell me more about that?'">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                        <small style="color: var(--text-secondary);">
                             <strong>Tips:</strong> Keep questions clear and concise. Start with easy questions to build rapport. 
                            Use a mix of question types for better engagement.
                        </small>
                    </div>
                </div>

                <!-- AI Behavior Settings -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 1rem; color: var(--warning-color);"> AI Behavior Settings</h4>
                    
                    <div class="form-group">
                        <label class="form-label">AI Personality</label>
                        <select id="template-ai-personality" class="form-select">
                            <option value="professional">Professional</option>
                            <option value="friendly" selected>Friendly</option>
                            <option value="casual">Casual</option>
                            <option value="formal">Formal</option>
                            <option value="empathetic">Empathetic</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Response Style</label>
                        <div style="display: grid; gap: 0.5rem;">
                            <label class="checkbox-label">
                                <input type="checkbox" id="ai-acknowledge" checked>
                                Acknowledge user responses before moving to next question
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="ai-clarify" checked>
                                Ask for clarification if response is unclear
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="ai-empathy">
                                Show empathy for negative feedback
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="ai-dynamic">
                                Dynamically adjust questions based on responses
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Template Preview -->
                <div style="margin-bottom: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="previewTemplate()" style="width: 100%;">
                         Preview Template Chat Flow
                    </button>
                </div>

                <!-- Form Actions -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                    <button type="button" class="btn btn-secondary" onclick="saveTemplateAsDraft()">Save as Draft</button>
                    <button type="submit" class="btn btn-primary">Save Template</button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Initialize question numbers
    updateQuestionNumbers();
}

// Add a new question to the template
function addTemplateQuestion() {
    const container = document.getElementById('template-questions-container');
    const questionCount = container.querySelectorAll('.template-question-item').length + 1;
    
    const questionHTML = `
        <div class="template-question-item" data-question-id="${questionCount}">
            <div class="question-header">
                <span class="question-number">Question ${questionCount}</span>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeTemplateQuestion(this)">Remove</button>
            </div>
            <div class="question-content">
                <div class="form-group">
                    <label class="form-label">Question Text <span style="color: red;">*</span></label>
                    <input type="text" class="form-input question-text" required 
                           placeholder="Enter your question here...">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Question Type</label>
                        <select class="form-select question-type" onchange="updateQuestionOptions(this)">
                            <option value="text">Text Response</option>
                            <option value="rating">Rating (1-5)</option>
                            <option value="yes-no">Yes/No</option>
                            <option value="multiple-choice">Multiple Choice</option>
                            <option value="scale">Scale (1-10)</option>
                            <option value="emoji">Emoji Rating</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Required?</label>
                        <select class="form-select question-required">
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                </div>
                <div class="question-options" style="display: none;">
                    <!-- Options for multiple choice questions will appear here -->
                </div>
                <div class="form-group">
                    <label class="form-label">Follow-up Prompt (Optional)</label>
                    <input type="text" class="form-input question-followup" 
                           placeholder="e.g., 'Can you tell me more about that?'">
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', questionHTML);
    updateQuestionNumbers();
    showToast('Question added!', 'success');
}

// Remove a question from the template
function removeTemplateQuestion(button) {
    const questionItem = button.closest('.template-question-item');
    questionItem.remove();
    updateQuestionNumbers();
    showToast('Question removed', 'info');
}

// Update question numbers after add/remove
function updateQuestionNumbers() {
    const questions = document.querySelectorAll('.template-question-item');
    questions.forEach((question, index) => {
        question.querySelector('.question-number').textContent = `Question ${index + 1}`;
        question.setAttribute('data-question-id', index + 1);
    });
}

// Update question options based on type
function updateQuestionOptions(select) {
    const questionItem = select.closest('.template-question-item');
    const optionsDiv = questionItem.querySelector('.question-options');
    const questionType = select.value;
    
    if (questionType === 'multiple-choice') {
        optionsDiv.style.display = 'block';
        optionsDiv.innerHTML = `
            <div class="form-group">
                <label class="form-label">Options (one per line)</label>
                <textarea class="form-input question-mc-options" rows="4" 
                          placeholder="Option 1&#10;Option 2&#10;Option 3&#10;Option 4"></textarea>
            </div>
        `;
    } else {
        optionsDiv.style.display = 'none';
        optionsDiv.innerHTML = '';
    }
}

// Save the template
function saveChatTemplate(event) {
    event.preventDefault();
    
    // Gather all the template data
    const templateData = {
        id: 'template_' + Date.now(),
        name: document.getElementById('template-name').value,
        description: document.getElementById('template-description').value,
        category: document.getElementById('template-category').value,
        estimatedTime: document.getElementById('template-time').value,
        intro: document.getElementById('template-intro').value,
        closing: document.getElementById('template-closing').value,
        allowSkip: document.getElementById('template-allow-skip').checked,
        showProgress: document.getElementById('template-show-progress').checked,
        aiPersonality: document.getElementById('template-ai-personality').value,
        aiSettings: {
            acknowledge: document.getElementById('ai-acknowledge').checked,
            clarify: document.getElementById('ai-clarify').checked,
            empathy: document.getElementById('ai-empathy').checked,
            dynamic: document.getElementById('ai-dynamic').checked
        },
        questions: [],
        createdAt: new Date().toISOString(),
        status: 'active'
    };
    
    // Gather all questions
    const questionItems = document.querySelectorAll('.template-question-item');
    questionItems.forEach((item, index) => {
        const question = {
            id: index + 1,
            text: item.querySelector('.question-text').value,
            type: item.querySelector('.question-type').value,
            required: item.querySelector('.question-required').value === 'yes',
            followup: item.querySelector('.question-followup').value
        };
        
        // Add options for multiple choice
        if (question.type === 'multiple-choice') {
            const optionsText = item.querySelector('.question-mc-options')?.value || '';
            question.options = optionsText.split('\n').filter(opt => opt.trim());
        }
        
        templateData.questions.push(question);
    });
    
    // Validate at least one question
    if (templateData.questions.length === 0) {
        showToast('Please add at least one question to the template', 'warning');
        return;
    }
    
    // Save to storage
    window.chatTemplates.push(templateData);
    localStorage.setItem('chatTemplates', JSON.stringify(window.chatTemplates));
    
    // Close modal
    event.target.closest('.modal').remove();
    
    // Show success message
    showToast(`Template "${templateData.name}" saved successfully!`, 'success');
    
    // Refresh template list if on chat management page
    if (document.getElementById('chat-management-section') && !document.getElementById('chat-management-section').classList.contains('hidden')) {
        refreshTemplatesList();
    }
}

// Save template as draft
function saveTemplateAsDraft() {
    const templateName = document.getElementById('template-name').value || 'Untitled Template';
    
    // Similar to saveChatTemplate but with draft status
    const templateData = {
        id: 'template_draft_' + Date.now(),
        name: templateName + ' (Draft)',
        status: 'draft',
        // ... gather other data same as saveChatTemplate
    };
    
    window.chatTemplates.push(templateData);
    localStorage.setItem('chatTemplates', JSON.stringify(window.chatTemplates));
    
    document.querySelector('.modal').remove();
    showToast(`Draft template saved!`, 'info');
}

// Preview template
function previewTemplate() {
    const questions = [];
    document.querySelectorAll('.template-question-item').forEach(item => {
        questions.push({
            text: item.querySelector('.question-text').value || 'Question text',
            type: item.querySelector('.question-type').value
        });
    });
    
    if (questions.length === 0) {
        showToast('Add questions to preview the template', 'warning');
        return;
    }
    
    // Create preview modal
    const previewModal = document.createElement('div');
    previewModal.className = 'modal';
    previewModal.style.zIndex = '10001';
    previewModal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Template Preview</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                <div class="chat-preview-message bot">
                    <strong>AI:</strong> ${document.getElementById('template-intro').value || 'Welcome!'}
                </div>
                ${questions.map((q, i) => `
                    <div class="chat-preview-message bot">
                        <strong>AI:</strong> ${q.text}
                        ${getQuestionTypePreview(q.type)}
                    </div>
                    <div class="chat-preview-message user">
                        <strong>User:</strong> <em>[User response]</em>
                    </div>
                `).join('')}
                <div class="chat-preview-message bot">
                    <strong>AI:</strong> ${document.getElementById('template-closing').value || 'Thank you!'}
                </div>
            </div>
            <div style="margin-top: 1rem; text-align: right;">
                <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Close Preview</button>
            </div>
        </div>
    `;
    document.body.appendChild(previewModal);
}

// Get question type preview HTML
function getQuestionTypePreview(type) {
    const previews = {
        'text': '<div style="margin-top: 0.5rem;"><input type="text" class="form-input" placeholder="Type your answer..." disabled></div>',
        'rating': '<div style="margin-top: 0.5rem;"></div>',
        'yes-no': '<div style="margin-top: 0.5rem;"><button class="btn btn-sm">Yes</button> <button class="btn btn-sm">No</button></div>',
        'multiple-choice': '<div style="margin-top: 0.5rem;"> Option A<br> Option B<br> Option C</div>',
        'scale': '<div style="margin-top: 0.5rem;">1  10</div>',
        'emoji': '<div style="margin-top: 0.5rem;">    </div>'
    };
    return previews[type] || '';
}

// Load templates from storage on page load
function loadTemplates() {
    const saved = localStorage.getItem('chatTemplates');
    if (saved) {
        window.chatTemplates = JSON.parse(saved);
    }
}

// Refresh templates list in the UI
function refreshTemplatesList() {
    const container = document.querySelector('#chat-management-section .card:nth-child(2) div');
    if (!container) return;
    
    const templates = window.chatTemplates.filter(t => t.status === 'active');
    
    if (templates.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                No templates created yet. Click "Create Template" to get started.
            </div>
        `;
        return;
    }
    
    container.innerHTML = templates.map(template => `
        <div style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 0.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <strong>${template.name}</strong><br>
                    <small style="color: var(--text-secondary);">
                        ${template.questions.length} questions  ${template.estimatedTime} min  ${template.category}
                    </small>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary btn-sm" onclick="editTemplate('${template.id}')">Edit</button>
                    <button class="btn btn-primary btn-sm" onclick="duplicateTemplate('${template.id}')">Duplicate</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTemplate('${template.id}')">Delete</button>
                </div>
            </div>
        </div>
    `).join('');
}

// Edit existing template
function editTemplate(templateId) {
    const template = window.chatTemplates.find(t => t.id === templateId);
    if (!template) {
        showToast('Template not found', 'error');
        return;
    }
    
    // Create edit modal (similar to create but pre-filled)
    createChatTemplate();
    
    // Pre-fill the form after a short delay to ensure modal is rendered
    setTimeout(() => {
        document.getElementById('template-name').value = template.name;
        document.getElementById('template-description').value = template.description || '';
        document.getElementById('template-category').value = template.category;
        document.getElementById('template-time').value = template.estimatedTime;
        document.getElementById('template-intro').value = template.intro;
        document.getElementById('template-closing').value = template.closing;
        // ... fill other fields
        
        showToast('Editing template: ' + template.name, 'info');
    }, 100);
}

// Duplicate template
function duplicateTemplate(templateId) {
    const template = window.chatTemplates.find(t => t.id === templateId);
    if (!template) return;
    
    const duplicate = {
        ...template,
        id: 'template_' + Date.now(),
        name: template.name + ' (Copy)',
        createdAt: new Date().toISOString()
    };
    
    window.chatTemplates.push(duplicate);
    localStorage.setItem('chatTemplates', JSON.stringify(window.chatTemplates));
    
    refreshTemplatesList();
    showToast(`Template duplicated: ${duplicate.name}`, 'success');
}

// Delete template
function deleteTemplate(templateId) {
    if (!confirm('Are you sure you want to delete this template?')) return;
    
    const index = window.chatTemplates.findIndex(t => t.id === templateId);
    if (index > -1) {
        const name = window.chatTemplates[index].name;
        window.chatTemplates.splice(index, 1);
        localStorage.setItem('chatTemplates', JSON.stringify(window.chatTemplates));
        
        refreshTemplatesList();
        showToast(`Template deleted: ${name}`, 'success');
    }
}

// Function to load selected template details
function loadSelectedTemplate(templateId) {
    const infoDiv = document.getElementById('template-info');
    const hiddenField = document.getElementById('selected-template-data');
    
    if (!templateId) {
        infoDiv.style.display = 'none';
        hiddenField.value = '';
        document.getElementById('chat-welcome-msg').value = 'Welcome to our feedback chat! Your insights help us improve.';
        return;
    }
    
    const template = window.chatTemplates.find(t => t.id === templateId);
    if (!template) return;
    
    // Store template data
    hiddenField.value = JSON.stringify(template);
    
    // Update welcome message with template intro
    document.getElementById('chat-welcome-msg').value = template.intro;
    
    // Show template info
    infoDiv.style.display = 'block';
    infoDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <strong style="color: #0f766e;">${template.name}</strong>
                <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                    ${template.description || 'No description provided'}
                </div>
            </div>
            <button type="button" class="btn btn-sm" onclick="previewSelectedTemplate('${templateId}')">
                 Preview
            </button>
        </div>
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e6fffa;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                <div>
                    <strong style="font-size: 0.75rem; color: #0f766e;">Questions:</strong>
                    <div style="font-size: 1.25rem; font-weight: bold;">${template.questions.length}</div>
                </div>
                <div>
                    <strong style="font-size: 0.75rem; color: #0f766e;">Est. Time:</strong>
                    <div style="font-size: 1.25rem; font-weight: bold;">${template.estimatedTime} min</div>
                </div>
                <div>
                    <strong style="font-size: 0.75rem; color: #0f766e;">Category:</strong>
                    <div style="font-size: 1.25rem; font-weight: bold;">${template.category}</div>
                </div>
                <div>
                    <strong style="font-size: 0.75rem; color: #0f766e;">AI Style:</strong>
                    <div style="font-size: 1.25rem; font-weight: bold;">${template.aiPersonality}</div>
                </div>
            </div>
        </div>
        <div style="margin-top: 1rem;">
            <strong style="font-size: 0.75rem; color: #0f766e;">Questions Preview:</strong>
            <ol style="margin: 0.5rem 0 0 1.5rem; font-size: 0.875rem;">
                ${template.questions.slice(0, 3).map(q => `
                    <li>${q.text} <span style="color: var(--text-secondary);">(${q.type})</span></li>
                `).join('')}
                ${template.questions.length > 3 ? `<li style="color: var(--text-secondary);">... and ${template.questions.length - 3} more</li>` : ''}
            </ol>
        </div>
    `;
    
    showToast(`Template loaded: ${template.name}`, 'success');
}

// Preview selected template
function previewSelectedTemplate(templateId) {
    const template = window.chatTemplates.find(t => t.id === templateId);
    if (!template) return;
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.zIndex = '10001';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Template Preview: ${template.name}</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div style="max-height: 500px; overflow-y: auto;">
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                    <div class="chat-preview-message bot">
                        <strong> AI:</strong> ${template.intro}
                    </div>
                    ${template.questions.map((q, i) => `
                        <div class="chat-preview-message bot" style="margin-top: 1rem;">
                            <strong> AI (Question ${i + 1}/${template.questions.length}):</strong> ${q.text}
                            ${getQuestionTypePreview(q.type)}
                        </div>
                        <div class="chat-preview-message user" style="margin-top: 0.5rem;">
                            <strong> User:</strong> <em style="color: var(--text-secondary);">[User would respond here]</em>
                        </div>
                        ${q.followup ? `
                            <div class="chat-preview-message bot" style="margin-top: 0.5rem;">
                                <strong> AI (Follow-up):</strong> ${q.followup}
                            </div>
                        ` : ''}
                    `).join('')}
                    <div class="chat-preview-message bot" style="margin-top: 1rem;">
                        <strong> AI:</strong> ${template.closing}
                    </div>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: #e6fffa; border-radius: 8px;">
                    <strong>Template Settings:</strong>
                    <ul style="margin: 0.5rem 0 0 1rem; font-size: 0.875rem;">
                        <li>AI Personality: ${template.aiPersonality}</li>
                        <li>Allow Skip: ${template.allowSkip ? 'Yes' : 'No'}</li>
                        <li>Show Progress: ${template.showProgress ? 'Yes' : 'No'}</li>
                        <li>Total Questions: ${template.questions.length}</li>
                    </ul>
                </div>
            </div>
            <div style="margin-top: 1rem; text-align: right;">
                <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Close Preview</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Function to manage templates
function manageTemplates() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.zIndex = '10001';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Manage Templates</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()"></button>
            </div>
            <div>
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-primary" onclick="createChatTemplate(); this.closest('.modal').remove();">
                        + Create New Template
                    </button>
                </div>
                <div id="templates-list">
                    ${window.chatTemplates && window.chatTemplates.length > 0 ? 
                        window.chatTemplates.map(t => `
                            <div class="template-card">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <strong>${t.name}</strong>
                                        ${t.status === 'draft' ? '<span class="tag tag-pending">Draft</span>' : ''}
                                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                            ${t.questions.length} questions  ${t.estimatedTime} min  ${t.category}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-secondary btn-sm" onclick="editTemplate('${t.id}')">Edit</button>
                                        <button class="btn btn-primary btn-sm" onclick="duplicateTemplate('${t.id}')">Duplicate</button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteTemplate('${t.id}'); refreshManageTemplates();">Delete</button>
                                    </div>
                                </div>
                            </div>
                        `).join('') : 
                        '<div style="text-align: center; padding: 3rem; color: var(--text-secondary);">No templates created yet</div>'
                    }
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Refresh the manage templates modal
function refreshManageTemplates() {
    const templatesList = document.getElementById('templates-list');
    if (!templatesList) return;
    
    templatesList.innerHTML = window.chatTemplates && window.chatTemplates.length > 0 ? 
        window.chatTemplates.map(t => `
            <div class="template-card">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <strong>${t.name}</strong>
                        ${t.status === 'draft' ? '<span class="tag tag-pending">Draft</span>' : ''}
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                            ${t.questions.length} questions  ${t.estimatedTime} min  ${t.category}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary btn-sm" onclick="editTemplate('${t.id}')">Edit</button>
                        <button class="btn btn-primary btn-sm" onclick="duplicateTemplate('${t.id}')">Duplicate</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTemplate('${t.id}'); refreshManageTemplates();">Delete</button>
                    </div>
                </div>
            </div>
        `).join('') : 
        '<div style="text-align: center; padding: 3rem; color: var(--text-secondary);">No templates created yet</div>';
}

// DATABASE FORM HANDLERS

// Handle organization form submission
async function handleOrganizationUpdate(event) {
    event.preventDefault();
    
    const formData = {
        name: document.getElementById('org-name').value,
        industry: document.getElementById('org-industry').value,
        size: document.getElementById('org-size').value,
        country: document.getElementById('org-country').value,
        website: document.getElementById('org-website').value,
        description: document.getElementById('org-description').value,
        plan: 'Start Listening'
    };
    
    try {
        const result = await saveOrganization(formData);
        showToast('Organization saved successfully!', 'success');
        closeModal('organization-settings-modal');
        loadOrganizationsData(); // Refresh the organizations table
    } catch (error) {
        console.error('Error saving organization:', error);
        showToast('Failed to save organization', 'error');
    }
}

// Handle user form submission (for adding users)
async function handleUserSubmit(event) {
    event.preventDefault();
    
    const formData = {
        name: document.getElementById('user-name').value,
        email: document.getElementById('user-email').value,
        organization: document.getElementById('user-org').value,
        role: document.getElementById('user-role').value || 'user'
    };
    
    try {
        const result = await saveUser(formData);
        showToast('User saved successfully!', 'success');
        closeModal('add-user-modal');
        loadUsersData(); // Refresh the users table
    } catch (error) {
        console.error('Error saving user:', error);
        showToast('Failed to save user', 'error');
    }
}

// Force remove any checkboxes from organizations table

// Load organizations data from database - SIMPLIFIED VERSION
async function loadOrganizationsData() {
    try {
        console.log(' LOADING ORGANIZATIONS GRID');
        
        const organizations = await loadOrganizations();
        const gridContainer = document.querySelector('.organizations-grid-container');
        
        console.log(' Data received:', organizations);
        
        // Clear existing data rows (keep headers)
        const existingDataCells = gridContainer.querySelectorAll('.org-grid-cell');
        existingDataCells.forEach(cell => cell.remove());
        
        const existingEmptyMsg = gridContainer.querySelector('.org-grid-empty');
        if (existingEmptyMsg) existingEmptyMsg.remove();
        
        if (organizations.length === 0) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'org-grid-empty';
            emptyDiv.style.gridColumn = '1 / -1';
            emptyDiv.style.textAlign = 'center';
            emptyDiv.style.padding = '2rem';
            emptyDiv.style.color = 'var(--text-secondary)';
            emptyDiv.textContent = 'No organizations found. Click \'Add Organization\' to create your first organization.';
            gridContainer.appendChild(emptyDiv);
            return;
        }
        
        // Build each row explicitly using CSS Grid
        let gridHTML = '';
        for (let i = 0; i < organizations.length; i++) {
            const org = organizations[i];
            console.log(`Building grid row ${i+1}:`, org);
            
            // Create 5 grid cells for each organization (auto-wraps to next row)
            gridHTML += '<div class="org-grid-cell" onclick="showOrganizationDetails(\'' + (org.id || 'temp') + '\')">' + (org.name || 'Unnamed') + '</div>';
            gridHTML += '<div class="org-grid-cell" onclick="showOrganizationDetails(\'' + (org.id || 'temp') + '\')">' + (org.user_count || 0) + '</div>';
            gridHTML += '<div class="org-grid-cell" onclick="showOrganizationDetails(\'' + (org.id || 'temp') + '\')"><span class="tag tag-active">Active</span></div>';
            gridHTML += '<div class="org-grid-cell" onclick="showOrganizationDetails(\'' + (org.id || 'temp') + '\')">' + (org.created_at ? new Date(org.created_at).toLocaleDateString() : 'Today') + '</div>';
            gridHTML += '<div class="org-grid-cell" onclick="event.stopPropagation()">';
            gridHTML += '<button class="btn btn-secondary btn-sm" onclick="handleEditOrganization(\'' + (org.id || 'temp') + '\')">Edit</button> ';
            gridHTML += '<button class="btn btn-warning btn-sm" onclick="handleSuspendOrganization(\'' + (org.id || 'temp') + '\')">Suspend</button> ';
            gridHTML += '<button class="btn btn-danger btn-sm" onclick="handleDeleteOrganization(\'' + (org.id || 'temp') + '\')">Delete</button>';
            gridHTML += '</div>';
        }
        
        gridContainer.insertAdjacentHTML('beforeend', gridHTML);
        console.log(' GRID POPULATED SUCCESSFULLY');
        
        // Update filter
        const filter = document.getElementById('organization-filter');
        if (filter) {
            let filterHTML = '<option value="">All Organizations</option>';
            for (let i = 0; i < organizations.length; i++) {
                const org = organizations[i];
                filterHTML += '<option value="' + (org.id || 'temp') + '">' + (org.name || 'Unnamed') + '</option>';
            }
            filter.innerHTML = filterHTML;
        }
        
    } catch (error) {
        console.error(' ERROR:', error);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'org-grid-empty';
        errorDiv.style.gridColumn = '1 / -1';
        errorDiv.style.textAlign = 'center';
        errorDiv.style.padding = '2rem';
        errorDiv.style.color = 'red';
        errorDiv.textContent = 'Error: ' + error.message;
        const gridContainer = document.querySelector('.organizations-grid-container');
        if (gridContainer) {
            gridContainer.appendChild(errorDiv);
        }
    }
}

// Load users data from database
async function loadUsersData() {
    try {
        const users = await loadUsers();
        const tbody = document.getElementById('users-table-body');
        
        if (users.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        No users found. Add your first user to get started.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = users.map(user => `
            <tr>
                <td onclick="event.stopPropagation()"><input type="checkbox"></td>
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td>${user.organization || 'N/A'}</td>
                <td><span class="tag tag-active">${user.role || 'User'}</span></td>
                <td><span class="tag tag-${user.status === 'active' ? 'active' : 'pending'}">${user.status || 'Active'}</span></td>
                <td>${user.last_login || 'Never'}</td>
                <td onclick="event.stopPropagation()">
                    <button class="btn btn-secondary btn-sm" onclick="handleEditUser('${user.id}')" data-translate="edit">Edit</button>
                    <button class="btn btn-warning btn-sm" onclick="handleSuspendUser('${user.id}')" data-translate="suspend">Suspend</button>
                    <button class="btn btn-danger btn-sm" onclick="handleRemoveUser('${user.id}')">Remove</button>
                </td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading users:', error);
        showToast('Failed to load users', 'error');
    }
}

// Enhanced Chat Management Functions

function toggleDropdown(button) {
    const dropdown = button.nextElementSibling;
    const isVisible = dropdown.classList.contains('show');
    
    // Close all other dropdowns
    document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
        menu.classList.remove('show');
    });
    
    // Toggle current dropdown
    if (!isVisible) {
        dropdown.classList.add('show');
    }
    
    // Close dropdown when clicking outside
    if (!isVisible) {
        setTimeout(() => {
            document.addEventListener('click', function closeOnOutside(e) {
                if (!button.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                    document.removeEventListener('click', closeOnOutside);
                }
            });
        }, 0);
    }
}

function viewChannelAnalytics(channelId) {
    showToast(`Opening analytics for ${channelId} channel...`, 'info');
    // Implementation would load analytics dashboard
}

function pauseWidget(widgetId) {
    showToast(`Pausing ${widgetId} widget...`, 'info');
    // Implementation would pause the widget
    
    // Update UI to show paused state
    const widget = document.querySelector(`[onclick*="${widgetId}"]`)?.closest('.chat-widget-card');
    if (widget) {
        const statusTag = widget.querySelector('.tag');
        if (statusTag) {
            statusTag.textContent = 'PAUSED';
            statusTag.style.background = 'var(--bg-secondary)';
            statusTag.style.color = 'var(--warning-color)';
            statusTag.style.border = '1px solid var(--warning-color)';
        }
        
        const activeCount = widget.querySelector('[data-active]');
        if (activeCount) {
            activeCount.textContent = ' 0 active';
        }
    }
}

function resumeWidget(widgetId) {
    showToast(`Resuming ${widgetId} widget...`, 'info');
    // Implementation would resume the widget
    
    // Update UI to show live state
    const widget = document.querySelector(`[onclick*="${widgetId}"]`)?.closest('.chat-widget-card');
    if (widget) {
        const statusTag = widget.querySelector('.tag');
        if (statusTag) {
            statusTag.textContent = 'LIVE';
            statusTag.className = 'tag tag-success';
        }
    }
}

function duplicateWidget(widgetId) {
    showToast(`Duplicating ${widgetId} widget...`, 'info');
    // Implementation would create a copy of the widget
}

function exportWidget(widgetId) {
    showToast(`Exporting data from ${widgetId} widget...`, 'info');
    // Implementation would export widget data
}

function deleteWidget(widgetId) {
    if (confirm(`Are you sure you want to delete the ${widgetId} widget? This action cannot be undone.`)) {
        showToast(`Deleting ${widgetId} widget...`, 'warning');
        // Implementation would delete the widget
    }
}

function refreshChannels() {
    showToast('Refreshing channels...', 'info');
    // Implementation would refresh the channels list
    
    // Simulate refresh with loading animation
    const refreshBtn = document.querySelector('[onclick="refreshChannels()"]');
    const originalText = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<span style="margin-right: 0.25rem;"></span>Refreshing...';
    refreshBtn.disabled = true;
    
    setTimeout(() => {
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
        showToast('Channels refreshed successfully', 'success');
    }, 1500);
}

function useTemplate(templateId) {
    showToast(`Using ${templateId} template...`, 'info');
    // Implementation would create a new widget based on the template
}

function previewTemplate(templateId) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Template Preview: ${templateId.charAt(0).toUpperCase() + templateId.slice(1)}</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                <div class="chat-preview-message bot">
                    <strong>AI:</strong> Welcome! I'd like to get your feedback on our ${templateId} experience.
                </div>
                <div class="chat-preview-message bot">
                    <strong>AI:</strong> How would you rate your overall experience? (Scale: 1-5)
                </div>
                <div class="chat-preview-message user">
                    <strong>You:</strong> 4
                </div>
                <div class="chat-preview-message bot">
                    <strong>AI:</strong> Thank you! What did you like most about your experience?
                </div>
                <div class="chat-preview-message user">
                    <strong>You:</strong> The service was quick and helpful.
                </div>
                <div class="chat-preview-message bot">
                    <strong>AI:</strong> Great! Is there anything we could improve?
                </div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                <button class="btn btn-primary" onclick="useTemplate('${templateId}'); this.closest('.modal').remove();">Use Template</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}


function viewActiveConversations() {
    showToast('Opening active conversations dashboard...', 'info');
    // Implementation would show active conversations
}

function generateWeeklyReport() {
    showToast('Generating weekly report...', 'info');
    // Implementation would generate and download weekly report
    
    setTimeout(() => {
        showToast('Weekly report generated successfully!', 'success');
    }, 3000);
}

// Modal utility functions
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.remove();
    }
}

// Close modal when clicking outside the modal content
function setupModalCloseOnOutsideClick(modal) {
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => modal.remove());
    }
});

// Show create organization modal (without plan selection)
function showCreateOrganizationModal() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'create-organization-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Organization</h3>
                <button class="close-btn" onclick="closeModal('create-organization-modal')">&times;</button>
            </div>
            <form onsubmit="handleCreateOrganization(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Organization Name *</label>
                        <input type="text" id="create-org-name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Industry</label>
                        <select id="create-org-industry" class="form-select">
                            <option value="">Select Industry</option>
                            <option value="technology">Technology</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="finance">Finance</option>
                            <option value="education">Education</option>
                            <option value="retail">Retail</option>
                            <option value="manufacturing">Manufacturing</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Company Size</label>
                        <select id="create-org-size" class="form-select">
                            <option value="">Select Size</option>
                            <option value="1-10">1-10 employees</option>
                            <option value="11-50">11-50 employees</option>
                            <option value="51-200">51-200 employees</option>
                            <option value="201-1000">201-1000 employees</option>
                            <option value="1000+">1000+ employees</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Country</label>
                        <select id="create-org-country" class="form-select">
                            <option value="">Select Country</option>
                            <option value="GB">United Kingdom</option>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="ES">Spain</option>
                            <option value="AU">Australia</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Website</label>
                    <input type="url" id="create-org-website" class="form-input" placeholder="https://www.example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="create-org-description" class="form-input" rows="3" placeholder="Describe your organization..."></textarea>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('create-organization-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Organization</button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    modal.style.display = 'flex';
    setupModalCloseOnOutsideClick(modal);
}

// Show create user modal (without plan selection)
async function showCreateUserModal() {
    // Load organizations for the dropdown
    const organizations = await loadOrganizations();
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'create-user-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New User</h3>
                <button class="close-btn" onclick="closeModal('create-user-modal')">&times;</button>
            </div>
            <form onsubmit="handleCreateUser(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <input type="text" id="create-user-name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address *</label>
                        <input type="email" id="create-user-email" class="form-input" required>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Organization</label>
                        <select id="create-user-organization" class="form-select">
                            <option value="">Select Organization</option>
                            ${organizations.map(org => `<option value="${org.id}">${org.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select id="create-user-role" class="form-select">
                            <option value="">Select Role</option>
                            <option value="viewer">Viewer</option>
                            <option value="survey_admin">Survey Admin</option>
                            <option value="org_admin">Organization Admin</option>
                            <option value="super_admin">Super Admin</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" id="create-user-phone" class="form-input" placeholder="+1 (555) 123-4567">
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('create-user-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create User</button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    modal.style.display = 'flex';
    setupModalCloseOnOutsideClick(modal);
}

// Handle create organization form submission
async function handleCreateOrganization(event) {
    event.preventDefault();
    
    const formData = {
        name: document.getElementById('create-org-name').value,
        industry: document.getElementById('create-org-industry').value,
        size: document.getElementById('create-org-size').value,
        country: document.getElementById('create-org-country').value,
        website: document.getElementById('create-org-website').value,
        description: document.getElementById('create-org-description').value,
        plan: 'Start Listening' // Fixed plan - no selection needed
    };
    
    try {
        const result = await saveOrganization(formData);
        showToast('Organization created successfully!', 'success');
        closeModal('create-organization-modal');
        loadOrganizationsData(); // Refresh the table
    } catch (error) {
        console.error('Error creating organization:', error);
        showToast('Failed to create organization', 'error');
    }
}

// Handle create user form submission
async function handleCreateUser(event) {
    event.preventDefault();
    
    const formData = {
        name: document.getElementById('create-user-name').value,
        email: document.getElementById('create-user-email').value,
        organization_id: document.getElementById('create-user-organization').value,
        role: document.getElementById('create-user-role').value,
        phone: document.getElementById('create-user-phone').value,
        plan: 'Start Listening', // Fixed plan - no selection needed
        status: 'active'
    };
    
    console.log('User form data being sent:', formData);
    
    try {
        const result = await saveUser(formData);
        console.log('User creation result:', result);
        showToast('User created successfully!', 'success');
        closeModal('create-user-modal');
        loadUsersData(); // Refresh the users table
        // Small delay to ensure database is updated before refreshing organization counts
        setTimeout(() => {
            loadOrganizationsData(); // Refresh organizations to update user counts
        }, 500);
    } catch (error) {
        console.error('Error creating user:', error);
        showToast('Failed to create user: ' + error.message, 'error');
    }
}

// Organization action handlers
async function handleDeleteOrganization(orgId) {
    if (!orgId || orgId === 'temp') {
        showToast('Invalid organization ID', 'error');
        return;
    }
    
    // First check if there are users assigned to this organization
    try {
        const users = await loadUsers();
        const usersInOrg = users.filter(user => user.organization_id === orgId);
        
        if (usersInOrg.length > 0) {
            showToast(`Cannot delete organization: ${usersInOrg.length} user(s) are still assigned to it. Please reassign or remove these users first.`, 'error');
            return;
        }
        
        if (confirm('Are you sure you want to delete this organization? This action cannot be undone.')) {
            const result = await deleteOrganization(orgId);
            if (result) {
                showToast('Organization deleted successfully!', 'success');
                loadOrganizationsData(); // Refresh the grid
                loadUsersData(); // Refresh users table too
            } else {
                showToast('Failed to delete organization. It may not exist.', 'error');
            }
        }
    } catch (error) {
        console.error('Error deleting organization:', error);
        if (error.message && error.message.includes('still referenced')) {
            showToast('Cannot delete organization: Users are still assigned to it. Please reassign or remove these users first.', 'error');
        } else {
            showToast('Failed to delete organization: ' + error.message, 'error');
        }
    }
}

async function handleEditOrganization(orgId) {
    if (!orgId || orgId === 'temp') {
        showToast('Invalid organization ID', 'error');
        return;
    }
    
    // TODO: Implement edit organization modal
    showToast('Edit functionality coming soon!', 'info');
}

async function handleSuspendOrganization(orgId) {
    if (!orgId || orgId === 'temp') {
        showToast('Invalid organization ID', 'error');
        return;
    }
    
    if (confirm('Are you sure you want to suspend this organization?')) {
        try {
            const result = await updateOrganization(orgId, { status: 'suspended' });
            if (result) {
                showToast('Organization suspended successfully!', 'success');
                loadOrganizationsData(); // Refresh the grid
            } else {
                showToast('Failed to suspend organization', 'error');
            }
        } catch (error) {
            console.error('Error suspending organization:', error);
            showToast('Failed to suspend organization: ' + error.message, 'error');
        }
    }
}

function showOrganizationDetails(orgId) {
    if (!orgId || orgId === 'temp') {
        showToast('Invalid organization ID', 'error');
        return;
    }
    
    // TODO: Implement organization details modal
    showToast('Organization details coming soon!', 'info');
}

// User action handlers
async function handleRemoveUser(userId) {
    if (!userId || userId === 'temp') {
        showToast('Invalid user ID', 'error');
        return;
    }
    
    if (confirm('Are you sure you want to remove this user? This action cannot be undone.')) {
        try {
            const result = await deleteUser(userId);
            if (result) {
                showToast('User removed successfully!', 'success');
                loadUsersData(); // Refresh the users table
                // Small delay to ensure database is updated before refreshing organization counts
                setTimeout(() => {
                    loadOrganizationsData(); // Refresh organizations to update user counts
                }, 500);
            } else {
                showToast('Failed to remove user. It may not exist.', 'error');
            }
        } catch (error) {
            console.error('Error removing user:', error);
            showToast('Failed to remove user: ' + error.message, 'error');
        }
    }
}

async function handleEditUser(userId) {
    if (!userId || userId === 'temp') {
        showToast('Invalid user ID', 'error');
        return;
    }
    
    // TODO: Implement edit user modal
    showToast('Edit user functionality coming soon!', 'info');
}

async function handleSuspendUser(userId) {
    if (!userId || userId === 'temp') {
        showToast('Invalid user ID', 'error');
        return;
    }
    
    if (confirm('Are you sure you want to suspend this user?')) {
        try {
            const result = await updateUser(userId, { status: 'suspended' });
            if (result) {
                showToast('User suspended successfully!', 'success');
                loadUsersData(); // Refresh the users table
            } else {
                showToast('Failed to suspend user', 'error');
            }
        } catch (error) {
            console.error('Error suspending user:', error);
            showToast('Failed to suspend user: ' + error.message, 'error');
        }
    }
}

// Database connection test
/*
REQUIRED SUPABASE TABLES - Create these in your Supabase dashboard:

1. organizations
CREATE TABLE organizations (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

2. users  
CREATE TABLE users (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    email TEXT NOT NULL UNIQUE,
    organization_id UUID REFERENCES organizations(id),
    role TEXT DEFAULT 'user',
    status TEXT DEFAULT 'active',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

3. surveys
CREATE TABLE surveys (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    organization_id UUID REFERENCES organizations(id),
    created_by UUID REFERENCES users(id),
    status TEXT DEFAULT 'draft',
    questions JSONB,
    settings JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

4. responses
CREATE TABLE responses (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    survey_id UUID REFERENCES surveys(id),
    respondent_email TEXT,
    responses JSONB NOT NULL,
    submitted_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

5. url_mappings
CREATE TABLE url_mappings (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    slug TEXT NOT NULL UNIQUE,
    original_url TEXT NOT NULL,
    chat_name TEXT,
    chat_type TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
*/

async function testDatabaseConnection() {
    console.log(' Testing database connection...');
    
    const tables = ['organizations', 'users', 'surveys', 'responses', 'url_mappings'];
    const tableStatus = {};
    
    for (const table of tables) {
        try {
            const { data, error } = await window.supabaseClient
                .from(table)
                .select('*')
                .limit(1);
            
            if (error) {
                tableStatus[table] = ` Error: ${error.message}`;
                console.error(`Table '${table}':`, error);
            } else {
                tableStatus[table] = ` OK (${data ? data.length : 0} records)`;
                console.log(`Table '${table}': OK`);
            }
        } catch (err) {
            tableStatus[table] = ` Exception: ${err.message}`;
            console.error(`Table '${table}' exception:`, err);
        }
    }
    
    console.log(' Database Table Status:', tableStatus);
    
    // Show status to user
    const missingTables = Object.entries(tableStatus)
        .filter(([table, status]) => status.includes(''))
        .map(([table]) => table);
    
    if (missingTables.length > 0) {
        showToast(`Missing database tables: ${missingTables.join(', ')}. Check console for details.`, 'error', 8000);
    } else {
        showToast('All database tables are accessible!', 'success');
    }
}

// Initialize templates on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check for short URL redirect first
    handleShortUrlRedirect();
    
    // Test database connection first
    if (window.supabaseClient) {
        testDatabaseConnection();
    }
    
    loadTemplates();
    loadOrganizationsData();
    loadUsersData();
    
    // Load active chats
    loadActiveChatsList();
    
    // Initialize enhanced chat management features
    if (window.location.hash === '#chat-management') {
        showSection('chat-management');
    }
});

// Handle short URL redirects
async function handleShortUrlRedirect() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Check for ?chat=slug parameter
    const chatSlug = urlParams.get('chat');
    
    if (chatSlug) {
        try {
            const mapping = await loadUrlMapping(chatSlug);
            
            if (mapping && mapping.original_url) {
                // Redirect to the original chat URL
                window.location.href = mapping.original_url;
                return;
            }
        } catch (error) {
            console.error('Error handling chat slug redirect:', error);
        }
    }
    
    // Also check other URL parameters for slug-based routing
    const slugParam = urlParams.get('s') || urlParams.get('slug');
    
    if (slugParam) {
        try {
            const mapping = await loadUrlMapping(slugParam);
            
            if (mapping && mapping.original_url) {
                // Redirect to the original chat URL
                window.location.href = mapping.original_url;
                return;
            }
        } catch (error) {
            console.error('Error handling slug parameter redirect:', error);
        }
    }
}

// Load and display active chats
async function loadActiveChatsList() {
    console.log(' Loading active chats list...');
    try {
        // Check if we're in the right section first
        const chatSection = document.getElementById('chat-management-section');
        if (!chatSection) {
            console.error(' Chat management section not found');
            return;
        }
        if (chatSection.classList.contains('hidden')) {
            console.log(' Chat management section not visible, skipping load');
            return;
        }
        console.log(' Chat management section is visible, proceeding with load');

        // Try to load from database first
        let chatSessions = await loadChatSessions();
        
        // If database is empty, try localStorage as fallback
        if (chatSessions.length === 0) {
            chatSessions = loadChatSessionsFromLocalStorage();
        }
        
        // Filter out deleted chats
        chatSessions = chatSessions.filter(chat => chat.status !== 'deleted');
        
        const activeChatsContainer = document.getElementById('active-chats-list');
        if (!activeChatsContainer) {
            console.error('active-chats-list element not found');
            return;
        }
        const emptyState = activeChatsContainer.previousElementSibling;
        
        if (chatSessions.length === 0) {
            // Show empty state
            activeChatsContainer.style.display = 'none';
            emptyState.style.display = 'block';
        } else {
            // Show chat list
            emptyState.style.display = 'none';
            activeChatsContainer.style.display = 'block';
            
            // Generate chat items HTML
            activeChatsContainer.innerHTML = chatSessions.map(chat => `
                <div class="chat-item" style="
                    padding: 1rem; 
                    border: 1px solid var(--border-color); 
                    border-radius: 8px; 
                    margin-bottom: 1rem;
                    background: white;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.25rem;">
                                ${chat.type === 'listening' ? '' : chat.type === 'chat' ? '' : ''}
                            </span>
                            <strong>${chat.name}</strong>
                            <span class="tag ${chat.status === 'active' ? 'tag-success' : 'tag-secondary'}" style="font-size: 0.75rem;">
                                ${chat.status?.toUpperCase() || 'ACTIVE'}
                            </span>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                            Type: ${chat.type === 'listening' ? 'Listening Chat' : chat.type === 'chat' ? 'Guided Chat' : 'Pulse Survey'}
                        </div>
                        ${chat.topics ? `
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                Topics: ${Array.isArray(chat.topics) ? chat.topics.join(', ') : chat.topics}
                            </div>
                        ` : ''}
                        ${chat.questions ? `
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                Questions: ${Array.isArray(chat.questions) ? chat.questions.length : 'N/A'} questions
                            </div>
                        ` : ''}
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">
                            Created: ${new Date(chat.created || chat.created_at).toLocaleDateString()}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <div class="dropdown" style="position: relative;">
                            <button class="btn btn-secondary btn-sm" onclick="toggleChatDropdown(this, event)" style="border-radius: 4px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; padding: 0;" title="Chat Settings">
                                
                            </button>
                            <div class="dropdown-menu" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 200px; padding: 8px 0;">
                                <button class="dropdown-item" onclick="editChatSession('${chat.session_id || chat.id}')" style="width: 100%; text-align: left; padding: 0.75rem 1rem; border: none; background: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                                    <span style="width: 16px;"></span> Edit Chat
                                </button>
                                <button class="dropdown-item" onclick="copyChatSession('${chat.id}')" style="width: 100%; text-align: left; padding: 0.75rem 1rem; border: none; background: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                                    <span style="width: 16px;"></span> Copy Chat
                                </button>
                                <button class="dropdown-item" onclick="exportPrintCopy('${chat.id}')" style="width: 100%; text-align: left; padding: 0.75rem 1rem; border: none; background: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                                    <span style="width: 16px;"></span> Export Print Copy
                                </button>
                                <button class="dropdown-item" onclick="downloadChatData('${chat.id}')" style="width: 100%; text-align: left; padding: 0.75rem 1rem; border: none; background: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                                    <span style="width: 16px;"></span> Download Chat Data
                                </button>
                                <button class="dropdown-item" onclick="manageRecipients('${chat.id}')" style="width: 100%; text-align: left; padding: 0.75rem 1rem; border: none; background: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                                    <span style="width: 16px;"></span> Manage Recipients
                                </button>
                                <hr style="margin: 0.5rem 0; border: none; border-top: 1px solid var(--border-color);">
                                <button class="dropdown-item" onclick="deleteChatSession('${chat.session_id || chat.id}')" style="width: 100%; text-align: left; padding: 0.75rem 1rem; border: none; background: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--danger-color);">
                                    <span style="width: 16px;"></span> Delete Chat
                                </button>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="chat-link-${chat.id}" value="${chat.link}">
                </div>
            `).join('');
        }
        
        console.log(`Loaded ${chatSessions.length} active chats`);
    } catch (error) {
        console.error('Error loading active chats:', error);
        showToast('Error loading active chats', 'error');
    }
}

// Copy link function for active chats
function copyToClipboard(elementId, link) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(link).then(() => {
            showToast('Link copied to clipboard!', 'success');
        }).catch(err => {
            console.error('Failed to copy link:', err);
            fallbackCopyTextToClipboard(link);
        });
    } else {
        fallbackCopyTextToClipboard(link);
    }
}

function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.top = '0';
    textArea.style.left = '0';
    textArea.style.position = 'fixed';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
        document.execCommand('copy');
        showToast('Link copied to clipboard!', 'success');
    } catch (err) {
        showToast('Failed to copy link', 'error');
    }
    document.body.removeChild(textArea);
}

// Edit chat session (placeholder)
function editChatSession(sessionId) {
    showToast('Edit functionality coming soon!', 'info');
    // TODO: Implement edit functionality
}

// Delete chat session
async function deleteChatSession(sessionId) {
    if (confirm('Are you sure you want to delete this chat session? This action cannot be undone.')) {
        try {
            await updateChatSessionStatus(sessionId, 'deleted');
            showToast('Chat session deleted successfully', 'success');
            loadActiveChatsList(); // Refresh the list
        } catch (error) {
            console.error('Error deleting chat session:', error);
            showToast('Error deleting chat session', 'error');
        }
    }
}

// Function to add chat to management interface
function addChatToManagement(chatSessionData) {
    const activeChatsList = document.getElementById('active-chats-list');
    const emptyState = document.querySelector('#chat-management-section .card:nth-child(2) > div:not(#active-chats-list)');
    
    // Hide empty state and show the list
    if (emptyState) {
        emptyState.style.display = 'none';
    }
    activeChatsList.style.display = 'block';
    
    // Create chat item
    const chatItem = document.createElement('div');
    chatItem.className = 'chat-item';
    chatItem.style.cssText = `
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 1rem;
        background: var(--bg-primary);
    `;
    
    const chatTypeBadge = chatSessionData.type === 'listening' ? 'Listening' : chatSessionData.type === 'pulse' ? 'Pulse' : 'Chat';
    const welcomeMsg = chatSessionData.welcome || chatSessionData.welcomeMsg || 'No welcome message';
    
    chatItem.innerHTML = `
        <div>
            <h4 style="margin: 0 0 0.5rem 0;">${chatSessionData.name}</h4>
            <p style="margin: 0; color: var(--text-secondary); font-size: 0.875rem;">${welcomeMsg}</p>
            <div style="margin-top: 0.5rem;">
                <span class="tag tag-active" style="font-size: 0.75rem;">Active</span>
                <span class="tag" style="font-size: 0.75rem; margin-left: 0.5rem; background: var(--primary-color); color: white;">${chatTypeBadge}</span>
                <span style="color: var(--text-secondary); font-size: 0.75rem; margin-left: 1rem;">
                    Created: ${new Date().toLocaleDateString()}
                </span>
            </div>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <div class="dropdown" style="position: relative;">
                <button class="btn btn-secondary btn-sm" onclick="toggleChatDropdown(this, event)" style="border-radius: 4px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; padding: 0;" title="Chat Settings">
                    
                </button>
                <div class="dropdown-menu" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 200px; padding: 8px 0;">
                    <button class="dropdown-item" onclick="editChatSettings('${chatSessionData.id}')" style="width: 100%; text-align: left; padding: 0.75rem 1rem; border: none; background: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <span style="width: 16px;"></span> Edit Chat
                    </button>
                    <button class="dropdown-item" onclick="copyChatSession('${chatSessionData.id}')" style="width: 100%; text-align: left; padding: 0.75rem 1rem; border: none; background: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <span style="width: 16px;"></span> Copy Chat
                    </button>
                    <button class="dropdown-item" onclick="exportPrintCopy('${chatSessionData.id}')" style="width: 100%; text-align: left; padding: 0.75rem 1rem; border: none; background: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <span style="width: 16px;"></span> Export Print Copy
                    </button>
                    <button class="dropdown-item" onclick="downloadChatData('${chatSessionData.id}')" style="width: 100%; text-align: left; padding: 0.75rem 1rem; border: none; background: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <span style="width: 16px;"></span> Download Chat Data
                    </button>
                    <button class="dropdown-item" onclick="manageRecipients('${chatSessionData.id}')" style="width: 100%; text-align: left; padding: 0.75rem 1rem; border: none; background: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <span style="width: 16px;"></span> Manage Recipients
                    </button>
                    <hr style="margin: 0.5rem 0; border: none; border-top: 1px solid var(--border-color);">
                    <button class="dropdown-item" onclick="deleteChat('${chatSessionData.id}')" style="width: 100%; text-align: left; padding: 0.75rem 1rem; border: none; background: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--danger-color);">
                        <span style="width: 16px;"></span> Delete Chat
                    </button>
                </div>
            </div>
        </div>
    `;
    
    activeChatsList.appendChild(chatItem);
}

// Universal chat finder function
function findChatById(chatId) {
    console.log('Finding chat with ID:', chatId);
    
    let chat = null;
    
    // Try different storage locations with different ID formats
    const sources = [
        window.chatSessions,
        window.activeChatSessions
    ];
    
    for (let source of sources) {
        if (source && Array.isArray(source) && source.length > 0) {
            chat = source.find(c => 
                c.id === chatId || 
                c.session_id === chatId ||
                c.id === String(chatId) ||
                c.session_id === String(chatId) ||
                String(c.id) === String(chatId) ||
                String(c.session_id) === String(chatId)
            );
            
            if (chat) {
                console.log('Found chat in source:', chat);
                return chat;
            }
        }
    }
    
    // If not found, get from the DOM (extract from chat item)
    const chatElements = document.querySelectorAll('.chat-item');
    for (let element of chatElements) {
        const buttons = element.querySelectorAll('button[onclick*="' + chatId + '"]');
        if (buttons.length > 0) {
            // Extract data from DOM element
            const nameElement = element.querySelector('h4, strong');
            const typeElement = element.querySelector('[style*="Type:"]');
            
            chat = {
                id: chatId,
                session_id: chatId,
                name: nameElement ? nameElement.textContent.trim() : 'Chat',
                type: 'listening', // Default type
                status: 'active',
                welcome: 'Welcome to our feedback chat!',
                welcomeMsg: 'Welcome to our feedback chat!',
                created: new Date().toISOString(),
                link: window.location.origin + '?chat=' + chatId,
                shortUrl: window.location.origin + '?chat=' + chatId
            };
            
            console.log('Created chat from DOM:', chat);
            return chat;
        }
    }
    
    // Final fallback - create dummy chat
    chat = {
        id: chatId,
        session_id: chatId,
        name: 'Chat',
        type: 'listening',
        status: 'active',
        welcome: 'Welcome to our feedback chat!',
        welcomeMsg: 'Welcome to our feedback chat!',
        created: new Date().toISOString(),
        link: window.location.origin + '?chat=' + chatId,
        shortUrl: window.location.origin + '?chat=' + chatId
    };
    
    console.log('Created fallback chat:', chat);
    return chat;
}

// Helper functions for chat management
function copyLink(link) {
    navigator.clipboard.writeText(link).then(() => {
        showToast('Link copied to clipboard!', 'success');
    }).catch(() => {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = link;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('Link copied to clipboard!', 'success');
    });
}

function toggleChatDropdown(button, event) {
    console.log('toggleChatDropdown called', button); // Debug log
    
    // Prevent event bubbling
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    const dropdown = button.nextElementSibling;
    if (!dropdown) {
        console.error('Dropdown menu not found');
        return;
    }
    
    const isVisible = dropdown.style.display === 'block';
    console.log('Dropdown current state:', isVisible ? 'visible' : 'hidden'); // Debug log
    
    // Close all other dropdowns
    document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.style.display = 'none';
    });
    
    // Toggle this dropdown
    dropdown.style.display = isVisible ? 'none' : 'block';
    console.log('Dropdown new state:', dropdown.style.display); // Debug log
    
    // Close dropdown when clicking outside
    if (!isVisible) {
        setTimeout(() => {
            document.addEventListener('click', function closeDropdown(e) {
                if (!button.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }, 0);
    }
}

function viewChatDetails(chatId) {
    // Find the chat data (check both window storage locations)
    let chat = null;
    if (window.chatSessions) {
        chat = window.chatSessions.find(c => c.id === chatId);
    }
    if (!chat && window.activeChatSessions) {
        chat = window.activeChatSessions.find(c => c.id === chatId);
    }
    
    if (!chat) {
        showToast('Chat details not found', 'warning');
        return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Chat Details: ${chat.name}</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div>
                <div class="form-group">
                    <label class="form-label">Chat Link:</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" class="form-input" value="${chat.link || chat.shortUrl}" readonly style="font-family: monospace; font-size: 0.875rem;">
                        <button class="btn btn-primary btn-sm" onclick="copyLink('${chat.link || chat.shortUrl}')">Copy</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Welcome Message:</label>
                    <textarea class="form-input" readonly rows="3">${chat.welcome || chat.welcomeMsg || 'No welcome message'}</textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Type:</label>
                        <input type="text" class="form-input" value="${chat.type || 'Chat'}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status:</label>
                        <input type="text" class="form-input" value="Active" readonly>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="testChatLink('${chat.link || chat.shortUrl}')">Test Chat</button>
                    <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Close</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function editChatSettings(chatId) {
    console.log('=== EDIT CHAT SETTINGS DEBUG ===');
    console.log('ChatId received:', chatId, typeof chatId);
    
    try {
        const chat = findChatById(chatId);
        console.log('Chat found:', chat);
        
        if (!chat) {
            console.error('Chat is null/undefined');
            showToast('Unable to load chat data', 'error');
            return;
        }
        
        // Safely get chat properties with fallbacks and escape them
        const chatName = (chat.name || 'Unnamed Chat').replace(/"/g, '&quot;');
        const chatWelcome = (chat.welcome || chat.welcomeMsg || 'Welcome!').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const chatType = (chat.type || 'listening').replace(/"/g, '&quot;');
        const chatStatus = chat.status || 'active';
        
        console.log('Using chat data:', {
            name: chatName,
            welcome: chatWelcome,
            type: chatType,
            status: chatStatus
        });
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        
        // Create the modal content step by step to avoid template literal issues
        const modalContent = document.createElement('div');
        modalContent.className = 'modal-content';
        modalContent.style.maxWidth = '600px';
        
        modalContent.innerHTML = `
            <div class="modal-header">
                <h3> Edit Chat: ${chatName}</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <form id="edit-chat-form">
                <div style="padding: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Chat Name</label>
                        <input type="text" id="edit-chat-name" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Welcome Message</label>
                        <textarea id="edit-chat-welcome" class="form-input" rows="4" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Chat Type</label>
                        <input type="text" id="edit-chat-type" class="form-input" readonly style="background-color: #f8f9fa;">
                        <small class="form-help">Chat type cannot be changed after creation</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="edit-chat-status" class="form-input">
                            <option value="active">Active</option>
                            <option value="paused">Paused</option>
                            <option value="archived">Archived</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </div>
            </form>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // Set form values after modal is added to DOM
        setTimeout(() => {
            const nameInput = document.getElementById('edit-chat-name');
            const welcomeInput = document.getElementById('edit-chat-welcome');
            const typeInput = document.getElementById('edit-chat-type');
            const statusSelect = document.getElementById('edit-chat-status');
            
            if (nameInput) nameInput.value = chat.name || 'Unnamed Chat';
            if (welcomeInput) welcomeInput.value = chat.welcome || chat.welcomeMsg || 'Welcome!';
            if (typeInput) typeInput.value = chat.type || 'listening';
            if (statusSelect) statusSelect.value = chat.status || 'active';
            
            console.log('Form values set successfully');
        }, 10);
        
        // Add form submit handler
        const form = document.getElementById('edit-chat-form');
        if (form) {
            form.onsubmit = function(event) {
                event.preventDefault();
                saveEditedChat(event, chatId);
            };
        }
        
        console.log('Edit modal created and added to page');
        
    } catch (error) {
        console.error('Error in editChatSettings:', error);
        showToast('Error opening edit dialog: ' + error.message, 'error');
    }
}

function saveEditedChat(event, chatId) {
    console.log('=== SAVE EDITED CHAT DEBUG ===');
    event.preventDefault();
    
    try {
        const newName = document.getElementById('edit-chat-name').value;
        const newWelcome = document.getElementById('edit-chat-welcome').value;
        const newStatus = document.getElementById('edit-chat-status').value;
        
        console.log('Form values:', { newName, newWelcome, newStatus });
        
        if (!newName.trim()) {
            showToast('Chat name is required', 'warning');
            return;
        }
        
        // Update chat data in storage
        let updated = false;
        
        if (window.chatSessions) {
            const chat = window.chatSessions.find(c => 
                c.id === chatId || c.session_id === chatId ||
                String(c.id) === String(chatId) || String(c.session_id) === String(chatId)
            );
            if (chat) {
                console.log('Updating chat in chatSessions:', chat);
                chat.name = newName;
                chat.welcome = newWelcome;
                chat.welcomeMsg = newWelcome;
                chat.status = newStatus;
                updated = true;
            }
        }
        
        if (!updated && window.activeChatSessions) {
            const chat = window.activeChatSessions.find(c => 
                c.id === chatId || c.session_id === chatId ||
                String(c.id) === String(chatId) || String(c.session_id) === String(chatId)
            );
            if (chat) {
                console.log('Updating chat in activeChatSessions:', chat);
                chat.name = newName;
                chat.welcome = newWelcome;
                chat.welcomeMsg = newWelcome;
                chat.status = newStatus;
                updated = true;
            }
        }
        
        // Close modal
        const modal = event.target.closest('.modal');
        if (modal) {
            modal.remove();
        }
        
        // Always refresh the chat list to show changes
        setTimeout(() => {
            loadActiveChatsList();
        }, 100);
        
        showToast(`Chat "${newName}" updated successfully!`, 'success');
        console.log('Chat update completed, updated:', updated);
        
    } catch (error) {
        console.error('Error saving chat:', error);
        showToast('Error saving changes: ' + error.message, 'error');
    }
}

function copyChatSession(chatId) {
    const originalChat = findChatById(chatId);
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3> Copy Chat</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <form onsubmit="createCopiedChat(event, '${chatId}')">
                <div style="padding: 1.5rem;">
                    <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                        <strong>Copying:</strong> ${originalChat.name}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">New Chat Name</label>
                        <input type="text" id="copy-chat-name" class="form-input" value="${originalChat.name} (Copy)" required>
                        <small class="form-help">Enter a name for the copied chat</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">What will be copied:</label>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; font-size: 0.875rem;">
                            <li>Chat type (${originalChat.type})</li>
                            <li>Welcome message</li>
                            <li>Configuration settings</li>
                            ${originalChat.topics ? '<li>Topics</li>' : ''}
                            ${originalChat.questions ? '<li>Questions</li>' : ''}
                        </ul>
                        <small class="form-help" style="color: var(--text-secondary);">A new chat link will be generated</small>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Copy Chat</button>
                    </div>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Focus on the name input
    setTimeout(() => {
        document.getElementById('copy-chat-name').focus();
        document.getElementById('copy-chat-name').select();
    }, 100);
}

function createCopiedChat(event, originalChatId) {
    event.preventDefault();
    
    const newName = document.getElementById('copy-chat-name').value;
    const originalChat = findChatById(originalChatId);
    
    // Create new chat data by copying from original
    const newChatId = originalChat.type + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    const newLink = 'https://employee-survey-platform.surge.sh/chat.html?session=' + newChatId;
    
    const copiedChat = {
        id: newChatId,
        session_id: newChatId,
        name: newName,
        type: originalChat.type,
        welcome: originalChat.welcome || originalChat.welcomeMsg,
        welcomeMsg: originalChat.welcome || originalChat.welcomeMsg,
        link: newLink,
        shortUrl: newLink,
        status: 'active',
        created: new Date().toISOString(),
        created_at: new Date().toISOString(),
        // Copy additional properties
        topics: originalChat.topics,
        questions: originalChat.questions,
        allowAnonymous: originalChat.allowAnonymous,
        expiry: originalChat.expiry
    };
    
    // Add to storage
    if (!window.chatSessions) {
        window.chatSessions = [];
    }
    window.chatSessions.push(copiedChat);
    
    // Close modal
    event.target.closest('.modal').remove();
    
    // Add to management interface and refresh
    addChatToManagement(copiedChat);
    loadActiveChatsList();
    
    showToast(`Chat "${newName}" created successfully!`, 'success');
}

function exportPrintCopy(chatId) {
    const chat = findChatById(chatId);
    
    // Create printable HTML content
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Chat Export - ${chat.name}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 2rem; line-height: 1.6; }
                .header { border-bottom: 2px solid #333; padding-bottom: 1rem; margin-bottom: 2rem; }
                .section { margin-bottom: 1.5rem; }
                .label { font-weight: bold; color: #555; }
                .value { margin-bottom: 1rem; }
                .chat-link { font-family: monospace; background: #f5f5f5; padding: 0.5rem; border-radius: 4px; }
                @media print {
                    body { margin: 1rem; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Chat Export</h1>
                <p>Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
            </div>
            
            <div class="section">
                <div class="label">Chat Name:</div>
                <div class="value">${chat.name}</div>
            </div>
            
            <div class="section">
                <div class="label">Chat Type:</div>
                <div class="value">${chat.type || 'Chat'}</div>
            </div>
            
            <div class="section">
                <div class="label">Status:</div>
                <div class="value">${chat.status || 'Active'}</div>
            </div>
            
            <div class="section">
                <div class="label">Created:</div>
                <div class="value">${new Date(chat.created || chat.created_at).toLocaleString()}</div>
            </div>
            
            <div class="section">
                <div class="label">Welcome Message:</div>
                <div class="value">${chat.welcome || chat.welcomeMsg || 'No welcome message'}</div>
            </div>
            
            <div class="section">
                <div class="label">Chat Link:</div>
                <div class="value chat-link">${chat.link || chat.shortUrl}</div>
            </div>
            
            ${chat.topics ? `
                <div class="section">
                    <div class="label">Topics:</div>
                    <div class="value">${Array.isArray(chat.topics) ? chat.topics.join(', ') : chat.topics}</div>
                </div>
            ` : ''}
            
            ${chat.questions ? `
                <div class="section">
                    <div class="label">Questions:</div>
                    <div class="value">${Array.isArray(chat.questions) ? chat.questions.length + ' questions configured' : 'Custom questions configured'}</div>
                </div>
            ` : ''}
            
            <div class="section">
                <div class="label">Additional Settings:</div>
                <div class="value">
                     Anonymous Access: ${chat.allowAnonymous ? 'Enabled' : 'Disabled'}<br>
                     Expiry: ${chat.expiry || 'Never expires'}<br>
                     Link Sharing: Enabled
                </div>
            </div>
            
            <div class="no-print" style="margin-top: 3rem; text-align: center;">
                <button onclick="window.print()" style="background: #2563eb; color: white; border: none; padding: 0.75rem 2rem; border-radius: 4px; cursor: pointer;">Print This Page</button>
                <button onclick="window.close()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 2rem; border-radius: 4px; cursor: pointer; margin-left: 1rem;">Close</button>
            </div>
        </body>
        </html>
    `;
    
    // Open in new window for printing
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    showToast('Print preview opened in new window', 'success');
}

function downloadChatData(chatId) {
    const chat = findChatById(chatId);
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3> Download Chat Data</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div style="padding: 1.5rem;">
                <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                    <strong>Chat:</strong> ${chat.name}
                </div>
                
                <div class="form-group">
                    <label class="form-label">Select Data to Download:</label>
                    <div style="margin: 1rem 0;">
                        <label style="display: flex; align-items: center; margin-bottom: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="download-config" checked style="margin-right: 0.5rem;"> Chat Configuration
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="download-responses" checked style="margin-right: 0.5rem;"> User Responses (Sample)
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="download-analytics" checked style="margin-right: 0.5rem;"> Analytics Summary
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">File Format:</label>
                    <select id="download-format" class="form-input">
                        <option value="csv">CSV (Excel compatible)</option>
                        <option value="json">JSON (Developer format)</option>
                        <option value="txt">Text Report</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="performDownload('${chatId}')">Download</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function performDownload(chatId) {
    const includeConfig = document.getElementById('download-config').checked;
    const includeResponses = document.getElementById('download-responses').checked;
    const includeAnalytics = document.getElementById('download-analytics').checked;
    const format = document.getElementById('download-format').value;
    
    const chat = findChatById(chatId);
    
    // Generate sample data
    const currentDate = new Date().toLocaleDateString();
    const currentTime = new Date().toLocaleTimeString();
    
    let data = {};
    
    if (includeConfig) {
        data.configuration = {
            name: chat.name,
            type: chat.type,
            status: chat.status || 'active',
            created: chat.created || chat.created_at,
            welcome_message: chat.welcome || chat.welcomeMsg,
            link: chat.link,
            topics: chat.topics,
            questions: chat.questions
        };
    }
    
    if (includeResponses) {
        data.responses = [
            {
                timestamp: new Date(Date.now() - 86400000).toISOString(),
                user_id: 'user_001',
                message: 'Great initiative! Really happy with the new features.',
                sentiment: 'positive',
                topics: ['features', 'satisfaction']
            },
            {
                timestamp: new Date(Date.now() - 43200000).toISOString(),
                user_id: 'user_002',
                message: 'Could improve the user interface, but overall good.',
                sentiment: 'neutral',
                topics: ['ui', 'improvement']
            },
            {
                timestamp: new Date(Date.now() - 21600000).toISOString(),
                user_id: 'user_003',
                message: 'Loving the new chat system!',
                sentiment: 'positive',
                topics: ['chat', 'satisfaction']
            }
        ];
    }
    
    if (includeAnalytics) {
        data.analytics = {
            total_responses: 3,
            positive_sentiment: 2,
            neutral_sentiment: 1,
            negative_sentiment: 0,
            top_topics: ['satisfaction', 'features', 'ui'],
            response_rate: '15.2%',
            avg_response_length: 45,
            generated_on: currentDate + ' ' + currentTime
        };
    }
    
    let content = '';
    let filename = '';
    let mimeType = '';
    
    if (format === 'csv') {
        filename = `${chat.name}_data_${new Date().toISOString().split('T')[0]}.csv`;
        mimeType = 'text/csv';
        content = generateCSV(data);
    } else if (format === 'json') {
        filename = `${chat.name}_data_${new Date().toISOString().split('T')[0]}.json`;
        mimeType = 'application/json';
        content = JSON.stringify(data, null, 2);
    } else if (format === 'txt') {
        filename = `${chat.name}_report_${new Date().toISOString().split('T')[0]}.txt`;
        mimeType = 'text/plain';
        content = generateTextReport(data, chat);
    }
    
    // Create and download file
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    // Close modal
    document.querySelector('.modal').remove();
    
    showToast(`Data downloaded as ${filename}`, 'success');
}

function generateCSV(data) {
    let csv = '';
    
    if (data.configuration) {
        csv += 'CONFIGURATION\n';
        csv += 'Property,Value\n';
        Object.entries(data.configuration).forEach(([key, value]) => {
            csv += `"${key}","${value}"\n`;
        });
        csv += '\n';
    }
    
    if (data.responses) {
        csv += 'RESPONSES\n';
        csv += 'Timestamp,User ID,Message,Sentiment,Topics\n';
        data.responses.forEach(response => {
            csv += `"${response.timestamp}","${response.user_id}","${response.message}","${response.sentiment}","${response.topics.join(', ')}"\n`;
        });
        csv += '\n';
    }
    
    if (data.analytics) {
        csv += 'ANALYTICS\n';
        csv += 'Metric,Value\n';
        Object.entries(data.analytics).forEach(([key, value]) => {
            csv += `"${key}","${value}"\n`;
        });
    }
    
    return csv;
}

function generateTextReport(data, chat) {
    let report = `CHAT DATA REPORT\n`;
    report += `================\n\n`;
    report += `Chat: ${chat.name}\n`;
    report += `Generated: ${new Date().toLocaleString()}\n\n`;
    
    if (data.configuration) {
        report += `CONFIGURATION:\n`;
        report += `- Name: ${data.configuration.name}\n`;
        report += `- Type: ${data.configuration.type}\n`;
        report += `- Status: ${data.configuration.status}\n`;
        report += `- Created: ${new Date(data.configuration.created).toLocaleString()}\n`;
        report += `- Link: ${data.configuration.link}\n\n`;
    }
    
    if (data.analytics) {
        report += `ANALYTICS SUMMARY:\n`;
        report += `- Total Responses: ${data.analytics.total_responses}\n`;
        report += `- Sentiment: ${data.analytics.positive_sentiment} positive, ${data.analytics.neutral_sentiment} neutral, ${data.analytics.negative_sentiment} negative\n`;
        report += `- Response Rate: ${data.analytics.response_rate}\n`;
        report += `- Top Topics: ${data.analytics.top_topics.join(', ')}\n\n`;
    }
    
    if (data.responses) {
        report += `RECENT RESPONSES:\n`;
        data.responses.forEach((response, index) => {
            report += `\n${index + 1}. [${new Date(response.timestamp).toLocaleString()}] (${response.sentiment})\n`;
            report += `   "${response.message}"\n`;
            report += `   Topics: ${response.topics.join(', ')}\n`;
        });
    }
    
    return report;
}

function manageRecipients(chatId) {
    // Set the global chat ID for recipient management
    window.currentChatId = chatId;
    console.log(' Set current chat ID to:', chatId);

    const contentArea = document.getElementById('content-area');

    // Store the original content so we can restore it later
    if (contentArea && !window.originalContentHTML) {
        console.log(' Storing original content for restoration...');
        window.originalContentHTML = contentArea.innerHTML;
    }

    // Get chat data to show the chat name
    const chat = findChatById(chatId);
    const chatName = chat ? chat.name : 'Unknown Chat';
    
    // Create the full-screen recipients management interface
    contentArea.innerHTML = `
        <div class="manage-recipients-container">
            <!-- Navigation Breadcrumb -->
            <nav class="recipients-nav">
                <div class="breadcrumb">
                    <span class="breadcrumb-item">
                        <a href="#" onclick="showDashboard()" class="breadcrumb-link">Manage Surveys</a>
                    </span>
                    <span class="breadcrumb-separator">></span>
                    <span class="breadcrumb-item">
                        <a href="#" onclick="returnToChatManagement()" class="breadcrumb-link">Chat Management</a>
                    </span>
                    <span class="breadcrumb-separator">></span>
                    <span class="breadcrumb-item current">
                        Manage Recipients: ${chatName}
                    </span>
                </div>
                <div class="back-arrow">
                    <button onclick="returnToChatManagement()" class="back-btn" title="Back to Chat Management">
                        <span class="back-icon"></span> Back
                    </button>
                </div>
            </nav>

            <!-- Header Section -->
            <div class="recipients-header">
                <h1> Manage Recipients: ${chatName}</h1>
                
                <!-- Stats Cards -->
                <div class="recipients-stats">
                    <div class="stat-card">
                        <div class="stat-label">Participation Rate</div>
                        <div class="stat-value">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Completion Rate</div>
                        <div class="stat-value">-</div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="recipients-actions">
                <button class="btn btn-primary" onclick="sendEmailInvitation()">
                    <span></span> Send E-mail Invitation / Reminder to Selected Recipients
                </button>
                
                <button class="btn btn-secondary" onclick="preloadRecipients()">
                    <span></span> Pre-load recipients and demographic data
                </button>

                <button class="btn btn-warning" onclick="testDatabaseDirectUpdate()" style="background: orange; color: white;">
                    <span></span> TEST: Update First Record
                </button>

                <button class="btn btn-success" onclick="addRecipient()">
                    <span></span> Add Recipient
                </button>
                
                <button class="btn btn-info" onclick="uploadRecipient()">
                    <span></span> Upload Recipient
                </button>
                
                <button class="btn btn-warning" onclick="uploadSurveyResponses()">
                    <span></span> Upload Survey Responses
                </button>
            </div>

            <!-- Data Table -->
            <div class="recipients-table-container">
                <table class="recipients-table">
                    <thead>
                        <tr>
                            <th class="checkbox-column">
                                <input type="checkbox" id="select-all" onchange="toggleSelectAllRecipients()">
                            </th>
                            <th>Forename</th>
                            <th>Surname</th>
                            <th>E-mail</th>
                            <th>Employee No</th>
                            <th>Invite Sent</th>
                            <th>No. Reminders Sent</th>
                            <th>Last Reminder Sent</th>
                            <th class="sortable" onclick="sortTable('date_started')">
                                Date Survey Started 
                                <span class="sort-arrow"></span>
                            </th>
                            <th class="sortable" onclick="sortTable('date_completed')">
                                Date Survey Completed 
                                <span class="sort-arrow"></span>
                            </th>
                            <th>Edit Survey Recipient</th>
                            <th>Delete Survey Recipient</th>
                        </tr>
                    </thead>
                    <tbody id="recipients-table-body">
                        <tr class="no-data-row">
                            <td colspan="12" class="no-data">No data</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    // Load recipients data for this chat
    loadRecipientsData(chatId);
}

function generateInviteMessage(chat) {
    return `Hi there!

You're invited to share your thoughts through our ${chat.type} chat: "${chat.name}".

${chat.welcome || chat.welcomeMsg || 'Your feedback is valuable to us!'}

Please click the link below to get started:
{CHAT_LINK}

Thank you for your time!`;
}

function sendInvitations(chatId) {
    const emails = document.getElementById('recipient-emails').value.trim();
    const message = document.getElementById('invitation-message').value;
    
    if (!emails) {
        showToast('Please enter at least one email address', 'warning');
        return;
    }
    
    const emailList = emails.split('\n').filter(email => email.trim());
    const validEmails = emailList.filter(email => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.trim()));
    
    if (validEmails.length === 0) {
        showToast('Please enter valid email addresses', 'warning');
        return;
    }
    
    if (validEmails.length !== emailList.length) {
        showToast(`${emailList.length - validEmails.length} invalid email(s) were skipped`, 'warning');
    }
    
    // Simulate sending invitations
    showToast(`Sending invitations to ${validEmails.length} recipient(s)...`, 'info');
    
    setTimeout(() => {
        // Add new recipients to the list (simulation)
        const recipientsList = document.getElementById('current-recipients');
        validEmails.forEach(email => {
            const recipientItem = document.createElement('div');
            recipientItem.className = 'recipient-item';
            recipientItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 0.5rem;';
            recipientItem.innerHTML = `
                <div>
                    <div style="font-weight: 500;">${email.trim()}</div>
                    <small style="color: var(--text-secondary);">Invited just now  Pending</small>
                </div>
                <span style="color: var(--warning-color); font-size: 0.75rem;"></span>
            `;
            recipientsList.appendChild(recipientItem);
        });
        
        // Clear the input
        document.getElementById('recipient-emails').value = '';
        
        showToast(`Invitations sent successfully to ${validEmails.length} recipient(s)!`, 'success');
    }, 2000);
}

function archiveChat(chatId) {
    if (confirm('Are you sure you want to archive this chat? It will no longer be accessible to participants.')) {
        showToast('Chat archived successfully!', 'success');
        // In a real app, update the database status here
    }
}

function deleteChat(chatId) {
    if (confirm('Are you sure you want to delete this chat? This action cannot be undone.')) {
        const chatItem = document.querySelector(`[onclick*="${chatId}"]`)?.closest('.chat-item');
        if (chatItem) {
            chatItem.remove();
        }
        
        // Remove from sessions arrays
        if (window.chatSessions) {
            window.chatSessions = window.chatSessions.filter(c => c.id !== chatId);
        }
        if (window.activeChatSessions) {
            window.activeChatSessions = window.activeChatSessions.filter(c => c.id !== chatId);
        }
        
        // Show empty state if no chats left
        const activeChatsList = document.getElementById('active-chats-list');
        if (activeChatsList && activeChatsList.children.length === 0) {
            activeChatsList.style.display = 'none';
            const emptyState = document.querySelector('#chat-management-section .card:nth-child(2) > div:not(#active-chats-list)');
            if (emptyState) {
                emptyState.style.display = 'block';
            }
        }
        
        showToast('Chat deleted successfully!', 'success');
    }
}

// Debug function to test chat functionality
window.testChatFunctions = function() {
    console.log('=== CHAT FUNCTION TEST ===');
    console.log('Available chat data:');
    console.log('window.chatSessions:', window.chatSessions);
    console.log('window.activeChatSessions:', window.activeChatSessions);
    
    // Test with different ID formats
    const testIds = ['test', 'test2', 'listening_123', '1', 'user_001'];
    testIds.forEach(id => {
        const chat = findChatById(id);
        console.log(`Test ID "${id}":`, chat);
    });
    
    // Try to edit first available chat
    if (window.chatSessions && window.chatSessions.length > 0) {
        const firstChat = window.chatSessions[0];
        console.log('Testing edit with first chat:', firstChat);
        editChatSettings(firstChat.id || firstChat.session_id);
    } else if (window.activeChatSessions && window.activeChatSessions.length > 0) {
        const firstChat = window.activeChatSessions[0];
        console.log('Testing edit with first active chat:', firstChat);
        editChatSettings(firstChat.id || firstChat.session_id);
    } else {
        console.log('Testing edit with dummy ID: test');
        editChatSettings('test');
    }
};

// Simple edit test function
window.testEditFunction = function() {
    console.log('=== TESTING EDIT FUNCTION DIRECTLY ===');
    try {
        console.log('Calling editChatSettings with "test"');
        editChatSettings('test');
        console.log('Edit function completed without error');
    } catch (error) {
        console.error('Error calling edit function:', error);
    }
};

// Test if the function exists
console.log('editChatSettings function exists:', typeof editChatSettings);


// Make sure showSection function is available with navigation highlighting
function showSection(sectionName) {
    console.log(` showSection called with: ${sectionName}`);

    // Clear any stored content when navigating to prevent conflicts
    if (window.originalContentHTML && sectionName !== 'chat-management') {
        console.log(' Clearing stored content for section navigation');
        window.originalContentHTML = null;
    }

    // Only hide main content sections, NOT sidebar nav-sections
    const sections = document.querySelectorAll('.main-content [id$="-section"]');
    console.log(`Found ${sections.length} sections to hide`);
    sections.forEach(section => {
        section.classList.add('hidden');
        console.log(`Hidden section: ${section.id}`);
    });

    const targetSectionId = sectionName + '-section';
    console.log(`Looking for section: ${targetSectionId}`);

    // Try to find the element with multiple approaches
    let targetSection = document.getElementById(targetSectionId);

    if (!targetSection) {
        // Fallback: search by querySelector
        console.log(`Retrying with querySelector...`);
        targetSection = document.querySelector(`#${targetSectionId}`);
    }

    if (!targetSection) {
        // Debug: List all sections with matching pattern
        console.log(`All sections found:`, Array.from(sections).map(s => s.id));
        console.error(` Target section not found: ${targetSectionId}`);

        // Try a delayed retry in case of timing issues
        setTimeout(() => {
            console.log(`Retrying showSection after delay...`);
            const retrySection = document.getElementById(targetSectionId);
            if (retrySection) {
                console.log(` Found section on retry: ${retrySection.id}`);
                retrySection.classList.remove('hidden');
                updateNavHighlight(sectionName);
            } else {
                console.error(` Section still not found after retry: ${targetSectionId}`);
            }
        }, 100);
        return;
    }

    targetSection.classList.remove('hidden');
    console.log(` Showed section: ${targetSection.id}`);

    updateNavHighlight(sectionName);

    // Reload chat list when showing chat management to ensure latest template is used
    if (sectionName === 'chat-management') {
        // Wait for DOM to update, then load chats
        setTimeout(() => {
            try {
                console.log(' Delayed loading of active chats...');
                loadActiveChatsList();
            } catch (error) {
                console.error('Error loading active chats list:', error);
            }
        }, 500);
    }

    // Initialize analytics dashboard when showing analytics section
    if (sectionName === 'chat-feedback' && typeof initAnalyticsDashboard === 'function') {
        setTimeout(() => {
            try {
                console.log(' Initializing analytics dashboard...');
                initAnalyticsDashboard();
            } catch (error) {
                console.error('Error initializing analytics dashboard:', error);
            }
        }, 100);
    }

    // Load listening chats when showing listen section
    if (sectionName === 'listen' && typeof renderChatCards === 'function') {
        setTimeout(() => {
            try {
                console.log(' Loading listening chats...');
                renderChatCards();
            } catch (error) {
                console.error('Error loading listening chats:', error);
            }
        }, 100);
    }
}

// Helper function to update navigation highlighting
function updateNavHighlight(sectionName) {
    // Update navigation highlighting
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });

    // Find and highlight the correct nav item
    const navItem = document.querySelector(`[onclick="showSection('${sectionName}')"]`);
    if (navItem) {
        navItem.classList.add('active');
    }
}

// Database cleanup function for testing
async function cleanupTestRecipients() {
    try {
        console.log(' Cleaning up old test recipients...');
        
        // Delete all recipients with survey_id 'test' (from earlier testing)
        const { data, error } = await window.supabaseClient
            .from('survey_recipients')
            .delete()
            .eq('survey_id', 'test');
            
        if (error) {
            console.error(' Error cleaning up:', error);
        } else {
            console.log(' Cleanup complete');
        }
    } catch (error) {
        console.error(' Cleanup failed:', error);
    }
}

// Function to get current chat ID from the page context
function getCurrentChatId() {
    // Try to get from global variable or page context
    if (window.currentChatId) {
        return window.currentChatId;
    }
    
    // Try to extract from URL or page title
    const breadcrumb = document.querySelector('.breadcrumb');
    if (breadcrumb) {
        const breadcrumbText = breadcrumb.textContent;
        const match = breadcrumbText.match(/survey - (.+)/);
        if (match) {
            return match[1];
        }
    }
    
    // Fallback to 'test' if we can't determine the chat ID
    return 'test';
}

// Recipients Management Helper Functions
// loadRecipientsData function removed - using version from app.js to avoid conflicts

function returnToChatManagement() {
    console.log(' Returning to Chat Management...');

    // Restore the original content if it was stored
    const contentArea = document.getElementById('content-area');
    if (contentArea && window.originalContentHTML) {
        console.log(' Restoring original content...');
        contentArea.innerHTML = window.originalContentHTML;

        // Clear the stored content to prevent issues
        window.originalContentHTML = null;
    } else if (contentArea) {
        // If no stored content, refresh the page to restore everything
        console.log(' No stored content found, reloading page...');
        window.location.reload();
        return;
    }

    // Small delay to ensure content is restored before showing section
    setTimeout(() => {
        // Show the chat management section
        showSection('chat-management');

        // Update the breadcrumb
        const breadcrumb = document.getElementById('breadcrumb');
        if (breadcrumb) {
            breadcrumb.textContent = 'Chat Management';
        }

        // Make sure the nav item is highlighted
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        const chatMgmtNavItem = document.querySelector('[onclick="showSection(\'chat-management\')"]');
        if (chatMgmtNavItem) {
            chatMgmtNavItem.classList.add('active');
        }

        console.log(' Successfully returned to Chat Management');
    }, 100);
}

function updateRecipientStats(recipients) {
    const total = recipients.length;
    const completed = recipients.filter(r => r.status === 'completed').length;
    const invited = recipients.filter(r => r.inviteSent === 'Yes').length;
    
    const participationRate = total > 0 ? Math.round((invited / total) * 100) : 0;
    const completionRate = invited > 0 ? Math.round((completed / invited) * 100) : 0;

    // Update the stats cards - show "-" when no data
    const statsCards = document.querySelectorAll('.recipients-stats .stat-card');
    if (statsCards[0]) {
        statsCards[0].querySelector('.stat-value').textContent = total > 0 ? `${participationRate}%` : '-';
    }
    if (statsCards[1]) {
        statsCards[1].querySelector('.stat-value').textContent = total > 0 ? `${completionRate}%` : '-';
    }
}

function toggleSelectAllRecipients() {
    const selectAllCheckbox = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('#recipients-table-body input[type="checkbox"]');

    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
}

function sortRecipientsTable(column) {
    showToast(`Sorting by ${column}`, 'info');
    // TODO: Implement table sorting functionality
}

function sendEmailInvitation() {
    // Auto-select recipients who haven't completed the survey
    const allRecipients = document.querySelectorAll('#recipients-table-body input[type="checkbox"]');
    console.log('Found recipients:', allRecipients.length);

    const nonResponders = Array.from(allRecipients).filter(checkbox => {
        const row = checkbox.closest('tr');
        // Check if "Date Survey Completed" column is empty (indicates no response)
        const completedCell = row.cells[9]; // "Date Survey Completed" column
        const completedText = completedCell ? completedCell.textContent.trim() : '';
        console.log('Checking recipient:', row.cells[1].textContent, 'completion status:', completedText);
        return completedText === '-' || completedText === '' || !completedText;
    });

    console.log('Non-responders found:', nonResponders.length);

    if (nonResponders.length === 0) {
        showToast('All recipients have already completed the survey!', 'info');
        return;
    }

    // Get non-responder details
    const selectedDetails = nonResponders.map(checkbox => {
        const row = checkbox.closest('tr');
        return {
            id: checkbox.dataset.recipientId,
            name: `${row.cells[1].textContent} ${row.cells[2].textContent}`,
            email: row.cells[3].textContent
        };
    });

    showToast(`Automatically selected ${nonResponders.length} recipients who haven't responded`, 'info');

    // Create email invitation modal
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3> Send Email Invitations</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Recipients (${selectedDetails.length} selected):</label>
                    <div class="recipients-preview">
                        ${selectedDetails.map(r => `
                            <div class="recipient-tag">
                                <span>${r.name} (${r.email})</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Subject:</label>
                    <input type="text" id="email-subject" class="form-input" 
                           value="Survey Invitation - Your Feedback Matters" 
                           placeholder="Enter email subject">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Message:</label>
                    <textarea id="email-message" class="form-input" rows="6" placeholder="Enter your message...">Hi {name},

We would love to hear your feedback! Please take a few minutes to complete our survey.

Click here to start: {survey_link}

Thank you for your time!

Best regards,
Survey Team</textarea>
                    <small class="form-help">Use {name} for recipient name and {survey_link} for the survey link</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="send-reminder" checked> Send as reminder (for previously invited recipients)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmSendInvitations(${JSON.stringify(selectedDetails).replace(/"/g, '&quot;')})">
                    Send ${selectedDetails.length} Invitation${selectedDetails.length > 1 ? 's' : ''}
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function preloadRecipients() {
    // Create pre-load recipients modal
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3> Pre-load Recipients and Demographic Data</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Import recipient lists and demographic information from various sources.</p>
                
                <div class="preload-options">
                    <div class="option-card" onclick="preloadFromCSV()">
                        <div class="option-icon"></div>
                        <h4>CSV/Excel Import</h4>
                        <p>Upload a CSV or Excel file with recipient details and demographic information.</p>
                        <div class="option-features">
                            <span class="feature"> Bulk import</span>
                            <span class="feature"> Demographic data</span>
                            <span class="feature"> Validation</span>
                        </div>
                    </div>
                    
                    <div class="option-card" onclick="preloadFromHR()">
                        <div class="option-icon"></div>
                        <h4>HR System Integration</h4>
                        <p>Connect to your HR system to automatically import employee data.</p>
                        <div class="option-features">
                            <span class="feature"> Live sync</span>
                            <span class="feature"> Department data</span>
                            <span class="feature"> Role information</span>
                        </div>
                    </div>
                    
                    <div class="option-card" onclick="preloadFromAD()">
                        <div class="option-icon"></div>
                        <h4>Active Directory</h4>
                        <p>Import users from your organization's Active Directory.</p>
                        <div class="option-features">
                            <span class="feature"> AD integration</span>
                            <span class="feature"> Group filtering</span>
                            <span class="feature"> Auto-sync</span>
                        </div>
                    </div>
                </div>
                
                <div class="sample-data-section" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                    <h4>Quick Start: Load Sample Data</h4>
                    <p>Add sample recipients with demographic data for testing purposes.</p>
                    <button class="btn btn-info" onclick="loadSampleData()">
                         Load Sample Recipients
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function addRecipient() {
    // Create add recipient modal
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3> Add New Recipient</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-recipient-form">
                    <div class="form-group">
                        <label class="form-label">First Name *</label>
                        <input type="text" id="recipient-forename" class="form-input" required 
                               placeholder="Enter first name">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Last Name *</label>
                        <input type="text" id="recipient-surname" class="form-input" required 
                               placeholder="Enter last name">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email Address *</label>
                        <input type="email" id="recipient-email" class="form-input" required 
                               placeholder="name@company.com">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Employee Number</label>
                        <input type="text" id="recipient-employee-no" class="form-input" 
                               placeholder="EMP001 (optional)">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="send-immediate-invitation"> 
                            Send invitation immediately after adding
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                <button type="button" class="btn btn-success" onclick="confirmAddRecipient()">Add Recipient</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function uploadRecipient() {
    // Create upload modal
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3> Upload Recipients</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="upload-section">
                    <p>Upload a CSV or Excel file containing recipient information.</p>
                    
                    <div class="file-upload-area" onclick="document.getElementById('recipient-file').click()">
                        <div class="upload-icon"></div>
                        <div class="upload-text">
                            <strong>Click to select file</strong> or drag and drop
                        </div>
                        <div class="upload-hint">Supported formats: .csv, .xlsx, .xls</div>
                    </div>
                    
                    <input type="file" id="recipient-file" accept=".csv,.xlsx,.xls" style="display: none;" 
                           onchange="handleRecipientFileUpload(event)">
                    
                    <div class="template-section" style="margin-top: 2rem;">
                        <h4>Expected File Format:</h4>
                        <div class="format-example">
                            <table style="width: 100%; font-size: 0.875rem; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="border: 1px solid #dee2e6; padding: 0.5rem;">Forename</th>
                                        <th style="border: 1px solid #dee2e6; padding: 0.5rem;">Surname</th>
                                        <th style="border: 1px solid #dee2e6; padding: 0.5rem;">Email</th>
                                        <th style="border: 1px solid #dee2e6; padding: 0.5rem;">Employee_No</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="border: 1px solid #dee2e6; padding: 0.5rem;">John</td>
                                        <td style="border: 1px solid #dee2e6; padding: 0.5rem;">Smith</td>
                                        <td style="border: 1px solid #dee2e6; padding: 0.5rem;">john@company.com</td>
                                        <td style="border: 1px solid #dee2e6; padding: 0.5rem;">EMP001</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <button class="btn btn-info" onclick="downloadTemplate()" style="margin-top: 1rem;">
                             Download Template
                        </button>
                    </div>
                </div>
                
                <div id="upload-preview" style="display: none; margin-top: 2rem;">
                    <h4>Preview:</h4>
                    <div id="preview-content"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-upload-btn" style="display: none;" 
                        onclick="confirmUploadRecipients()">Import Recipients</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function uploadSurveyResponses() {
    // Create survey responses upload modal
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3> Upload Survey Responses</h3>
                <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="upload-section">
                    <p>Upload survey responses to import existing data or bulk update participant responses.</p>
                    
                    <div class="file-upload-area" onclick="document.getElementById('responses-file').click()">
                        <div class="upload-icon"></div>
                        <div class="upload-text">
                            <strong>Click to select responses file</strong> or drag and drop
                        </div>
                        <div class="upload-hint">Supported formats: .csv, .xlsx, .json</div>
                    </div>
                    
                    <input type="file" id="responses-file" accept=".csv,.xlsx,.json" style="display: none;" 
                           onchange="handleResponsesFileUpload(event)">
                    
                    <div class="template-section" style="margin-top: 2rem;">
                        <h4>Expected Response Format:</h4>
                        <div class="format-example">
                            <table style="width: 100%; font-size: 0.875rem; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="border: 1px solid #dee2e6; padding: 0.5rem;">Email</th>
                                        <th style="border: 1px solid #dee2e6; padding: 0.5rem;">Response_Date</th>
                                        <th style="border: 1px solid #dee2e6; padding: 0.5rem;">Status</th>
                                        <th style="border: 1px solid #dee2e6; padding: 0.5rem;">Score</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="border: 1px solid #dee2e6; padding: 0.5rem;">john@company.com</td>
                                        <td style="border: 1px solid #dee2e6; padding: 0.5rem;">2025-09-01</td>
                                        <td style="border: 1px solid #dee2e6; padding: 0.5rem;">Completed</td>
                                        <td style="border: 1px solid #dee2e6; padding: 0.5rem;">85</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <button class="btn btn-info" onclick="downloadResponsesTemplate()" style="margin-top: 1rem;">
                             Download Response Template
                        </button>
                    </div>
                </div>
                
                <div id="responses-preview" style="display: none; margin-top: 2rem;">
                    <h4>Preview:</h4>
                    <div id="responses-preview-content"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-responses-btn" style="display: none;" 
                        onclick="confirmUploadResponses()">Import Responses</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

async function confirmSendInvitations(recipients) {
    const subject = document.getElementById('email-subject').value;
    const message = document.getElementById('email-message').value;
    const isReminder = document.getElementById('send-reminder').checked;

    if (!subject.trim() || !message.trim()) {
        showToast('Please fill in both subject and message', 'warning');
        return;
    }

    // Close modal
    document.querySelector('.modal').remove();

    // Actually send emails
    showToast('Sending invitations...', 'info');

    let successCount = 0;
    let failureCount = 0;
    const errors = [];

    try {
        // Send emails to each recipient
        for (const recipient of recipients) {
            try {
                // Generate survey link for this recipient - use explicit localhost URL
                const surveyLink = `https://employee-survey-platform.surge.sh/chat.html?session=${encodeURIComponent(recipient.email)}&type=listening&name=${encodeURIComponent('Employee Feedback Session')}`;

                // Personalize the message
                const personalizedMessage = message
                    .replace(/\{name\}/g, recipient.name)
                    .replace(/\{survey_link\}/g, surveyLink);

                // Create HTML email content
                const htmlBody = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>
                            body {
                                font-family: 'Segoe UI', Arial, sans-serif;
                                line-height: 1.6;
                                color: #333;
                                margin: 0;
                                padding: 0;
                            }
                            .email-container {
                                max-width: 600px;
                                margin: 0 auto;
                                background: #ffffff;
                            }
                            .header {
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                padding: 30px;
                                text-align: center;
                            }
                            .header h1 {
                                color: white;
                                margin: 0;
                                font-size: 24px;
                            }
                            .content {
                                padding: 40px 30px;
                            }
                            .button {
                                display: inline-block;
                                padding: 14px 30px;
                                background: #2563eb;
                                color: white;
                                text-decoration: none;
                                border-radius: 6px;
                                margin: 20px 0;
                                font-weight: bold;
                            }
                            .message-content {
                                background: #f8f9fa;
                                padding: 20px;
                                border-radius: 8px;
                                margin: 20px 0;
                                white-space: pre-line;
                            }
                            .footer {
                                background: #f8f9fa;
                                padding: 20px;
                                text-align: center;
                                color: #666;
                                font-size: 14px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="email-container">
                            <div class="header">
                                <h1>${subject}</h1>
                            </div>
                            <div class="content">
                                <div class="message-content">
                                    ${personalizedMessage.replace(/\n/g, '<br>')}
                                </div>
                                <div style="text-align: center;">
                                    <a href="${surveyLink}" class="button">Start Survey</a>
                                </div>
                            </div>
                            <div class="footer">
                                <p>This is an automated message from the Employee Survey Platform.</p>
                                <p>If you have questions, please contact your administrator.</p>
                            </div>
                        </div>
                    </body>
                    </html>
                `;

                // Send email via API
                const response = await fetch('/api/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        to: recipient.email,
                        subject: subject,
                        htmlBody: htmlBody
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    successCount++;
                    console.log(`Email sent successfully to ${recipient.email}`);

                    // Update table UI for successful sends
                    const checkbox = document.querySelector(`input[data-recipient-id="${recipient.id}"]`);
                    if (checkbox) {
                        const row = checkbox.closest('tr');
                        // Update invite sent status
                        const inviteCell = row.cells[5];
                        inviteCell.innerHTML = '<span class="status-badge status-sent">Yes</span>';

                        // Update reminders sent
                        const remindersCell = row.cells[6];
                        const currentReminders = parseInt(remindersCell.textContent) || 0;
                        remindersCell.textContent = currentReminders + 1;

                        // Update last reminder date
                        const lastReminderCell = row.cells[7];
                        lastReminderCell.textContent = new Date().toISOString().split('T')[0];
                    }
                } else {
                    failureCount++;
                    errors.push(`${recipient.email}: ${result.error || 'Unknown error'}`);
                    console.error(`Failed to send email to ${recipient.email}:`, result);
                }

            } catch (error) {
                failureCount++;
                errors.push(`${recipient.email}: ${error.message}`);
                console.error(`Error sending email to ${recipient.email}:`, error);
            }

            // Small delay between emails to avoid rate limiting
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        // Show results
        if (successCount > 0 && failureCount === 0) {
            showToast(`Successfully sent ${successCount} invitation${successCount > 1 ? 's' : ''}!`, 'success');
        } else if (successCount > 0 && failureCount > 0) {
            showToast(`Sent ${successCount} emails successfully, ${failureCount} failed. Check console for details.`, 'warning');
            console.warn('Email sending errors:', errors);
        } else {
            showToast(`Failed to send emails. Please check your email configuration.`, 'error');
            console.error('All emails failed:', errors);
        }

    } catch (error) {
        console.error('Email sending process failed:', error);
        showToast('Failed to send emails. Please try again.', 'error');
    }

    // Clear selections
    document.querySelectorAll('#recipients-table-body input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
    document.getElementById('select-all').checked = false;
}

async function confirmAddRecipient() {
    const forename = document.getElementById('recipient-forename').value.trim();
    const surname = document.getElementById('recipient-surname').value.trim();
    const email = document.getElementById('recipient-email').value.trim();
    const employeeNo = document.getElementById('recipient-employee-no').value.trim();
    const sendInvitation = document.getElementById('send-immediate-invitation').checked;
    
    // Validation
    if (!forename || !surname || !email) {
        showToast('Please fill in all required fields', 'warning');
        return;
    }
    
    // Email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showToast('Please enter a valid email address', 'warning');
        return;
    }
    
    try {
        console.log(' Checking for duplicate email:', email);
        
        // Get the current chat ID from the page
        const currentChatId = getCurrentChatId() || 'test';
        console.log(' Using survey ID:', currentChatId);
        
        // Check for duplicate email in database
        const { data: existingRecipient, error: checkError } = await window.supabaseClient
            .from('survey_recipients')
            .select('email')
            .eq('email', email)
            .eq('survey_id', currentChatId)
            .single();
            
        console.log(' Duplicate check result:', { existingRecipient, checkError });
        
        if (existingRecipient) {
            showToast('A recipient with this email already exists', 'warning');
            return;
        }
        
        // Create new recipient object for database
        const newRecipient = {
            survey_id: currentChatId,
            forename: forename,
            surname: surname,
            email: email,
            employee_no: employeeNo || `EMP${Date.now().toString().slice(-3)}`,
            invite_sent: sendInvitation,
            reminder_count: sendInvitation ? 1 : 0,
            last_reminder_sent: sendInvitation ? new Date().toISOString().split('T')[0] : null,
            survey_started_date: null,
            survey_completed_date: null,
            created_at: new Date().toISOString()
        };
        
        console.log(' Saving recipient to database:', newRecipient);
        
        // Save to database
        const { data: savedRecipient, error } = await window.supabaseClient
            .from('survey_recipients')
            .insert([newRecipient])
            .select()
            .single();
            
        console.log(' Save result:', { savedRecipient, error });
        
        if (error) {
            console.error(' Error saving recipient:', error);
            showToast('Error saving recipient to database', 'error');
            return;
        }
        
        console.log(' Recipient saved successfully:', savedRecipient);
        
        // Close modal
        document.querySelector('.modal').remove();
        
        // Reload the data to show the new recipient
        loadRecipientsData(currentChatId);
        
        // Show success message
        showToast(`Recipient ${forename} ${surname} added successfully!`, 'success');
        
        // Send invitation if requested
        if (sendInvitation) {
            // You can implement invitation sending logic here
            showToast(`Invitation sent to ${email}`, 'info');
        }
        
    } catch (error) {
        console.error('Error adding recipient:', error);
        showToast('Error adding recipient', 'error');
    }
}

function handleRecipientFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    showToast('Processing file...', 'info');
    
    // Simulate file processing
    setTimeout(() => {
        // Mock data for preview
        const mockData = [
            { forename: 'Alice', surname: 'Wilson', email: 'alice.wilson@company.com', employeeNo: 'EMP005' },
            { forename: 'Bob', surname: 'Taylor', email: 'bob.taylor@company.com', employeeNo: 'EMP006' },
            { forename: 'Carol', surname: 'Anderson', email: 'carol.anderson@company.com', employeeNo: 'EMP007' }
        ];
        
        // Show preview
        const previewDiv = document.getElementById('upload-preview');
        const previewContent = document.getElementById('preview-content');
        
        previewContent.innerHTML = `
            <div style="margin-bottom: 1rem;">
                <strong>${mockData.length} recipients found in file: ${file.name}</strong>
            </div>
            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6;">
                <table style="width: 100%; font-size: 0.875rem;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;">Name</th>
                            <th style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;">Email</th>
                            <th style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;">Employee No</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${mockData.map(r => `
                            <tr>
                                <td style="padding: 0.5rem;">${r.forename} ${r.surname}</td>
                                <td style="padding: 0.5rem;">${r.email}</td>
                                <td style="padding: 0.5rem;">${r.employeeNo}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        previewDiv.style.display = 'block';
        document.getElementById('confirm-upload-btn').style.display = 'inline-block';
        
        showToast('File processed successfully!', 'success');
    }, 1500);
}

function downloadTemplate() {
    const csvContent = "Forename,Surname,Email,Employee_No\nJohn,Smith,john.smith@company.com,EMP001\nJane,Doe,jane.doe@company.com,EMP002";
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'recipients_template.csv';
    a.click();
    window.URL.revokeObjectURL(url);
    showToast('Template downloaded!', 'success');
}

function confirmUploadRecipients() {
    // Mock implementation - would normally process the actual file data
    showToast('Importing recipients...', 'info');
    
    setTimeout(() => {
        // Simulate adding the mock data to the table
        const mockData = [
            { forename: 'Alice', surname: 'Wilson', email: 'alice.wilson@company.com', employeeNo: 'EMP005' },
            { forename: 'Bob', surname: 'Taylor', email: 'bob.taylor@company.com', employeeNo: 'EMP006' },
            { forename: 'Carol', surname: 'Anderson', email: 'carol.anderson@company.com', employeeNo: 'EMP007' }
        ];
        
        const tableBody = document.getElementById('recipients-table-body');
        
        // Remove "No data" row if it exists
        const noDataRow = tableBody.querySelector('.no-data-row');
        if (noDataRow) {
            noDataRow.remove();
        }
        
        mockData.forEach(recipient => {
            const newId = Date.now() + Math.random();
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="checkbox-column">
                    <input type="checkbox" data-recipient-id="${newId}">
                </td>
                <td>${recipient.forename}</td>
                <td>${recipient.surname}</td>
                <td>${recipient.email}</td>
                <td>${recipient.employeeNo}</td>
                <td>
                    <span class="status-badge status-not-sent">No</span>
                </td>
                <td>0</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>
                    <button class="btn btn-small btn-info" onclick="editRecipient('${newId}')" title="Edit Recipient">
                        
                    </button>
                </td>
                <td>
                    <button class="btn btn-small btn-danger" onclick="deleteRecipient('${newId}')" title="Delete Recipient">
                        
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });
        
        // Close modal
        document.querySelector('.modal').remove();
        showToast(`Successfully imported ${mockData.length} recipients!`, 'success');
    }, 2000);
}

function editRecipient(id) {
    showToast(`Edit recipient ${id} - Feature coming soon!`, 'info');
}


function preloadFromCSV() {
    document.querySelector('.modal').remove();
    uploadRecipient(); // Reuse the upload functionality
}

function preloadFromHR() {
    showToast('HR System integration coming soon!', 'info');
    document.querySelector('.modal').remove();
}

function preloadFromAD() {
    showToast('Active Directory integration coming soon!', 'info');
    document.querySelector('.modal').remove();
}

function loadSampleData() {
    document.querySelector('.modal').remove();
    showToast('Loading enhanced sample data...', 'info');
    
    setTimeout(() => {
        const sampleData = [
            { forename: 'David', surname: 'Williams', email: 'david.williams@company.com', employeeNo: 'EMP008' },
            { forename: 'Lisa', surname: 'Garcia', email: 'lisa.garcia@company.com', employeeNo: 'EMP009' },
            { forename: 'Robert', surname: 'Martinez', email: 'robert.martinez@company.com', employeeNo: 'EMP010' },
            { forename: 'Jennifer', surname: 'Lopez', email: 'jennifer.lopez@company.com', employeeNo: 'EMP011' },
            { forename: 'James', surname: 'Wilson', email: 'james.wilson@company.com', employeeNo: 'EMP012' }
        ];
        
        const tableBody = document.getElementById('recipients-table-body');
        
        // Remove "No data" row if it exists
        const noDataRow = tableBody.querySelector('.no-data-row');
        if (noDataRow) {
            noDataRow.remove();
        }
        
        sampleData.forEach(recipient => {
            const newId = Date.now() + Math.random();
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="checkbox-column">
                    <input type="checkbox" data-recipient-id="${newId}">
                </td>
                <td>${recipient.forename}</td>
                <td>${recipient.surname}</td>
                <td>${recipient.email}</td>
                <td>${recipient.employeeNo}</td>
                <td>
                    <span class="status-badge status-not-sent">No</span>
                </td>
                <td>0</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>
                    <button class="btn btn-small btn-info" onclick="editRecipient('${newId}')" title="Edit Recipient">
                        
                    </button>
                </td>
                <td>
                    <button class="btn btn-small btn-danger" onclick="deleteRecipient('${newId}')" title="Delete Recipient">
                        
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });
        
        showToast(`Successfully loaded ${sampleData.length} sample recipients!`, 'success');
    }, 1500);
}

function handleResponsesFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    showToast('Processing responses file...', 'info');
    
    setTimeout(() => {
        // Mock response data for preview
        const mockResponses = [
            { email: 'john.smith@company.com', responseDate: '2025-09-01', status: 'Completed', score: 85 },
            { email: 'sarah.johnson@company.com', responseDate: '2025-09-01', status: 'In Progress', score: 0 }
        ];
        
        const previewDiv = document.getElementById('responses-preview');
        const previewContent = document.getElementById('responses-preview-content');
        
        previewContent.innerHTML = `
            <div style="margin-bottom: 1rem;">
                <strong>${mockResponses.length} responses found in file: ${file.name}</strong>
            </div>
            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6;">
                <table style="width: 100%; font-size: 0.875rem;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;">Email</th>
                            <th style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;">Date</th>
                            <th style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;">Status</th>
                            <th style="padding: 0.5rem; border-bottom: 1px solid #dee2e6;">Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${mockResponses.map(r => `
                            <tr>
                                <td style="padding: 0.5rem;">${r.email}</td>
                                <td style="padding: 0.5rem;">${r.responseDate}</td>
                                <td style="padding: 0.5rem;">${r.status}</td>
                                <td style="padding: 0.5rem;">${r.score}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        previewDiv.style.display = 'block';
        document.getElementById('confirm-responses-btn').style.display = 'inline-block';
        
        showToast('Response file processed successfully!', 'success');
    }, 1500);
}

function downloadResponsesTemplate() {
    const csvContent = "Email,Response_Date,Status,Score\njohn.smith@company.com,2025-09-01,Completed,85\nsarah.johnson@company.com,2025-09-01,In Progress,0";
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'survey_responses_template.csv';
    a.click();
    window.URL.revokeObjectURL(url);
    showToast('Response template downloaded!', 'success');
}

function confirmUploadResponses() {
    showToast('Importing survey responses...', 'info');
    
    setTimeout(() => {
        // Update existing recipients with response data
        const existingRows = document.querySelectorAll('#recipients-table-body tr');
        let updatedCount = 0;
        
        existingRows.forEach(row => {
            const email = row.cells[3]?.textContent;
            if (email === 'john.smith@company.com') {
                // Update John's data
                row.cells[8].textContent = '2025-09-01'; // Date Started
                row.cells[9].innerHTML = '<span class="status-badge status-completed">2025-09-01</span>'; // Date Completed
                updatedCount++;
            } else if (email === 'sarah.johnson@company.com') {
                // Update Sarah's data
                row.cells[8].textContent = '2025-09-01'; // Date Started
                row.cells[9].textContent = '-'; // Still in progress
                updatedCount++;
            }
        });
        
        document.querySelector('.modal').remove();
        showToast(`Successfully imported responses for ${updatedCount} recipients!`, 'success');
    }, 2000);
}

function showDashboard() {
    // Return to dashboard view by reloading content
    location.reload();
}

// ====== BRANDING COLOR CUSTOMIZATION FUNCTIONS ======

// Switch between Basic and Advanced color tabs
function switchColorTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.color-tab-content').forEach(tab => {
        tab.style.display = 'none';
    });

    // Remove active class from all buttons
    document.querySelectorAll('.color-tab-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.style.borderBottom = '3px solid transparent';
        btn.style.color = 'var(--text-secondary)';
    });

    // Show selected tab
    document.getElementById(tabName + '-color-tab').style.display = 'block';

    // Add active class to clicked button
    const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
    activeBtn.classList.add('active');
    activeBtn.style.borderBottom = '3px solid var(--primary-color)';
    activeBtn.style.color = 'var(--primary-color)';
}

// Update color preview when color picker changes
function updateColorPreview(colorType, colorValue) {
    // Update the corresponding text input
    const textInput = document.getElementById(`brand-${colorType}-text`) ||
                     document.getElementById(`brand-${colorType}-color-text`);
    if (textInput) {
        textInput.value = colorValue;
    }

    // Apply color to preview (if in advanced tab)
    applyColorToPreview(colorType, colorValue);
}

// Update color when text input changes
function updateColorFromText(colorType, colorValue) {
    // Validate hex color
    if (!/^#[0-9A-F]{6}$/i.test(colorValue)) {
        return; // Invalid color format
    }

    // Update the corresponding color picker
    const colorPicker = document.getElementById(`brand-${colorType}`) ||
                       document.getElementById(`brand-${colorType}-color`);
    if (colorPicker) {
        colorPicker.value = colorValue;
    }

    // Apply color to preview
    applyColorToPreview(colorType, colorValue);
}

// Apply color to specific UI elements
function applyColorToPreview(colorType, colorValue) {
    const root = document.documentElement;

    const colorMap = {
        'primary': '--primary-color',
        'secondary': '--secondary-color',
        'bg-main': '--bg-main',
        'bg-secondary': '--bg-secondary',
        'sidebar-bg': '--sidebar-bg',
        'sidebar-text': '--sidebar-text-color',
        'text-primary': '--text-primary',
        'text-secondary': '--text-secondary',
        'card-bg': '--card-bg',
        'border': '--border-color',
        'button-hover': '--button-hover',
        'success': '--success-color',
        'warning': '--warning-color',
        'error': '--error-color'
    };

    if (colorMap[colorType]) {
        root.style.setProperty(colorMap[colorType], colorValue);
    }
}

// Apply all colors live to see changes
function applyColorsLive() {
    const colors = {
        primary: document.getElementById('brand-primary-color').value,
        secondary: document.getElementById('brand-secondary-color').value,
        'bg-main': document.getElementById('brand-bg-main').value,
        'bg-secondary': document.getElementById('brand-bg-secondary').value,
        'sidebar-bg': document.getElementById('brand-sidebar-bg').value,
        'sidebar-text': document.getElementById('brand-sidebar-text').value,
        'text-primary': document.getElementById('brand-text-primary').value,
        'text-secondary': document.getElementById('brand-text-secondary').value,
        'card-bg': document.getElementById('brand-card-bg').value,
        border: document.getElementById('brand-border').value,
        'button-hover': document.getElementById('brand-button-hover').value,
        success: document.getElementById('brand-success').value,
        warning: document.getElementById('brand-warning').value,
        error: document.getElementById('brand-error').value
    };

    Object.entries(colors).forEach(([type, value]) => {
        applyColorToPreview(type, value);
    });

    showToast(' Colors applied! Refresh to see full changes across all pages.', 'success');
}

// Reset all colors to defaults
function resetAllColors() {
    const defaults = {
        'brand-primary-color': '#2563eb',
        'brand-secondary-color': '#64748b',
        'brand-bg-main': '#f8fafc',
        'brand-bg-secondary': '#ffffff',
        'brand-sidebar-bg': '#1e293b',
        'brand-sidebar-text': '#e2e8f0',
        'brand-text-primary': '#1e293b',
        'brand-text-secondary': '#64748b',
        'brand-card-bg': '#ffffff',
        'brand-border': '#e2e8f0',
        'brand-button-hover': '#1d4ed8',
        'brand-success': '#22c55e',
        'brand-warning': '#f59e0b',
        'brand-error': '#ef4444'
    };

    Object.entries(defaults).forEach(([id, value]) => {
        const colorPicker = document.getElementById(id);
        const textInput = document.getElementById(id + '-text');

        if (colorPicker) colorPicker.value = value;
        if (textInput) textInput.value = value;
    });

    // Apply default colors
    applyColorsLive();

    showToast(' All colors reset to defaults', 'success');
}

// Save branding settings
function saveBranding() {
    const brandingData = {
        companyName: document.getElementById('brand-company-name').value,
        primaryColor: document.getElementById('brand-primary-color').value,
        secondaryColor: document.getElementById('brand-secondary-color').value,
        bgMain: document.getElementById('brand-bg-main')?.value,
        bgSecondary: document.getElementById('brand-bg-secondary')?.value,
        sidebarBg: document.getElementById('brand-sidebar-bg')?.value,
        sidebarText: document.getElementById('brand-sidebar-text')?.value,
        textPrimary: document.getElementById('brand-text-primary')?.value,
        textSecondary: document.getElementById('brand-text-secondary')?.value,
        cardBg: document.getElementById('brand-card-bg')?.value,
        border: document.getElementById('brand-border')?.value,
        buttonHover: document.getElementById('brand-button-hover')?.value,
        success: document.getElementById('brand-success')?.value,
        warning: document.getElementById('brand-warning')?.value,
        error: document.getElementById('brand-error')?.value,
        font: document.getElementById('brand-font').value,
        welcomeMessage: document.getElementById('brand-welcome-message').value
    };

    // Save to localStorage
    localStorage.setItem('brandingSettings', JSON.stringify(brandingData));

    // Apply colors
    Object.entries(brandingData).forEach(([key, value]) => {
        if (key !== 'companyName' && key !== 'font' && key !== 'welcomeMessage' && value) {
            const colorType = key.replace(/([A-Z])/g, '-$1').toLowerCase();
            applyColorToPreview(colorType.replace('brand-', ''), value);
        }
    });

    showToast(' Branding saved successfully!', 'success');
}

// Reset branding to defaults
function resetBranding() {
    if (confirm('Are you sure you want to reset all branding settings to defaults?')) {
        localStorage.removeItem('brandingSettings');
        document.getElementById('brand-company-name').value = 'Realworld';
        resetAllColors();
        document.getElementById('brand-font').value = 'system';
        document.getElementById('brand-welcome-message').value = 'Welcome! Your feedback helps us improve and create a better workplace for everyone.';

        showToast(' Branding reset to defaults', 'success');
    }
}

// Handle logo upload
function handleLogoUpload(event) {
    const file = event.target.files[0];
    if (file) {
        if (file.size > 2 * 1024 * 1024) {
            showToast('File size must be less than 2MB', 'error');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            localStorage.setItem('brandLogo', e.target.result);
            showToast(' Logo uploaded successfully!', 'success');
        };
        reader.readAsDataURL(file);
    }
}

// Load saved branding on page load
function loadSavedBranding() {
    const savedBranding = localStorage.getItem('brandingSettings');
    if (savedBranding) {
        const brandingData = JSON.parse(savedBranding);

        // Apply saved values to inputs
        if (brandingData.companyName)
            document.getElementById('brand-company-name').value = brandingData.companyName;

        // Apply colors
        const colorFields = [
            'primaryColor', 'secondaryColor', 'bgMain', 'bgSecondary',
            'sidebarBg', 'sidebarText', 'textPrimary', 'textSecondary',
            'cardBg', 'border', 'buttonHover', 'success', 'warning', 'error'
        ];

        colorFields.forEach(field => {
            if (brandingData[field]) {
                const fieldName = field.replace(/([A-Z])/g, '-$1').toLowerCase();
                const colorPicker = document.getElementById('brand-' + fieldName);
                const textInput = document.getElementById('brand-' + fieldName + '-text');

                if (colorPicker) colorPicker.value = brandingData[field];
                if (textInput) textInput.value = brandingData[field];

                // Apply to CSS
                const colorType = fieldName.replace('brand-', '');
                applyColorToPreview(colorType, brandingData[field]);
            }
        });
    }
}

// Initialize branding on page load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadSavedBranding);
} else {
    loadSavedBranding();
}

// ====== PAINT MODE FUNCTIONALITY ======

let paintModeActive = false;
let paintHistory = [];
let paintModeListener = null;

function togglePaintMode() {
    const toggleBtn = document.getElementById('toggle-paint-mode');

    // Toggle state
    paintModeActive = !paintModeActive;

    if (paintModeActive) {
        // Enable paint mode
        toggleBtn.textContent = ' Disable Paint Mode';
        toggleBtn.style.background = '#ef4444';
        toggleBtn.style.color = 'white';
        document.body.style.cursor = 'crosshair';

        // Add overlay message
        showPaintModeOverlay();

        // Add click listener with delay to prevent immediate trigger
        setTimeout(() => {
            paintModeListener = function(e) {
                handlePaintClick(e);
            };
            document.addEventListener('click', paintModeListener, true);
        }, 100);

        showToast(' Paint Mode ACTIVE! Click on any element to change its color', 'info');
    } else {
        // Disable paint mode
        toggleBtn.textContent = ' Enable Paint Mode';
        toggleBtn.style.background = 'white';
        toggleBtn.style.color = '#667eea';
        document.body.style.cursor = 'default';

        // Remove overlay
        removePaintModeOverlay();

        // Remove click listener
        if (paintModeListener) {
            document.removeEventListener('click', paintModeListener, true);
            paintModeListener = null;
        }

        showToast('Paint Mode disabled', 'info');
    }
}

function showPaintModeOverlay() {
    const overlay = document.createElement('div');
    overlay.id = 'paint-mode-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 30px;
        border-radius: 12px;
        z-index: 999999;
        font-weight: 600;
        font-size: 16px;
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        animation: slideDown 0.3s ease;
        pointer-events: none;
    `;
    overlay.innerHTML = ' Paint Mode Active - Click on any element to customize';
    document.body.appendChild(overlay);
}

function removePaintModeOverlay() {
    const overlay = document.getElementById('paint-mode-overlay');
    if (overlay) overlay.remove();
}

function handlePaintClick(e) {
    const target = e.target;
    const brushColor = document.getElementById('paint-brush-color').value;

    // Allow clicking on paint mode controls and buttons
    if (target.closest('#paint-mode-controls') ||
        target.id === 'toggle-paint-mode' ||
        target.closest('#toggle-paint-mode') ||
        target.id === 'paint-brush-color' ||
        target.closest('button[onclick*="clearPaintMode"]') ||
        target.closest('button[onclick*="undoLastPaint"]') ||
        target.closest('#paint-color-tab')) {
        // Let the normal click through for controls - don't stop propagation
        return;
    }

    // Prevent default action for other elements
    e.preventDefault();
    e.stopPropagation();

    // Get element info
    const elementTag = target.tagName.toLowerCase();
    const elementClass = target.className;
    const elementId = target.id;
    const elementText = target.textContent.substring(0, 30) + (target.textContent.length > 30 ? '...' : '');

    // Store original color
    const originalBgColor = window.getComputedStyle(target).backgroundColor;
    const originalTextColor = window.getComputedStyle(target).color;

    // Determine what property to change
    let propertyToChange = 'backgroundColor';
    let originalValue = originalBgColor;

    // If element has mostly transparent background or is text, change text color instead
    if (originalBgColor === 'rgba(0, 0, 0, 0)' || originalBgColor === 'transparent' ||
        elementTag === 'span' || elementTag === 'p' || elementTag === 'h1' ||
        elementTag === 'h2' || elementTag === 'h3' || elementTag === 'h4' ||
        elementTag === 'h5' || elementTag === 'h6' || elementTag === 'a') {
        propertyToChange = 'color';
        originalValue = originalTextColor;
    }

    // Apply the color
    target.style[propertyToChange] = brushColor;

    // Add to history
    const historyEntry = {
        element: target,
        property: propertyToChange,
        originalValue: originalValue,
        newValue: brushColor,
        tag: elementTag,
        class: elementClass,
        id: elementId,
        text: elementText,
        timestamp: new Date().toLocaleTimeString()
    };

    paintHistory.push(historyEntry);

    // Update history UI
    updatePaintHistory();

    // Auto-save changes
    savePaintModeChanges();

    // Show feedback
    showPaintFeedback(target, brushColor);

    showToast(` ${elementTag.toUpperCase()} painted ${brushColor}`, 'success');
}

function showPaintFeedback(element, color) {
    const rect = element.getBoundingClientRect();
    const feedback = document.createElement('div');
    feedback.style.cssText = `
        position: fixed;
        top: ${rect.top + rect.height / 2}px;
        left: ${rect.left + rect.width / 2}px;
        transform: translate(-50%, -50%);
        background: ${color};
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 12px;
        z-index: 1000000;
        pointer-events: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: paintPop 0.6s ease;
    `;
    feedback.textContent = ' Painted!';
    document.body.appendChild(feedback);

    setTimeout(() => feedback.remove(), 600);
}

function updatePaintHistory() {
    const historyContainer = document.getElementById('paint-history');
    if (!historyContainer) return;

    if (paintHistory.length === 0) {
        historyContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #9e9e9e;">
                <div style="font-size: 48px; margin-bottom: 10px;"></div>
                <p style="margin: 0;">No elements painted yet. Enable paint mode and click on elements to start customizing!</p>
            </div>
        `;
        return;
    }

    historyContainer.innerHTML = paintHistory.map((entry, index) => `
        <div style="display: flex; align-items: center; gap: 15px; padding: 12px; border-bottom: 1px solid #e0e0e0; transition: background 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
            <div style="width: 40px; height: 40px; background: ${entry.newValue}; border-radius: 8px; border: 2px solid #ddd; flex-shrink: 0;"></div>
            <div style="flex: 1;">
                <div style="font-weight: 600; color: #2c3e50; margin-bottom: 3px;">
                    &lt;${entry.tag}&gt; ${entry.id ? '#' + entry.id : entry.class ? '.' + entry.class.split(' ')[0] : ''}
                </div>
                <div style="font-size: 12px; color: #757575;">
                    ${entry.property === 'backgroundColor' ? 'Background' : 'Text'}: ${entry.originalValue}  ${entry.newValue}
                </div>
                <div style="font-size: 11px; color: #9e9e9e; margin-top: 2px;">${entry.timestamp}</div>
            </div>
            <button onclick="removePaintEntry(${index})" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                Remove
            </button>
        </div>
    `).reverse().join('');
}

function removePaintEntry(index) {
    const entry = paintHistory[index];
    if (entry && entry.element) {
        entry.element.style[entry.property] = entry.originalValue;
    }
    paintHistory.splice(index, 1);
    updatePaintHistory();
    showToast('Paint entry removed', 'info');
}

function undoLastPaint() {
    if (paintHistory.length === 0) {
        showToast('No paint history to undo', 'warning');
        return;
    }

    const lastEntry = paintHistory.pop();
    if (lastEntry && lastEntry.element) {
        lastEntry.element.style[lastEntry.property] = lastEntry.originalValue;
    }

    updatePaintHistory();
    showToast(' Last paint undone', 'success');
}

function clearPaintMode() {
    if (paintHistory.length === 0) {
        showToast('Nothing to clear', 'warning');
        return;
    }

    if (confirm(`Clear all ${paintHistory.length} painted elements?`)) {
        paintHistory.forEach(entry => {
            if (entry && entry.element) {
                entry.element.style[entry.property] = entry.originalValue;
            }
        });

        paintHistory = [];
        updatePaintHistory();
        showToast(' All paint cleared', 'success');
    }
}

// Save paint mode changes
function savePaintModeChanges() {
    const paintData = paintHistory.map(entry => ({
        selector: entry.id ? `#${entry.id}` : entry.class ? `.${entry.class.split(' ')[0]}` : entry.tag,
        property: entry.property,
        value: entry.newValue
    }));

    localStorage.setItem('paintModeCustomization', JSON.stringify(paintData));
    showToast(' Paint customization saved!', 'success');
}

// Load paint mode changes
function loadPaintModeChanges() {
    const savedPaint = localStorage.getItem('paintModeCustomization');
    if (savedPaint) {
        const paintData = JSON.parse(savedPaint);
        paintData.forEach(item => {
            const elements = document.querySelectorAll(item.selector);
            elements.forEach(el => {
                el.style[item.property] = item.value;
            });
        });
    }
}

// Add CSS animation
const style = document.createElement('style');
style.textContent = `
    @keyframes slideDown {
        from {
            transform: translateX(-50%) translateY(-20px);
            opacity: 0;
        }
        to {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    }

    @keyframes paintPop {
        0% {
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
        }
        50% {
            transform: translate(-50%, -50%) scale(1.2);
            opacity: 1;
        }
        100% {
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

// Load paint customizations on startup
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadPaintModeChanges);
} else {
    loadPaintModeChanges();
}

// Keyboard shortcut for paint mode (Ctrl+Shift+P or Cmd+Shift+P)
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'P') {
        e.preventDefault();
        togglePaintMode();
    }
});

// ============================================== //
// SURVEY BUILDER JAVASCRIPT - START              //
// ============================================== //

// Survey Builder Data
const sbThemeColors = {
    purple: { primary: '#673ab7', light: '#ede7f6' },
    blue: { primary: '#1a73e8', light: '#e8f0fe' },
    teal: { primary: '#009688', light: '#e0f2f1' },
    green: { primary: '#34a853', light: '#e6f4ea' },
    red: { primary: '#ea4335', light: '#fce8e6' },
    orange: { primary: '#fa7b17', light: '#fef7e0' },
    pink: { primary: '#e91e63', light: '#fce4ec' },
    grey: { primary: '#5f6368', light: '#f1f3f4' }
};

const sbQuestionTypeLabels = {
    rating: 'Linear Scale',
    single: 'Multiple Choice',
    multi: 'Checkboxes',
    text: 'Paragraph'
};

let sbSurveys = JSON.parse(localStorage.getItem('sbSurveys') || '[]');
let sbCurrentSurvey = null;
let sbCurrentPageIndex = 0;
let sbDraggedQuestionIndex = null;

// Survey Builder Utility Functions
function sbGenerateId() {
    return Math.random().toString(36).substr(2, 9);
}

function sbCreateDefaultSurvey() {
    return {
        id: sbGenerateId(),
        name: 'Untitled Survey',
        description: '',
        themeColor: 'purple',
        ratingScale: {
            points: 5,
            labels: ['Strongly Disagree', 'Disagree', 'Neutral', 'Agree', 'Strongly Agree'],
            values: [1, 2, 3, 4, 5]
        },
        startDate: new Date().toISOString().split('T')[0],
        endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
        landingPageContent: 'Thank you for taking the time to complete this survey. Your feedback is valuable to us.',
        thankYouContent: 'Your response has been recorded. Thank you for your feedback!',
        pages: [{ id: sbGenerateId(), title: 'Page 1', instructions: '', questions: [], logic: [] }],
        createdAt: new Date().toISOString()
    };
}

function sbCreateDefaultQuestion(type) {
    return {
        id: sbGenerateId(),
        type,
        text: '',
        required: false,
        options: type === 'single' || type === 'multi' ? ['Option 1'] : undefined,
        logic: []
    };
}

function sbApplyTheme(colorName) {
    const theme = sbThemeColors[colorName] || sbThemeColors.purple;
    const container = document.querySelector('.survey-builder-container');
    if (container) {
        container.style.setProperty('--sb-primary', theme.primary);
        container.style.setProperty('--sb-primary-light', theme.light);
        container.style.setProperty('--sb-background', theme.light);
    }
}

function sbSaveSurveys() {
    localStorage.setItem('sbSurveys', JSON.stringify(sbSurveys));
}

// Survey Builder Dashboard
function sbRenderDashboard() {
    const grid = document.getElementById('sb-surveys-grid');
    if (!grid) return;

    grid.innerHTML = `
        <div class="sb-new-survey-card" onclick="sbCreateNewSurvey()">
            <svg class="sb-icon-xl" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            <span>Blank</span>
        </div>
    `;

    sbSurveys.forEach(survey => {
        const theme = sbThemeColors[survey.themeColor] || sbThemeColors.purple;
        const card = document.createElement('div');
        card.className = 'sb-card sb-survey-card';
        card.innerHTML = `
            <div class="sb-survey-card-header" style="background: ${theme.primary}"></div>
            <div class="sb-survey-card-body">
                <h3 class="sb-survey-card-title">${survey.name || 'Untitled Survey'}</h3>
                <div class="sb-survey-card-meta">
                    <svg class="sb-icon-sm" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                    <span>Opened ${new Date(survey.createdAt).toLocaleDateString()}</span>
                </div>
                <div class="sb-survey-card-actions">
                    <button class="sb-survey-card-action" onclick="event.stopPropagation(); sbCopyToClipboard('${survey.id}', this)">
                        <svg class="sb-icon-sm" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                        Copy link
                    </button>
                    <button class="sb-survey-card-action" onclick="event.stopPropagation(); sbDeleteSurvey('${survey.id}')">
                        <svg class="sb-icon-sm" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        Delete
                    </button>
                </div>
            </div>
        `;
        card.onclick = () => sbEditSurvey(survey.id);
        grid.appendChild(card);
    });

    document.getElementById('sb-dashboard-view').classList.remove('sb-hidden');
    document.getElementById('sb-builder-view').classList.add('sb-hidden');
    document.getElementById('sb-preview-view').classList.add('sb-hidden');
    sbApplyTheme('purple');
}

// ============================================
// CHATS FUNCTIONS
// ============================================

// Open chat editor (called when clicking Blank or existing chat)
function openChatEditor(chatId = null) {
    // Hide success panel initially
    const successPanel = document.getElementById('chat-success-panel');
    if (successPanel) {
        successPanel.style.display = 'none';
    }

    // Clear the editing ID and chat object
    window.currentEditingChatId = null;
    window.currentEditingChat = null;

    // Reset form for new chat or load existing
    if (!chatId) {
        // New chat - reset form
        document.getElementById('chat-editor-name').value = '';
        document.getElementById('chat-setup-name').value = '';
        document.getElementById('chat-setup-welcome').value = 'Hi! Thanks for taking the time to share your feedback with us. Please feel free to tell us about your experience or any suggestions you might have.';
        selectAccessType('open');
    } else {
        // Existing chat - load from database
        loadChatIntoEditor(chatId);
    }

    showSection('chat-editor');
    showChatEditorTab('setup');
}

// Load existing chat data into the editor
async function loadChatIntoEditor(chatId) {
    try {
        // Fetch chat from database
        const { data: chat, error } = await window.supabaseClient
            .from('listening_chats')
            .select('*')
            .eq('id', chatId)
            .single();

        if (error) throw error;

        if (!chat) {
            console.error('Chat not found');
            return;
        }

        // Store the current chat ID and full chat object for saving updates later
        window.currentEditingChatId = chatId;
        window.currentEditingChat = chat;

        // Populate form fields
        const chatEditorName = document.getElementById('chat-editor-name');
        const chatSetupName = document.getElementById('chat-setup-name');
        const chatSetupWelcome = document.getElementById('chat-setup-welcome');

        if (chatEditorName) chatEditorName.value = chat.name || '';
        if (chatSetupName) chatSetupName.value = chat.name || '';
        if (chatSetupWelcome) chatSetupWelcome.value = chat.welcome_message || '';

        // Set access type selection
        if (chat.access_type === 'invite_only') {
            selectAccessType('invite');
        } else {
            selectAccessType('open');
        }

        // Show the success panel on the right with existing link
        const successPanel = document.getElementById('chat-success-panel');
        const successChatName = document.getElementById('successChatName');
        const generatedChatLink = document.getElementById('generatedChatLink');

        if (successPanel) {
            successPanel.style.display = 'block';
        }
        if (successChatName) {
            successChatName.textContent = chat.name || 'Untitled Chat';
        }
        if (generatedChatLink) {
            generatedChatLink.value = 'https://rworldfeedback.co.uk/chat/' + chat.slug;
        }

        console.log('Loaded chat into editor:', chat.name);

    } catch (error) {
        console.error('Error loading chat:', error);
        alert('Failed to load chat: ' + error.message);
    }
}

// Show Chat Editor tab
function showChatEditorTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.chat-editor-tab-content').forEach(content => {
        content.style.display = 'none';
    });

    // Remove active state from all tabs
    document.querySelectorAll('.chat-editor-tab').forEach(tab => {
        tab.style.color = '#64748b';
        tab.style.borderBottomColor = 'transparent';
    });

    // Show selected tab content
    const tabContent = document.getElementById('chat-editor-tab-' + tabName);
    if (tabContent) {
        tabContent.style.display = 'block';
    }

    // Set active state on selected tab
    const activeTab = document.querySelector('.chat-editor-tab[data-tab="' + tabName + '"]');
    if (activeTab) {
        activeTab.style.color = '#3b82f6';
        activeTab.style.borderBottomColor = '#3b82f6';
    }

    // Load responses when Responses tab is clicked
    if (tabName === 'responses' && window.currentEditingChatId) {
        loadChatResponses(window.currentEditingChatId);
    }
}

// Select access type
function selectAccessType(type) {
    const openCard = document.getElementById('access-type-open');
    const inviteCard = document.getElementById('access-type-invite');

    if (type === 'open') {
        openCard.style.borderColor = '#3b82f6';
        openCard.style.background = '#eff6ff';
        inviteCard.style.borderColor = '#e2e8f0';
        inviteCard.style.background = 'white';
    } else {
        inviteCard.style.borderColor = '#3b82f6';
        inviteCard.style.background = '#eff6ff';
        openCard.style.borderColor = '#e2e8f0';
        openCard.style.background = 'white';
    }
}

// Generate unique ID for chat link
function generateUniqueId() {
    return Math.random().toString(36).substring(2, 10);
}

// Generate chat link and show success panel
function generateChatLink() {
    const chatName = document.getElementById('chat-setup-name').value || 'Untitled Chat';
    const successPanel = document.getElementById('chat-success-panel');
    const successChatName = document.getElementById('successChatName');
    const generatedChatLink = document.getElementById('generatedChatLink');

    // Generate unique ID and create link
    const uniqueId = generateUniqueId();
    const chatLink = 'https://rworldfeedback.co.uk/chat/' + uniqueId;

    // Update success panel content
    successChatName.textContent = chatName;
    generatedChatLink.value = chatLink;

    // Show success panel
    successPanel.style.display = 'block';
}

// Initialize chat success panel event listeners
function initChatSuccessPanel() {
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const closeSuccessPanel = document.getElementById('closeSuccessPanel');
    const closeSuccessPanelX = document.getElementById('closeSuccessPanelX');
    const testChatBtn = document.getElementById('testChatBtn');
    const successPanel = document.getElementById('chat-success-panel');
    const generatedChatLink = document.getElementById('generatedChatLink');

    // Copy Link button handler
    if (copyLinkBtn) {
        copyLinkBtn.addEventListener('click', function() {
            const link = generatedChatLink.value;
            navigator.clipboard.writeText(link).then(function() {
                // Show feedback
                const originalText = copyLinkBtn.textContent;
                copyLinkBtn.textContent = 'Copied!';
                copyLinkBtn.style.background = '#22c55e';
                setTimeout(function() {
                    copyLinkBtn.textContent = originalText;
                    copyLinkBtn.style.background = '#3b82f6';
                }, 2000);
            });
        });
    }

    // Close button handler
    if (closeSuccessPanel) {
        closeSuccessPanel.addEventListener('click', function() {
            successPanel.style.display = 'none';
        });
    }

    // Close X button handler
    if (closeSuccessPanelX) {
        closeSuccessPanelX.addEventListener('click', function() {
            successPanel.style.display = 'none';
        });
    }

    // Test Chat button handler
    if (testChatBtn) {
        testChatBtn.addEventListener('click', function() {
            const link = generatedChatLink.value;
            window.open(link, '_blank');
        });
    }
}

// Initialize chat success panel when DOM is ready
document.addEventListener('DOMContentLoaded', initChatSuccessPanel);

// Copy chat link to clipboard (for slug-based links)
function copyChatLink(slug) {
    const link = 'https://rworldfeedback.co.uk/chat/' + slug;
    navigator.clipboard.writeText(link).then(() => {
        // Show brief feedback
        const btn = document.querySelector(`.chat-card[data-chat-slug="${slug}"] .chat-card-action`);
        if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied!';
            setTimeout(() => { btn.innerHTML = originalText; }, 2000);
        }
    }).catch(() => {
        alert('Failed to copy link');
    });
}

// Legacy deleteChat function (placeholder for non-database chats)
function deleteChat(chatId) {
    if (confirm('Are you sure you want to delete this chat?')) {
        console.log('Deleting chat:', chatId);
        alert('Delete chat functionality coming soon!');
    }
}

// ============================================
// LISTENING CHATS DATABASE FUNCTIONS
// ============================================

// Generate unique slug for chat
function generateSlug() {
    return Math.random().toString(36).substring(2, 10) + Math.random().toString(36).substring(2, 4);
}

// Get current access type selection
function getSelectedAccessType() {
    const openCard = document.getElementById('access-type-open');
    if (openCard && openCard.style.borderColor === 'rgb(59, 130, 246)') {
        return 'open';
    }
    return 'invite_only';
}

// Save chat to database (handles both new and existing chats)
async function saveListeningChat() {
    const saveChatBtn = document.getElementById('saveChatBtn');

    // Get form values
    const chatNameInput = document.getElementById('chat-setup-name');
    const welcomeMessageInput = document.getElementById('chat-setup-welcome');

    const chatName = chatNameInput?.value?.trim() || 'Untitled Chat';
    const welcomeMessage = welcomeMessageInput?.value?.trim() || 'Hi! Thanks for taking the time to share your feedback with us. Please feel free to tell us about your experience or any suggestions you might have.';

    // Determine access type
    const accessType = getSelectedAccessType();

    // Disable button and show loading state
    saveChatBtn.disabled = true;
    saveChatBtn.textContent = 'Saving...';

    try {
        // Check if we're updating an existing chat or creating a new one
        const isUpdating = window.currentEditingChatId !== null && window.currentEditingChatId !== undefined;

        if (isUpdating) {
            // UPDATE existing chat
            const { data: chatData, error: chatError } = await window.supabaseClient
                .from('listening_chats')
                .update({
                    name: chatName,
                    welcome_message: welcomeMessage,
                    access_type: accessType
                })
                .eq('id', window.currentEditingChatId)
                .select()
                .single();

            if (chatError) {
                throw chatError;
            }

            console.log('Chat updated successfully:', chatData);

        } else {
            // INSERT new chat
            // Get current user's organization_id and user id
            const { data: { user } } = await window.supabaseClient.auth.getUser();

            if (!user) {
                throw new Error('Not authenticated');
            }

            // Get user's organization_id from users table
            const { data: userData, error: userError } = await window.supabaseClient
                .from('users')
                .select('id, organization_id')
                .eq('auth_id', user.id)
                .single();

            if (userError || !userData) {
                throw new Error('Could not get user data');
            }

            // Generate unique slug for new chat
            const slug = generateSlug();

            const { data: chatData, error: chatError } = await window.supabaseClient
                .from('listening_chats')
                .insert({
                    organization_id: userData.organization_id,
                    created_by: userData.id,
                    name: chatName,
                    welcome_message: welcomeMessage,
                    access_type: accessType,
                    slug: slug,
                    is_active: true
                })
                .select()
                .single();

            if (chatError) {
                throw chatError;
            }

            console.log('Chat created successfully:', chatData);
        }

        // Navigate back to the chats list page
        showSection('listen');

    } catch (error) {
        console.error('Error saving chat:', error);
        alert('Failed to save chat: ' + error.message);
    } finally {
        saveChatBtn.disabled = false;
        saveChatBtn.textContent = 'Save';
    }
}

// Load listening chats from database
async function loadListeningChats() {
    try {
        const { data: { user } } = await window.supabaseClient.auth.getUser();

        if (!user) {
            console.log('Not authenticated');
            return [];
        }

        const { data: chats, error } = await window.supabaseClient
            .from('listening_chats')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            throw error;
        }

        return chats || [];

    } catch (error) {
        console.error('Error loading chats:', error);
        return [];
    }
}

// Format date for display
function formatChatDate(dateString) {
    const date = new Date(dateString);
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return date.toLocaleDateString('en-US', options);
}

// Generate chat card HTML
function createChatCardHTML(chat) {
    return `
        <div class="chat-card" data-chat-id="${chat.id}" data-chat-slug="${chat.slug}" onclick="openChatEditor('${chat.id}')">
            <div class="chat-card-header"></div>
            <div class="chat-card-body">
                <div class="chat-card-title">${chat.name}</div>
                <div class="chat-card-meta">
                    <span>Opened ${formatChatDate(chat.created_at)}</span>
                </div>
                <div class="chat-card-actions">
                    <button class="chat-card-action" onclick="event.stopPropagation(); copyChatLink('${chat.slug}')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                        </svg>
                        Copy link
                    </button>
                    <button class="chat-card-action" onclick="event.stopPropagation(); deleteListeningChat('${chat.id}')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                            <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        Delete
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Maximum visible tiles before stacking (not counting blank card)
const MAX_VISIBLE_TILES = 8;

// Store overflow chats for expansion
window.overflowChats = [];

// Render all chat cards with stacking for overflow
async function renderChatCards() {
    const chats = await loadListeningChats();
    const chatsGrid = document.getElementById('chats-grid');
    const stack = document.getElementById('chatStack');
    const overflowExpanded = document.getElementById('chatsOverflowExpanded');
    const overflowGrid = document.getElementById('overflowGrid');

    if (!chatsGrid) {
        console.error('Chats grid container not found');
        return;
    }

    // Clear existing chat cards (but keep structure)
    const existingCards = chatsGrid.querySelectorAll('.chat-card');
    existingCards.forEach(card => card.remove());

    // Reset stack and overflow
    if (stack) stack.style.display = 'none';
    if (overflowExpanded) overflowExpanded.style.display = 'none';
    if (overflowGrid) overflowGrid.innerHTML = '';
    window.overflowChats = [];

    // Ensure new chat card exists
    let newChatCard = chatsGrid.querySelector('.new-chat-card');
    if (!newChatCard) {
        const newChatHTML = `
            <div class="new-chat-card" onclick="openChatEditor()">
                <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <span>Blank</span>
            </div>
        `;
        chatsGrid.insertAdjacentHTML('afterbegin', newChatHTML);
        newChatCard = chatsGrid.querySelector('.new-chat-card');
    }

    if (!chats || chats.length === 0) {
        return;
    }

    // Split chats into visible and overflow
    const visibleChats = chats.slice(0, MAX_VISIBLE_TILES);
    const overflowChatsData = chats.slice(MAX_VISIBLE_TILES);

    // Render visible tiles (insert before the stack element)
    visibleChats.forEach(chat => {
        const cardHTML = createChatCardHTML(chat);
        if (stack) {
            stack.insertAdjacentHTML('beforebegin', cardHTML);
        } else {
            chatsGrid.insertAdjacentHTML('beforeend', cardHTML);
        }
    });

    // Show stack if there are overflow chats
    if (overflowChatsData.length > 0 && stack) {
        stack.style.display = 'block';
        const stackCount = stack.querySelector('.stack-count');
        if (stackCount) {
            stackCount.textContent = `+${overflowChatsData.length} more`;
        }
        window.overflowChats = overflowChatsData;
    }
}

// Handle stack click to expand
function expandChatStack() {
    const stack = document.getElementById('chatStack');
    const overflowExpanded = document.getElementById('chatsOverflowExpanded');
    const overflowGrid = document.getElementById('overflowGrid');

    if (!stack || !overflowExpanded || !overflowGrid) return;

    // Hide the stack
    stack.style.display = 'none';

    // Show expanded section
    overflowExpanded.style.display = 'block';

    // Render overflow tiles
    if (window.overflowChats && window.overflowChats.length > 0) {
        overflowGrid.innerHTML = window.overflowChats.map(chat => createChatCardHTML(chat)).join('');
    }
}

// Handle show less click
function collapseChatStack() {
    const stack = document.getElementById('chatStack');
    const overflowExpanded = document.getElementById('chatsOverflowExpanded');

    if (!stack || !overflowExpanded) return;

    // Hide expanded section
    overflowExpanded.style.display = 'none';

    // Show stack again
    stack.style.display = 'block';
}

// Set up event listeners for stack expand/collapse
document.addEventListener('DOMContentLoaded', function() {
    const stack = document.getElementById('chatStack');
    const showLessBtn = document.getElementById('showLessBtn');

    if (stack) {
        stack.addEventListener('click', expandChatStack);
    }

    if (showLessBtn) {
        showLessBtn.addEventListener('click', collapseChatStack);
    }
});

// Delete a listening chat from database
async function deleteListeningChat(chatId) {
    if (!confirm('Are you sure you want to delete this chat? This cannot be undone.')) {
        return;
    }

    try {
        const { error } = await window.supabaseClient
            .from('listening_chats')
            .delete()
            .eq('id', chatId);

        if (error) {
            throw error;
        }

        // Remove card from UI
        const card = document.querySelector(`.chat-card[data-chat-id="${chatId}"]`);
        if (card) {
            card.remove();
        }

        console.log('Chat deleted successfully');

    } catch (error) {
        console.error('Error deleting chat:', error);
        alert('Failed to delete chat: ' + error.message);
    }
}

// Initialize save chat button event listener
function initSaveChatButton() {
    const saveChatBtn = document.getElementById('saveChatBtn');
    if (saveChatBtn) {
        saveChatBtn.addEventListener('click', saveListeningChat);
    }
}

// Initialize save button when DOM is ready
document.addEventListener('DOMContentLoaded', initSaveChatButton);

// ============================================
// CHAT RESPONSES FUNCTIONS
// ============================================

// Load responses for the current chat
async function loadChatResponses(chatId) {
    if (!chatId) {
        console.log('No chat ID provided for loading responses');
        return;
    }

    try {
        const { data: responses, error } = await window.supabaseClient
            .from('chat_responses')
            .select('*')
            .eq('chat_id', chatId)
            .order('submitted_at', { ascending: false });

        if (error) throw error;

        displayResponses(responses);

    } catch (error) {
        console.error('Error loading responses:', error);
    }
}

// Display responses in the table
function displayResponses(responses) {
    const tableContainer = document.getElementById('responsesTableContainer');
    const tableBody = document.getElementById('responsesTableBody');
    const responseCount = document.getElementById('responseCount');

    // Always show the table
    tableContainer.style.display = 'block';

    // Hide the old empty state if it exists
    const emptyState = document.getElementById('responsesEmptyState');
    if (emptyState) {
        emptyState.style.display = 'none';
    }

    // Update count
    responseCount.textContent = responses ? responses.length : 0;

    // Check if current chat is invite_only to show/hide participant column
    const participantColumn = document.getElementById('participantColumn');
    const participantCells = document.querySelectorAll('.col-participant');
    const chat = window.currentEditingChat;
    const showParticipant = chat && chat.access_type === 'invite_only';

    if (participantColumn) {
        participantColumn.style.display = showParticipant ? '' : 'none';
    }
    participantCells.forEach(cell => {
        cell.style.display = showParticipant ? '' : 'none';
    });

    // If no responses, show empty row
    if (!responses || responses.length === 0) {
        tableBody.innerHTML = `
            <tr class="empty-row">
                <td colspan="5" style="text-align: center; padding: 40px; color: #6b7280;">
                    <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                    <div>No responses yet. Responses will appear here once people start using your chat.</div>
                </td>
            </tr>
        `;
        return;
    }

    // Display responses
    tableBody.innerHTML = responses.map(response => `
        <tr data-response-id="${response.id}">
            <td>
                <div class="response-text">${escapeHtmlForResponses(response.response_text || '')}</div>
            </td>
            <td class="col-participant" style="${showParticipant ? '' : 'display: none;'}">
                <div class="participant-info">
                    ${response.participant_name ? escapeHtmlForResponses(response.participant_name) : 'Anonymous'}
                </div>
                ${response.participant_email ? `<div class="participant-email">${escapeHtmlForResponses(response.participant_email)}</div>` : ''}
            </td>
            <td>
                <div class="date-submitted">${formatResponseDate(response.submitted_at)}</div>
            </td>
            <td>
                ${!response.is_read ? '<span class="status-badge new">New</span>' : ''}
            </td>
            <td>
                <div class="action-buttons">
                    ${!response.is_read ? `<button class="btn-action" onclick="markResponseAsRead('${response.id}')">Mark Read</button>` : ''}
                    <button class="btn-action delete" onclick="deleteResponse('${response.id}')">Delete</button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Format date for display
function formatResponseDate(dateString) {
    if (!dateString) return 'Unknown';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
    });
}

// Escape HTML to prevent XSS
function escapeHtmlForResponses(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Mark response as read
async function markResponseAsRead(responseId) {
    try {
        const { error } = await window.supabaseClient
            .from('chat_responses')
            .update({ is_read: true })
            .eq('id', responseId);

        if (error) throw error;

        // Reload responses
        if (window.currentEditingChatId) {
            loadChatResponses(window.currentEditingChatId);
        }
    } catch (error) {
        console.error('Error marking response as read:', error);
        alert('Failed to update response');
    }
}

// Delete response
async function deleteResponse(responseId) {
    if (!confirm('Are you sure you want to delete this response?')) return;

    try {
        const { error } = await window.supabaseClient
            .from('chat_responses')
            .delete()
            .eq('id', responseId);

        if (error) throw error;

        // Reload responses
        if (window.currentEditingChatId) {
            loadChatResponses(window.currentEditingChatId);
        }
    } catch (error) {
        console.error('Error deleting response:', error);
        alert('Failed to delete response');
    }
}

// Export responses to CSV
function exportResponsesToCSV() {
    const table = document.querySelector('.responses-table');
    if (!table) return;

    let csv = [];
    const rows = table.querySelectorAll('tr');

    rows.forEach(row => {
        const cols = row.querySelectorAll('th, td');
        const rowData = [];
        cols.forEach(col => {
            // Skip hidden columns
            if (col.style.display === 'none') return;
            let text = col.textContent.trim().replace(/"/g, '""');
            rowData.push(`"${text}"`);
        });
        if (rowData.length > 0) {
            csv.push(rowData.join(','));
        }
    });

    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `responses-${window.currentEditingChatId || 'export'}-${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

// Initialize export button
function initExportResponsesButton() {
    const exportBtn = document.getElementById('exportResponsesBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', exportResponsesToCSV);
    }
}

// Initialize export button when DOM is ready
document.addEventListener('DOMContentLoaded', initExportResponsesButton);

function sbCreateNewSurvey() {
    sbCurrentSurvey = sbCreateDefaultSurvey();
    sbCurrentPageIndex = 0;
    sbOpenBuilder();
}

function sbEditSurvey(id) {
    sbCurrentSurvey = sbSurveys.find(s => s.id === id);
    if (sbCurrentSurvey) {
        sbCurrentPageIndex = 0;
        sbOpenBuilder();
    }
}

function sbDeleteSurvey(id) {
    if (confirm('Are you sure you want to delete this survey?')) {
        sbSurveys = sbSurveys.filter(s => s.id !== id);
        sbSaveSurveys();
        sbRenderDashboard();
    }
}

function sbCopyToClipboard(surveyId, button) {
    const link = `${window.location.origin}/survey/${surveyId}`;
    navigator.clipboard.writeText(link);
    button.classList.add('copied');
    button.innerHTML = `
        <svg class="sb-icon-sm" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
        Copied!
    `;
    setTimeout(() => {
        button.classList.remove('copied');
        button.innerHTML = `
            <svg class="sb-icon-sm" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
            Copy link
        `;
    }, 2000);
}

// Survey Builder
function sbOpenBuilder() {
    document.getElementById('sb-dashboard-view').classList.add('sb-hidden');
    document.getElementById('sb-builder-view').classList.remove('sb-hidden');
    document.getElementById('sb-preview-view').classList.add('sb-hidden');
    sbApplyTheme(sbCurrentSurvey.themeColor);
    sbRenderBuilder();
}

function sbGoToDashboard() {
    sbRenderDashboard();
}

function sbRenderBuilder() {
    document.getElementById('sb-builder-survey-name').textContent = sbCurrentSurvey.name || 'Untitled Survey';
    sbRenderPageSidebar();
    sbRenderBuilderMain();
}

function sbRenderPageSidebar() {
    const container = document.getElementById('sb-page-thumbnails');
    if (!container) return;
    container.innerHTML = '';

    sbCurrentSurvey.pages.forEach((page, index) => {
        const thumb = document.createElement('div');
        thumb.className = `sb-page-thumbnail ${index === sbCurrentPageIndex ? 'active' : ''}`;
        thumb.draggable = true;
        thumb.dataset.index = index;

        let questionsHtml = '';
        page.questions.slice(0, 3).forEach(() => {
            questionsHtml += `
                <div class="sb-page-thumbnail-question">
                    <div class="sb-page-thumbnail-dot"></div>
                    <div class="sb-page-thumbnail-line" style="flex:1; height:2px;"></div>
                </div>
            `;
        });

        thumb.innerHTML = `
            <div class="sb-page-thumbnail-preview">
                <div class="sb-page-thumbnail-bar"></div>
                <div class="sb-page-thumbnail-content">
                    <div class="sb-page-thumbnail-line w-80"></div>
                    <div class="sb-page-thumbnail-line w-60"></div>
                    ${questionsHtml || '<div style="font-size:8px;color:var(--sb-text-secondary);text-align:center;">Empty</div>'}
                </div>
            </div>
            <div class="sb-page-thumbnail-info">
                <span class="sb-page-thumbnail-label">${index + 1}. ${page.title || 'Page ' + (index + 1)}</span>
                ${sbCurrentSurvey.pages.length > 1 ? `<button class="sb-page-thumbnail-delete" onclick="event.stopPropagation(); sbDeletePage(${index})"><svg class="sb-icon-sm" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>` : ''}
            </div>
            <span class="sb-page-thumbnail-count">${page.questions.length} question${page.questions.length !== 1 ? 's' : ''}</span>
        `;

        thumb.onclick = () => sbSelectPage(index);

        // Drag events for page reordering
        thumb.ondragstart = (e) => {
            e.dataTransfer.setData('text/plain', index);
            thumb.style.opacity = '0.5';
        };
        thumb.ondragend = () => thumb.style.opacity = '1';
        thumb.ondragover = (e) => {
            e.preventDefault();
            thumb.classList.add('drag-over');
        };
        thumb.ondragleave = () => thumb.classList.remove('drag-over');
        thumb.ondrop = (e) => {
            e.preventDefault();
            thumb.classList.remove('drag-over');
            const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
            const toIndex = index;
            if (fromIndex !== toIndex) {
                const [page] = sbCurrentSurvey.pages.splice(fromIndex, 1);
                sbCurrentSurvey.pages.splice(toIndex, 0, page);
                if (sbCurrentPageIndex === fromIndex) sbCurrentPageIndex = toIndex;
                else if (fromIndex < sbCurrentPageIndex && toIndex >= sbCurrentPageIndex) sbCurrentPageIndex--;
                else if (fromIndex > sbCurrentPageIndex && toIndex <= sbCurrentPageIndex) sbCurrentPageIndex++;
                sbRenderBuilder();
            }
        };

        container.appendChild(thumb);
    });
}

function sbRenderBuilderMain() {
    const main = document.getElementById('sb-builder-main');
    if (!main) return;
    const page = sbCurrentSurvey.pages[sbCurrentPageIndex];

    let html = `
        <!-- Header Card -->
        <div class="sb-card sb-header-card">
            <div class="sb-header-card-top"></div>
            <div class="sb-header-card-body">
                <input type="text" class="sb-input sb-input-title" value="${sbCurrentSurvey.name}" placeholder="Untitled Survey" oninput="sbCurrentSurvey.name = this.value; document.getElementById('sb-builder-survey-name').textContent = this.value || 'Untitled Survey';">
                <input type="text" class="sb-input" value="${sbCurrentSurvey.description || ''}" placeholder="Form description" oninput="sbCurrentSurvey.description = this.value;">
            </div>
        </div>

        <!-- Page Instructions Card -->
        <div class="sb-card sb-page-card">
            <div class="sb-page-card-header">
                <div class="sb-page-card-header-top">
                    <div class="sb-page-card-label">
                        <svg class="sb-icon" viewBox="0 0 24 24"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
                        PAGE ${sbCurrentPageIndex + 1} SETTINGS
                    </div>
                    <button class="sb-page-logic-btn ${page.logic && page.logic.length > 0 ? 'active' : ''}" onclick="sbTogglePageLogic()">
                        <svg class="sb-icon-sm" viewBox="0 0 24 24"><line x1="6" y1="3" x2="6" y2="15"></line><circle cx="18" cy="6" r="3"></circle><circle cx="6" cy="18" r="3"></circle><path d="M18 9a9 9 0 0 1-9 9"></path></svg>
                        Page Logic ${page.logic && page.logic.length > 0 ? `(${page.logic.length})` : ''}
                    </button>
                </div>
                <input type="text" class="sb-input" style="font-size:18px;" value="${page.title || ''}" placeholder="Page title (optional)" oninput="sbCurrentSurvey.pages[${sbCurrentPageIndex}].title = this.value; sbRenderPageSidebar();">
                <textarea class="sb-input" rows="2" placeholder="Page instructions - explain what this section is about..." oninput="sbCurrentSurvey.pages[${sbCurrentPageIndex}].instructions = this.value;">${page.instructions || ''}</textarea>
            </div>
            <div class="sb-page-logic-panel sb-hidden" id="sb-page-logic-panel">
                <!-- Page logic will be rendered here -->
            </div>
        </div>
    `;

    // Questions
    page.questions.forEach((question, qIndex) => {
        html += sbRenderQuestionCard(question, qIndex);
    });

    // Empty state
    if (page.questions.length === 0) {
        html += `
            <div class="sb-card">
                <div class="sb-empty-state">
                    <div class="sb-empty-state-icon"></div>
                    <p class="sb-empty-state-text">Start by adding your first question</p>
                    <button class="sb-btn sb-btn-primary" onclick="sbAddQuestion('single')">
                        <svg class="sb-icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Add Question
                    </button>
                </div>
            </div>
        `;
    }

    // Page Navigation
    html += `
        <div class="sb-card sb-page-navigation">
            <button class="sb-page-nav-btn" onclick="sbSelectPage(${sbCurrentPageIndex - 1})" ${sbCurrentPageIndex === 0 ? 'disabled' : ''}>
                <svg class="sb-icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            ${sbCurrentSurvey.pages.map((_, i) => `
                <button class="sb-page-nav-dot ${i === sbCurrentPageIndex ? 'active' : ''}" onclick="sbSelectPage(${i})">${i + 1}</button>
            `).join('')}
            <button class="sb-page-nav-btn" onclick="sbSelectPage(${sbCurrentPageIndex + 1})" ${sbCurrentPageIndex === sbCurrentSurvey.pages.length - 1 ? 'disabled' : ''}>
                <svg class="sb-icon" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </button>
            <div style="width:1px;height:24px;background:var(--sb-border);margin:0 8px;"></div>
            <button class="sb-btn sb-btn-secondary" style="padding:8px 16px;border-radius:18px;font-size:13px;" onclick="sbAddPage()">
                <svg class="sb-icon-sm" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Add page
            </button>
        </div>
    `;

    main.innerHTML = html;
}

function sbRenderQuestionCard(question, qIndex) {
    const optionsHtml = (question.type === 'single' || question.type === 'multi') ? `
        <div class="sb-options-editor">
            ${(question.options || []).map((opt, i) => `
                <div class="sb-option-row">
                    <div class="sb-option-icon ${question.type === 'multi' ? 'checkbox' : ''}"></div>
                    <input type="text" class="sb-option-input" value="${opt}" onchange="sbUpdateOption(${qIndex}, ${i}, this.value)">
                    ${question.options.length > 1 ? `<button class="sb-btn-icon" onclick="sbRemoveOption(${qIndex}, ${i})"><svg class="sb-icon-sm" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>` : ''}
                </div>
            `).join('')}
            <button class="sb-add-option-btn" onclick="sbAddOption(${qIndex})">
                <div class="sb-option-icon ${question.type === 'multi' ? 'checkbox' : ''}"></div>
                <span class="sb-add-option-label">Add option</span>
            </button>
        </div>
    ` : '';

    const ratingHtml = question.type === 'rating' ? `
        <div class="sb-rating-preview">
            <span class="sb-rating-label">${sbCurrentSurvey.ratingScale.labels[0]}</span>
            <div class="sb-rating-points">
                ${sbCurrentSurvey.ratingScale.values.map(val => `
                    <div class="sb-rating-point">
                        <span class="sb-rating-point-value">${val}</span>
                        <div class="sb-rating-point-circle"></div>
                    </div>
                `).join('')}
            </div>
            <span class="sb-rating-label">${sbCurrentSurvey.ratingScale.labels[sbCurrentSurvey.ratingScale.labels.length - 1]}</span>
        </div>
    ` : '';

    const textHtml = question.type === 'text' ? `
        <div style="margin-top:16px;border-bottom:1px solid var(--sb-border);padding:8px 0;color:var(--sb-text-secondary);font-size:14px;">
            Long answer text
        </div>
    ` : '';

    return `
        <div class="sb-card sb-question-card"
             id="sb-question-${qIndex}"
             draggable="true"
             ondragstart="sbHandleQuestionDragStart(event, ${qIndex})"
             ondragover="sbHandleQuestionDragOver(event, ${qIndex})"
             ondrop="sbHandleQuestionDrop(event, ${qIndex})"
             ondragend="sbHandleQuestionDragEnd(event)">
            <div class="sb-question-drag-handle">
                <svg class="sb-icon-sm" viewBox="0 0 24 24" style="color:var(--sb-text-secondary);"><circle cx="9" cy="12" r="1"></circle><circle cx="9" cy="5" r="1"></circle><circle cx="9" cy="19" r="1"></circle><circle cx="15" cy="12" r="1"></circle><circle cx="15" cy="5" r="1"></circle><circle cx="15" cy="19" r="1"></circle></svg>
                <span>Q${qIndex + 1}</span>
            </div>
            <div class="sb-question-body">
                <div class="sb-question-header">
                    <div class="sb-question-text-input">
                        <input type="text" class="sb-input sb-input-lg" value="${question.text}" placeholder="Question" onchange="sbUpdateQuestionText(${qIndex}, this.value)">
                    </div>
                    <div class="sb-question-type-selector">
                        <button class="sb-question-type-btn" onclick="sbToggleTypeDropdown(${qIndex})">
                            ${sbGetQuestionTypeIcon(question.type)}
                            <span>${sbQuestionTypeLabels[question.type]}</span>
                            <svg class="sb-icon-sm" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </button>
                        <div class="sb-question-type-dropdown sb-hidden" id="sb-type-dropdown-${qIndex}">
                            ${Object.entries(sbQuestionTypeLabels).map(([type, label]) => `
                                <button class="sb-question-type-option ${type === question.type ? 'selected' : ''}" onclick="sbChangeQuestionType(${qIndex}, '${type}')">
                                    ${sbGetQuestionTypeIcon(type)}
                                    ${label}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
                ${optionsHtml}
                ${ratingHtml}
                ${textHtml}
            </div>
            <div class="sb-question-footer">
                <button class="sb-btn-icon" onclick="sbDuplicateQuestion(${qIndex})" title="Duplicate">
                    <svg class="sb-icon" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                </button>
                <button class="sb-btn-icon" onclick="sbDeleteQuestion(${qIndex})" title="Delete">
                    <svg class="sb-icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
                <div class="sb-question-footer-divider"></div>
                <div class="sb-required-toggle">
                    <span class="sb-required-label">Required</span>
                    <label class="sb-toggle">
                        <input type="checkbox" ${question.required ? 'checked' : ''} onchange="sbToggleRequired(${qIndex}, this.checked)">
                        <span class="sb-toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
    `;
}

function sbGetQuestionTypeIcon(type) {
    const icons = {
        rating: '<svg class="sb-icon" viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>',
        single: '<svg class="sb-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle></svg>',
        multi: '<svg class="sb-icon" viewBox="0 0 24 24"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>',
        text: '<svg class="sb-icon" viewBox="0 0 24 24"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>'
    };
    return icons[type] || icons.single;
}

// Question Operations
function sbAddQuestion(type) {
    const question = sbCreateDefaultQuestion(type);
    sbCurrentSurvey.pages[sbCurrentPageIndex].questions.push(question);
    sbRenderBuilder();
}

function sbUpdateQuestionText(qIndex, value) {
    sbCurrentSurvey.pages[sbCurrentPageIndex].questions[qIndex].text = value;
}

function sbToggleTypeDropdown(qIndex) {
    const dropdown = document.getElementById(`sb-type-dropdown-${qIndex}`);
    const isHidden = dropdown.classList.contains('sb-hidden');

    // Close all dropdowns first
    document.querySelectorAll('.sb-question-type-dropdown').forEach(d => d.classList.add('sb-hidden'));
    document.querySelectorAll('.sb-question-type-btn').forEach(b => b.classList.remove('open'));

    if (isHidden) {
        dropdown.classList.remove('sb-hidden');
        dropdown.previousElementSibling.classList.add('open');
    }
}

function sbChangeQuestionType(qIndex, type) {
    const question = sbCurrentSurvey.pages[sbCurrentPageIndex].questions[qIndex];
    question.type = type;
    if (type === 'single' || type === 'multi') {
        if (!question.options) question.options = ['Option 1'];
    }
    sbRenderBuilder();
}

function sbAddOption(qIndex) {
    const question = sbCurrentSurvey.pages[sbCurrentPageIndex].questions[qIndex];
    question.options.push(`Option ${question.options.length + 1}`);
    sbRenderBuilder();
}

function sbUpdateOption(qIndex, optIndex, value) {
    sbCurrentSurvey.pages[sbCurrentPageIndex].questions[qIndex].options[optIndex] = value;
}

function sbRemoveOption(qIndex, optIndex) {
    sbCurrentSurvey.pages[sbCurrentPageIndex].questions[qIndex].options.splice(optIndex, 1);
    sbRenderBuilder();
}

function sbToggleRequired(qIndex, checked) {
    sbCurrentSurvey.pages[sbCurrentPageIndex].questions[qIndex].required = checked;
}

function sbDuplicateQuestion(qIndex) {
    const question = sbCurrentSurvey.pages[sbCurrentPageIndex].questions[qIndex];
    const newQuestion = JSON.parse(JSON.stringify(question));
    newQuestion.id = sbGenerateId();
    sbCurrentSurvey.pages[sbCurrentPageIndex].questions.splice(qIndex + 1, 0, newQuestion);
    sbRenderBuilder();
}

function sbDeleteQuestion(qIndex) {
    sbCurrentSurvey.pages[sbCurrentPageIndex].questions.splice(qIndex, 1);
    sbRenderBuilder();
}

// Question drag and drop
function sbHandleQuestionDragStart(e, index) {
    sbDraggedQuestionIndex = index;
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function sbHandleQuestionDragOver(e, index) {
    e.preventDefault();
    if (sbDraggedQuestionIndex !== null && sbDraggedQuestionIndex !== index) {
        document.getElementById(`sb-question-${index}`).classList.add('drag-over');
    }
}

function sbHandleQuestionDrop(e, dropIndex) {
    e.preventDefault();
    document.querySelectorAll('.sb-question-card').forEach(c => c.classList.remove('drag-over'));

    if (sbDraggedQuestionIndex !== null && sbDraggedQuestionIndex !== dropIndex) {
        const questions = sbCurrentSurvey.pages[sbCurrentPageIndex].questions;
        const [dragged] = questions.splice(sbDraggedQuestionIndex, 1);
        questions.splice(dropIndex, 0, dragged);
        sbRenderBuilder();
    }
    sbDraggedQuestionIndex = null;
}

function sbHandleQuestionDragEnd(e) {
    e.target.classList.remove('dragging');
    document.querySelectorAll('.sb-question-card').forEach(c => c.classList.remove('drag-over'));
    sbDraggedQuestionIndex = null;
}

// Page Operations
function sbSelectPage(index) {
    if (index >= 0 && index < sbCurrentSurvey.pages.length) {
        sbCurrentPageIndex = index;
        sbRenderBuilder();
    }
}

function sbAddPage() {
    sbCurrentSurvey.pages.push({
        id: sbGenerateId(),
        title: `Page ${sbCurrentSurvey.pages.length + 1}`,
        instructions: '',
        questions: [],
        logic: []
    });
    sbCurrentPageIndex = sbCurrentSurvey.pages.length - 1;
    sbRenderBuilder();
}

function sbDeletePage(index) {
    if (sbCurrentSurvey.pages.length > 1) {
        sbCurrentSurvey.pages.splice(index, 1);
        if (sbCurrentPageIndex >= sbCurrentSurvey.pages.length) {
            sbCurrentPageIndex = sbCurrentSurvey.pages.length - 1;
        }
        sbRenderBuilder();
    }
}

function sbTogglePageLogic() {
    const panel = document.getElementById('sb-page-logic-panel');
    panel.classList.toggle('sb-hidden');
}

// Settings
function sbOpenSettings() {
    document.getElementById('sb-settings-panel').classList.remove('sb-hidden');
    sbRenderSettings();
}

function sbCloseSettings() {
    document.getElementById('sb-settings-panel').classList.add('sb-hidden');
}

function sbRenderSettings() {
    // Theme colors
    const themeContainer = document.getElementById('sb-theme-colors');
    if (themeContainer) {
        themeContainer.innerHTML = Object.entries(sbThemeColors).map(([name, colors]) => `
            <button class="sb-theme-color-btn ${sbCurrentSurvey.themeColor === name ? 'selected' : ''}"
                    style="background:${colors.primary};"
                    onclick="sbSetThemeColor('${name}')"
                    title="${name}"></button>
        `).join('');
    }

    // Dates
    const startDate = document.getElementById('sb-start-date');
    const endDate = document.getElementById('sb-end-date');
    if (startDate) startDate.value = sbCurrentSurvey.startDate;
    if (endDate) endDate.value = sbCurrentSurvey.endDate;

    // Scale points
    const scaleSelect = document.getElementById('sb-scale-points');
    if (scaleSelect) {
        scaleSelect.innerHTML = [3,4,5,6,7,10].map(n => `
            <option value="${n}" ${sbCurrentSurvey.ratingScale.points === n ? 'selected' : ''}>${n} points</option>
        `).join('');
    }

    // Scale labels
    const labelsContainer = document.getElementById('sb-scale-labels');
    if (labelsContainer) {
        labelsContainer.innerHTML = Array(sbCurrentSurvey.ratingScale.points).fill(0).map((_, i) => `
            <div class="sb-scale-label-row">
                <span class="sb-scale-label-number">${i + 1}</span>
                <input type="text" class="sb-scale-label-input" value="${sbCurrentSurvey.ratingScale.labels[i] || ''}"
                       placeholder="Label ${i + 1}"
                       onchange="sbUpdateScaleLabel(${i}, this.value)">
            </div>
        `).join('');
    }

    // Landing and thank you content
    const landingContent = document.getElementById('sb-landing-content');
    const thankyouContent = document.getElementById('sb-thankyou-content');
    if (landingContent) landingContent.value = sbCurrentSurvey.landingPageContent;
    if (thankyouContent) thankyouContent.value = sbCurrentSurvey.thankYouContent;
}

function sbSetThemeColor(name) {
    sbCurrentSurvey.themeColor = name;
    sbApplyTheme(name);
    sbRenderSettings();
}

function sbUpdateScaleLabel(index, value) {
    sbCurrentSurvey.ratingScale.labels[index] = value;
}

// Settings event listeners (attached when section is shown)
function sbInitSettingsListeners() {
    const startDate = document.getElementById('sb-start-date');
    const endDate = document.getElementById('sb-end-date');
    const scalePoints = document.getElementById('sb-scale-points');
    const landingContent = document.getElementById('sb-landing-content');
    const thankyouContent = document.getElementById('sb-thankyou-content');

    if (startDate) {
        startDate.addEventListener('change', function() {
            if (sbCurrentSurvey) sbCurrentSurvey.startDate = this.value;
        });
    }

    if (endDate) {
        endDate.addEventListener('change', function() {
            if (sbCurrentSurvey) sbCurrentSurvey.endDate = this.value;
        });
    }

    if (scalePoints) {
        scalePoints.addEventListener('change', function() {
            if (!sbCurrentSurvey) return;
            const points = parseInt(this.value);
            const newLabels = Array(points).fill('').map((_, i) => sbCurrentSurvey.ratingScale.labels[i] || `Point ${i + 1}`);
            const newValues = Array(points).fill(0).map((_, i) => i + 1);
            sbCurrentSurvey.ratingScale = { points, labels: newLabels, values: newValues };
            sbRenderSettings();
        });
    }

    if (landingContent) {
        landingContent.addEventListener('input', function() {
            if (sbCurrentSurvey) sbCurrentSurvey.landingPageContent = this.value;
        });
    }

    if (thankyouContent) {
        thankyouContent.addEventListener('input', function() {
            if (sbCurrentSurvey) sbCurrentSurvey.thankYouContent = this.value;
        });
    }
}

// Save
function sbSaveSurvey() {
    const existingIndex = sbSurveys.findIndex(s => s.id === sbCurrentSurvey.id);
    if (existingIndex >= 0) {
        sbSurveys[existingIndex] = sbCurrentSurvey;
    } else {
        sbSurveys.unshift(sbCurrentSurvey);
    }
    sbSaveSurveys();
    sbRenderDashboard();
}

// Link Modal
function sbOpenLinkModal() {
    document.getElementById('sb-link-modal').classList.remove('sb-hidden');
    document.getElementById('sb-survey-link').value = `${window.location.origin}/survey/${sbCurrentSurvey.id}`;
}

function sbCloseLinkModal() {
    document.getElementById('sb-link-modal').classList.add('sb-hidden');
}

function sbCopyLink() {
    const input = document.getElementById('sb-survey-link');
    navigator.clipboard.writeText(input.value);
    document.getElementById('sb-copy-btn-text').textContent = 'Copied!';
    setTimeout(() => {
        document.getElementById('sb-copy-btn-text').textContent = 'Copy';
    }, 2000);
}

// Preview
let sbPreviewResponses = {};
let sbPreviewStarted = false;
let sbPreviewSubmitted = false;
let sbPreviewPageIndex = 0;

function sbPreviewSurvey() {
    document.getElementById('sb-dashboard-view').classList.add('sb-hidden');
    document.getElementById('sb-builder-view').classList.add('sb-hidden');
    document.getElementById('sb-preview-view').classList.remove('sb-hidden');
    sbApplyTheme(sbCurrentSurvey.themeColor);
    sbRenderPreview();
}

function sbRenderPreview() {
    const container = document.getElementById('sb-preview-view');
    container.style.minHeight = 'calc(100vh - 200px)';
    container.style.background = 'var(--sb-primary-light)';

    sbPreviewResponses = {};
    sbPreviewStarted = false;
    sbPreviewSubmitted = false;
    sbPreviewPageIndex = 0;

    sbRenderPreviewContent();
}

function sbRenderPreviewContent() {
    const container = document.getElementById('sb-preview-view');
    const theme = sbThemeColors[sbCurrentSurvey.themeColor] || sbThemeColors.purple;

    if (sbPreviewSubmitted) {
        container.innerHTML = `
            <div class="sb-preview-banner">
                Preview mode - responses won't be saved
                <button onclick="sbExitPreview()">Exit Preview</button>
            </div>
            <div style="display:flex;align-items:center;justify-content:center;min-height:calc(100vh - 250px);padding:24px;">
                <div class="sb-card sb-thankyou-card">
                    <div class="sb-thankyou-card-top" style="background:${theme.primary};"></div>
                    <div class="sb-thankyou-card-body">
                        <svg class="sb-icon-xl sb-thankyou-icon" viewBox="0 0 24 24" style="color:var(--sb-success);"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        <h2 class="sb-thankyou-title">Thank you!</h2>
                        <p class="sb-thankyou-message">${sbCurrentSurvey.thankYouContent}</p>
                        <button class="sb-btn sb-btn-primary" onclick="sbExitPreview()">Back to Editor</button>
                    </div>
                </div>
            </div>
        `;
        return;
    }

    if (!sbPreviewStarted) {
        container.innerHTML = `
            <div class="sb-preview-banner">
                Preview mode - responses won't be saved
                <button onclick="sbExitPreview()">Exit Preview</button>
            </div>
            <div class="sb-preview-main">
                <div class="sb-card sb-landing-card">
                    <div class="sb-landing-card-top" style="background:${theme.primary};"></div>
                    <div class="sb-landing-card-body">
                        <h1 class="sb-landing-title">${sbCurrentSurvey.name}</h1>
                        ${sbCurrentSurvey.description ? `<p class="sb-landing-description">${sbCurrentSurvey.description}</p>` : ''}
                        <p class="sb-landing-content">${sbCurrentSurvey.landingPageContent}</p>
                    </div>
                    <div class="sb-landing-footer">
                        <button class="sb-btn sb-btn-primary" onclick="sbStartPreviewSurvey()">Start</button>
                    </div>
                </div>
            </div>
        `;
        return;
    }

    const page = sbCurrentSurvey.pages[sbPreviewPageIndex];
    const totalQuestions = sbCurrentSurvey.pages.reduce((acc, p) => acc + p.questions.length, 0);
    const answeredCount = Object.keys(sbPreviewResponses).filter(k =>
        sbPreviewResponses[k] !== '' && sbPreviewResponses[k] !== undefined &&
        (Array.isArray(sbPreviewResponses[k]) ? sbPreviewResponses[k].length > 0 : true)
    ).length;
    const progress = totalQuestions > 0 ? Math.round((answeredCount / totalQuestions) * 100) : 0;

    let html = `
        <div class="sb-preview-banner">
            Preview mode - responses won't be saved
            <button onclick="sbExitPreview()">Exit Preview</button>
        </div>
        <div class="sb-preview-progress" style="background:var(--sb-primary-light);">
            <div class="sb-preview-progress-bar">
                <div class="sb-preview-progress-fill" style="width:${progress}%;background:${theme.primary};"></div>
            </div>
        </div>
        <div class="sb-preview-main">
            <!-- Header -->
            <div class="sb-card" style="margin-bottom:16px;overflow:hidden;">
                <div style="height:10px;background:${theme.primary};"></div>
                <div style="padding:24px;">
                    <h1 style="font-size:24px;font-weight:400;margin:0;">${sbCurrentSurvey.name}</h1>
                    ${sbCurrentSurvey.description ? `<p style="color:var(--sb-text-secondary);margin:8px 0 0;">${sbCurrentSurvey.description}</p>` : ''}
                </div>
            </div>
    `;

    // Page instructions
    if (page.title || page.instructions) {
        html += `
            <div class="sb-preview-page-instructions" style="background:var(--sb-primary-light);">
                ${page.title ? `<h2 class="sb-preview-page-title">${page.title}</h2>` : ''}
                ${page.instructions ? `<p class="sb-preview-page-text">${page.instructions}</p>` : ''}
            </div>
        `;
    }

    // Page indicator
    if (sbCurrentSurvey.pages.length > 1) {
        html += `
            <div class="sb-page-indicator">
                <span>Page ${sbPreviewPageIndex + 1} of ${sbCurrentSurvey.pages.length}</span>
                <div class="sb-page-indicator-dots">
                    ${sbCurrentSurvey.pages.map((_, i) => `
                        <div class="sb-page-indicator-dot ${i === sbPreviewPageIndex ? 'active' : ''}" style="${i === sbPreviewPageIndex ? 'background:' + theme.primary : ''}"></div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    // Questions
    page.questions.forEach((question, qIndex) => {
        html += sbRenderPreviewQuestion(question, qIndex, theme);
    });

    // Navigation
    html += `
        <div class="sb-preview-navigation">
            <div class="sb-preview-nav-left">
                ${sbPreviewPageIndex > 0 ? `
                    <button class="sb-btn sb-btn-secondary" onclick="sbPreviewPrevPage()">
                        <svg class="sb-icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        Back
                    </button>
                ` : ''}
                ${sbPreviewPageIndex < sbCurrentSurvey.pages.length - 1 ? `
                    <button class="sb-btn sb-btn-primary" onclick="sbPreviewNextPage()">
                        Next
                        <svg class="sb-icon" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </button>
                ` : `
                    <button class="sb-btn sb-btn-primary" onclick="sbSubmitPreview()">Submit</button>
                `}
            </div>
            <button class="sb-btn-text" onclick="sbClearPreviewResponses()">Clear form</button>
        </div>
    `;

    html += '</div>';
    container.innerHTML = html;
}

function sbRenderPreviewQuestion(question, qIndex, theme) {
    const response = sbPreviewResponses[question.id];

    let inputHtml = '';

    if (question.type === 'rating') {
        inputHtml = `
            <div class="sb-preview-rating">
                <span class="sb-preview-rating-label">${sbCurrentSurvey.ratingScale.labels[0]}</span>
                <div class="sb-preview-rating-points">
                    ${sbCurrentSurvey.ratingScale.values.map(val => `
                        <label class="sb-preview-rating-point">
                            <span class="sb-preview-rating-point-value">${val}</span>
                            <input type="radio" name="sb-q-${question.id}" value="${val}"
                                   ${response === val ? 'checked' : ''}
                                   onchange="sbSetPreviewResponse('${question.id}', ${val})">
                        </label>
                    `).join('')}
                </div>
                <span class="sb-preview-rating-label">${sbCurrentSurvey.ratingScale.labels[sbCurrentSurvey.ratingScale.labels.length - 1]}</span>
            </div>
        `;
    } else if (question.type === 'single') {
        inputHtml = `
            <div class="sb-preview-options">
                ${(question.options || []).map(opt => `
                    <label class="sb-preview-option">
                        <input type="radio" name="sb-q-${question.id}" value="${opt}"
                               ${response === opt ? 'checked' : ''}
                               onchange="sbSetPreviewResponse('${question.id}', '${opt}')">
                        <span>${opt}</span>
                    </label>
                `).join('')}
            </div>
        `;
    } else if (question.type === 'multi') {
        inputHtml = `
            <div class="sb-preview-options">
                ${(question.options || []).map(opt => `
                    <label class="sb-preview-option">
                        <input type="checkbox" value="${opt}"
                               ${(response || []).includes(opt) ? 'checked' : ''}
                               onchange="sbTogglePreviewMultiResponse('${question.id}', '${opt}', this.checked)">
                        <span>${opt}</span>
                    </label>
                `).join('')}
            </div>
        `;
    } else if (question.type === 'text') {
        inputHtml = `
            <textarea class="sb-preview-textarea" rows="4" placeholder="Your answer"
                      oninput="sbSetPreviewResponse('${question.id}', this.value)">${response || ''}</textarea>
        `;
    }

    return `
        <div class="sb-card sb-preview-question">
            <div class="sb-preview-question-text">
                ${question.text}
                ${question.required ? '<span class="required">*</span>' : ''}
            </div>
            ${inputHtml}
        </div>
    `;
}

function sbStartPreviewSurvey() {
    sbPreviewStarted = true;
    sbRenderPreviewContent();
}

function sbSetPreviewResponse(questionId, value) {
    sbPreviewResponses[questionId] = value;
}

function sbTogglePreviewMultiResponse(questionId, value, checked) {
    if (!sbPreviewResponses[questionId]) {
        sbPreviewResponses[questionId] = [];
    }
    if (checked) {
        sbPreviewResponses[questionId].push(value);
    } else {
        sbPreviewResponses[questionId] = sbPreviewResponses[questionId].filter(v => v !== value);
    }
}

function sbClearPreviewResponses() {
    sbPreviewResponses = {};
    sbRenderPreviewContent();
}

function sbPreviewNextPage() {
    if (sbPreviewPageIndex < sbCurrentSurvey.pages.length - 1) {
        sbPreviewPageIndex++;
        window.scrollTo(0, 0);
        sbRenderPreviewContent();
    }
}

function sbPreviewPrevPage() {
    if (sbPreviewPageIndex > 0) {
        sbPreviewPageIndex--;
        window.scrollTo(0, 0);
        sbRenderPreviewContent();
    }
}

function sbSubmitPreview() {
    sbPreviewSubmitted = true;
    sbRenderPreviewContent();
}

function sbExitPreview() {
    sbOpenBuilder();
}

// Close dropdowns on click outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.sb-question-type-selector')) {
        document.querySelectorAll('.sb-question-type-dropdown').forEach(d => d.classList.add('sb-hidden'));
        document.querySelectorAll('.sb-question-type-btn').forEach(b => b.classList.remove('open'));
    }
});

// Initialize Survey Builder when section is shown
function sbInitialize() {
    sbRenderDashboard();
    sbInitSettingsListeners();
}

// Hook into showSection to initialize survey builder when shown
const originalShowSection = window.showSection;
window.showSection = function(sectionName) {
    originalShowSection(sectionName);
    if (sectionName === 'survey-builder') {
        sbInitialize();
    }
};

// ============================================== //
// SURVEY BUILDER JAVASCRIPT - END                //
// ============================================== //

</script>
</body>
</html>